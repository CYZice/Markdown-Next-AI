toolName: todo_write
            
status: success
          
Todos updated: 1 items
          
**背景与目标**
- 让用户在设置中自定义“按键触发规则”，用于两类动作：触发自动补全、唤出对话框。
- 支持输入字符、组合键（含 Alt/Ctrl/Shift/Meta）、双击空格、按键序列等触发方式。
- 与现有自动补全控制器和全局对话模式自然融合，保留现有 UI/交互规范与优先级。

**术语**
- 触发器：一条按键规则，满足条件时执行一个动作。
- 动作：自动补全或唤出对话框。
- 范围/作用域：规则生效的上下文（当前编辑器、全局、特定文件类型等）。
- 键和修饰键：字符键、功能键（Space/Enter/Tab）、修饰键（Alt/Ctrl/Shift/Meta）。
- 序列与组合：时间序列（如“空格-空格”）与同时按下（如“Alt+/”）。

**用户场景**
- 在中文输入法下，用户希望输入“：”或“@”后自动补全建议，不被 IME 干扰。
- 用户习惯用 Alt+/ 在任意编辑器中唤出对话框进行快速询问<mccoremem id="03filan33edw62gdmi6hahe26" />。
- 用户希望在 Markdown 中双击空格触发补全，但不影响正常输入，可选择是否“消费第二个空格”。

**范围与不做**
- 做：按键触发规则的配置、解析与执行；与编辑器事件（keydown/input/composition）集成；冲突与优先级策略；设置 UI。
- 不做：复杂的宏录制、跨应用系统级快捷键注册、历史记录相关功能<mccoremem id="03fj0wiwcxjw4y7ku4zskud5m|01KGMRSKE8CQDSHNAYFAHYQWP0" />。

**配置项规格**
- 规则基本字段
  - 名称：用户自定义，便于识别与搜索。
  - 动作：autoComplete | openDialog。
  - 生效范围：activeEditor | globalFallback（无活跃编辑器则走全局对话）<mccoremem id="03filan33edw62gdmi6hahe26" /> | fileTypes（如 md, mdx, txt）。
  - 启用：on/off。
- 触发类型（至少支持）
  - 输入字符：单字符或字符集；支持正则/集合（如 [:@#]）。
  - 组合键：键 + 修饰键（Alt/Ctrl/Shift/Meta），如 Alt+/。
  - 双击与序列：同键双击（Double Space），或短序列（Space → Space）。
  - 长按与连击：按住时触发（hold N ms）、在窗口内连击 N 次（可选）。
- 触发条件与阈值
  - 双击窗口：默认 250 ms，可配置 150–500 ms。
  - 连击窗口：默认 300 ms。
  - 最小上下文长度：minContextLength，用于自动补全<mccoremem id="03fj8fy7fdg472fphwkxse2mj" />。
  - IME 状态：composition 中仅记录字符，触发延后至 compositionend。
- 执行策略
  - 自动补全：复用既有控制器与参数（lengthPreset、constraints、requestTimeoutMs、maxRetries 等）<mccoremem id="03fj8fy7fdg472fphwkxse2mj" />。
  - 唤出对话框：调用 AtTriggerPopup（chat 默认），遵循 Esc 优先级与 overlay-root 定位<mccoremem id="01KGM34328TE85DPFN1BRQZEF3|03fimett186jtf8z4ing1e5iw" />。
- 文本处理
  - 消费输入：触发后是否拦截并不插入该键（如第二个空格）；默认不消费，提供可切换。
  - 光标位置：触发动作不改变光标，除非动作需要（如补全插入时由控制器决定）。

**触发器模型与优先级**
- 匹配流程
  - 输入事件到达 → 组合键判定（keydown）→ 输入字符判定（input/compositionend）→ 序列/双击判定（按时间窗）→ 条件（上下文/范围/最小长度）→ 执行动作。
- 优先级
  - 组合键 > 序列/双击 > 输入字符。
  - 若同优先级存在多条规则，按“更具体”排序（范围更窄、条件更多者优先），否则按用户排序或创建时间。
- 冲突策略
  - 与编辑器默认快捷键冲突时：提供三种策略 per 规则
    - 占用：preventDefault，使用本规则。
    - 并行：同时放行，若编辑器动作影响体验则给出冲突提示。
    - 回退：放行编辑器动作，仅在其未处理时再触发本规则。
- 退出与关闭
  - Esc 统一关闭最上层弹层（包括对话框/菜单），遵循既有优先级<mccoremem id="01KGM34328TE85DPFN1BRQZEF3" />。

**设置界面设计**
- 入口：插件设置 → 按键触发器。
- 分区
  - 自动补全触发：规则列表 + 新增/编辑。
  - 对话框触发：规则列表 + 新增/编辑。
- 规则编辑表单
  - 名称、动作、范围、fileTypes。
  - 触发类型（单选）：输入字符 / 组合键 / 双击 / 序列 / 长按 / 连击。
  - 键捕获器：支持录制组合键（显示 Alt/Ctrl/Shift/Meta + Key）。
  - 字符匹配：字符/集合/正则。
  - 时间窗：双击/连击/长按阈值。
  - 行为：是否消费输入、是否 preventDefault、最小上下文长度（补全）。
  - 预览：在测试输入框中试按，预览触发效果（不影响真实编辑器）。
- 预设与导入/导出
  - 内置预设：Alt+/, Double Space（补全）、Alt+Space（对话框）。
  - 规则导入/导出：JSON 格式。

**数据模型（建议）**
- TriggerRule
  - id: string
  - name: string
  - enabled: boolean
  - action: "autoComplete" | "openDialog"
  - scope: { type: "activeEditor" | "globalFallback" | "fileTypes"; fileTypes?: string[] }
  - type: "character" | "combo" | "doubleTap" | "sequence" | "hold" | "multiTap"
  - keys: { key?: string; alt?: boolean; ctrl?: boolean; shift?: boolean; meta?: boolean }
  - chars: { pattern: "literal" | "set" | "regex"; value: string }
  - timing: { windowMs?: number; holdMs?: number; taps?: number }
  - behavior: { consumeInput?: boolean; preventDefault?: "always" | "never" | "fallback" }
  - conditions: { minContextLength?: number }
  - order: number

**事件流与集成**
- 事件源：keydown/keyup、beforeinput/input、compositionstart/update/end。
- IME 处理
  - composition 中不触发字符规则；在 compositionend 将成串文本视为一次输入，逐字符或整体匹配。
- 自动补全集成
  - 触发后调用现有控制器，沿用 lengthPreset/constraints/timeout 与重试策略<mccoremem id="03fj8fy7fdg472fphwkxse2mj" />。
- 对话框集成
  - 触发后调用 open-ai-popup（活跃编辑器）或 open-ai-popup-global（无活跃编辑器），UI 用 AtTriggerPopup，默认 chat 模式<mccoremem id="03filan33edw62gdmi6hahe26|03fimett186jtf8z4ing1e5iw" />。

**性能与兼容**
- 性能
  - 事件处理常数时间；规则表建立索引（按 type/scope 分桶）。
  - 双击/序列采用时间戳，避免复杂状态机。
- 兼容
  - Windows/Obsidian 环境 Alt 数字码需防止误触；组合键匹配以 KeyboardEvent 标准字段为准。
  - 不绑定系统级快捷键；仅在应用内捕获。
  - 不依赖历史记录能力<mccoremem id="03fj0wiwcxjw4y7ku4zskud5m|01KGMRSKE8CQDSHNAYFAHYQWP0" />。

**安全与隐私**
- 不记录按键内容到持久化日志，除非用户在“调试模式”下临时启用。
- 防止通过键序列泄露敏感输入；调试日志默认脱敏。

**无障碍与国际化**
- 设置界面提供键盘可达性；表单控件可通过 Tab 导航。
- 规则可为不同语言/文件类型提供不同字符触发；中文 IME 友好。
- 文本与提示支持本地化。

**错误处理**
- 重复规则与冲突：在保存时提示并给出解决策略（占用/并行/回退）。
- 无效正则或键名：表单校验并阻止保存。
- 执行失败：弹出轻量提示，不中断输入流。

**日志与遥测（可选）**
- 统计触发次数与耗时，评估规则使用度。
- 可在设置中关闭遥测。

**测试方案**
- 单元测试
  - 组合键判定、字符匹配（含正则）、双击/序列时间窗。
  - IME 事件序列下的触发与延后。
- 集成测试
  - 在 Markdown 编辑器中验证自动补全触发与插入。
  - 无活跃编辑器时的全局对话触发<mccoremem id="03filan33edw62gdmi6hahe26" />。
- 回归测试
  - Esc 关闭优先级与弹层交互保持一致<mccoremem id="01KGM34328TE85DPFN1BRQZEF3" />。

**验收标准**
- 用户可创建/编辑/启用/禁用规则，预设可一键启用。
- 在不同输入法与文件类型下，规则稳定触发，无明显冲突。
- 自动补全与对话框动作与现有体验一致；Esc 优先级正确<mccoremem id="01KGM34328TE85DPFN1BRQZEF3" />。
- 双击与序列在配置的时间窗内准确识别。

**迁移与默认**
- 默认不启用任何自定义规则，仅保留现有触发机制。
- 提供三条官方预设但保持关闭：Alt+/, Double Space（补全）、Alt+Space（对话）。
- 用户首次开启时显示“键捕获”引导。

**风险与权衡**
- 双击空格可能影响打字节律：建议默认不消费第二个空格，并标注风险。
- 与编辑器默认快捷键冲突：通过 per 规则策略与提示缓解。
- IME 复杂性：采用 compositionend 延后触发，兼顾可靠性与体验。

**后续扩展**
- 条件增强：选中文本时的不同动作、在代码块/列表项中的规则分支。
- 上下文感知：结合 minContextLength 与“当前行长度/语法”进一步精细化<mccoremem id="03fj8fy7fdg472fphwkxse2mj" />。
- 工作区共享与团队预设库。

**里程碑建议**
- M1：触发器内核与数据模型；组合键/字符/双击三类；设置 UI 基础。
- M2：IME 兼容与序列/长按；冲突策略；预设与导入/导出。
- M3：日志/遥测与测试完善；无障碍与国际化；文档与示例。

**参考实现（YOLO）**
- Smart Space（空行空格/“/ + 空格”触发）
  - 事件：keydown，过滤修饰键 Alt/Ctrl/Meta，仅处理 Slash/Space，支持 600ms 组合窗口与 double-space 模式。
  - 代码参考：
    - 触发扩展与按键判定：[smartSpaceController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/smart-space/smartSpaceController.ts#L150-L301)
    - 关闭与位置维护（选择/文档变更监听）：[smartSpaceController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/smart-space/smartSpaceController.ts#L303-L319)
- Quick Ask（行首触发字符）
  - 事件：beforeinput，inputType=insertText 且非 isComposing；在空行或行首组成完整触发串时 preventDefault，清理已输入后唤出面板。
  - 代码参考：
    - 触发扩展与字符匹配：[quickAskController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/quick-ask/quickAskController.ts#L180-L275)
    - 上下文采集与面板渲染：[quickAskController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/quick-ask/quickAskController.ts#L112-L178)
- Tab Completion（基于文本模式）
  - 事件：EditorView.updateListener 监听 docChanged；根据触发器（string/regex）在前文窗口末尾匹配；延时/冷却控制与上下文长度门槛。
  - 代码参考：
    - 触发扩展与编辑器变更处理：[tabCompletionController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/tab-completion/tabCompletionController.ts#L153-L166)
    - 触发器匹配逻辑 shouldTrigger：[tabCompletionController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/tab-completion/tabCompletionController.ts#L201-L241)
    - 请求与流式渲染 Ghost：[tabCompletionController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/tab-completion/tabCompletionController.ts#L331-L585)
    - 接受建议（插入文本与光标定位）：[tabCompletionController.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/features/editor/tab-completion/tabCompletionController.ts#L587-L627)
- 命令热键映射（供 Obsidian 设置→Hotkeys 绑定）
  - 代码参考：打开聊天/触发 Smart Space/触发 Quick Ask/触发 TabCompletion/接受内联建议
    - [main.ts: open-new-chat](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/main.ts#L549-L556)
    - [main.ts: trigger-smart-space](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/main.ts#L573-L581)
    - [main.ts: trigger-quick-ask](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/main.ts#L585-L591)
    - [main.ts: trigger-tab-completion](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/main.ts#L593-L602)
    - [main.ts: accept-inline-suggestion](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/main.ts#L604-L614)
- 设置界面与 Schema
  - 触发器表单（string/regex/启用/描述）：[ContinuationSection.tsx](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/components/settings/sections/ContinuationSection.tsx#L495-L527)
  - 自动触发延时/冷却与高级参数：[ContinuationSection.tsx](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/components/settings/sections/ContinuationSection.tsx#L588-L701), [ContinuationSection.tsx](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/components/settings/sections/ContinuationSection.tsx#L721-L870)
  - 默认触发器与选项/Schema 定义：
    - 默认触发器数组：[setting.types.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/settings/schema/setting.types.ts#L84-L121)
    - TabCompletion 选项默认值：[setting.types.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/settings/schema/setting.types.ts#L72-L83)
    - Quick Ask/Smart Space/TabCompletion 设置字段：[setting.types.ts](file:///d:/Microsoft%20VS%20Code/PYTHON/FlowText/test_ai/.obsidian/plugins/obsidian-yolo-1.4.13/src/settings/schema/setting.types.ts#L284-L390)

**迁移落地建议（Markdown-Next-AI）**
- 事件层次
  - 字符触发采用 beforeinput 并跳过 isComposing，确保中文 IME 兼容。
  - 组合键与空格连击采用 keydown，设计 250–600ms 时间窗并支持“/ + 空格”组合清理。
- 统一触发器模型
  - 在设置中增加触发器列表：type=character/combo/doubleTap/sequence，pattern 或 keys，enabled 与行为（consumeInput、preventDefault）。
  - 将 Tab Completion 的 string/regex 触发器扩展为统一触发器模型，便于复用同一 UI。
- 命令与设置协同
  - 保留命令入口供 Hotkeys 绑定（如 Alt+/ 打开对话框），同时提供编辑器内触发器，二者互不冲突。
  - 针对双击空格可选“消费第二个空格”，与 YOLO 的删除触发字符策略一致。
- 优先级与门槛
  - 组合键 > 序列/双击 > 字符；选区非空不触发；仅在活动编辑器与当前视图一致时生效；满足最小上下文长度再触发补全。

**示例预设（建议）**
- Alt+/ → openDialog（不消费输入，preventDefault always）
- Double Space（空行） → autoComplete 或 openDialog（可配置消费第二空格）
- 字符集 [:@#]（行首） → openDialog（beforeinput 匹配，IME 兼容）
- 正则触发 “换行结尾” → autoComplete：pattern “\\n$”

**接入注意事项**
- IME 兼容：字符触发在 compositionend 时判定；beforeinput 中跳过 isComposing。
- 事件顺序：优先处理组合键，其次序列/双击，最后字符；避免互相干扰。
- 活动视图一致性：activeView 与当前 update.view 必须一致，避免多编辑器下误触。

**测试用例参考（来自 YOLO 策略）**
- 中文输入法下输入“@”不会提前触发；在 compositionend 完整匹配后触发对话框。
- 600ms 内“/ + 空格”触发 Smart Space；超过窗口或存在修饰键不触发。
- 在 Tab Completion 中，前文末尾匹配 string/regex 才触发；idleTrigger 冷却生效；最小上下文长度门槛有效。

**实施方案草案**
- 统一触发器配置
  - 新增 triggers: TriggerRule[]，与现有 tabCompletionTriggers 合并管理，动作扩展为 autoComplete | openDialog。
  - 引入行为控制：consumeInput、preventDefault、windowMs、taps、holdMs。
- 控制器集成
  - 新增 CustomKeyTriggerController，内部调度三类事件源：keydown、beforeinput、updateListener。
  - 触发后调用现有控制器：autoComplete → TabCompletionController.run；openDialog → QuickAskController.show 或 SmartSpaceController.show。
- 优先级与冲突
  - 组合键 > 序列/双击 > 字符；每层按“更具体”排序（scope 更窄、条件更多优先）。
  - 冲突策略：always/never/fallback 三档 preventDefault；fallback 在编辑器未处理时再触发。
- IME 兼容
  - 字符触发使用 beforeinput 且跳过 isComposing；在 compositionend 进行最终匹配。
  - 组合键不受 IME 影响，序列/双击需记录时间戳并避开修饰键。

**统一触发器 Schema 草案**

```ts
type TriggerAction = 'autoComplete' | 'openDialog'
type TriggerType = 'character' | 'combo' | 'doubleTap' | 'sequence' | 'hold' | 'multiTap'
type TriggerScopeType = 'activeEditor' | 'globalFallback' | 'fileTypes'

type TriggerRule = {
  id: string
  name: string
  enabled: boolean
  action: TriggerAction
  scope: { type: TriggerScopeType; fileTypes?: string[] }
  type: TriggerType
  keys?: { key?: string; alt?: boolean; ctrl?: boolean; shift?: boolean; meta?: boolean }
  chars?: { pattern: 'literal' | 'set' | 'regex'; value: string }
  timing?: { windowMs?: number; holdMs?: number; taps?: number }
  behavior?: { consumeInput?: boolean; preventDefault?: 'always' | 'never' | 'fallback' }
  conditions?: { minContextLength?: number }
  order: number
}
```

**编辑器扩展骨架**

```ts
import { EditorView } from '@codemirror/view'

const customKeyTriggerExtension = EditorView.domEventHandlers({
  keydown: (event, view) => {
    const matched = matchComboOrSequence(event, view)
    if (!matched) return false
    executeAction(matched, view)
    return true
  },
  beforeinput: (event, view) => {
    const inputEvent = event as InputEvent
    if (inputEvent.inputType !== 'insertText' || inputEvent.isComposing) return false
    const matched = matchCharacter(inputEvent.data ?? '', view)
    if (!matched) return false
    if (matched.behavior?.consumeInput) {
      event.preventDefault()
      event.stopPropagation()
    }
    executeAction(matched, view)
    return true
  },
})
```

```ts
type LastKeyState = { key: string; pos: number; timestamp: number } | null

function isDoubleTap(last: LastKeyState, now: number, windowMs: number, currentKey: string) {
  if (!last) return false
  if (last.key !== currentKey) return false
  return now - last.timestamp <= windowMs
}
```

**设置界面字段与交互**
- 列表：名称、动作、范围、类型、pattern/keys、enabled、行为、时间窗、顺序。
- 键捕获器：记录 Alt/Ctrl/Shift/Meta 与主键；显示标准化字符串（如 Alt+/）。
- 预览输入框：试按触发器，不影响真实编辑器；显示将触发的动作与消费策略。
- 导入/导出：JSON；校验重复 id 与无效正则/键名。

**示例预设 JSON**

```json
[
  {
    "id": "preset-open-dialog-alt-slash",
    "name": "Alt+/",
    "enabled": true,
    "action": "openDialog",
    "scope": { "type": "activeEditor" },
    "type": "combo",
    "keys": { "key": "/", "alt": true },
    "behavior": { "consumeInput": false, "preventDefault": "always" },
    "order": 1
  },
  {
    "id": "preset-double-space-autocomplete",
    "name": "Double Space",
    "enabled": true,
    "action": "autoComplete",
    "scope": { "type": "activeEditor", "fileTypes": ["md", "mdx"] },
    "type": "doubleTap",
    "timing": { "windowMs": 300, "taps": 2 },
    "behavior": { "consumeInput": true, "preventDefault": "always" },
    "order": 2
  }
]
```

**冲突与优先级算法**
- 收集当前可用规则，按类型优先级排序：combo > sequence/doubleTap > character。
- 过滤 scope 与条件（活动视图、文件类型、最小上下文长度）。
- 对同优先级按 order 从小到大、再按范围更窄优先。
- 根据行为决定是否 preventDefault 与是否消费输入。

**开发任务清单（可执行）**
- 定义 TriggerRule Schema 与存储读写。
- 实现 CustomKeyTriggerController 与事件匹配函数。
- 设置界面新增“按键触发器”列表与键捕获器组件。
- 将 TabCompletion 的触发器迁移为统一模型并保留兼容解析。
- 增加预设与导入/导出、校验与错误提示。
- 编写测试：IME 序列、双击窗口、组合键优先级、冲突策略。

**实施细则**
- 设置存储
  - 在 settings.schema 中新增 triggers: TriggerRule[] 与 schema 版本升级；提供迁移函数将现有 tabCompletionTriggers 复制为 type="character" 规则。
  - 默认不启用任何新规则，仅保留现有机制；用户启用后再写入。
- 控制器职责
  - CustomKeyTriggerController：统一注册 keydown/beforeinput/updateListener；解析触发器并路由到对应动作。
  - 与 QuickAskController/SmartSpaceController/TabCompletionController 的桥接：
    - openDialog：优先 Quick Ask（行首/空行），否则 Smart Space（空行/“/ + 空格”）。
    - autoComplete：调用 TabCompletionController.run 并沿用上下文范围与长度门槛。
- 视图一致性
  - 仅在 activeEditor 的 EditorView 与当前事件源视图一致时触发；避免多编辑器同时打开导致误触。
  - 选区非空不触发（除非将来扩展“选中时触发”特例）。
- 清理策略
  - 组合键与双击/序列可配置是否消费输入；如 Double Space 在空行触发时删除第二个空格，与 YOLO 清理策略一致。
  - “/ + 空格”组合触发时，先删除“/”，再显示面板，以保持文档整洁。

**事件匹配算法**

```ts
function matchCharacter(typedChar: string, view: EditorView): TriggerRule | null {
  // 仅当 isComposing=false 且 inputType=insertText
  const line = view.state.doc.lineAt(view.state.selection.main.head)
  const before = line.text.slice(0, view.state.selection.main.head - line.from)
  // 拼接可能的触发串（行首触发常见）
  const seq = before + typedChar
  // 遍历所有 type=character 的规则，pattern 支持 literal/set/regex
  return bestMatchCharacter(seq, rules)
}

function matchCombo(event: KeyboardEvent, view: EditorView): TriggerRule | null {
  // 规范化键值（/、Space、Enter 等）；匹配 alt/ctrl/shift/meta 布尔
  const combo = normalizeCombo(event)
  return bestMatchCombo(combo, rules)
}

function matchDoubleTapOrSequence(event: KeyboardEvent, view: EditorView): TriggerRule | null {
  // 记录 lastKeyState { key, pos, timestamp }；窗口 windowMs，taps=N
  // 同键双击：last.key === currentKey 且 now - last.timestamp <= windowMs
  // 序列：按录入队列比对（如 Space → Space 或 / → Space）
  return bestMatchSequence(lastKeyState, event, rules)
}
```

**键捕获器组件草案**

```ts
type CapturedCombo = { key: string; alt: boolean; ctrl: boolean; shift: boolean; meta: boolean }

function captureKeyCombo(e: KeyboardEvent): CapturedCombo {
  const key = normalizeKey(e.key, e.code) // 兼容不同平台与布局
  return { key, alt: e.altKey, ctrl: e.ctrlKey, shift: e.shiftKey, meta: e.metaKey }
}
```

- 展示字符串：将组合转为“Alt+/”“Ctrl+Shift+Space”等；避免不可见键（如 Dead key）。
- 录制模式：按一次即可记录；支持清空与重新录制；校验 key 合法性。

**设置迁移与版本控制**
- 在 smartComposerSettingsSchema 增加 triggers 字段与版本号 +1。
- 迁移步骤
  - 复制 tabCompletionTriggers 为 triggers 中的 type="character" 规则，action="autoComplete"。
  - 保留 quickAskTrigger 与 smartSpaceTriggerMode 原有行为，但在 UI 中展示为统一触发器（只读映射或可编辑）。
- 回滚策略：若用户清空 triggers，则继续使用旧逻辑；不影响现有体验。

**数据持久化与兼容**
- 规则上限：建议最多 50 条，超出给出提示，避免性能问题。
- 校验：regex 需 try/catch；组合键名与修饰键布尔校验；order 需为整数。
- 导入/导出：JSON，避免重复 id（自动重排或提示）。

**性能与资源控制**
- 事件处理常数时间：按 type 分桶索引；仅在匹配候选上做轻量比对。
- 时间窗：默认 300ms，可配置 150–600ms；避免过长导致误触。
- 流式响应展示：沿用 InlineSuggestionGhost 与 QuickAskOverlay，避免重复渲染。

**无障碍与国际化细节**
- 可通过键盘操作完成所有设置（Tab、Enter、Space）。
- 键名显示本地化：在非英文布局下仍显示标准键名；国际化文案与提示对齐现有语言上下文。

**验收与回归用例集**
- 组合键：Alt+/ 在活动编辑器触发 openDialog；有选区不触发；有修饰键冲突时按 preventDefault 策略处理。
- 双击空格：空行 300ms 内双击触发 autoComplete；删除第二空格；有文本的行不触发。
- 字符集：在行首输入“@”或“：”触发 openDialog；中文 IME 组合期间不触发，compositionend 完成后触发。
- TabCompletion：string/regex 在前文末尾匹配后延时触发；冷却生效；最小上下文长度门槛生效。

**迭代计划与切换策略**
- 迭代 1：统一触发器 Schema 与控制器骨架；UI 列表与键捕获；不改动旧逻辑。
- 迭代 2：将 quickAsk/smartSpace/tabCompletion 的触发入口切换到统一控制器；保持配置兼容。
- 迭代 3：扩展序列/长按/连击类型；完善冲突策略与消耗输入行为；增加团队预设与导入/导出。

