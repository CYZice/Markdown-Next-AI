var ve=Object.defineProperty;var je=Object.getOwnPropertyDescriptor;var qe=Object.getOwnPropertyNames;var Ge=Object.prototype.hasOwnProperty;var G=(g,e)=>()=>(g&&(e=g(g=0)),e);var Ae=(g,e)=>{for(var t in e)ve(g,t,{get:e[t],enumerable:!0})},Ke=(g,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of qe(e))!Ge.call(g,o)&&o!==t&&ve(g,o,{get:()=>e[o],enumerable:!(n=je(e,o))||n.enumerable});return g};var Ue=g=>Ke(ve({},"__esModule",{value:!0}),g);var pe,He=G(()=>{pe=class{constructor(){this.name="gemini";this.baseUrl="https://generativelanguage.googleapis.com/v1beta/models";this.model="text-embedding-004"}async getEmbedding(e,t){var n,o,s,r,a;try{let i=((n=t.embedModel)==null?void 0:n.apiKey)||((s=(o=t.providers)==null?void 0:o.gemini)==null?void 0:s.apiKey);if(!i)return console.error("[GeminiAdapter] Gemini API key not configured"),null;let c=((r=t.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,l=((a=t.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[GeminiAdapter] Getting embedding using model: ${l}`);let d=await fetch(`${c}/${l}:embedContent?key=${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:e}]}}),signal:AbortSignal.timeout(3e4)});if(!d.ok){let h=await d.text();return console.error(`[GeminiAdapter] Gemini API error: ${d.status} ${h}`),null}let p=await d.json();if(!p.embedding||!p.embedding.values)return console.error("[GeminiAdapter] Invalid embedding response"),null;let u=p.embedding.values;return console.log(`[GeminiAdapter] Generated embedding, dimension: ${u.length}`),u}catch(i){return console.error("[GeminiAdapter] Failed to generate embedding:",i),null}}async getEmbeddings(e,t){var n,o,s,r,a;try{let i=((n=t.embedModel)==null?void 0:n.apiKey)||((s=(o=t.providers)==null?void 0:o.gemini)==null?void 0:s.apiKey);if(!i)return console.error("[GeminiAdapter] Gemini API key not configured"),null;let c=((r=t.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,l=((a=t.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[GeminiAdapter] Getting embeddings for ${e.length} texts using model: ${l}`);let d=[];for(let p of e)try{let u=await fetch(`${c}/${l}:embedContent?key=${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:p}]}}),signal:AbortSignal.timeout(3e4)});if(u.ok){let h=await u.json();h.embedding&&h.embedding.values&&d.push(h.embedding.values)}else console.warn(`[GeminiAdapter] Failed to embed text: ${u.statusText}`),d.push([])}catch(u){console.warn("[GeminiAdapter] Error embedding single text:",u),d.push([])}return console.log(`[GeminiAdapter] Generated ${d.length} embeddings`),d}catch(i){return console.error("[GeminiAdapter] Failed to generate embeddings:",i),null}}getModelInfo(){return{adapter:this.name,baseUrl:this.baseUrl,model:this.model,description:"Google Gemini embedding service",models:["text-embedding-004"]}}}});var ue,Re=G(()=>{ue=class{constructor(){this.name="ollama";this.baseUrl="http://localhost:11434";this.model="nomic-embed-text"}async isOllamaAvailable(){try{return(await fetch(`${this.baseUrl}/api/tags`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok}catch(e){return console.error("[OllamaAdapter] Ollama service not available:",e),!1}}async getEmbedding(e,t){var n,o;try{let s=((n=t.embedModel)==null?void 0:n.baseUrl)||this.baseUrl,r=((o=t.embedModel)==null?void 0:o.modelKey)||this.model;if(!await this.isOllamaAvailable())return console.error("[OllamaAdapter] Ollama service is not running"),null;console.log(`[OllamaAdapter] Getting embedding for text using model: ${r}`);let a=await fetch(`${s}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,prompt:e}),signal:AbortSignal.timeout(3e4)});if(!a.ok)return console.error(`[OllamaAdapter] Failed to get embedding: ${a.statusText}`),null;let i=await a.json();return!i.embedding||!Array.isArray(i.embedding)?(console.error("[OllamaAdapter] Invalid embedding response"),null):(console.log(`[OllamaAdapter] Generated embedding, dimension: ${i.embedding.length}`),i.embedding)}catch(s){return console.error("[OllamaAdapter] Failed to generate embedding:",s),null}}async getEmbeddings(e,t){var n,o;try{let s=((n=t.embedModel)==null?void 0:n.baseUrl)||this.baseUrl,r=((o=t.embedModel)==null?void 0:o.modelKey)||this.model;if(!await this.isOllamaAvailable())return console.error("[OllamaAdapter] Ollama service is not running"),null;console.log(`[OllamaAdapter] Getting embeddings for ${e.length} texts using model: ${r}`);let a=[];for(let i of e)try{let c=await fetch(`${s}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,prompt:i}),signal:AbortSignal.timeout(3e4)});if(c.ok){let l=await c.json();l.embedding&&Array.isArray(l.embedding)&&a.push(l.embedding)}else console.warn(`[OllamaAdapter] Failed to embed text: ${c.statusText}`),a.push([])}catch(c){console.warn("[OllamaAdapter] Error embedding single text:",c),a.push([])}return console.log(`[OllamaAdapter] Generated ${a.length} embeddings`),a}catch(s){return console.error("[OllamaAdapter] Failed to generate embeddings:",s),null}}getModelInfo(){return{adapter:this.name,baseUrl:this.baseUrl,model:this.model,description:"Local Ollama service for embeddings"}}}});var he,Oe=G(()=>{he=class{constructor(){this.name="openai";this.baseUrl="https://api.openai.com/v1";this.model="text-embedding-3-small"}async getEmbedding(e,t){var n,o,s,r,a;try{let i=((n=t.embedModel)==null?void 0:n.apiKey)||((s=(o=t.providers)==null?void 0:o.openai)==null?void 0:s.apiKey);if(!i)return console.error("[OpenAIAdapter] OpenAI API key not configured"),null;let c=((r=t.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,l=((a=t.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[OpenAIAdapter] Getting embedding using model: ${l}`);let d=await fetch(`${c}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:l,input:e,encoding_format:"float"}),signal:AbortSignal.timeout(3e4)});if(!d.ok){let h=await d.text();return console.error(`[OpenAIAdapter] OpenAI API error: ${d.status} ${h}`),null}let p=await d.json();if(!p.data||!p.data[0]||!p.data[0].embedding)return console.error("[OpenAIAdapter] Invalid embedding response"),null;let u=p.data[0].embedding;return console.log(`[OpenAIAdapter] Generated embedding, dimension: ${u.length}`),u}catch(i){return console.error("[OpenAIAdapter] Failed to generate embedding:",i),null}}async getEmbeddings(e,t){var n,o,s,r,a;try{let i=((n=t.embedModel)==null?void 0:n.apiKey)||((s=(o=t.providers)==null?void 0:o.openai)==null?void 0:s.apiKey);if(!i)return console.error("[OpenAIAdapter] OpenAI API key not configured"),null;let c=((r=t.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,l=((a=t.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[OpenAIAdapter] Getting embeddings for ${e.length} texts using model: ${l}`);let d=await fetch(`${c}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:l,input:e,encoding_format:"float"}),signal:AbortSignal.timeout(6e4)});if(!d.ok){let h=await d.text();return console.error(`[OpenAIAdapter] OpenAI API error: ${d.status} ${h}`),null}let p=await d.json();if(!p.data||!Array.isArray(p.data))return console.error("[OpenAIAdapter] Invalid embeddings response"),null;let u=p.data.sort((h,w)=>h.index-w.index).map(h=>h.embedding);return console.log(`[OpenAIAdapter] Generated ${u.length} embeddings`),u}catch(i){return console.error("[OpenAIAdapter] Failed to generate embeddings:",i),null}}getModelInfo(){return{adapter:this.name,baseUrl:this.baseUrl,model:this.model,description:"OpenAI embedding service",models:["text-embedding-3-small","text-embedding-3-large"]}}}});var X,Fe=G(()=>{X=class{static async loadTransformers(){let e="transformers";if(this.loadedModules.has(e))return this.loadedModules.get(e);if(this.loadingPromises.has(e))return this.loadingPromises.get(e);let t=this._loadTransformersFromCDN();this.loadingPromises.set(e,t);try{let n=await t;return this.loadedModules.set(e,n),n}finally{this.loadingPromises.delete(e)}}static async _loadTransformersFromCDN(){try{console.log("[ExternalLoader] Loading transformers.js from CDN...");let e=await this._loadViaScript("https://cdn-allow-origin.huggingface.co/transformers.js@3/dist/transformers.min.js");return console.log("[ExternalLoader] Transformers.js loaded successfully"),e}catch(e){return console.error("[ExternalLoader] Failed to load transformers.js from CDN:",e),this._loadTransformersFromUnpkg()}}static async _loadTransformersFromUnpkg(){try{console.log("[ExternalLoader] Trying unpkg CDN as fallback...");let e=await this._loadViaScript("https://unpkg.com/@xenova/transformers@3/dist/transformers.min.js");return console.log("[ExternalLoader] Transformers.js loaded from unpkg"),e}catch(e){throw console.error("[ExternalLoader] Failed to load from unpkg:",e),new Error("Failed to load transformers.js from all CDN sources. Please check your internet connection.")}}static _loadViaScript(e){return new Promise((t,n)=>{let o=window.transformers;if(o){console.log("[ExternalLoader] Transformers already loaded in global scope"),t(o);return}let s=document.createElement("script");s.src=e,s.type="text/javascript",s.async=!0,s.onload=()=>{let r=window.transformers;r?(console.log(`[ExternalLoader] Successfully loaded from ${e}`),t(r)):n(new Error(`Transformers not found in global scope after loading ${e}`))},s.onerror=()=>{n(new Error(`Failed to load script from ${e}`))},s.setAttribute("crossorigin","anonymous"),document.head.appendChild(s)})}static async loadTransformersViaScript(){return this._loadViaScript("https://cdn-allow-origin.huggingface.co/transformers.js@3/dist/transformers.min.js")}static clearModuleCache(e){e?(this.loadedModules.delete(e),console.log(`[ExternalLoader] Module cache cleared for: ${e}`)):(this.loadedModules.clear(),console.log("[ExternalLoader] All module caches cleared"))}static getModuleStatus(e){return this.loadedModules.has(e)?"loaded":this.loadingPromises.has(e)?"loading":"not-loaded"}};X.loadedModules=new Map,X.loadingPromises=new Map});var K,me,$e=G(()=>{K=class K{constructor(){this.db=null;this.dbName="MardownNextAI-ModelCache";this.storeName="models";this.dbVersion=1;this.initPromise=null}static getInstance(){return K.instance||(K.instance=new K),K.instance}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((e,t)=>{try{let n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>{console.error("[ModelCache] Failed to open database"),t(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,console.log("[ModelCache] Database initialized"),e()},n.onupgradeneeded=o=>{let s=o.target.result;s.objectStoreNames.contains(this.storeName)||(s.createObjectStore(this.storeName,{keyPath:"key"}),console.log("[ModelCache] Object store created"))}}catch(n){console.error("[ModelCache] Error initializing database:",n),t(n)}}),this.initPromise)}async get(e){try{return await this.init(),this.db?new Promise((t,n)=>{let r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);r.onsuccess=()=>{let a=r.result;a?(console.log(`[ModelCache] Cache hit for key: ${e}`),t(a.data)):(console.log(`[ModelCache] Cache miss for key: ${e}`),t(null))},r.onerror=()=>{console.error("[ModelCache] Error reading from cache"),n(new Error("Failed to read from cache"))}}):null}catch(t){return console.error("[ModelCache] Error getting cache:",t),null}}async set(e,t,n){try{return await this.init(),this.db?new Promise((o,s)=>{let a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),i={key:e,data:t,timestamp:Date.now(),size:n},c=a.put(i);c.onsuccess=()=>{console.log(`[ModelCache] Cache saved for key: ${e}`),o(!0)},c.onerror=()=>{console.error("[ModelCache] Error writing to cache"),s(new Error("Failed to write to cache"))}}):!1}catch(o){return console.error("[ModelCache] Error setting cache:",o),!1}}async remove(e){try{return await this.init(),this.db?new Promise((t,n)=>{let r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);r.onsuccess=()=>{console.log(`[ModelCache] Cache removed for key: ${e}`),t(!0)},r.onerror=()=>{console.error("[ModelCache] Error deleting cache"),n(new Error("Failed to delete cache"))}}):!1}catch(t){return console.error("[ModelCache] Error removing cache:",t),!1}}async clear(){try{return await this.init(),this.db?new Promise((e,t)=>{let s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();s.onsuccess=()=>{console.log("[ModelCache] All caches cleared"),e(!0)},s.onerror=()=>{console.error("[ModelCache] Error clearing cache"),t(new Error("Failed to clear cache"))}}):!1}catch(e){return console.error("[ModelCache] Error clearing cache:",e),!1}}close(){this.db&&(this.db.close(),this.db=null,console.log("[ModelCache] Database closed"))}};K.instance=null;me=K});var U,ge,Be=G(()=>{Fe();$e();U=class U{constructor(){this.name="transformers";this.embedder=null;this.currentModelKey=null;this.isLoading=!1;this.loadingPromise=null;this.transformersLib=null;this.cacheManager=me.getInstance()}static getInstance(){return U.instance||(U.instance=new U),U.instance}async loadTransformersLib(){if(this.transformersLib)return this.transformersLib;try{console.log("[TransformersAdapter] Loading transformers.js from CDN..."),this.transformersLib=await X.loadTransformers();let{env:e}=this.transformersLib;return e&&(e.allowLocalModels=!1,e.allowRemoteModels=!0,e.cacheDir="transformers-cache",console.log("[TransformersAdapter] Environment configured with IndexedDB caching")),this.transformersLib}catch(e){throw console.error("[TransformersAdapter] Failed to load transformers library:",e),new Error("Failed to load Transformers.js from CDN. Please check your internet connection.")}}async loadModel(e){if(!(this.embedder&&this.currentModelKey===e)){if(this.isLoading&&this.currentModelKey===e&&this.loadingPromise){await this.loadingPromise;return}this.isLoading=!0,this.currentModelKey=e,this.loadingPromise=(async()=>{try{console.log(`[TransformersAdapter] Loading model: ${e}...`);let t=await this.loadTransformersLib(),{pipeline:n}=t;this.embedder=await n("feature-extraction",e,{quantized:!0,device:"gpu"}),console.log(`[TransformersAdapter] Model loaded successfully: ${e}`)}catch(t){throw console.error(`[TransformersAdapter] Failed to load model ${e}:`,t),this.embedder=null,this.currentModelKey=null,t}finally{this.isLoading=!1,this.loadingPromise=null}})(),await this.loadingPromise}}async getEmbedding(e,t){var n;try{let o=((n=t.embedModel)==null?void 0:n.modelKey)||"TaylorAI/bge-micro-v2";if(await this.loadModel(o),!this.embedder)return console.error("[TransformersAdapter] Embedder not initialized"),null;let s=await this.embedder(e,{pooling:"mean",normalize:!0}),r=Array.from(s.data);return r.length===0?(console.warn("[TransformersAdapter] Empty embedding generated"),null):(console.log(`[TransformersAdapter] Generated embedding, dimension: ${r.length}`),r)}catch(o){return console.error("[TransformersAdapter] Failed to generate embedding:",o),null}}async getEmbeddings(e,t){var n;try{let o=((n=t.embedModel)==null?void 0:n.modelKey)||"TaylorAI/bge-micro-v2";if(await this.loadModel(o),!this.embedder)return console.error("[TransformersAdapter] Embedder not initialized"),null;console.log(`[TransformersAdapter] Generating embeddings for ${e.length} texts...`);let s=[];for(let r of e){let a=await this.embedder(r,{pooling:"mean",normalize:!0});s.push(Array.from(a.data))}return console.log(`[TransformersAdapter] Generated ${s.length} embeddings`),s}catch(o){return console.error("[TransformersAdapter] Failed to generate embeddings:",o),null}}async unload(){this.embedder&&(console.log(`[TransformersAdapter] Unloading model: ${this.currentModelKey}`),this.embedder=null,this.currentModelKey=null),this.transformersLib=null}getModelInfo(){return{adapter:this.name,modelKey:this.currentModelKey,isLoading:this.isLoading,hasEmbedder:!!this.embedder}}};U.instance=null;ge=U});var oe={};Ae(oe,{GeminiEmbeddingAdapter:()=>pe,OllamaEmbeddingAdapter:()=>ue,OpenAIEmbeddingAdapter:()=>he,TransformersEmbeddingAdapter:()=>ge});var se=G(()=>{He();Re();Oe();Be()});var Ze={};Ae(Ze,{default:()=>we});module.exports=Ue(Ze);var R=require("obsidian");var O={THINKING:"thinking",VISION:"vision",MULTIMODAL:"multimodal",TEXT:"text",IMAGE:"image"},Pe={edit:"\u4F60\u662F\u4E00\u4E2A\u7CBE\u786E\u7684\u6587\u672C\u7F16\u8F91\u52A9\u624B\u3002\u4EC5\u4FEE\u6539\u7528\u6237\u9009\u4E2D\u7684\u6587\u672C\uFF0C\u4FDD\u6301\u539F\u6709\u98CE\u683C\u3001\u8BED\u6C14\u548C\u7ED3\u6784\uFF0C\u4E0D\u8981\u6539\u52A8\u672A\u9009\u5185\u5BB9\uFF1B\u5982\u9700\u4F18\u5316\u903B\u8F91\u4E0E\u8868\u8FBE\uFF0C\u7B80\u6D01\u5B8C\u6210\u3002",chat:"\u4F60\u662F\u4E00\u4E2A\u5BF9\u8BDD\u548C\u95EE\u7B54\u52A9\u624B\u3002\u76F4\u63A5\u56DE\u7B54\u7528\u6237\u95EE\u9898\u6216\u534F\u52A9\u751F\u6210\u5185\u5BB9\uFF1B\u82E5\u63D0\u4F9B\u53C2\u8003\u6587\u6863\uFF0C\u5FC5\u987B\u4EE5\u6587\u6863\u4E3A\u51C6\uFF0C\u907F\u514D\u81C6\u9020\u3002",insert:"\u4F60\u662F\u4E00\u4E2A\u7EED\u5199/\u63D2\u5165\u52A9\u624B\u3002\u6839\u636E\u5149\u6807\u4E0A\u4E0B\u6587\u751F\u6210\u53EF\u76F4\u63A5\u63D2\u5165\u7684\u65B0\u5185\u5BB9\uFF0C\u4FDD\u6301\u8FDE\u8D2F\u4E0E\u98CE\u683C\u4E00\u81F4\uFF0C\u4E0D\u590D\u8FF0\u5DF2\u6709\u4E0A\u4E0B\u6587\u3002",continue:"\u4F60\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u5199\u4F5C\u52A9\u624B\u3002\u8BF7\u6839\u636E\u7528\u6237\u63D0\u4F9B\u7684\u4E0A\u4E0B\u6587\uFF0C\u4ECE\u5149\u6807\u4F4D\u7F6E\u5F00\u59CB\u7EED\u5199\u540E\u7EED\u5185\u5BB9\u3002\u91CD\u8981\uFF1A\u53EA\u751F\u6210\u65B0\u7684\u5185\u5BB9\uFF0C\u4E0D\u8981\u91CD\u590D\u6216\u91CD\u5199\u5DF2\u6709\u7684\u5185\u5BB9\u3002"},ye={IMAGE:["png","jpg","jpeg","gif","bmp","svg","webp"],DOCUMENT:["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"]},Ee={MAX_FILE_SIZE:10485760,ALLOWED_TYPES:["image/jpeg","image/png","image/gif","image/webp"]};var D={providers:{openai:{apiKey:"",baseUrl:"https://api.openai.com/v1",enabled:!0}},models:{"gemini-3-pro-preview":{id:"gemini-3-pro-preview",name:"Gemini 3 Pro Preview",provider:"openai",model:"gemini-3-pro-preview",enabled:!0,category:O.MULTIMODAL},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",name:"Gemini 3 Flash Preview",provider:"openai",model:"gemini-3-flash-preview",enabled:!0,category:O.MULTIMODAL},"gpt-5":{id:"gpt-5",name:"GPT-5",provider:"openai",model:"gpt-5",enabled:!0,category:O.MULTIMODAL}},currentModel:"gemini-3-flash-preview",timeout:3e4,enableRightClick:!0,enableAtTrigger:!0,maxTokens:5e3,maxContextLines:20,maxContextChars:3e3,globalRules:[],ruleTemplates:[],enableGlobalRules:!0,commonPrompts:[{id:"expand",name:"\u6269\u5C55\u5185\u5BB9",content:"\u8BF7\u6269\u5C55\u8FD9\u6BB5\u5185\u5BB9\uFF0C\u589E\u52A0\u66F4\u591A\u7EC6\u8282\u548C\u4F8B\u5B50"},{id:"summarize",name:"\u603B\u7ED3\u6982\u62EC",content:"\u8BF7\u603B\u7ED3\u8FD9\u6BB5\u5185\u5BB9\u7684\u8981\u70B9"},{id:"improve",name:"\u6539\u8FDB\u6587\u672C",content:"\u8BF7\u6539\u8FDB\u8FD9\u6BB5\u6587\u672C\u7684\u8868\u8FBE\u548C\u903B\u8F91"},{id:"translate",name:"\u7FFB\u8BD1",content:"\u8BF7\u5C06\u8FD9\u6BB5\u5185\u5BB9\u7FFB\u8BD1\u6210\u82F1\u6587"},{id:"continue",name:"\u7EE7\u7EED\u5199\u4F5C",content:"\u8BF7\u6839\u636E\u4E0A\u4E0B\u6587\u7EE7\u7EED\u5199\u4F5C\uFF0C\u4FDD\u6301\u98CE\u683C\u4E00\u81F4"}],enableKnowledgeSearch:!1,knowledgeTopK:5,knowledgeMinScore:.2,conversationHistory:[],conversationHistoryLimit:50,enableGlobalDialog:!1,useFloatingPreview:!1,lastInsertAction:"insert",enableAutoRoutingByLLM:!0,minConfidenceForAuto:.6,fallbackMode:"chat"};var z=require("obsidian");var ee=class{constructor(e,t){this.requestQueue=[];this.isProcessing=!1;this.settings=e,this.app=t}updateSettings(e){this.settings=e}getCurrentModelConfig(){if(this.settings.apiKey&&this.settings.baseUrl&&this.settings.model)return{apiKey:this.settings.apiKey,baseUrl:this.settings.baseUrl,model:this.settings.model};let e=this.settings.currentModel;if(!e)throw new Error("\u672A\u9009\u62E9\u5F53\u524D\u6A21\u578B");let t=this.settings.models[e];if(!t||!t.enabled)throw new Error(`\u6A21\u578B ${e} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);let n=this.settings.providers[t.provider];if(!n||!n.enabled)throw new Error(`\u4F9B\u5E94\u5546 ${t.provider} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);return{apiKey:n.apiKey,baseUrl:n.baseUrl,model:t.actualModel||t.model||t.id}}isVisionModel(e){let t=this.settings.currentModel,n=this.settings.models[t];if(!n)return!1;let o=n.category;return!o&&n.type&&(o=n.type==="image"?O.IMAGE:O.TEXT),o===O.VISION}isThinkingModel(e=null){let t=this.settings.currentModel,n=this.settings.models[t];if(!n)return!1;let o=n.category;return!o&&n.type&&(o=n.type==="image"?O.IMAGE:O.TEXT),o===O.THINKING}normalizeBaseUrl(e){return e?e.replace(/\/$/,""):""}buildApiUrl(e){let t=this.getCurrentModelConfig(),n=this.normalizeBaseUrl(t.baseUrl),o=n.includes("api.openai.com");return n.endsWith("/v1")?`${n}${e}`:!o&&(n.includes("/chat/completions")||n.includes("/images/generations"))?`${n.split("/chat/completions")[0].split("/images/generations")[0]}${e}`:`${n}/v1${e}`}getMaxTokens(e){return this.settings.maxTokens||D.maxTokens}async sendRequest(e,t,n="",o=[],s=[],r=null){let a=this.getCurrentModelConfig();if(!a.apiKey)throw new Error("\u8BF7\u5148\u914D\u7F6EAPI Key");let i=this.settings.currentModel,c=this.settings.models[i],l=c==null?void 0:c.category;if(!l&&c&&(c.type==="image"?l=O.IMAGE:l=O.TEXT,c.category=l),l===O.IMAGE){if(e==="continue"&&t.selectedText&&t.selectedText.trim())throw new Error("\u4E0D\u652F\u6301\u56FE\u7247\u751F\u6210\u6A21\u578B\uFF0C\u8BF7\u9009\u62E9\u6587\u672C\u751F\u6210\u6A21\u578B\u8FDB\u884C\u6587\u672C\u4FEE\u6539\u3002");return this.handleImageGeneration(n,a,t.cursorPosition)}let d=l===O.THINKING||this.isThinkingModel(a.model),p=r&&typeof r=="function",u=l===O.MULTIMODAL,h=l===O.VISION||this.isVisionModel(a.model);o&&o.length>0&&!(u||h)&&(new z.Notice(`\u5F53\u524D\u6A21\u578B ${a.model} \u4E0D\u652F\u6301\u56FE\u7247\u548C\u9644\u4EF6\uFF0C\u8BF7\u5207\u6362\u5230\u591A\u6A21\u6001\u6A21\u578B\u6216\u89C6\u89C9\u6A21\u578B`),o=[]);let w=Pe[e]||"";if(this.settings.enableGlobalRules&&this.settings.globalRules&&this.settings.globalRules.length>0){let H=this.settings.globalRules.filter(A=>A.enabled!==!1).sort((A,T)=>(T.priority||0)-(A.priority||0));if(H.length>0){let A=H.map(T=>T.content).join(`
`);w+=`

\u5168\u5C40\u89C4\u5219\uFF08\u8BF7\u4E25\u683C\u9075\u5FAA\u4EE5\u4E0B\u89C4\u5219\uFF09\uFF1A
`+A}}let v=!!(t.selectedText&&t.selectedText.trim()),y=!!(n&&n.trim()),f=t.beforeText||"",b=t.afterText||"",M=t.selectedText||"",I="";switch(e){case"edit":v?(I=`\u5F85\u4FEE\u6539\u5185\u5BB9\uFF1A${M}

\u4E0A\u4E0B\u6587\uFF08\u524D\uFF09\uFF1A${f}

\u4E0A\u4E0B\u6587\uFF08\u540E\uFF09\uFF1A${b}`,y&&(I+=`

\u4FEE\u6539\u8981\u6C42\uFF1A${n}`)):I=y?`\u7528\u6237\u6307\u4EE4\uFF1A${n}

\u4E0A\u4E0B\u6587\uFF08\u524D\uFF09\uFF1A${f}

\u4E0A\u4E0B\u6587\uFF08\u540E\uFF09\uFF1A${b}`:`\u4E0A\u4E0B\u6587\uFF08\u524D\uFF09\uFF1A${f}

\u4E0A\u4E0B\u6587\uFF08\u540E\uFF09\uFF1A${b}

\u8BF7\u57FA\u4E8E\u4E0A\u4E0B\u6587\u5B8C\u6210\u4FEE\u6539\u6216\u56DE\u7B54\u3002`;break;case"insert":case"continue":I=`\u5149\u6807\u524D\u7684\u5185\u5BB9\uFF1A${f}

\u5149\u6807\u540E\u7684\u5185\u5BB9\uFF1A${b}`,v&&(I+=`

\u53C2\u8003\u9009\u4E2D\u6587\u672C\uFF1A${M}`),I+=`

\u8BF7\u5728\u5149\u6807\u5904\u63D2\u5165\u6216\u7EED\u5199\u65B0\u5185\u5BB9\uFF0C\u4FDD\u6301\u4E0A\u4E0B\u6587\u8FDE\u8D2F\u3002`,y&&(I+=`

\u751F\u6210\u8981\u6C42\uFF1A${n}`);break;case"chat":default:I=y?`\u7528\u6237\u95EE\u9898\u6216\u6307\u4EE4\uFF1A${n}`:"\u8BF7\u6839\u636E\u4E0B\u8FF0\u4FE1\u606F\u8FDB\u884C\u56DE\u7B54\u3002",(v||f.trim()||b.trim())&&(I+=`

\u53EF\u53C2\u8003\u7684\u4E0A\u4E0B\u6587\uFF1A
- \u5149\u6807\u524D\uFF1A${f}
- \u9009\u4E2D\u6587\u672C\uFF1A${M}
- \u5149\u6807\u540E\uFF1A${b}`);break}t.additionalContext&&t.additionalContext.trim()&&(I+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${t.additionalContext}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`),t.contextContent&&t.contextContent.trim()&&(I+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${t.contextContent}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`);let $=this.buildApiUrl("/chat/completions"),P=[{role:"system",content:w}];if(s&&s.length>0&&s.forEach(H=>{(H.role==="user"||H.role==="assistant")&&P.push({role:H.role,content:H.content})}),o&&o.length>0){I+=`

\u9644\u52A0\u56FE\u7247\uFF1A\u5171${o.length}\u5F20\u56FE\u7247`;let H=[{type:"text",text:I}];o.forEach(A=>{H.push({type:"image_url",image_url:{url:A.base64||A.url}})}),P.push({role:"user",content:H})}else P.push({role:"user",content:I});let B={model:a.model,messages:P,temperature:.7,max_tokens:this.getMaxTokens(e)};p&&(B.stream=!0);try{let H={"Content-Type":"application/json",Authorization:`Bearer ${a.apiKey}`};if(p)return await this.handleStreamRequest($,H,B,r);let A=await(0,z.requestUrl)({url:$,method:"POST",headers:H,body:JSON.stringify(B),throw:!1});if(A.status!==200){let x=A.text;throw A.status===429?x.includes("quota")||x.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${A.status} ${x}`)}let T=A.json;if(!T.choices||T.choices.length===0)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11choices\u6570\u7EC4");let L=T.choices[0];if(!L.message)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11message\u5BF9\u8C61");let E="";if(L.message.content)E=L.message.content.trim();else if(L.text)E=L.text.trim();else if(L.message.text)E=L.message.text.trim();else throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u627E\u4E0D\u5230\u5185\u5BB9\u5B57\u6BB5");let S=T.usage||{};return{content:E,usage:S}}catch(H){throw H}}async handleStreamRequest(e,t,n,o){var s,r;try{let a=await fetch(e,{method:"POST",headers:t,body:JSON.stringify(n)});if(!a.ok){let h=await a.text();throw a.status===429?h.includes("quota")||h.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${a.status} ${h}`)}let i=a.body.getReader(),c=new TextDecoder,l="",d="",p="",u="";try{for(;;){let{done:h,value:w}=await i.read();if(h)break;l+=c.decode(w,{stream:!0});let v=l.split(`
`);l=v.pop()||"";for(let y of v)if(y.startsWith("data: ")){let f=y.slice(6);if(f==="[DONE]")break;try{let M=(r=(s=JSON.parse(f).choices)==null?void 0:s[0])==null?void 0:r.delta;if(M!=null&&M.reasoning_content){let I=M.reasoning_content;d+=I,u+=I,o({content:p,thinking:d,fullContent:u,isComplete:!1})}if(M!=null&&M.content){let I=M.content;p+=I,u+=I,o({content:p,thinking:d,fullContent:u,isComplete:!1})}if(M!=null&&M.text){let I=M.text;p+=I,u+=I,o({content:p,thinking:d,fullContent:u,isComplete:!1})}}catch(b){}}}return o({content:p,thinking:d,fullContent:u,isComplete:!0}),{content:p.trim(),thinking:d.trim(),usage:{}}}finally{i.releaseLock()}}catch(a){throw a}}async handleImageGeneration(e,t,n=null){if(!e||!e.trim())throw new Error("\u8BF7\u8F93\u5165\u56FE\u7247\u63CF\u8FF0");let o=this.buildApiUrl("/images/generations"),s=t.model,r={model:s,prompt:e.trim(),response_format:"b64_json",n:1,size:this.settings.imageGenerationSize||"1024x1024"};s.includes("dall-e")&&s==="dall-e-3"&&(r.quality="standard",r.style="vivid");try{let a=await(0,z.requestUrl)({url:o,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify(r),throw:!1});if(a.status!==200){let d=a.text;throw a.status===429?d.includes("quota")||d.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):a.status===401?new Error("API\u5BC6\u94A5\u65E0\u6548\uFF0C\u8BF7\u68C0\u67E5\u914D\u7F6E\u3002"):new Error(`\u56FE\u7247\u751F\u6210API\u8BF7\u6C42\u5931\u8D25: ${a.status} ${d}`)}let i=a.json;if(!i.data||!Array.isArray(i.data)||i.data.length===0)throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let c=i.data[0],l=null;if(c.b64_json)l=c.b64_json;else throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u4E2D\u7F3A\u5C11\u56FE\u7247\u5185\u5BB9");try{let d=`image_${Date.now()}.png`,p=this.settings.imageSavePath||"Extras/\u9644\u4EF6",u=p+"/"+d;try{this.app.vault.getAbstractFileByPath(p)||await this.app.vault.createFolder(p)}catch(b){try{await this.app.vault.adapter.mkdir(p)}catch(M){throw new Error(`\u65E0\u6CD5\u521B\u5EFA\u76EE\u5F55 ${p}: ${M.message}`)}}let h=atob(l||""),w=new Uint8Array(h.length);for(let b=0;b<h.length;b++)w[b]=h.charCodeAt(b);await this.app.vault.createBinary(u,w.buffer);let v=this.settings.imageSize||300,y=!0;n&&n.ch>0&&(y=!1);let f;return y?f=`![Generated Image|${v}](${u})`:f=`<span class="image-mask-rounded-R" style="width: 200px; height: 200px;"><img src="${u}" alt="" style="width: 100%; height: 100%; object-fit: cover;"></span>`,{content:f,imageData:{filePath:u,format:"png",prompt:e},usage:i.usage||{}}}catch(d){throw new Error("\u56FE\u7247\u4FDD\u5B58\u5931\u8D25: "+d.message)}}catch(a){throw a}}getAvailableImageModels(){let e=[];for(let[t,n]of Object.entries(this.settings.models))n.type==="image"&&n.enabled&&e.push(n.name||t);return e}async testConnection(){try{let e=this.getCurrentModelConfig(),t=this.buildApiUrl("/chat/completions"),n=await(0,z.requestUrl)({url:t,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:"hi"}],max_tokens:5})});return n.status===200?{success:!0}:{success:!1,message:`HTTP ${n.status}: ${n.text}`}}catch(e){return{success:!1,message:e.message}}}};var de=require("obsidian");var te=class{constructor(){this.images=[];this.maxFileSize=Ee.MAX_FILE_SIZE;this.allowedTypes=Ee.ALLOWED_TYPES}handlePaste(e,t){var o;let n=(o=e.clipboardData)==null?void 0:o.items;if(n)for(let s=0;s<n.length;s++){let r=n[s];if(r.type.indexOf("image")!==-1){e.preventDefault();let a=r.getAsFile();a&&this.processImageFile(a,t);break}}}handleFileSelect(e,t){for(let n of Array.from(e))this.allowedTypes.includes(n.type)?this.processImageFile(n,t):new de.Notice("\u4E0D\u652F\u6301\u7684\u6587\u4EF6\u7C7B\u578B: "+n.type)}processImageFile(e,t){if(e.size>this.maxFileSize){new de.Notice("\u56FE\u7247\u6587\u4EF6\u8FC7\u5927\uFF0C\u8BF7\u9009\u62E9\u5C0F\u4E8E10MB\u7684\u56FE\u7247");return}let n=new FileReader;n.onload=o=>{var a;let s=(a=o.target)==null?void 0:a.result,r={id:String(Date.now()+Math.random()),name:e.name,size:e.size,type:e.type,base64:s,url:s};this.images.push(r),t&&t(r)},n.onerror=()=>{new de.Notice("\u8BFB\u53D6\u56FE\u7247\u5931\u8D25")},n.readAsDataURL(e)}removeImage(e,t){this.images=this.images.filter(n=>n.id!==e),t&&t(e)}getImages(){return this.images}addImage(e){this.images.push(e)}clearImages(){this.images=[]}createImagePreview(e,t){let n=document.createElement("div");n.className="markdown-next-ai-image-preview",n.setAttribute("data-image-id",String(e.id)),n.innerHTML=`
            <div class="markdown-next-ai-image-container">
                <img src="${e.url}" alt="${e.name}" class="markdown-next-ai-preview-img">
                <button class="markdown-next-ai-remove-image" title="\u5220\u9664\u56FE\u7247">\u2715</button>
            </div>
            <div class="markdown-next-ai-image-info">
                <span class="markdown-next-ai-image-name">${e.name}</span>
                <span class="markdown-next-ai-image-size">${this.formatFileSize(e.size)}</span>
            </div>
        `;let o=n.querySelector(".markdown-next-ai-remove-image");return o.onclick=s=>{s.stopPropagation(),this.removeImage(String(e.id),()=>{t&&t()}),n.remove()},n}formatFileSize(e){if(e===0)return"0 Bytes";let t=1024,n=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,o)).toFixed(2))+" "+n[o]}};var Ie=require("obsidian"),Ve=.6,We="chat";function xe(g){return(g||"").length}function _e(){return['\u4F60\u662F\u4E00\u4E2A"\u751F\u6210\u6A21\u5F0F\u8DEF\u7531\u5206\u7C7B\u5668"\u3002',"\u4EFB\u52A1\uFF1A\u6839\u636E\u7528\u6237\u6307\u4EE4\u4E0E\u63D0\u4F9B\u7684\u6750\u6599\uFF0C\u5224\u5B9A\u6700\u5408\u9002\u7684\u751F\u6210\u6A21\u5F0F\uFF08edit|chat|insert\uFF09\u3002","\u8F93\u51FA\u8981\u6C42\uFF1A\u4EC5\u8F93\u51FA\u4E25\u683C\u7684JSON\uFF0C\u5305\u542B\u5B57\u6BB5\uFF1Amode\uFF08\u679A\u4E3E\uFF09\u3001confidence\uFF080~1\uFF09\u3001reason\uFF08\u4E00\u53E5\u8BDD\u89E3\u91CA\uFF09\u3002","\u4E0D\u8981\u8F93\u51FA\u4EFB\u4F55\u975EJSON\u5185\u5BB9\u3002","\u5224\u5B9A\u63D0\u793A\uFF1A\u6709\u9009\u533A+\u6539\u5199\u7C7B\u9700\u6C42\u2192edit\uFF1B\u63D2\u5165\u6216\u7EED\u5199\u7C7B\u9700\u6C42\u2192insert\uFF1B\u95EE\u7B54\u6216\u521B\u4F5C\u2192chat\uFF1B\u65E0\u660E\u663E\u4FE1\u53F7\u2192chat\u3002"].join(`
`)}function ze(g){let e=!!(g.selectionText&&g.selectionText.trim()),t=!!(g.useCursor&&((g.cursorBefore||"").trim()||(g.cursorAfter||"").trim())),n=!!((g.additionalContext||"").trim()||(g.contextContent||"").trim()),o=xe(g.selectionText),s=xe(g.cursorBefore),r=xe(g.cursorAfter),a=n?1:0;return[`\u7528\u6237\u6307\u4EE4\uFF1A${g.prompt}`,`\u9009\u4E2D\u6587\u672C\uFF1A${e?"\u6709":"\u65E0"} length=${o}`,"\u5149\u6807\u4E0A\u4E0B\u6587\uFF08\u5982\u5141\u8BB8\uFF09\uFF1A",`  - hasCursorContext=${t} beforeLen=${s} afterLen=${r}`,`\u53C2\u8003\u6587\u6863\uFF1AhasReferences=${n} count=${a}`,"\u8DEF\u7531\u72B6\u6001\uFF08\u7531\u670D\u52A1\u81EA\u52A8\u8BA1\u7B97\uFF09\uFF1A",`  - cursorPosition=${g.cursorPosition?`${g.cursorPosition.line}:${g.cursorPosition.ch}`:"null"}`,'\u8BF7\u4EC5\u8F93\u51FAJSON\uFF1A{"mode":"chat","confidence":0.72,"reason":"..."}'].join(`
`)}function Xe(g){try{return JSON.parse(g)}catch(e){let t=g.match(/\{[\s\S]*\}/);if(t)return JSON.parse(t[0])}return null}function Ye(g){if(!g||typeof g!="object")return null;let e=g.mode,t=Number(g.confidence),n=String(g.reason||"");return!e||!["edit","chat","insert"].includes(e)||Number.isNaN(t)?null:{mode:e,confidence:t,reason:n||"",raw:JSON.stringify(g)}}function Je(g,e,t){return g.confidence>=e?g:{...g,mode:t,appliedFallback:!0,reason:`${g.reason||"\u4F4E\u7F6E\u4FE1\u5EA6"} -> fallback ${t}`}}async function be(g,e){var d,p,u,h,w,v;let t=e.aiService,n=(d=e.minConfidenceForAuto)!=null?d:Ve,o=(p=e.fallbackMode)!=null?p:We,s=_e(),r=ze(g),a=t.getCurrentModelConfig(),i=t.buildApiUrl("/chat/completions"),c={model:a.model,messages:[{role:"system",content:s},{role:"user",content:r}],temperature:0,max_tokens:200},l="";try{let y=await(0,Ie.requestUrl)({url:i,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a.apiKey}`},body:JSON.stringify(c),throw:!1});if(y.status!==200)throw new Error(`HTTP ${y.status}: ${y.text}`);let f=y.json,b=(u=f==null?void 0:f.choices)==null?void 0:u[0];if(l=((w=(h=b==null?void 0:b.message)==null?void 0:h.content)==null?void 0:w.trim())||((v=b==null?void 0:b.text)==null?void 0:v.trim())||"",!l)throw new Error("\u7A7A\u54CD\u5E94\u6216\u7F3A\u5C11\u5185\u5BB9");let M=Ye(Xe(l));if(!M)throw new Error("\u65E0\u6CD5\u89E3\u6790\u8DEF\u7531JSON");return Je(M,n,o)}catch(y){return{mode:o,confidence:0,reason:`routing failed: ${(y==null?void 0:y.message)||y}`,raw:l,appliedFallback:!0}}}var ne=class{constructor(e){this.plugin=e}getRules(){return this.plugin.settings.globalRules||[]}getActiveRules(){return this.getRules().filter(e=>e.enabled!==!1)}async addRule(e){let t={id:this.generateRuleId(),name:e.name||"\u65B0\u89C4\u5219",content:e.content||"",description:e.description||"",category:e.category||"custom",priority:e.priority||0,enabled:e.enabled!==!1,createdAt:Date.now(),updatedAt:Date.now()};return this.plugin.settings.globalRules||(this.plugin.settings.globalRules=[]),this.plugin.settings.globalRules.push(t),await this.plugin.saveSettings(),t}async updateRule(e,t){let n=this.getRules(),o=n.findIndex(s=>s.id===e);if(o===-1)throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728");return n[o]={...n[o],...t,updatedAt:Date.now()},await this.plugin.saveSettings(),n}async deleteRule(e){let t=this.getRules(),n=t.findIndex(o=>o.id===e);if(n===-1)throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728");t.splice(n,1),await this.plugin.saveSettings()}async toggleRule(e){let t=this.getRules().find(n=>n.id===e);if(t)return t.enabled=!t.enabled,t.updatedAt=Date.now(),await this.plugin.saveSettings(),t;throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728")}async createFromTemplate(e){let t=(this.plugin.settings.ruleTemplates||[]).find(n=>n.id===e);if(t)return this.addRule({name:t.name,content:t.content,description:t.description,category:t.category});throw new Error("\u6A21\u677F\u4E0D\u5B58\u5728")}getTemplates(){return this.plugin.settings.ruleTemplates||[]}getTemplatesByCategory(e){return this.getTemplates().filter(t=>t.category===e)}generateRuleId(){return"rule_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}exportRules(){return{version:"1.0",exportedAt:Date.now(),rules:this.getRules()}}async importRules(e){if(!e||!e.rules||!Array.isArray(e.rules))throw new Error("\u5BFC\u5165\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let t=0;for(let n of e.rules)try{await this.addRule(n),t++}catch(o){console.error("\u5BFC\u5165\u89C4\u5219\u5931\u8D25",o)}return t}};var N=class{constructor(e){this.scPlugin=null;this.app=e}getPlugin(){var t;if(this.scPlugin)return this.scPlugin;let e=(t=this.app.plugins)==null?void 0:t.plugins;return!e||!e["smart-connections"]?(console.warn("[SmartConnectionsAdapter] smart-connections plugin not found"),null):(this.scPlugin=e["smart-connections"],this.scPlugin)}isAvailable(){var t,n;let e=this.getPlugin();return!!((n=(t=e==null?void 0:e.env)==null?void 0:t.smart_sources)!=null&&n.lookup)}async ensureLoaded(){var t;let e=this.getPlugin();if(!e)return!1;if(!e.loaded)try{await((t=this.app.plugins)==null?void 0:t.loadPlugin("smart-connections"))}catch(n){return console.error("[SmartConnectionsAdapter] Failed to load plugin:",n),!1}return e.env?this.isAvailable():(console.warn("[SmartConnectionsAdapter] Plugin env not ready"),!1)}async lookup(e,t={}){if(!await this.ensureLoaded())return console.error("[SmartConnectionsAdapter] Plugin not available"),[];let n=this.getPlugin(),o={hypotheticals:[e],filter:{limit:t.limit||10}};t.excludeBlocks&&(o.skip_blocks=!0),t.includeFilter&&(o.filter.include_filter=t.includeFilter),t.excludeFilter&&(o.filter.exclude_filter=t.excludeFilter);try{let s=await n.env.smart_sources.lookup(o);return Array.isArray(s)?(console.log(`[SmartConnectionsAdapter] Found ${s.length} results for query: "${e}"`),s):(console.warn("[SmartConnectionsAdapter] Invalid results:",s),[])}catch(s){return console.error("[SmartConnectionsAdapter] Lookup failed:",s),[]}}async findSimilar(e,t=10){if(!await this.ensureLoaded())return[];let o=this.getPlugin().env.smart_sources.get(e);if(!o||!o.vec)return console.warn("[SmartConnectionsAdapter] Source not embedded:",e),[];try{return await o.find_connections({exclude_keys:[e],filter:{limit:t}})||[]}catch(s){return console.error("[SmartConnectionsAdapter] Find similar failed:",s),[]}}getPluginInfo(){var t;let e=this.getPlugin();return e?{available:this.isAvailable(),version:(t=e.manifest)==null?void 0:t.version}:{available:!1}}getEnv(){let e=this.getPlugin();return e==null?void 0:e.env}async getSettings(){var t,n;if(!await this.ensureLoaded())return null;let e=this.getPlugin();return(n=(t=e==null?void 0:e.env)==null?void 0:t.settings)!=null?n:null}async shouldExcludeBlocksFromSourceConnections(){var t,n;let e=await this.getSettings();return(n=(t=e==null?void 0:e.smart_view_filter)==null?void 0:t.exclude_blocks_from_source_connections)!=null?n:!1}async renderConnectionsResults(e,t={}){if(!await this.ensureLoaded())return null;let n=this.getEnv();if(!(n!=null&&n.render_component))return null;try{return await n.render_component("connections_results",e,t)}catch(o){return console.error("[SmartConnectionsAdapter] render_connections_results failed:",o),null}}};var q=class{static async getAdapter(e,t){let n=e;if(this.adapters.has(n))return this.adapters.get(n)||null;let o=null;switch(e){case"transformers":try{o=(await Promise.resolve().then(()=>(se(),oe))).TransformersEmbeddingAdapter.getInstance()}catch(s){return console.error("[EmbeddingFactory] Failed to load transformers adapter:",s),null}break;case"openai":try{let r=(await Promise.resolve().then(()=>(se(),oe))).OpenAIEmbeddingAdapter;o=new r}catch(s){return console.error("[EmbeddingFactory] Failed to load OpenAI adapter:",s),null}break;case"ollama":try{let r=(await Promise.resolve().then(()=>(se(),oe))).OllamaEmbeddingAdapter;o=new r}catch(s){return console.error("[EmbeddingFactory] Failed to load Ollama adapter:",s),null}break;case"gemini":try{let r=(await Promise.resolve().then(()=>(se(),oe))).GeminiEmbeddingAdapter;o=new r}catch(s){return console.error("[EmbeddingFactory] Failed to load Gemini adapter:",s),null}break;default:return console.warn(`[EmbeddingFactory] Unknown adapter type: ${e}`),null}return o&&this.adapters.set(n,o),o}static async unloadAdapter(e){let t=this.adapters.get(e);t&&t.unload&&(await t.unload(),this.adapters.delete(e))}static async unloadAll(){for(let[e,t]of this.adapters)if(t.unload)try{await t.unload()}catch(n){console.error(`[EmbeddingFactory] Error unloading adapter ${e}:`,n)}this.adapters.clear()}};q.adapters=new Map;var j=class j{constructor(){this.currentAdapter=null;this.currentAdapterType=null}static getInstance(){return j.instance||(j.instance=new j),j.instance}async getAdapter(e){var n;let t=((n=e.embedModel)==null?void 0:n.adapter)||"transformers";return this.currentAdapter&&this.currentAdapterType===t?this.currentAdapter:(console.log(`[EmbeddingService] Switching to adapter: ${t}`),this.currentAdapter=await q.getAdapter(t,e),this.currentAdapterType=t,this.currentAdapter||console.error(`[EmbeddingService] Failed to get adapter: ${t}`),this.currentAdapter)}async getEmbedding(e,t){try{let n=await this.getAdapter(t);return n?await n.getEmbedding(e,t):(console.error("[EmbeddingService] No adapter available"),null)}catch(n){return console.error("[EmbeddingService] Error getting embedding:",n),null}}async getEmbeddings(e,t){try{let n=await this.getAdapter(t);return n?await n.getEmbeddings(e,t):(console.error("[EmbeddingService] No adapter available"),null)}catch(n){return console.error("[EmbeddingService] Error getting embeddings:",n),null}}getAdapterInfo(){var e,t;return this.currentAdapter?{type:this.currentAdapterType,info:((t=(e=this.currentAdapter).getModelInfo)==null?void 0:t.call(e))||{}}:null}async unload(){this.currentAdapter&&this.currentAdapterType&&(await q.unloadAdapter(this.currentAdapterType),this.currentAdapter=null,this.currentAdapterType=null)}static async cleanup(){await q.unloadAll(),j.instance&&(j.instance=null)}};j.instance=null;var ke=j;var m=require("obsidian");var fe=class extends m.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"MarkdownNext AI \u8BBE\u7F6E"}),e.createEl("h3",{text:"\u4F9B\u5E94\u5546\u3001API\u8BBE\u7F6E"}),e.createEl("p",{text:"APIKey\uFF1A\u9700\u5728\u4F9B\u5E94\u5546API\u5BC6\u94A5\u4E2D\u8BBE\u7F6EAPIKey",attr:{style:"color: var(--text-muted); margin-bottom: 5px;"}}),e.createEl("p",{text:"Base URL\uFF1A\u9009\u586B\u7B2C\u4E09\u65B9URL\uFF0C\u4F7F\u7528openai\u517C\u5BB9\u683C\u5F0F",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}});let t=e.createEl("table",{cls:"markdown-next-ai-config-table"}),n=t.createEl("thead").createEl("tr");n.createEl("th",{text:"ID"}),n.createEl("th",{text:"Type"}),n.createEl("th",{text:"API Key"}),n.createEl("th",{text:"Get API keys"}),n.createEl("th",{text:"Actions"});let o=t.createEl("tbody");Object.keys(this.plugin.settings.providers).forEach(l=>{let d=this.plugin.settings.providers[l],p=o.createEl("tr");p.createEl("td",{text:l}),p.createEl("td",{text:d.type||"openai"});let u=p.createEl("td",{cls:"markdown-next-ai-api-key-cell"});d.apiKey&&d.apiKey.trim()&&u.createEl("span",{text:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",attr:{style:"color: var(--text-muted); margin-right: 8px;"}});let h=u.createEl("button",{cls:"markdown-next-ai-settings-btn",attr:{title:"\u8BBE\u7F6EAPI Key"}});h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',h.onclick=()=>this.showApiKeyModal(l);let w=p.createEl("td",{attr:{style:"text-align: left;"}}),y={openai:"https://platform.openai.com/api-keys",anthropic:"https://console.anthropic.com/",gemini:"https://aistudio.google.com/app/apikey",ollama:"https://ollama.com/"}[l]||this.plugin.settings.apiKeyLinks&&this.plugin.settings.apiKeyLinks[l];y?w.createEl("a",{text:"\u83B7\u53D6API Key",attr:{href:y,target:"_blank",style:"color: var(--text-accent); text-decoration: underline; font-size: 0.9em;"}}):w.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});let f=p.createEl("td",{cls:"markdown-next-ai-actions-cell"});if(["openai","anthropic","gemini","deepseek","ollama"].includes(l))f.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});else{let b=f.createEl("button",{text:"\u7F16\u8F91"});b.onclick=()=>this.showEditProviderModal(l);let M=f.createEl("button",{text:"\u5220\u9664"});M.onclick=async()=>{confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4F9B\u5E94\u5546 "${l}" \uFF1F\u8FD9\u5C06\u540C\u65F6\u5220\u9664\u8BE5\u4F9B\u5E94\u5546\u4E0B\u7684\u6240\u6709\u6A21\u578B\u3002`)&&(Object.keys(this.plugin.settings.models).forEach(I=>{this.plugin.settings.models[I].provider===l&&delete this.plugin.settings.models[I]}),delete this.plugin.settings.providers[l],await this.plugin.saveSettings(),this.display())}}}),e.createEl("div",{attr:{style:"margin-top: 15px; margin-bottom: 20px;"}}).createEl("button",{text:"+ \u6DFB\u52A0\u4F9B\u5E94\u5546",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;"}}).onclick=()=>this.showAddProviderModal();let s=e.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px;"}});s.createEl("h3",{text:"\u6A21\u578B\u8BBE\u7F6E",attr:{style:"margin: 0;"}}),s.createEl("button",{text:"+ \u6DFB\u52A0\u6A21\u578B",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;"}}).onclick=()=>this.showAddModelModal();let r=e.createEl("table",{cls:"markdown-next-ai-config-table"}),a=r.createEl("thead").createEl("tr");a.createEl("th",{text:"ID"}),a.createEl("th",{text:"Provider"}),a.createEl("th",{text:"Model"}),a.createEl("th",{text:"Enable"}),a.createEl("th",{text:"Actions"});let i=r.createEl("tbody"),c=Object.values(this.plugin.settings.models);if(c.length>0?c.forEach(l=>{let d=i.createEl("tr");d.createEl("td",{text:l.id}),d.createEl("td",{text:l.provider}),d.createEl("td",{text:l.name});let u=d.createEl("td",{cls:"markdown-next-ai-enable-cell"}).createEl("input",{type:"checkbox"});u.checked=l.enabled,u.onchange=async()=>{if(this.plugin.settings.models[l.id].enabled=u.checked,await this.plugin.saveSettings(),!u.checked&&this.plugin.settings.currentModel===l.id){let y=Object.keys(this.plugin.settings.models).find(f=>this.plugin.settings.models[f].enabled);y&&(this.plugin.settings.currentModel=y,await this.plugin.saveSettings(),this.display())}};let h=d.createEl("td",{cls:"markdown-next-ai-actions-cell"}),w=h.createEl("button",{text:"\u7F16\u8F91"});w.onclick=()=>this.showEditModelModal(l.id);let v=h.createEl("button",{text:"\u5220\u9664"});v.onclick=async()=>{if(confirm(`\u786E\u5B9A\u8981\u5220\u9664\u6A21\u578B "${l.name}" \uFF1F`)){if(this.plugin.settings.currentModel===l.id){let y=Object.keys(this.plugin.settings.models).find(f=>f!==l.id&&this.plugin.settings.models[f].enabled);this.plugin.settings.currentModel=y||""}delete this.plugin.settings.models[l.id],await this.plugin.saveSettings(),this.display()}}}):i.createEl("tr").createEl("td",{text:"\u6682\u65E0\u6A21\u578B\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{colspan:"5",style:"text-align: center; color: var(--text-muted); font-style: italic; padding: 20px;"}}),new m.Setting(e).setName("\u5F53\u524D\u6A21\u578B").setDesc("\u9009\u62E9\u5F53\u524D\u4F7F\u7528\u7684AI\u6A21\u578B").addDropdown(l=>{let d=Object.keys(this.plugin.settings.models).filter(p=>this.plugin.settings.models[p].enabled);d.forEach(p=>{let u=this.plugin.settings.models[p];l.addOption(p,`${u.name} (${u.provider})`)}),!d.includes(this.plugin.settings.currentModel)&&d.length>0&&(this.plugin.settings.currentModel=d[0],this.plugin.saveSettings()),l.setValue(this.plugin.settings.currentModel||"").onChange(async p=>{this.plugin.settings.currentModel=p,await this.plugin.saveSettings()})}),new m.Setting(e).setName("\u6D4B\u8BD5API\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u5F53\u524DAPI\u914D\u7F6E\u662F\u5426\u6B63\u5E38").addButton(l=>l.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{l.setButtonText("\u6D4B\u8BD5\u4E2D...");try{let d=await this.plugin.aiService.testConnection();d.success?new m.Notice("\u2705 API\u8FDE\u63A5\u6210\u529F"):new m.Notice("\u274C API\u8FDE\u63A5\u5931\u8D25: "+d.message)}catch(d){new m.Notice("\u274C \u6D4B\u8BD5\u5931\u8D25: "+d.message)}finally{l.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5")}})),new m.Setting(e).setName("\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4").setDesc("API\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4\uFF08\u6BEB\u79D2\uFF09").addText(l=>l.setPlaceholder("30000").setValue(String(this.plugin.settings.timeout)).onChange(async d=>{let p=parseInt(d)||3e4;this.plugin.settings.timeout=p,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u529F\u80FD\u8BBE\u7F6E"}),new m.Setting(e).setName("\u542F\u7528\u53F3\u952E\u83DC\u5355").setDesc("\u5728\u9009\u4E2D\u6587\u672C\u65F6\u663E\u793AAI\u5904\u7406\u9009\u9879").addToggle(l=>l.setValue(this.plugin.settings.enableRightClick).onChange(async d=>{this.plugin.settings.enableRightClick=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new m.Setting(e).setName("\u542F\u7528@\u6216&\u7B26\u53F7\u89E6\u53D1").setDesc("\u8F93\u5165@\u6216&\u7B26\u53F7\u65F6\u547C\u51FA\u7EED\u5199\u5BF9\u8BDD\u6846").addToggle(l=>l.setValue(this.plugin.settings.enableAtTrigger).onChange(async d=>{this.plugin.settings.enableAtTrigger=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),e.createEl("h3",{text:"\u77E5\u8BC6\u5E93\u68C0\u7D22"}),e.createEl("p",{text:"\u4F7F\u7528 Smart Connections \u63D2\u4EF6\u8FDB\u884C\u8BED\u4E49\u68C0\u7D22\uFF08\u9700\u8981\u5B89\u88C5 smart-connections >= 3.0.80\uFF09",attr:{style:"color: var(--text-muted); margin-bottom: 10px;"}}),new m.Setting(e).setName("\u542F\u7528\u77E5\u8BC6\u5E93\u68C0\u7D22").setDesc("\u5728\u5BF9\u8BDD\u4E2D\u53EF\u68C0\u7D22\u5E76\u9009\u62E9\u53C2\u8003\u8D44\u6599\u6CE8\u5165\u4E0A\u4E0B\u6587").addToggle(l=>l.setValue(!!this.plugin.settings.enableKnowledgeSearch).onChange(async d=>{var p,u,h,w,v;if(d){let y=(u=(p=this.app.plugins)==null?void 0:p.plugins)==null?void 0:u["smart-connections"];if(!y){new m.Notice("\u274C \u672A\u68C0\u6D4B\u5230 Smart Connections \u63D2\u4EF6\uFF0C\u8BF7\u5148\u5B89\u88C5",5e3),l.setValue(!1);return}let f=(h=y.manifest)==null?void 0:h.version;if(f){let[b,M,I]=f.split(".").map(Number),$=[3,0,80];if(!(b>$[0]||b===$[0]&&M>$[1]||b===$[0]&&M===$[1]&&I>=$[2])){new m.Notice(`\u274C Smart Connections \u7248\u672C\u8FC7\u4F4E\uFF08\u5F53\u524D: ${f}\uFF0C\u9700\u8981: >= 3.0.80\uFF09`,5e3),l.setValue(!1);return}}if(!((v=(w=y.env)==null?void 0:w.smart_sources)!=null&&v.lookup)){new m.Notice("\u26A0\uFE0F Smart Connections \u672A\u5B8C\u5168\u52A0\u8F7D\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5",5e3),l.setValue(!1);return}new m.Notice("\u2705 Smart Connections \u68C0\u6D4B\u6210\u529F\uFF0C\u77E5\u8BC6\u5E93\u68C0\u7D22\u5DF2\u542F\u7528",3e3)}this.plugin.settings.enableKnowledgeSearch=d,await this.plugin.saveSettings()})),new m.Setting(e).setName("Top K \u7ED3\u679C\u6570\u91CF").setDesc("\u8BED\u4E49\u68C0\u7D22\u8FD4\u56DE\u7684\u53C2\u8003\u6761\u76EE\u6570\u91CF").addText(l=>{var d;return l.setPlaceholder("5").setValue(String((d=this.plugin.settings.knowledgeTopK)!=null?d:5)).onChange(async p=>{let u=parseInt(p)||5;this.plugin.settings.knowledgeTopK=u,await this.plugin.saveSettings()})}),new m.Setting(e).setName("\u6700\u4F4E\u76F8\u4F3C\u5EA6\u9608\u503C").setDesc("\u8FC7\u6EE4\u4F4E\u76F8\u5173\u7ED3\u679C (0.0 - 1.0)").addText(l=>{var d;return l.setPlaceholder("0.2").setValue(String((d=this.plugin.settings.knowledgeMinScore)!=null?d:.2)).onChange(async p=>{let u=parseFloat(p);this.plugin.settings.knowledgeMinScore=isNaN(u)?.2:u,await this.plugin.saveSettings()})}),e.createEl("div",{text:"\u{1F4A1} \u63D0\u793A: \u77E5\u8BC6\u5E93\u68C0\u7D22\u4F9D\u8D56 Smart Connections \u63D2\u4EF6\u751F\u6210\u7684\u5411\u91CF\u7D22\u5F15\uFF0C\u8BF7\u786E\u4FDD\u5DF2\u5728 SC \u4E2D\u5B8C\u6210\u7D22\u5F15\u751F\u6210",attr:{style:"color: var(--text-accent); font-size: 0.9em; margin: -10px 0 15px 0; padding: 10px; background: var(--background-secondary); border-radius: 5px;"}}),e.createEl("h3",{text:"\u5168\u5C40\u89C4\u5219\u8BBE\u7F6E"}),e.createEl("p",{text:"\u5168\u5C40\u89C4\u5219\u4F1A\u81EA\u52A8\u5E94\u7528\u5230\u6240\u6709AI\u8BF7\u6C42\u4E2D\uFF0C\u6BCF\u6B21\u5BF9\u8BDD\u90FD\u9700\u8981\u9075\u5FAA\u5168\u5C40\u89C4\u5219",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new m.Setting(e).setName("\u542F\u7528\u5168\u5C40\u89C4\u5219").setDesc("\u5F00\u542F\u540E\uFF0C\u5168\u5C40\u89C4\u5219\u5C06\u81EA\u52A8\u5E94\u7528\u5230\u6240\u6709AI\u8BF7\u6C42\u4E2D").addToggle(l=>l.setValue(this.plugin.settings.enableGlobalRules).onChange(async d=>{this.plugin.settings.enableGlobalRules=d,await this.plugin.saveSettings()})),new m.Setting(e).setName("\u7BA1\u7406\u5168\u5C40\u89C4\u5219").setDesc("\u6DFB\u52A0\u3001\u7F16\u8F91\u548C\u7BA1\u7406\u5168\u5C40\u89C4\u5219").addButton(l=>l.setButtonText("\u6253\u5F00\u89C4\u5219\u7BA1\u7406\u5668").onClick(()=>this.showRuleManager())),new m.Setting(e).setName("\u6700\u5927Token\u6570").setDesc("AI\u751F\u6210\u6587\u672C\u7684\u6700\u5927\u957F\u5EA6\u9650\u5236").addText(l=>l.setPlaceholder("5000").setValue(String(this.plugin.settings.maxTokens)).onChange(async d=>{let p=parseInt(d)||5e3;p>0?(this.plugin.settings.maxTokens=p,await this.plugin.saveSettings()):new m.Notice("Token\u6570\u5FC5\u987B\u4E3A\u6B63\u6574\u6570")})),e.createEl("h3",{text:"\u5168\u5C40\u5BF9\u8BDD\u6A21\u5F0F\uFF08Beta\uFF09"}),e.createEl("p",{text:"\u542F\u7528\u5168\u5C40\u5BF9\u8BDD\u6A21\u5F0F\u540E\uFF0C\u53EF\u4EE5\u5728\u975E\u7F16\u8F91\u5668\u4E0A\u4E0B\u6587\u6253\u5F00AI\u5BF9\u8BDD\u6846\uFF0C\u751F\u6210\u7684\u5185\u5BB9\u5148\u663E\u793A\u5728\u6D6E\u7A97\u786E\u8BA4\u540E\u518D\u5199\u5165\u7F16\u8F91\u5668",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new m.Setting(e).setName("\u542F\u7528\u5168\u5C40\u5BF9\u8BDD\u6846\u6A21\u5F0F").setDesc("\u5141\u8BB8\u5728\u975EMarkdown\u7F16\u8F91\u5668\u4E0A\u4E0B\u6587\u6253\u5F00\u5BF9\u8BDD\u6846\uFF08\u5FEB\u6377\u952E: Ctrl+Shift+M\uFF09").addToggle(l=>{var d;return l.setValue((d=this.plugin.settings.enableGlobalDialog)!=null?d:!1).onChange(async p=>{this.plugin.settings.enableGlobalDialog=p,await this.plugin.saveSettings()})}),new m.Setting(e).setName("\u4F7F\u7528\u6D6E\u7A97\u786E\u8BA4\u6A21\u5F0F").setDesc("AI\u751F\u6210\u7ED3\u679C\u5148\u663E\u793A\u5728\u6D6E\u7A97\u4E2D\uFF0C\u7528\u6237\u786E\u8BA4\u540E\u518D\u5199\u5165\u7F16\u8F91\u5668").addToggle(l=>{var d;return l.setValue((d=this.plugin.settings.useFloatingPreview)!=null?d:!1).onChange(async p=>{this.plugin.settings.useFloatingPreview=p,await this.plugin.saveSettings()})}),e.createEl("h3",{text:"\u81EA\u52A8\u8DEF\u7531\uFF08LLM \u5224\u5B9A\u6A21\u5F0F\uFF09"}),new m.Setting(e).setName("\u542F\u7528\u81EA\u52A8\u8DEF\u7531").setDesc("\u7531 LLM \u6839\u636E\u9009\u533A/\u5149\u6807/\u6307\u4EE4\u5224\u5B9A edit/chat/insert \u6A21\u5F0F").addToggle(l=>{var d;return l.setValue((d=this.plugin.settings.enableAutoRoutingByLLM)!=null?d:!0).onChange(async p=>{this.plugin.settings.enableAutoRoutingByLLM=p,await this.plugin.saveSettings()})}),new m.Setting(e).setName("\u81EA\u52A8\u6267\u884C\u7684\u6700\u4F4E\u7F6E\u4FE1\u5EA6").setDesc("\u4F4E\u4E8E\u6B64\u503C\u5C06\u56DE\u9000\u5230\u9ED8\u8BA4\u6A21\u5F0F\u6216\u63D0\u793A\u7528\u6237\uFF080~1\uFF0C\u9ED8\u8BA40.6\uFF09").addText(l=>{var d;return l.setPlaceholder("0.6").setValue(String((d=this.plugin.settings.minConfidenceForAuto)!=null?d:.6)).onChange(async p=>{let u=Number(p);!Number.isNaN(u)&&u>=0&&u<=1?(this.plugin.settings.minConfidenceForAuto=u,await this.plugin.saveSettings()):new m.Notice("\u8BF7\u8F93\u5165 0~1 \u4E4B\u95F4\u7684\u6570\u5B57")})}),new m.Setting(e).setName("\u8DEF\u7531\u5931\u8D25/\u4F4E\u7F6E\u4FE1\u5EA6\u56DE\u9000\u6A21\u5F0F").setDesc("\u8DEF\u7531\u5931\u8D25\u6216\u7F6E\u4FE1\u5EA6\u8FC7\u4F4E\u65F6\u4F7F\u7528\u7684\u6A21\u5F0F").addDropdown(l=>{l.addOption("chat","chat"),l.addOption("edit","edit"),l.addOption("insert","insert"),l.setValue(this.plugin.settings.fallbackMode||"chat"),l.onChange(async d=>{this.plugin.settings.fallbackMode=d,await this.plugin.saveSettings()})}),e.createEl("h3",{text:"\u5E38\u7528\u63D0\u793A\u8BCD\u7BA1\u7406"}),e.createEl("p",{text:"\u7BA1\u7406\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u53EF\u5728\u8F93\u5165\u6846\u4E2D\u4F7F\u7528#\u7B26\u53F7\u5FEB\u901F\u8C03\u7528",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new m.Setting(e).setName("\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u5E38\u7528\u63D0\u793A\u8BCD").addButton(l=>l.setButtonText("\u6DFB\u52A0\u63D0\u793A\u8BCD").onClick(()=>this.showPromptModal())),this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts.length>0){let l=e.createEl("div",{attr:{style:"margin-top: 15px;"}});this.plugin.settings.commonPrompts.forEach((d,p)=>{let u=l.createEl("div",{attr:{style:"display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary);"}}),h=u.createEl("div",{attr:{style:"flex: 1;"}});h.createEl("div",{text:d.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD",attr:{style:"font-weight: bold; margin-bottom: 4px;"}}),h.createEl("div",{text:d.content&&d.content.length>100?d.content.substring(0,100)+"...":d.content||"",attr:{style:"color: var(--text-muted); font-size: 0.7em;"}});let w=u.createEl("div",{attr:{style:"display: flex; gap: 8px;"}});w.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--background-modifier-border); background: var(--background-primary); color: var(--text-normal); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.showPromptModal(p),w.createEl("button",{text:"\u5220\u9664",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--text-error); background: var(--background-primary); color: var(--text-error); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.deletePrompt(p)})}else e.createEl("p",{text:"\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{style:"color: var(--text-muted); font-style: italic; margin-top: 15px;"}})}showPromptModal(e=null){let t=new m.Modal(this.app);t.titleEl.setText(e!==null?"\u7F16\u8F91\u63D0\u793A\u8BCD":"\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD");let{contentEl:n}=t,o=e!==null,s=o&&this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]?this.plugin.settings.commonPrompts[e]:null;n.createEl("label",{text:"\u63D0\u793A\u8BCD\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});o&&s&&(r.value=s.name),n.createEl("label",{text:"\u63D0\u793A\u8BCD\u5185\u5BB9:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9",attr:{style:"width: 100%; height: 120px; padding: 8px; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px; resize: vertical; font-family: var(--font-text);"}});o&&s&&(a.value=s.content);let i=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}});i.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>t.close();let c=i.createEl("button",{text:o?"\u66F4\u65B0":"\u6DFB\u52A0",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),l=async()=>{let p=r.value.trim(),u=a.value.trim();if(!p){new m.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0");return}if(!u){new m.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9");return}if(this.plugin.settings.commonPrompts.findIndex((v,y)=>v.name===p&&y!==e)!==-1){new m.Notice("\u63D0\u793A\u8BCD\u540D\u79F0\u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6\u540D\u79F0");return}this.plugin.settings.commonPrompts||(this.plugin.settings.commonPrompts=[]);let w={id:o&&s?s.id:Date.now().toString(),name:p,content:u};o&&e!==null?(this.plugin.settings.commonPrompts[e]=w,new m.Notice("\u63D0\u793A\u8BCD\u5DF2\u66F4\u65B0")):(this.plugin.settings.commonPrompts.push(w),new m.Notice("\u63D0\u793A\u8BCD\u5DF2\u6DFB\u52A0")),await this.plugin.saveSettings(),t.close(),this.display()};c.onclick=l;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),l())};r.addEventListener("keydown",d),a.addEventListener("keydown",d),t.open(),r.focus()}async deletePrompt(e){if(this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]){let t=this.plugin.settings.commonPrompts[e],n=new m.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:o}=n;o.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u63D0\u793A\u8BCD "${t.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD"}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let s=o.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});s.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),s.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{this.plugin.settings.commonPrompts.splice(e,1),await this.plugin.saveSettings(),new m.Notice("\u63D0\u793A\u8BCD\u5DF2\u5220\u9664"),n.close(),this.display()},n.open()}}showApiKeyModal(e){let t=new m.Modal(this.app);t.titleEl.setText(`\u8BBE\u7F6E ${e.toUpperCase()} \u914D\u7F6E`);let{contentEl:n}=t,o=this.plugin.settings.providers[e];n.createEl("label",{text:"API Key:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"password",placeholder:"\u8BF7\u8F93\u5165API Key",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});s.value=(o==null?void 0:o.apiKey)||"",n.createEl("label",{text:"Base URL (\u53EF\u9009):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",value:(o==null?void 0:o.baseUrl)||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),a=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),i=a.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}});i.onclick=()=>t.close();let c=a.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),l=async()=>{this.plugin.settings.providers[e]||(this.plugin.settings.providers[e]={apiKey:"",baseUrl:"",enabled:!0}),this.plugin.settings.providers[e].apiKey=s.value.trim(),this.plugin.settings.providers[e].baseUrl=r.value.trim(),s.value.trim()&&(this.plugin.settings.providers[e].enabled=!0),await this.plugin.saveSettings(),new m.Notice(e.toUpperCase()+" \u914D\u7F6E\u5DF2\u4FDD\u5B58"),t.close(),this.display()};c.onclick=l;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),l())};s.addEventListener("keydown",d),r.addEventListener("keydown",d),t.open(),s.focus()}showAddProviderModal(){let e=new m.Modal(this.app);e.titleEl.setText("\u6DFB\u52A0\u4F9B\u5E94\u5546");let{contentEl:t}=e;t.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let n=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: custom-provider",attr:{style:"width: 100%; margin-bottom: 15px;"}});t.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u81EA\u5B9A\u4E49\u4F9B\u5E94\u5546",attr:{style:"width: 100%; margin-bottom: 15px;"}});t.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=t.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(l=>{s.createEl("option",{value:l,text:l.toUpperCase()})}),t.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",attr:{style:"width: 100%; margin-bottom: 15px;"}}),a=t.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),i=a.createEl("button",{text:"\u53D6\u6D88"});i.onclick=()=>e.close();let c=a.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});c.onclick=async()=>{let l=n.value.trim(),d=o.value.trim(),p=s.value,u=r.value.trim();if(!l||!d){new m.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.providers[l]){new m.Notice("\u4F9B\u5E94\u5546ID\u5DF2\u5B58\u5728");return}this.plugin.settings.providers[l]={name:d,type:p,enabled:!0,apiKey:"",baseUrl:u},await this.plugin.saveSettings(),new m.Notice("\u4F9B\u5E94\u5546\u5DF2\u6DFB\u52A0"),e.close(),this.display()},e.open(),n.focus()}showEditProviderModal(e){let t=new m.Modal(this.app);t.titleEl.setText("\u7F16\u8F91\u4F9B\u5E94\u5546");let{contentEl:n}=t,o=this.plugin.settings.providers[e];n.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:e,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",value:o.name||e,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(d=>{let p=r.createEl("option",{value:d,text:d.toUpperCase()});d===o.type&&(p.selected=!0)}),n.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("input",{type:"text",value:o.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px;"}}),i=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),c=i.createEl("button",{text:"\u53D6\u6D88"});c.onclick=()=>t.close();let l=i.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});l.onclick=async()=>{let d=s.value.trim(),p=r.value,u=a.value.trim();if(!d){new m.Notice("\u8BF7\u586B\u5199\u663E\u793A\u540D\u79F0");return}this.plugin.settings.providers[e]={...o,name:d,type:p,baseUrl:u},await this.plugin.saveSettings(),new m.Notice("\u4F9B\u5E94\u5546\u5DF2\u66F4\u65B0"),t.close(),this.display()},t.open(),s.focus()}showAddModelModal(e=O.MULTIMODAL){let t=new m.Modal(this.app);t.titleEl.setText("\u6DFB\u52A0\u65B0\u6A21\u578B");let{contentEl:n}=t;n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: gpt-4-turbo",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u6211\u7684\u81EA\u5B9A\u4E49\u6A21\u578B",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(d=>{r.createEl("option",{value:d,text:d.toUpperCase()})}),n.createEl("label",{text:"\u6A21\u578B\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});a.createEl("option",{value:O.MULTIMODAL,text:"\u591A\u6A21\u6001\u6A21\u578B (\u652F\u6301\u56FE\u7247)"}).selected=!0,a.createEl("option",{value:O.TEXT,text:"\u6587\u672C\u6A21\u578B"});let i=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),c=i.createEl("button",{text:"\u53D6\u6D88"});c.onclick=()=>t.close();let l=i.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});l.onclick=async()=>{let d=o.value.trim(),p=s.value.trim(),u=r.value,h=a.value;if(!d||!p){new m.Notice("\u8BF7\u586B\u5199\u6240\u6709\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.models[d]){new m.Notice("\u6A21\u578B ID \u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6 ID");return}this.plugin.settings.models[d]={id:d,name:p,provider:u,model:d,actualModel:d,enabled:!0,category:h},await this.plugin.saveSettings(),new m.Notice("\u6A21\u578B\u5DF2\u6DFB\u52A0"),t.close(),this.display()},t.open(),o.focus()}showEditModelModal(e){let t=new m.Modal(this.app);t.titleEl.setText("\u7F16\u8F91\u6A21\u578B");let{contentEl:n}=t,o=this.plugin.settings.models[e];n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:e,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",value:o.name,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(l=>{let d=r.createEl("option",{value:l,text:l.toUpperCase()});l===o.provider&&(d.selected=!0)});let a=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),i=a.createEl("button",{text:"\u53D6\u6D88"});i.onclick=()=>t.close();let c=a.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});c.onclick=async()=>{let l=s.value.trim(),d=r.value;if(!l){new m.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}this.plugin.settings.models[e]={...o,name:l,provider:d,model:e,actualModel:e},await this.plugin.saveSettings(),new m.Notice("\u6A21\u578B\u5DF2\u66F4\u65B0"),t.close(),this.display()},t.open(),s.focus()}renderRuleList(e,t){e.empty();let n=this.plugin.ruleManager.getRules();if(n.length===0){e.createEl("div",{text:'\u6682\u65E0\u89C4\u5219\uFF0C\u70B9\u51FB"\u65B0\u5EFA\u89C4\u5219"\u6216"\u4ECE\u6A21\u677F\u521B\u5EFA"\u5F00\u59CB\u6DFB\u52A0',attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});return}let o={};n.forEach(r=>{let a=r.category||"custom";o[a]||(o[a]=[]),o[a].push(r)});let s={writing:"\u5199\u4F5C\u98CE\u683C",format:"\u683C\u5F0F\u8981\u6C42",language:"\u8BED\u8A00\u8BBE\u7F6E",custom:"\u81EA\u5B9A\u4E49\u89C4\u5219"};Object.entries(o).forEach(([r,a])=>{e.createEl("h4",{text:s[r]||r,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),a.forEach(i=>{let c=e.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; background: var(--background-secondary);"}}),l=c.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"}}),d=l.createEl("div",{attr:{style:"flex: 1;"}});d.createEl("h5",{text:i.name,attr:{style:"margin: 0 0 5px 0; font-weight: 600;"}}),i.description&&d.createEl("p",{text:i.description,attr:{style:"margin: 0; color: var(--text-muted); font-size: 0.9em;"}});let p=l.createEl("div",{attr:{style:"display: flex; gap: 8px; align-items: center;"}}),u=p.createEl("input",{type:"checkbox",attr:{style:"margin-right: 5px;"}});u.checked=i.enabled!==!1,u.onchange=async()=>{try{await this.plugin.ruleManager.toggleRule(i.id),new m.Notice(u.checked?"\u89C4\u5219\u5DF2\u542F\u7528":"\u89C4\u5219\u5DF2\u7981\u7528")}catch(h){new m.Notice("\u64CD\u4F5C\u5931\u8D25: "+h.message)}},p.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>{this.showRuleEditor(t,i)},p.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>this.deleteRule(i,t),i.content&&(c.createEl("div",{attr:{style:"background: var(--background-primary); padding: 10px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85em; color: var(--text-muted); max-height: 100px; overflow-y: auto;"}}).textContent=i.content.length>200?i.content.substring(0,200)+"...":i.content)})})}showRuleManager(){let e=new m.Modal(this.app);e.titleEl.setText("\u5168\u5C40\u89C4\u5219\u7BA1\u7406\u5668"),e.modalEl.addClass("flowtext-rule-manager-modal");let{contentEl:t}=e;t.empty();let n=t.createEl("div",{attr:{style:"min-height: 500px; display: flex; flex-direction: column;"}}),o=n.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--background-modifier-border);"}}),s=o.createEl("div",{attr:{style:"display: flex; gap: 10px;"}});s.createEl("button",{text:"\u65B0\u5EFA\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showRuleEditor(e),s.createEl("button",{text:"\u4ECE\u63D0\u793A\u8BCD\u521B\u5EFA",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showTemplateSelector(e);let r=o.createEl("div",{attr:{style:"display: flex; gap: 10px;"}});r.createEl("button",{text:"\u5BFC\u5165\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.importRules(e),r.createEl("button",{text:"\u5BFC\u51FA\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.exportRules();let a=n.createEl("div",{attr:{style:"flex: 1; overflow-y: auto;"}});this.renderRuleList(a,e),e.open()}showRuleEditor(e,t=null){let n=new m.Modal(this.app);n.titleEl.setText(t?"\u7F16\u8F91\u89C4\u5219":"\u65B0\u5EFA\u89C4\u5219"),n.modalEl.addClass("flowtext-rule-editor-modal");let{contentEl:o}=n;o.empty();let s=o.createEl("div",{attr:{style:"display: flex; flex-direction: column; gap: 15px; min-width: 500px;"}});s.createEl("label",{text:"\u89C4\u5219\u540D\u79F0",attr:{style:"font-weight: 600;"}});let r=s.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u540D\u79F0",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});t&&(r.value=t.name),s.createEl("label",{text:"\u89C4\u5219\u63CF\u8FF0",attr:{style:"font-weight: 600;"}});let a=s.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u63CF\u8FF0\uFF08\u53EF\u9009\uFF09",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});t&&t.description&&(a.value=t.description),s.createEl("label",{text:"\u89C4\u5219\u5206\u7C7B",attr:{style:"font-weight: 600;"}});let i=s.createEl("select",{attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),c=[{value:"writing",text:"\u5199\u4F5C\u98CE\u683C"},{value:"format",text:"\u683C\u5F0F\u8981\u6C42"},{value:"language",text:"\u8BED\u8A00\u8BBE\u7F6E"},{value:"custom",text:"\u81EA\u5B9A\u4E49\u89C4\u5219"}],l=t?t.category:"custom";c.forEach(y=>{let f=i.createEl("option",{value:y.value,text:y.text});y.value===l&&(f.selected=!0)}),s.createEl("label",{text:"\u4F18\u5148\u7EA7 (\u6570\u5B57\u8D8A\u5927\u4F18\u5148\u7EA7\u8D8A\u9AD8\uFF0C\u6700\u592710)",attr:{style:"font-weight: 600;"}});let d=s.createEl("input",{type:"number",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});d.min="0",d.max="10",d.value=String(t&&t.priority!==void 0?t.priority:0),s.createEl("label",{text:"\u89C4\u5219\u5185\u5BB9",attr:{style:"font-weight: 600;"}});let p=s.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u5185\u5BB9\uFF0C\u8FD9\u4E9B\u5185\u5BB9\u5C06\u4F5C\u4E3A\u7CFB\u7EDF\u63D0\u793A\u8BCD\u7684\u4E00\u90E8\u5206",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; min-height: 150px; font-family: var(--font-monospace); resize: vertical;"}});t&&(p.value=t.content);let u=s.createEl("div",{attr:{style:"display: flex; align-items: center; gap: 8px;"}}),h=u.createEl("input",{type:"checkbox"});h.checked=!t||t.enabled!==!1,u.createEl("label",{text:"\u542F\u7528\u6B64\u89C4\u5219",attr:{style:"font-weight: 600;"}});let w=s.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;"}});w.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 8px 16px;"}}).onclick=()=>n.close();let v=w.createEl("button",{text:t?"\u66F4\u65B0":"\u521B\u5EFA",cls:"mod-cta",attr:{style:"padding: 8px 16px;"}});v.onclick=async()=>{let y=r.value.trim(),f=p.value.trim();if(!y){new m.Notice("\u8BF7\u8F93\u5165\u89C4\u5219\u540D\u79F0"),r.focus();return}if(!f){new m.Notice("\u8BF7\u8F93\u5165\u89C4\u5219\u5185\u5BB9"),p.focus();return}let b=parseInt(d.value)||0;if(b>10){new m.Notice("\u4F18\u5148\u7EA7\u4E0D\u80FD\u8D85\u8FC710"),d.focus();return}try{let M={name:y,description:a.value.trim(),category:i.value,priority:b,content:f,enabled:h.checked};t?(await this.plugin.ruleManager.updateRule(t.id,M),new m.Notice("\u89C4\u5219\u5DF2\u66F4\u65B0")):(await this.plugin.ruleManager.addRule(M),new m.Notice("\u89C4\u5219\u5DF2\u521B\u5EFA")),n.close(),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(M){new m.Notice("\u64CD\u4F5C\u5931\u8D25: "+M.message)}},n.open(),r.focus()}showTemplateSelector(e){let t=new m.Modal(this.app);t.titleEl.setText("\u4ECE\u6A21\u677F\u521B\u5EFA\u89C4\u5219");let{contentEl:n}=t;n.empty();let o=this.plugin.ruleManager.getTemplates();if(o.length===0)n.createEl("p",{text:"\u6682\u65E0\u53EF\u7528\u6A21\u677F",attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});else{let s={};o.forEach(a=>{let i=a.category||"custom";s[i]||(s[i]=[]),s[i].push(a)});let r={writing:"\u5199\u4F5C\u98CE\u683C",format:"\u683C\u5F0F\u8981\u6C42",language:"\u8BED\u8A00\u8BBE\u7F6E",custom:"\u81EA\u5B9A\u4E49\u6A21\u677F"};Object.entries(s).forEach(([a,i])=>{n.createEl("h4",{text:r[a]||a,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),i.forEach(c=>{let l=n.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;"}});l.addEventListener("mouseenter",()=>{l.style.backgroundColor="var(--background-modifier-hover)"}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor=""}),l.createEl("h5",{text:c.name,attr:{style:"margin: 0 0 8px 0; font-weight: 600;"}}),c.description&&l.createEl("p",{text:c.description,attr:{style:"margin: 0 0 10px 0; color: var(--text-muted); font-size: 0.9em;"}}),c.content&&(l.createEl("div",{attr:{style:"background: var(--background-primary); padding: 8px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.8em; color: var(--text-muted);"}}).textContent=c.content.length>100?c.content.substring(0,100)+"...":c.content),l.onclick=async()=>{try{await this.plugin.ruleManager.createFromTemplate(c.id),new m.Notice("\u5DF2\u4ECE\u6A21\u677F\u521B\u5EFA\u89C4\u5219: "+c.name),t.close(),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(d){new m.Notice("\u521B\u5EFA\u5931\u8D25: "+d.message)}}})})}t.open()}async deleteRule(e,t){let n=new m.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:o}=n;o.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u89C4\u5219 "${e.name}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let s=o.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});s.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),s.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{try{await this.plugin.ruleManager.deleteRule(e.id),new m.Notice("\u89C4\u5219\u5DF2\u5220\u9664"),n.close(),this.renderRuleList(t.contentEl.querySelector('[style*="flex: 1"]'),t)}catch(r){new m.Notice("\u5220\u9664\u5931\u8D25: "+r.message)}},n.open()}exportRules(){try{let e=this.plugin.ruleManager.exportRules(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`flowtext-rules-${new Date().toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(o),new m.Notice("\u89C4\u5219\u5DF2\u5BFC\u51FA")}catch(e){new m.Notice("\u5BFC\u51FA\u5931\u8D25: "+e.message)}}importRules(e){let t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async n=>{let o=n.target.files[0];if(o)try{let s=await o.text(),r=JSON.parse(s),a=await this.plugin.ruleManager.importRules(r);new m.Notice(`\u6210\u529F\u5BFC\u5165 ${a} \u6761\u89C4\u5219`),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(s){new m.Notice("\u5BFC\u5165\u5931\u8D25: "+s.message)}},t.click()}};var _=require("obsidian");var Qe=require("obsidian");function De(g){return g.length?g.map(e=>{var s,r,a;let t=((s=e.item)==null?void 0:s.path)||e.path||"",n=((r=e.item)==null?void 0:r.name)||((a=t.split("/").pop())==null?void 0:a.replace(/\.md$/,""))||t,o=e.score||0;return`=== \u53C2\u8003: ${n} (${t}) [\u76F8\u4F3C\u5EA6: ${(o*100).toFixed(1)}%] ===`}).join(`

`):""}function Me(g){let e=[],t=g.vault.getAllLoadedFiles();for(let n of t)n.children&&e.push(n.path);return e.sort()}var ie=class{constructor(e,t,n){this.suggestionEl=null;this.isOpen=!1;this.selectedIndex=0;this.items=[];this.searchQuery="";this.atPosition=0;this.selectedTags=[];this.keydownHandler=null;this.app=e,this.inputEl=t,this.onSelect=n}convertToContentEditable(){if(this.inputEl.tagName==="TEXTAREA"){let e=document.createElement("div");e.className=this.inputEl.className+" markdown-next-ai-editable-input",e.contentEditable="true",e.setAttribute("data-placeholder",this.inputEl.placeholder),e.style.minHeight="80px",e.style.maxHeight="300px",e.style.overflowY="auto",e.textContent=this.inputEl.value,this.inputEl.parentNode.replaceChild(e,this.inputEl),this.inputEl=e,this.updatePlaceholder(),e.addEventListener("input",()=>this.updatePlaceholder())}}updatePlaceholder(){this.inputEl.textContent.trim()===""&&this.inputEl.querySelectorAll(".markdown-next-ai-inline-tag").length===0?this.inputEl.classList.add("empty"):this.inputEl.classList.remove("empty")}getTextContent(){let e="";return this.inputEl.childNodes.forEach(t=>{if(t.nodeType===Node.TEXT_NODE)e+=t.textContent;else if(t.classList&&t.classList.contains("markdown-next-ai-inline-tag")){let n=t.getAttribute("data-type"),o=t.getAttribute("data-path");e+=`@[${n}:${o}]`}}),e}getCursorPosition(){let e=window.getSelection();if(!e||!e.rangeCount)return 0;let t=e.getRangeAt(0),n=0,o=s=>{if(s===t.endContainer)return n+=t.endOffset,!0;if(s.nodeType===Node.TEXT_NODE)n+=s.textContent.length;else if(s.nodeType===Node.ELEMENT_NODE){if(s.classList&&s.classList.contains("markdown-next-ai-inline-tag")){let r=`@[${s.getAttribute("data-type")}:${s.getAttribute("data-path")}]`;n+=r.length}else for(let r of Array.from(s.childNodes))if(o(r))return!0}return!1};for(let s of Array.from(this.inputEl.childNodes))if(o(s))break;return n}setCursorPosition(e){let t=window.getSelection(),n=document.createRange(),o=0,s=!1,r=a=>{if(!s){if(a.nodeType===Node.TEXT_NODE){let i=a.textContent.length;o+i>=e?(n.setStart(a,e-o),n.collapse(!0),s=!0):o+=i}else if(a.nodeType===Node.ELEMENT_NODE){for(let i of Array.from(a.childNodes))if(r(i),s)return}}};r(this.inputEl),!s&&this.inputEl.lastChild&&(n.setStartAfter(this.inputEl.lastChild),n.collapse(!0)),t.removeAllRanges(),t.addRange(n)}show(e,t=""){if(this.atPosition=e,this.searchQuery=t,this.isOpen=!0,this.items=this.getAllItems(t),this.items.length===0){this.close();return}this.suggestionEl||(this.suggestionEl=document.createElement("div"),this.suggestionEl.className="markdown-next-ai-context-suggestions",this.suggestionEl.addEventListener("click",n=>n.stopPropagation()),this.suggestionEl.addEventListener("mousedown",n=>n.stopPropagation()),document.body.appendChild(this.suggestionEl)),this.render(),this.position(),this.bindKeyboardEvents()}getAllItems(e){let t=[],n=e.toLowerCase(),o=ye.IMAGE,s=ye.DOCUMENT;return this.app.vault.getFiles().forEach(a=>{let i=a.extension.toLowerCase(),c="file",l="\u{1F4C4}";if(i==="md")c="file",l="\u{1F4C4}";else if(o.includes(i))c="image",l="\u{1F5BC}\uFE0F";else if(s.includes(i))c="file",l=i==="pdf"?"\u{1F4D5}":["xlsx","xls","csv"].includes(i)?"\u{1F4CA}":["docx","doc","txt"].includes(i)?"\u{1F4DD}":["epub","mobi"].includes(i)?"\u{1F4DA}":i==="json"?"\u{1F4CB}":"\u{1F4C4}";else return;e&&!a.basename.toLowerCase().includes(n)&&!a.path.toLowerCase().includes(n)||t.push({type:c,name:a.basename,path:a.path,icon:l})}),this.app.vault.getAllLoadedFiles().filter(a=>a.children).forEach(a=>{e&&!a.name.toLowerCase().includes(n)&&!a.path.toLowerCase().includes(n)||t.push({type:"folder",name:a.name,path:a.path,icon:"\u{1F4C1}"})}),t.slice(0,50)}render(){if(!this.suggestionEl)return;this.suggestionEl.innerHTML="";let e=document.createElement("div");e.className="markdown-next-ai-suggestions-header",e.textContent=`\u9009\u62E9\u4E0A\u4E0B\u6587 (${this.items.length}\u9879)`,this.suggestionEl.appendChild(e);let t=document.createElement("div");t.className="markdown-next-ai-suggestions-list",this.items.forEach((n,o)=>{let s=document.createElement("div");s.className="markdown-next-ai-suggestion-item",o===this.selectedIndex&&s.classList.add("selected"),s.innerHTML=`
                <span class="markdown-next-ai-suggestion-icon">${n.icon}</span>
                <div class="markdown-next-ai-suggestion-content">
                    <div class="markdown-next-ai-suggestion-name">${n.name}</div>
                    <div class="markdown-next-ai-suggestion-path">${n.path}</div>
                </div>
            `,s.onclick=r=>{r.stopPropagation(),r.preventDefault(),this.selectItem(o)},t.appendChild(s)}),this.suggestionEl.appendChild(t)}position(){if(!this.suggestionEl||!this.inputEl)return;let e=this.inputEl.getBoundingClientRect(),t=window.getSelection();if(t&&t.rangeCount>0){let o=t.getRangeAt(0).getBoundingClientRect();this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=o.left+"px",this.suggestionEl.style.top=o.bottom+5+"px"}else this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=e.left+"px",this.suggestionEl.style.top=e.bottom+5+"px";this.suggestionEl.style.maxHeight="300px",this.suggestionEl.style.overflowY="auto",this.suggestionEl.style.zIndex="10000"}bindKeyboardEvents(){this.keydownHandler&&this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=e=>{if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,this.items.length-1),this.render(),this.scrollToSelected();break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.render(),this.scrollToSelected();break;case"Enter":e.preventDefault(),e.stopPropagation(),this.selectItem(this.selectedIndex);break;case"Escape":e.preventDefault(),e.stopPropagation(),this.close();break}},this.inputEl.addEventListener("keydown",this.keydownHandler)}scrollToSelected(){if(!this.suggestionEl)return;let e=this.suggestionEl.querySelector(".markdown-next-ai-suggestion-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}selectItem(e){if(e<0||e>=this.items.length)return;let t=this.items[e],n=document.createElement("span");n.className="markdown-next-ai-inline-tag",n.contentEditable="false",n.setAttribute("data-type",t.type),n.setAttribute("data-path",t.path),n.innerHTML=`<span class="markdown-next-ai-inline-tag-icon">${t.icon}</span><span class="markdown-next-ai-inline-tag-name">${t.name}</span>`;let o=window.getSelection();if(!o||!o.rangeCount)return;let s=o.getRangeAt(0),r=this.getCursorPosition()-this.atPosition,a=0,i=!1,c=(d,p,u)=>{if(!i){if(d.nodeType===Node.TEXT_NODE){let h=d.textContent.length;if(a+h>p){let w=p-a,v=Math.min(w+u,h),y=d.textContent;d.textContent=y.substring(0,w)+y.substring(v),s.setStart(d,w),s.collapse(!0),i=!0}else a+=h}else if(d.nodeType===Node.ELEMENT_NODE){if(d.classList&&d.classList.contains("markdown-next-ai-inline-tag")){let h=`@[${d.getAttribute("data-type")}:${d.getAttribute("data-path")}]`;a+=h.length}else for(let h of Array.from(d.childNodes))if(c(h,p,u),i)return}}};c(this.inputEl,this.atPosition,r),i||s.deleteContents(),s.insertNode(n);let l=document.createTextNode(" ");s.setStartAfter(n),s.insertNode(l),s.setStartAfter(l),s.collapse(!0),o.removeAllRanges(),o.addRange(s),this.inputEl.focus(),this.updatePlaceholder(),this.selectedTags.push(t),this.onSelect&&this.onSelect(t),this.close()}updateSearch(e){this.searchQuery=e,this.items=this.getAllItems(e),this.selectedIndex=0,this.items.length===0?this.close():this.render()}close(){this.isOpen=!1,this.suggestionEl&&this.suggestionEl.parentNode&&this.suggestionEl.parentNode.removeChild(this.suggestionEl),this.suggestionEl=null,this.keydownHandler&&(this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}};var V=require("obsidian");var re=class{constructor(e,t){this.popupEl=null;this.isOpen=!1;this.isDragging=!1;this.component=null;this.currentQuery="";this.knowledgeResults=[];this.selectedKnowledge=new Set;this.selectedFolder="";this.onSelectCallback=null;this.onCloseCallback=null;this.app=e,this.position=t}open(){this.isOpen||(this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-knowledge-floating-window"),this.popupEl.innerHTML=`
            <div class="knowledge-window-header">
                <div class="knowledge-window-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <span>\u77E5\u8BC6\u5E93\u68C0\u7D22</span>
                </div>
                <button class="knowledge-window-close" title="\u5173\u95ED">\u2715</button>
            </div>
            <div class="knowledge-window-search">
                <input type="text" class="knowledge-search-input" placeholder="\u8F93\u5165\u68C0\u7D22\u5173\u952E\u8BCD..." />
                <select class="knowledge-folder-select">
                    <option value="">\u6240\u6709\u6587\u4EF6\u5939</option>
                </select>
                <button class="knowledge-search-btn">\u641C\u7D22</button>
            </div>
            <div class="knowledge-window-content">
                <div class="knowledge-results-list sc-list"></div>
            </div>
            <div class="knowledge-window-footer">
                <button class="knowledge-load-more-btn" style="display:none;">\u52A0\u8F7D\u66F4\u591A</button>
                <div class="knowledge-selection-info">
                    <span class="knowledge-selected-count">\u5DF2\u9009\u62E9: 0</span>
                    <button class="knowledge-confirm-btn" disabled>\u786E\u8BA4\u9009\u62E9</button>
                </div>
            </div>
        `,document.body.appendChild(this.popupEl),this.positionWindow(),this.component=new V.Component,this.bindEvents(),this.populateFolderOptions(),this.enableDragging(),setTimeout(()=>{let e=this.popupEl.querySelector(".knowledge-search-input");e&&e.focus()},100))}positionWindow(){this.popupEl&&(this.position?(this.popupEl.style.position="fixed",this.popupEl.style.left=this.position.left+"px",this.popupEl.style.top=this.position.top+(this.position.height||20)+10+"px"):(this.popupEl.style.position="fixed",this.popupEl.style.left="50%",this.popupEl.style.top="50%",this.popupEl.style.transform="translate(-50%, -50%)"),this.popupEl.style.zIndex="10001")}bindEvents(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".knowledge-window-close"),t=this.popupEl.querySelector(".knowledge-search-btn"),n=this.popupEl.querySelector(".knowledge-search-input"),o=this.popupEl.querySelector(".knowledge-folder-select"),s=this.popupEl.querySelector(".knowledge-load-more-btn"),r=this.popupEl.querySelector(".knowledge-confirm-btn");e==null||e.addEventListener("click",()=>this.close()),t==null||t.addEventListener("click",()=>this.runSearch()),s==null||s.addEventListener("click",()=>this.loadMore()),r==null||r.addEventListener("click",()=>this.confirmSelection()),n==null||n.addEventListener("keydown",a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),this.runSearch())}),o==null||o.addEventListener("change",()=>{this.selectedFolder=o.value})}populateFolderOptions(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".knowledge-folder-select");if(!e)return;let t=[],n=this.app.vault.getAllLoadedFiles();for(let o of n)o.children&&t.push(o.path);t.sort(),t.forEach(o=>{let s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)})}async runSearch(){var o;if(!this.popupEl)return;let e=this.popupEl.querySelector(".knowledge-search-input"),t=this.popupEl.querySelector(".knowledge-results-list"),n=(o=e==null?void 0:e.value)==null?void 0:o.trim();if(!n){new V.Notice("\u8BF7\u8F93\u5165\u68C0\u7D22\u5173\u952E\u8BCD");return}this.currentQuery=n,this.selectedKnowledge.clear(),this.updateSelectionInfo();try{t.innerHTML='<div class="knowledge-loading">\u6B63\u5728\u68C0\u7D22\u4E2D...</div>';let s=new N(this.app);await s.ensureLoaded();let r=await s.shouldExcludeBlocksFromSourceConnections(),a=10,i=this.selectedFolder||void 0,c=await s.lookup(n,{limit:a,excludeBlocks:r,includeFilter:i});this.knowledgeResults=c;let l=await s.renderConnectionsResults(c,{});if(t.innerHTML="",l&&l.firstChild){for(;l.firstChild;)t.appendChild(l.firstChild);this.injectSelectionCheckboxes(t);let d=this.popupEl.querySelector(".knowledge-load-more-btn");d&&c.length===a&&(d.style.display="block")}else t.innerHTML='<div class="knowledge-empty">\u672A\u627E\u5230\u76F8\u5173\u7ED3\u679C</div>'}catch(s){console.error("[KnowledgeResultsFloatingWindow] Search failed:",s),t.innerHTML='<div class="knowledge-error">\u68C0\u7D22\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5</div>',new V.Notice("\u68C0\u7D22\u5931\u8D25: "+String(s))}}injectSelectionCheckboxes(e){Array.from(e.querySelectorAll(".sc-result")).forEach(n=>{let o=n.getAttribute("data-path")||"",s=n.querySelector(".header");if(!s)return;let r=document.createElement("input");r.type="checkbox",r.className="markdown-next-ai-knowledge-select",r.title="\u9009\u62E9\u6B64\u7ED3\u679C",r.checked=this.selectedKnowledge.has(o),r.addEventListener("change",a=>{a.stopPropagation(),r.checked?this.selectedKnowledge.add(o):this.selectedKnowledge.delete(o),this.updateSelectionInfo()}),r.addEventListener("click",a=>{a.stopPropagation()}),s.insertBefore(r,s.firstChild)})}updateSelectionInfo(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".knowledge-selected-count"),t=this.popupEl.querySelector(".knowledge-confirm-btn"),n=this.selectedKnowledge.size;e&&(e.textContent=`\u5DF2\u9009\u62E9: ${n}`),t&&(t.disabled=n===0)}async loadMore(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".knowledge-results-list");if(e)try{let n=this.knowledgeResults.length+10,o=new N(this.app);await o.ensureLoaded();let s=await o.shouldExcludeBlocksFromSourceConnections(),r=this.selectedFolder||void 0,a=await o.lookup(this.currentQuery,{limit:n,excludeBlocks:s,includeFilter:r});this.knowledgeResults=a;let i=await o.renderConnectionsResults(a,{});if(e.innerHTML="",i)for(;i.firstChild;)e.appendChild(i.firstChild);this.injectSelectionCheckboxes(e);let c=this.popupEl.querySelector(".knowledge-load-more-btn");c&&a.length===this.knowledgeResults.length&&(c.style.display="none")}catch(t){console.error("[KnowledgeResultsFloatingWindow] Load more failed:",t),new V.Notice("\u52A0\u8F7D\u66F4\u591A\u5931\u8D25")}}confirmSelection(){let e=this.knowledgeResults.filter(t=>{var n;return this.selectedKnowledge.has((n=t.item)==null?void 0:n.path)});this.onSelectCallback&&this.onSelectCallback(e),new V.Notice(`\u5DF2\u9009\u62E9 ${e.length} \u4E2A\u7ED3\u679C`),this.close()}enableDragging(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".knowledge-window-header");if(!e)return;let t=0,n=0,o=0,s=0,r=c=>{if(c.button!==0||!this.popupEl||c.target.closest(".knowledge-window-close"))return;this.isDragging=!0,t=c.clientX,n=c.clientY;let d=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);d&&(o=parseFloat(d[1])||0,s=parseFloat(d[2])||0),document.body.style.userSelect="none"},a=c=>{if(!this.isDragging||!this.popupEl)return;c.preventDefault();let l=c.clientX-t,d=c.clientY-n;this.popupEl.style.transform=`translate(${o+l}px, ${s+d}px)`},i=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))};e.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)}setOnSelect(e){this.onSelectCallback=e}setOnClose(e){this.onCloseCallback=e}close(){!this.isOpen||!this.popupEl||(this.isOpen=!1,this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.component&&(this.component.unload(),this.component=null),this.onCloseCallback&&this.onCloseCallback())}isWindowOpen(){return this.isOpen}};var Y=class{constructor(e,t,n,o){this.selectedFiles=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=e,this.files=t,this.onSelect=n,this.onClose=o}open(e){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-file-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u6863</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6...">
                    </div>
                    <div class="markdown-next-ai-file-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let t=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),o=this.windowEl.querySelector(".markdown-next-ai-file-list"),s=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),r=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),a=c=>{c&&c.stopPropagation(),this.close()};t.onclick=a,r.onclick=a,s.onclick=c=>{c.stopPropagation(),this.onSelect(this.selectedFiles),this.close()},n.addEventListener("input",c=>{let l=c.target.value.toLowerCase();this.renderFileList(o,l)}),this.renderFileList(o,""),this.outsideClickHandler=c=>{this.windowEl.contains(c.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let i=this.windowEl.querySelector(".markdown-next-ai-window-content");if(e){let c=e.left;c+600>window.innerWidth-20&&(c=window.innerWidth-600-20),c<20&&(c=20);let l=e.bottom+8,d=Math.max(300,Math.min(window.innerHeight-l-20,500));i.style.maxHeight=d+"px",i.style.overflowY="auto",i.style.transform="none",i.style.left=c+"px",i.style.top=l+"px"}else i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),i.addEventListener("click",c=>c.stopPropagation())}renderFileList(e,t){e.innerHTML="",this.files.filter(o=>t===""?!0:(o.name||o.path).toLowerCase().includes(t)).forEach(o=>{let s=document.createElement("div");s.className="markdown-next-ai-file-item";let r=document.createElement("input");r.type="checkbox",r.className="markdown-next-ai-file-checkbox",r.checked=this.selectedFiles.some(l=>l.path===o.path);let a=document.createElement("label");a.className="markdown-next-ai-file-label";let i=document.createElement("span");i.className="markdown-next-ai-file-name",i.textContent=o.name;let c=document.createElement("span");c.className="markdown-next-ai-file-extension",c.textContent=o.extension?"."+o.extension:"",a.appendChild(i),a.appendChild(c),s.appendChild(r),s.appendChild(a),e.appendChild(s),r.addEventListener("change",()=>{r.checked?this.selectedFiles.some(l=>l.path===o.path)||this.selectedFiles.push(o):this.selectedFiles=this.selectedFiles.filter(l=>l.path!==o.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null,this.onClose&&this.onClose())}};var J=class{constructor(e,t,n,o){this.selectedFolders=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=e,this.folders=t,this.onSelect=n,this.onClose=o}open(e){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-folder-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u4EF6\u5939</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6\u5939...">
                    </div>
                    <div class="markdown-next-ai-folder-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let t=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),o=this.windowEl.querySelector(".markdown-next-ai-folder-list"),s=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),r=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),a=c=>{c&&c.stopPropagation(),this.close()};t.onclick=a,r.onclick=a,s.onclick=c=>{c.stopPropagation(),this.onSelect(this.selectedFolders),this.close()},n.addEventListener("input",c=>{let l=c.target.value.toLowerCase();this.renderFolderList(o,l)}),this.renderFolderList(o,""),this.outsideClickHandler=c=>{this.windowEl.contains(c.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let i=this.windowEl.querySelector(".markdown-next-ai-window-content");if(e){let c=e.left;c+600>window.innerWidth-20&&(c=window.innerWidth-600-20),c<20&&(c=20);let l=e.bottom+8,d=Math.max(300,Math.min(window.innerHeight-l-20,500));i.style.maxHeight=d+"px",i.style.overflowY="auto",i.style.transform="none",i.style.left=c+"px",i.style.top=l+"px"}else i.style.left="50%",i.style.top="50%",i.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),i.addEventListener("click",c=>c.stopPropagation())}renderFolderList(e,t){e.innerHTML="",this.folders.filter(o=>t===""?!0:(o.name||o.path).toLowerCase().includes(t)).forEach(o=>{let s=document.createElement("div");s.className="markdown-next-ai-folder-item";let r=document.createElement("input");r.type="checkbox",r.className="markdown-next-ai-folder-checkbox",r.checked=this.selectedFolders.some(i=>i.path===o.path);let a=document.createElement("label");a.className="markdown-next-ai-folder-label",a.textContent=o.name||o.path,s.appendChild(r),s.appendChild(a),e.appendChild(s),r.addEventListener("change",()=>{r.checked?this.selectedFolders.some(i=>i.path===o.path)||this.selectedFolders.push(o):this.selectedFolders=this.selectedFolders.filter(i=>i.path!==o.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null,this.onClose&&this.onClose())}};var W=class{constructor(e,t,n){this.isOpen=!1;this.modalEl=null;this.eventListeners=[];this.selectedIndex=0;this.commonPrompts=[];this.app=e,this.plugin=t,this.onSelect=n}open(e){if(!this.isOpen){this.isOpen=!0;try{this.modalEl=document.createElement("div"),this.modalEl.className="markdown-next-ai-context-suggestions";let t=this.plugin.settings.commonPrompts||[];this.commonPrompts=t,this.selectedIndex=0;let n=document.createElement("div");n.className="markdown-next-ai-suggestions-header",n.textContent=`\u5E38\u7528\u63D0\u793A\u8BCD (${this.commonPrompts.length})`,this.modalEl.appendChild(n);let o=document.createElement("div");if(o.className="markdown-next-ai-suggestions-list",this.commonPrompts.length===0)o.innerHTML=`
                    <div class="markdown-next-ai-suggestion-item" style="cursor: default;">
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD</div>
                            <div class="markdown-next-ai-suggestion-path">\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u6DFB\u52A0</div>
                        </div>
                    </div>
                `;else{let a=this.commonPrompts.map((i,c)=>`
                    <div class="markdown-next-ai-suggestion-item ${c===0?"selected":""}" data-index="${c}">
                        <span class="markdown-next-ai-suggestion-icon">\u{1F4A1}</span>
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">${i.name}</div>
                            <div class="markdown-next-ai-suggestion-path">${i.content.substring(0,50)}${i.content.length>50?"...":""}</div>
                        </div>
                    </div>
                `).join("");o.innerHTML=a}this.modalEl.appendChild(o),this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(a=>{if(this.commonPrompts.length===0)return;let i=()=>{let l=parseInt(a.dataset.index||"0");this.selectPrompt(l)};a.addEventListener("click",i),this.eventListeners.push({element:a,event:"click",handler:i});let c=()=>{let l=parseInt(a.dataset.index||"0");this.updateSelection(l)};a.addEventListener("mouseenter",c),this.eventListeners.push({element:a,event:"mouseenter",handler:c})});let s=a=>{a.target.closest(".markdown-next-ai-at-popup")||this.modalEl.contains(a.target)||this.close()};document.addEventListener("click",s),this.eventListeners.push({element:document,event:"click",handler:s});let r=a=>{a.key==="Escape"?(a.preventDefault(),this.close()):a.key==="ArrowDown"?(a.preventDefault(),this.moveSelection(1)):a.key==="ArrowUp"?(a.preventDefault(),this.moveSelection(-1)):a.key==="Enter"&&(a.preventDefault(),this.selectPrompt(this.selectedIndex))};document.addEventListener("keydown",r),this.eventListeners.push({element:document,event:"keydown",handler:r}),document.body.appendChild(this.modalEl),this.positionPopup(e)}catch(t){console.error("Failed to open prompt selector:",t)}}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e&&typeof e.removeEventListener=="function"&&e.removeEventListener(t,n)}),this.eventListeners=[],this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null)}positionPopup(e){if(this.modalEl&&e)try{let t=e.getBoundingClientRect(),n=this.modalEl.getBoundingClientRect(),o=window.innerWidth,s=window.innerHeight,r=t.left,a=t.bottom+5;r+n.width>o&&(r=o-n.width-10),a+n.height>s&&(a=t.top-n.height-5),r=Math.max(10,r),a=Math.max(10,a),this.modalEl.style.position="fixed",this.modalEl.style.left=r+"px",this.modalEl.style.top=a+"px",this.modalEl.style.zIndex="10002"}catch(t){console.error("Failed to position prompt selector:",t)}}moveSelection(e){if(this.commonPrompts.length===0)return;let t=this.selectedIndex+e;t<0&&(t=this.commonPrompts.length-1),t>=this.commonPrompts.length&&(t=0),this.updateSelection(t)}updateSelection(e){if(!this.modalEl||this.commonPrompts.length===0)return;this.selectedIndex=e,this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(n=>n.classList.remove("selected"));let t=this.modalEl.querySelector(`[data-index="${e}"]`);t&&(t.classList.add("selected"),t.scrollIntoView({block:"nearest",behavior:"smooth"}))}selectPrompt(e){if(e<0||e>=this.commonPrompts.length)return;let t=this.commonPrompts[e];t&&this.onSelect&&this.onSelect(t.content),this.close()}};var Q=class{constructor(e,t,n,o,s,r=""){this.popupEl=null;this.inputEl=null;this.modelSelectEl=null;this.modelMenuEl=null;this.modelTriggerEl=null;this.isModelMenuOpen=!1;this.isOpen=!1;this.eventListeners=[];this.selectedContext={files:[],folders:[]};this.scrollContainer=null;this.contextSelector=null;this.promptSelector=null;this.outsideClickHandler=null;this.knowledgeResults=[];this.selectedKnowledge=new Set;this.knowledgeResultsWindow=null;this.historyContainer=null;this.historyVisible=!1;this.isDragging=!1;this.closeGuards=new Set;this.selectedKbFolder="";this.knowledgeCurrentQuery="";this.knowledgeTotalResults=[];this.app=e,this.onSubmit=t,this.cursorPosition=n,this.plugin=o,this.view=s,this.selectedText=r,this.imageHandler=new te}addCloseGuard(e){e&&(this.closeGuards.add(e),this.popupEl&&this.popupEl.setAttribute("data-close-guard","true"))}removeCloseGuard(e){e&&(this.closeGuards.delete(e),this.popupEl&&this.closeGuards.size===0&&this.popupEl.removeAttribute("data-close-guard"))}hasCloseGuard(){return this.closeGuards.size>0}async submit(){var a,i;let e=((a=this.contextSelector)==null?void 0:a.getTextContent().trim())||"";await this.processInlineImages();let t=this.imageHandler.getImages(),n=((i=this.modelSelectEl)==null?void 0:i.value)||"",o=await this.getContextContent(),s=(this.knowledgeResults||[]).filter(c=>{var l;return this.selectedKnowledge.has((l=c.item)==null?void 0:l.path)}),r=De(s);if(r&&(o=o?`${o}

${r}`:r),!e&&t.length===0&&!o){new _.Notice("\u8BF7\u8F93\u5165\u7EED\u5199\u8981\u6C42\u6216\u4E0A\u4F20\u56FE\u7247");return}this.onSubmit(e,t,n,o,this.selectedText),this.close()}getModelOptions(){let e=this.plugin.getAvailableModels(),t=this.plugin.settings.currentModel;return e.map(n=>{let o=n.id===t?"selected":"";return`<option value="${n.id}" ${o}>${n.name}</option>`}).join("")}getModelNameById(e){var n;return((n=this.plugin.getAvailableModels().find(o=>o.id===e))==null?void 0:n.name)||e||"\u9009\u62E9\u6A21\u578B"}addImagePreview(e,t){let n=this.imageHandler.createImagePreview(e,()=>{});t.appendChild(n)}open(){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-at-popup");let e=this.selectedText.length>0,t=e?"\u4FEE\u6539\u6240\u9009\u5185\u5BB9":"Markdown-Next-AI",n=e?"\u8BF7\u8F93\u5165\u4FEE\u6539\u8981\u6C42...":"\uFF08@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD\uFF09...",o=this.selectedText,s=this.getModelNameById(this.plugin.settings.currentModel);this.popupEl.innerHTML=`
            <div class="markdown-next-ai-popup-header">
                <span class="markdown-next-ai-popup-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                    ${t}
                </span>
                <div class="markdown-next-ai-popup-actions">
                    <button class="markdown-next-ai-history-btn" title="\u67E5\u770B\u5386\u53F2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></button>
                    <button class="markdown-next-ai-popup-close">\u2715</button>
                </div>
            </div>
            <div class="markdown-next-ai-history-panel" style="display:none;"></div>
            <div class="markdown-next-ai-popup-content">
                ${e?`
                <div class="markdown-next-ai-selected-text-section">
                    <div class="markdown-next-ai-selected-text-header">
                        <span class="markdown-next-ai-selected-text-label">\u9009\u4E2D\u6587\u672C\u5185\u5BB9:</span>
                    </div>
                    <div class="markdown-next-ai-selected-text-preview">${o}</div>
                </div>
                `:""}
                <div class="markdown-next-ai-context-section">
                    <div class="markdown-next-ai-selected-context" style="display: none;">
                        <div class="markdown-next-ai-context-header">
                            <span class="markdown-next-ai-context-title">\u5DF2\u9009\u62E9\u4E0A\u4E0B\u6587:</span>
                            <button class="markdown-next-ai-clear-context-btn" title="\u6E05\u9664\u4E0A\u4E0B\u6587">\u2715</button>
                        </div>
                        <div class="markdown-next-ai-context-list"></div>
                    </div>
                </div>
                <textarea class="markdown-next-ai-continue-input" placeholder="${n}" rows="3"></textarea>
                <div class="markdown-next-ai-upload-section">
                    <div class="markdown-next-ai-left-section">
                        <div class="markdown-next-ai-model-dropdown">
                            <button type="button" class="markdown-next-ai-model-trigger">
                                <span class="markdown-next-ai-model-value">${s}</span>
                                <span class="markdown-next-ai-model-arrow">\u25BE</span>
                            </button>
                            <div class="markdown-next-ai-model-menu"></div>
                            <select class="markdown-next-ai-model-select" style="display:none;">
                                ${this.getModelOptions()}
                            </select>
                        </div>
                        <input type="file" class="markdown-next-ai-file-input" accept="image/*" multiple style="display: none;">
                        <button class="markdown-next-ai-upload-btn" title="\u4E0A\u4F20\u56FE\u7247"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg></button>
                        <div class="markdown-next-ai-context-buttons">
                            <button class="markdown-next-ai-select-file-btn" title="\u9009\u62E9\u6587\u6863\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></button>
                            <button class="markdown-next-ai-select-folder-btn" title="\u9009\u62E9\u6587\u4EF6\u5939\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg></button>
                            <button class="markdown-next-ai-knowledge-search-btn" title="\u667A\u80FD\u77E5\u8BC6\u5E93\u68C0\u7D22"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg></button>
                        </div>
                    </div>
                    <button class="markdown-next-ai-submit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="m22 2-7 19-4-9-9-4 20-6z"/></svg>\u63D0\u4EA4</button>
                </div>
                <div class="markdown-next-ai-knowledge-section" style="display:none;">
                    <div class="markdown-next-ai-knowledge-header">
                        <span class="markdown-next-ai-knowledge-title">\u{1F4DA} \u667A\u80FD\u68C0\u7D22\u53C2\u8003</span>
                        <select class="markdown-next-ai-knowledge-folder-select" title="\u8FC7\u6EE4\u6587\u4EF6\u5939">
                            <option value="">\u5168\u90E8\u6587\u4EF6\u5939</option>
                        </select>
                        <button class="markdown-next-ai-knowledge-more-btn" title="\u68C0\u7D22\u66F4\u591A" style="display:none;">\u66F4\u591A</button>
                    </div>
                    <div class="markdown-next-ai-knowledge-list"></div>
                </div>
                <div class="markdown-next-ai-image-previews"></div>
            </div>
        `,this.inputEl=this.popupEl.querySelector(".markdown-next-ai-continue-input"),this.modelSelectEl=this.popupEl.querySelector(".markdown-next-ai-model-select"),this.modelMenuEl=this.popupEl.querySelector(".markdown-next-ai-model-menu"),this.modelTriggerEl=this.popupEl.querySelector(".markdown-next-ai-model-trigger");let r=this.popupEl.querySelector(".markdown-next-ai-submit-btn"),a=this.popupEl.querySelector(".markdown-next-ai-popup-close"),i=this.popupEl.querySelector(".markdown-next-ai-file-input"),c=this.popupEl.querySelector(".markdown-next-ai-upload-btn"),l=this.popupEl.querySelector(".markdown-next-ai-image-previews"),d=this.popupEl.querySelector(".markdown-next-ai-select-file-btn"),p=this.popupEl.querySelector(".markdown-next-ai-select-folder-btn"),u=this.popupEl.querySelector(".markdown-next-ai-clear-context-btn"),h=this.popupEl.querySelector(".markdown-next-ai-history-btn");this.historyContainer=this.popupEl.querySelector(".markdown-next-ai-history-panel"),this.contextSelector=new ie(this.app,this.inputEl,()=>{}),this.contextSelector.convertToContentEditable(),this.inputEl=this.contextSelector.inputEl,this.promptSelector=new W(this.app,this.plugin,P=>{let B=this.contextSelector.getCursorPosition(),A=this.contextSelector.getTextContent().substring(0,B).lastIndexOf("#");if(A!==-1){let T=window.getSelection();if(T&&T.rangeCount>0){let L=T.getRangeAt(0),E=B-A,S=0,x=!1,k=(C,F,Ce)=>{if(!x){if(C.nodeType===Node.TEXT_NODE){let Z=C.textContent.length;if(S+Z>F){let Te=F-S,Ne=Math.min(Te+Ce,Z),Le=C.textContent;C.textContent=Le.substring(0,Te)+Le.substring(Ne);let Se=document.createTextNode(P);C.parentNode&&(C.parentNode.insertBefore(Se,C.nextSibling),L.setStartAfter(Se),L.collapse(!0)),x=!0}else S+=Z}else if(C.nodeType===Node.ELEMENT_NODE){for(let Z of Array.from(C.childNodes))if(k(Z,F,Ce),x)return}}};k(this.inputEl,A,E),T.removeAllRanges(),T.addRange(L),this.inputEl.focus()}}}),a.onclick=()=>this.close(),r.onclick=()=>this.submit(),c.onclick=()=>i.click(),d.onclick=()=>this.showFileSelector(),p.onclick=()=>this.showFolderSelector(),u.onclick=()=>this.clearContext(),h&&(h.onclick=()=>this.toggleHistoryPanel());let w=this.popupEl.querySelector(".markdown-next-ai-knowledge-search-btn");w&&(w.onclick=()=>{this.openKnowledgeSearchWindow()});let v=this.popupEl.querySelector(".markdown-next-ai-knowledge-folder-select");v&&(this.initKnowledgeFolderOptions(v),v.onchange=()=>{this.selectedKbFolder=v.value,this.filterAndRenderKnowledgeResults()});let y=this.popupEl.querySelector(".markdown-next-ai-knowledge-more-btn");y&&(y.onclick=async()=>{await this.loadMoreKnowledgeResults()}),this.initModelDropdown();let f=P=>{let B=P.target;B.files&&this.imageHandler.handleFileSelect(B.files,H=>{this.addImagePreview(H,l)}),B.value=""};i.addEventListener("change",f),this.eventListeners.push({element:i,event:"change",handler:f});let b=P=>{this.imageHandler.handlePaste(P,B=>{this.addImagePreview(B,l)})};this.inputEl.addEventListener("paste",b),this.eventListeners.push({element:this.inputEl,event:"paste",handler:b});let M=P=>{P.stopPropagation(),this.adjustPopupWidth();let B=this.contextSelector.getCursorPosition(),H=this.contextSelector.getTextContent().substring(0,B),A=H.lastIndexOf("@");if(A!==-1){let L=H.substring(A+1);if(!L.includes(" ")&&!L.includes(`
`)){this.contextSelector.show(A,L);return}else this.contextSelector.close()}else this.contextSelector.close();let T=H.lastIndexOf("#");if(T!==-1){let L=T>0?H.charAt(T-1):" ";if(L===" "||L===`
`){this.promptSelector.open(this.inputEl);let E=window.getSelection();if(E&&E.rangeCount>0){let x=E.getRangeAt(0).getBoundingClientRect(),k=document.querySelector(".markdown-next-ai-context-suggestions");k&&(k.style.position="fixed",k.style.left=x.left+"px",k.style.top=x.bottom+5+"px")}}else this.promptSelector.close()}else this.promptSelector.close()};this.inputEl.addEventListener("input",M),this.eventListeners.push({element:this.inputEl,event:"input",handler:M});let I=P=>{this.contextSelector&&this.contextSelector.isOpen||(P.key==="Enter"?P.shiftKey||(P.preventDefault(),r.click()):P.key==="Escape"&&(P.preventDefault(),this.close()))};this.inputEl.addEventListener("keydown",I),this.eventListeners.push({element:this.inputEl,event:"keydown",handler:I});let $=P=>{this.hasCloseGuard()||this.popupEl.hasAttribute("data-prompt-selecting")||P.target.closest(".markdown-next-ai-prompt-selector-popup")||P.target.closest(".markdown-next-ai-context-suggestions")||this.contextSelector&&this.contextSelector.isOpen||P.target.closest(".markdown-next-ai-file-selection-window")||P.target.closest(".markdown-next-ai-folder-selection-window")||P.target.closest(".markdown-next-ai-model-dropdown")||P.target.closest(".markdown-next-ai-knowledge-floating-window")||P.target.closest(".cm-editor")||P.target.closest(".markdown-source-view")||P.target.closest(".markdown-preview-view")||P.target.closest(".markdown-next-ai-result-floating-window")||this.popupEl.contains(P.target)||this.close()};setTimeout(()=>{document.addEventListener("click",$)},100),this.outsideClickHandler=$,this.view&&(this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor"))),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.scrollContainer.appendChild(this.popupEl)):document.body.appendChild(this.popupEl),this.positionPopup(),this.enableDragging(),this.adjustPopupWidth(),setTimeout(()=>{this.inputEl&&this.inputEl.focus()},100)}positionPopup(){if(!this.popupEl||!this.cursorPosition)return;let{left:e,top:t,height:n=20}=this.cursorPosition;if(this.scrollContainer){let o=this.scrollContainer.getBoundingClientRect(),s=this.scrollContainer.scrollTop,r=this.scrollContainer.scrollLeft,a=e-o.left+r,i=t+n+5-o.top+s;this.popupEl.style.position="absolute",this.popupEl.style.left=a+"px",this.popupEl.style.top=i+"px",this.popupEl.style.zIndex="10000";let c=this.popupEl.getBoundingClientRect(),l=o.width;c.right>o.right&&(a=l+r-c.width-10,this.popupEl.style.left=a+"px"),a<r&&(this.popupEl.style.left=r+10+"px"),c.bottom>o.bottom&&(i=t-o.top+s-c.height-5,this.popupEl.style.top=i+"px")}else{this.popupEl.style.position="fixed",this.popupEl.style.left=e+"px",this.popupEl.style.top=t+n+5+"px",this.popupEl.style.zIndex="10000";let o=this.popupEl.getBoundingClientRect(),s=window.innerWidth,r=window.innerHeight;o.right>s&&(this.popupEl.style.left=s-o.width-10+"px"),o.left<0&&(this.popupEl.style.left="10px"),o.bottom>r&&(this.popupEl.style.top=t-o.height-5+"px")}}adjustPopupWidth(){if(!this.popupEl||!this.inputEl)return;let e=document.createElement("span");e.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            max-width: 80vw;
        `;let t=this.contextSelector?this.contextSelector.getTextContent():"";e.textContent=t||"",document.body.appendChild(e);let n=e.offsetWidth;document.body.removeChild(e);let o=this.historyContainer&&this.historyVisible?this.historyContainer.scrollWidth+40:0,s=520,r=Math.min(window.innerWidth*.8,900),i=Math.max(s,Math.min(Math.max(n+120,o),r));this.popupEl.style.width=i+"px"}toggleHistoryPanel(){this.historyContainer&&(this.historyVisible=!this.historyVisible,this.historyContainer.style.display=this.historyVisible?"block":"none",this.historyVisible&&this.renderHistoryPanel(),this.adjustPopupWidth())}renderHistoryPanel(){if(!this.historyContainer)return;let e=(this.plugin.settings.conversationHistory||[]).slice(-10).reverse();if(!e.length){this.historyContainer.innerHTML='<div class="markdown-next-ai-history-empty">\u6682\u65E0\u5386\u53F2\u8BB0\u5F55</div>';return}let t=o=>{let s=new Date(o),r=a=>a.toString().padStart(2,"0");return`${s.getMonth()+1}-${s.getDate()} ${r(s.getHours())}:${r(s.getMinutes())}`},n=e.map((o,s)=>{let r=o.prompt.length>80?`${o.prompt.slice(0,80)}...`:o.prompt,a=o.response.length>120?`${o.response.slice(0,120)}...`:o.response;return`
                <div class="markdown-next-ai-history-item" 
                     data-history-id="${o.id}" 
                     data-history-idx="${s}"
                     title="\u70B9\u51FB\u6062\u590D\u6B64\u5BF9\u8BDD">
                    <div class="markdown-next-ai-history-header">
                        <span class="markdown-next-ai-history-time">${t(o.timestamp)}</span>
                        <span class="markdown-next-ai-history-model">${o.modelId}</span>
                    </div>
                    <div class="markdown-next-ai-history-prompt">${r||"(\u7A7A\u63D0\u793A)"}</div>
                    <div class="markdown-next-ai-history-response">${a||"(\u65E0\u56DE\u590D)"}</div>
                </div>
            `}).join("");this.historyContainer.innerHTML=n,this.historyContainer.querySelectorAll(".markdown-next-ai-history-item").forEach(o=>{o.addEventListener("click",()=>{let s=o.getAttribute("data-history-id");s&&this.restoreHistoryEntry(s)})})}restoreHistoryEntry(e){if(!this.inputEl)return;let t=(this.plugin.settings.conversationHistory||[]).find(n=>n.id===e);t&&this.inputEl instanceof HTMLTextAreaElement&&(this.inputEl.value=t.prompt,this.inputEl.focus(),this.adjustPopupWidth(),this.historyContainer&&(this.historyVisible=!1,this.historyContainer.style.display="none"),new _.Notice(`\u5DF2\u6062\u590D: "${t.prompt.slice(0,50)}${t.prompt.length>50?"...":""}"`))}openKnowledgeSearchWindow(){if(this.knowledgeResultsWindow&&this.knowledgeResultsWindow.isWindowOpen())return;let e=null;if(this.popupEl){let t=this.popupEl.getBoundingClientRect();e={left:t.left,top:t.bottom,height:0}}this.knowledgeResultsWindow=new re(this.app,e),this.knowledgeResultsWindow.setOnSelect(t=>{this.knowledgeResults=t,this.selectedKnowledge=new Set(t.map(n=>{var o;return(o=n.item)==null?void 0:o.path}).filter(Boolean)),this.updateContextDisplay()}),this.knowledgeResultsWindow.open()}async runKnowledgeSearch(){this.openKnowledgeSearchWindow()}initKnowledgeFolderOptions(e){let t=Me(this.app);e.innerHTML='<option value="">\u5168\u90E8\u6587\u4EF6\u5939</option>',t.forEach(n=>{let o=document.createElement("option");o.value=n,o.textContent=n,e.appendChild(o)})}async filterAndRenderKnowledgeResults(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-knowledge-list");if(!e)return;let t=this.knowledgeTotalResults;this.selectedKbFolder&&(t=t.filter(r=>{var a,i,c;return((i=(a=r.item)==null?void 0:a.path)==null?void 0:i.startsWith(this.selectedKbFolder+"/"))||((c=r.item)==null?void 0:c.path)===this.selectedKbFolder})),this.knowledgeResults=t.slice(0,10);let n=new N(this.app);await n.ensureLoaded();let o=await n.renderConnectionsResults(this.knowledgeResults,{});if(e.innerHTML="",o)for(;o.firstChild;)e.appendChild(o.firstChild);this.injectSelectionCheckboxes(e);let s=this.popupEl.querySelector(".markdown-next-ai-knowledge-more-btn");s&&(s.style.display=t.length>this.knowledgeResults.length?"inline-block":"none")}async loadMoreKnowledgeResults(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-knowledge-list");if(e)try{let n=this.knowledgeResults.length+10,o=new N(this.app);await o.ensureLoaded();let s=await o.shouldExcludeBlocksFromSourceConnections(),r=this.selectedKbFolder||void 0,a=await o.lookup(this.knowledgeCurrentQuery,{limit:n,excludeBlocks:s,includeFilter:r});this.knowledgeResults=a,this.knowledgeTotalResults=a;let i=await o.renderConnectionsResults(this.knowledgeResults,{});if(e.innerHTML="",i)for(;i.firstChild;)e.appendChild(i.firstChild);this.injectSelectionCheckboxes(e);let c=this.popupEl.querySelector(".markdown-next-ai-knowledge-more-btn");c&&a.length===this.knowledgeResults.length&&(c.style.display="none")}catch(t){console.error("\u52A0\u8F7D\u66F4\u591A\u7ED3\u679C\u5931\u8D25",t),new _.Notice("\u52A0\u8F7D\u66F4\u591A\u7ED3\u679C\u5931\u8D25")}}injectSelectionCheckboxes(e){Array.from(e.querySelectorAll(".sc-result")).forEach(n=>{let o=n.getAttribute("data-path")||"",s=n.querySelector(".header");if(!s)return;let r=document.createElement("input");r.type="checkbox",r.className="markdown-next-ai-knowledge-select",r.title="\u5C06\u6B64\u7ED3\u679C\u6DFB\u52A0\u4E3AAI\u53C2\u8003",r.checked=this.selectedKnowledge.has(o),r.addEventListener("change",a=>{a.stopPropagation(),r.checked?this.selectedKnowledge.add(o):this.selectedKnowledge.delete(o)}),r.addEventListener("click",a=>{a.stopPropagation()}),s.insertBefore(r,s.firstChild)})}async renderResultContent(e,t){let n=e.getAttribute("data-path");if(n)try{let o=this.app.vault.getAbstractFileByPath(n);if(o&&o instanceof _.TFile){let s=await this.app.vault.read(o),r=document.createDocumentFragment(),a=document.createElement("div");a.textContent=s,r.appendChild(a),t.appendChild(r)}}catch(o){console.error("[renderResultContent] \u8BFB\u53D6\u5931\u8D25:",o)}}adjustModelSelectWidth(){if(!this.modelSelectEl)return;let e=document.createElement("span");e.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: inherit;
            font-size: 12px;
            font-weight: 600;
        `,document.body.appendChild(e);let t=0;for(let a of Array.from(this.modelSelectEl.options))e.textContent=a.text,t=Math.max(t,e.offsetWidth);document.body.removeChild(e);let r=Math.min(360,Math.max(140,t+54));this.modelSelectEl.style.width=r+"px",this.modelTriggerEl&&(this.modelTriggerEl.style.width=r+"px"),this.modelMenuEl&&(this.modelMenuEl.style.minWidth=r+"px")}enableDragging(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(!e)return;let t=0,n=0,o=0,s=0,r=p=>{if(p.button!==0||!this.popupEl||p.target.closest(".markdown-next-ai-popup-actions"))return;this.isDragging=!0,t=p.clientX,n=p.clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(o=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},a=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.clientX-t,h=p.clientY-n,w=o+u,v=s+h;this.popupEl.style.transform=`translate(${w}px, ${v}px)`},i=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))},c=p=>{if(!this.popupEl)return;this.isDragging=!0,t=p.touches[0].clientX,n=p.touches[0].clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(o=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},l=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.touches[0].clientX-t,h=p.touches[0].clientY-n,w=o+u,v=s+h;this.popupEl.style.transform=`translate(${w}px, ${v}px)`},d=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))};e.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",i),e.addEventListener("touchstart",c,{passive:!1}),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",d),this.eventListeners.push({element:e,event:"mousedown",handler:r},{element:document,event:"mousemove",handler:a},{element:document,event:"mouseup",handler:i},{element:e,event:"touchstart",handler:c},{element:document,event:"touchmove",handler:l},{element:document,event:"touchend",handler:d})}close(){this.isOpen&&(this.isOpen=!1,this.contextSelector&&(this.contextSelector.close(),this.contextSelector=null),this.knowledgeResultsWindow&&(this.knowledgeResultsWindow.close(),this.knowledgeResultsWindow=null),this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e.removeEventListener(t,n)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.imageHandler.clearImages(),this.closeModelMenu(),this.closeGuards.clear(),this.popupEl&&this.popupEl.removeAttribute("data-close-guard"),this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.inputEl=null)}initModelDropdown(){if(!this.modelSelectEl||!this.modelMenuEl||!this.modelTriggerEl)return;this.renderModelMenu(),this.updateModelTrigger(this.modelSelectEl.value),this.updateUIForModelType(this.modelSelectEl.value),this.adjustModelSelectWidth();let e=o=>{o.stopPropagation(),this.toggleModelMenu()};this.modelTriggerEl.addEventListener("click",e),this.eventListeners.push({element:this.modelTriggerEl,event:"click",handler:e});let t=o=>{let r=o.target.closest(".markdown-next-ai-model-menu-item");if(!r)return;let a=r.getAttribute("data-model-id");a&&this.selectModel(a)};this.modelMenuEl.addEventListener("click",t),this.eventListeners.push({element:this.modelMenuEl,event:"click",handler:t});let n=o=>{o.target.closest(".markdown-next-ai-model-dropdown")||this.closeModelMenu()};document.addEventListener("click",n),this.eventListeners.push({element:document,event:"click",handler:n})}renderModelMenu(){if(!this.modelMenuEl||!this.modelSelectEl)return;let e=this.modelSelectEl.value||this.plugin.settings.currentModel,t=this.plugin.getAvailableModels();if(!t.length){this.modelMenuEl.innerHTML='<div class="markdown-next-ai-model-menu-empty">\u6682\u65E0\u6A21\u578B\u53EF\u7528</div>';return}let n=t.map(o=>{let s=o.id===e;return`
                <div class="markdown-next-ai-model-menu-item ${s?"is-active":""}" data-model-id="${o.id}">
                    <div class="markdown-next-ai-model-menu-title">${o.id}</div>
                    ${s?'<span class="markdown-next-ai-model-check">\u2713</span>':""}
                </div>
            `}).join("");this.modelMenuEl.innerHTML=n}updateModelTrigger(e){if(!this.modelTriggerEl)return;let t=this.modelTriggerEl.querySelector(".markdown-next-ai-model-value");t&&(t.textContent=this.getModelNameById(e)),this.modelTriggerEl.setAttribute("aria-expanded",this.isModelMenuOpen?"true":"false")}selectModel(e){this.modelSelectEl&&(this.addCloseGuard("model-selection"),this.modelSelectEl.value=e,this.plugin.settings.currentModel=e,this.plugin.saveSettings(),this.updateUIForModelType(e),this.renderModelMenu(),this.updateModelTrigger(e),this.adjustModelSelectWidth(),this.closeModelMenu(),setTimeout(()=>this.removeCloseGuard("model-selection"),0))}toggleModelMenu(){this.isModelMenuOpen?this.closeModelMenu():this.openModelMenu()}openModelMenu(){var e;this.modelMenuEl&&(this.modelMenuEl.style.display="block",this.isModelMenuOpen=!0,this.addCloseGuard("model-menu"),this.updateModelTrigger(((e=this.modelSelectEl)==null?void 0:e.value)||""))}closeModelMenu(){var e;this.modelMenuEl&&(this.modelMenuEl.style.display="none",this.isModelMenuOpen=!1,this.removeCloseGuard("model-menu"),this.updateModelTrigger(((e=this.modelSelectEl)==null?void 0:e.value)||""))}updateUIForModelType(e){var n;if(!this.popupEl||!e)return;let t=this.plugin.settings.models[e];if(t){let o=t.category===O.IMAGE,s=this.popupEl.querySelector(".markdown-next-ai-popup-title");s&&(s.innerHTML=o?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-icon lucide-image" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>AI\u56FE\u7247\u751F\u6210':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>Markdown-Next-AI'),this.inputEl&&(this.inputEl.setAttribute("data-placeholder",o?"\u8BF7\u63CF\u8FF0\u60A8\u60F3\u8981\u751F\u6210\u7684\u56FE\u7247...":"(@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD)"),(n=this.contextSelector)==null||n.updatePlaceholder());let r=this.popupEl.querySelector(".markdown-next-ai-submit-btn");r&&(r.innerHTML=o?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-plus-icon lucide-image-plus" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M16 5h6"/><path d="M19 2v6"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>\u751F\u6210\u56FE\u7247':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="m22 2-7 19-4-9-9-4 20-6z"/></svg>\u63D0\u4EA4');let a=this.popupEl.querySelector(".markdown-next-ai-upload-btn");a&&(a.style.display=o?"none":"inline-flex")}}showFileSelector(){let e=["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"],t=this.plugin.app.vault.getFiles().filter(o=>e.includes(o.extension.toLowerCase())).map(o=>({name:o.basename,path:o.path,extension:o.extension.toLowerCase()})),n=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(n){let o=n.getBoundingClientRect();this.addCloseGuard("file-window"),new Y(this.plugin.app,t,s=>{this.addFilesToContext(s)},()=>this.removeCloseGuard("file-window")).open(o)}}showFolderSelector(){let e=this.plugin.app.vault.getAllLoadedFiles().filter(n=>!!n.children).map(n=>({name:n.name,path:n.path})),t=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(t){let n=t.getBoundingClientRect();this.addCloseGuard("folder-window"),new J(this.plugin.app,e,o=>{this.addFoldersToContext(o)},()=>this.removeCloseGuard("folder-window")).open(n)}}addFilesToContext(e){e.forEach(t=>{this.selectedContext.files.find(n=>n.path===t.path)||this.selectedContext.files.push(t)}),this.updateContextDisplay()}addFoldersToContext(e){e.forEach(t=>{this.selectedContext.folders.find(n=>n.path===t.path)||this.selectedContext.folders.push(t)}),this.updateContextDisplay()}updateContextDisplay(){let e=this.popupEl.querySelector(".markdown-next-ai-selected-context"),t=this.popupEl.querySelector(".markdown-next-ai-context-list"),n=this.selectedKnowledge.size;this.selectedContext.files.length>0||this.selectedContext.folders.length>0||n>0?(e.style.display="block",t.innerHTML="",this.selectedContext.files.forEach(s=>{let r=document.createElement("div");r.className="markdown-next-ai-context-item",r.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${s.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="file" data-path="${s.path}">\xD7</button>
                `,t.appendChild(r)}),this.selectedContext.folders.forEach(s=>{let r=document.createElement("div");r.className="markdown-next-ai-context-item",r.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${s.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="folder" data-path="${s.path}">\xD7</button>
                `,t.appendChild(r)}),this.knowledgeResults&&this.knowledgeResults.length>0&&this.knowledgeResults.forEach(s=>{var a,i;let r=(a=s.item)==null?void 0:a.path;if(r&&this.selectedKnowledge.has(r)){let c=((i=r.split("/").pop())==null?void 0:i.replace(/\.md$/,""))||r,l=document.createElement("div");l.className="markdown-next-ai-context-item markdown-next-ai-knowledge-item",l.innerHTML=`
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                            <span class="markdown-next-ai-context-name" title="${r}">${c}</span>
                            <span class="markdown-next-ai-knowledge-score">${(s.score*100).toFixed(0)}%</span>
                            <button class="markdown-next-ai-remove-context" data-type="knowledge" data-path="${r}">\xD7</button>
                        `,t.appendChild(l)}}),t.querySelectorAll(".markdown-next-ai-remove-context").forEach(s=>{s.onclick=r=>{r.stopPropagation();let a=s.getAttribute("data-type"),i=s.getAttribute("data-path");this.removeFromContext(a,i)}})):e.style.display="none"}removeFromContext(e,t){e==="file"?this.selectedContext.files=this.selectedContext.files.filter(n=>n.path!==t):e==="folder"?this.selectedContext.folders=this.selectedContext.folders.filter(n=>n.path!==t):e==="knowledge"&&this.selectedKnowledge.delete(t),this.updateContextDisplay()}clearContext(){this.selectedContext={files:[],folders:[]},this.updateContextDisplay()}async processInlineImages(){var t;if(!this.contextSelector||!this.contextSelector.inputEl)return;let e=this.contextSelector.inputEl.querySelectorAll(".markdown-next-ai-inline-tag");for(let n of Array.from(e)){let o=n.getAttribute("data-type"),s=n.getAttribute("data-path");if(o==="image"&&s)try{let r=this.plugin.app.vault.getAbstractFileByPath(s);if(!r)continue;let a=await this.plugin.app.vault.readBinary(r),i=new Uint8Array(a),c="";for(let v=0;v<i.length;v++)c+=String.fromCharCode(i[v]);let l=btoa(c),p={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",svg:"image/svg+xml"}[((t=r.extension)==null?void 0:t.toLowerCase())||"png"]||"image/png",u=`data:${p};base64,${l}`,h={id:Date.now()+Math.random(),name:r.name,size:a.byteLength,type:p,base64:u,url:u,fromInline:!0};this.imageHandler.getImages().some(v=>v.name===h.name&&v.size===h.size)||this.imageHandler.addImage(h)}catch(r){console.error("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+s,r),new _.Notice("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+s)}}}async getContextContent(){let e="";for(let n of this.selectedContext.files)try{let o=this.plugin.app.vault.getAbstractFileByPath(n.path);if(o){let s=await this.plugin.app.vault.read(o);e+=`

=== \u6587\u6863: ${n.name} ===
${s}`}}catch(o){console.error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:",o)}let t=(n,o)=>{let s=[];if(n&&n.children){for(let r of n.children)if(r.extension==="md")s.push({file:r,sourcePath:r.path,baseFolderName:o});else if(r.children){let a=t(r,o);s.push(...a)}}return s};for(let n of this.selectedContext.folders)try{let o=this.plugin.app.vault.getAbstractFileByPath(n.path);if(o){let s=t(o,n.name);for(let{file:r,sourcePath:a,baseFolderName:i}of s){let c=await this.plugin.app.vault.read(r);e+=`

=== \u6587\u6863: ${r.basename} (\u6765\u81EA\u6587\u4EF6\u5939: ${i}, \u8DEF\u5F84: ${a}) ===
${c}`}}}catch(o){console.error("\u8BFB\u53D6\u6587\u4EF6\u5939\u5931\u8D25:",o)}return e.trim()}};var ae=class{constructor(e,t,n,o,s,r=null){this.isOpen=!1;this.popupEl=null;this.scrollContainer=null;this.app=e,this.editor=t,this.view=n,this.onConfirm=o,this.onReject=s,this.onAppend=r}open(e){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-preview-popup"),this.popupEl.style.minWidth="240px",this.popupEl.style.maxWidth="420px",this.popupEl.innerHTML=`
            <div class="markdown-next-ai-preview-content">
                <div class="markdown-next-ai-preview-header">
                    <div class="markdown-next-ai-preview-status thinking">
                        <span class="status-dot"></span>
                        <span class="status-text">\u6B63\u5728\u601D\u8003\u4E2D</span>
                    </div>
                </div>
                <div class="markdown-next-ai-preview-actions" style="display: none;">
                    <button class="markdown-next-ai-preview-btn confirm" title="\u66FF\u6362\u539F\u6587">\u66FF\u6362</button>
                    ${this.onAppend?'<button class="markdown-next-ai-preview-btn append" title="\u4FDD\u7559\u539F\u6587\u5E76\u8FFD\u52A0">\u8FFD\u52A0</button>':""}
                    <button class="markdown-next-ai-preview-btn reject" title="\u653E\u5F03\u751F\u6210">\u653E\u5F03</button>
                </div>
            </div>
        `;let t=this.popupEl.querySelector(".markdown-next-ai-preview-btn.confirm"),n=this.popupEl.querySelector(".markdown-next-ai-preview-btn.reject"),o=this.popupEl.querySelector(".markdown-next-ai-preview-btn.append");if(t.onclick=()=>{this.onConfirm&&this.onConfirm(),this.close()},o&&(o.onclick=()=>{this.onAppend&&this.onAppend(),this.close()}),n.onclick=()=>{this.onReject&&this.onReject(),this.close()},this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor")),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.popupEl.style.position="absolute",this.scrollContainer.appendChild(this.popupEl)):(this.popupEl.style.position="fixed",document.body.appendChild(this.popupEl)),e){let s=e.top+(e.height||0);this.positionAt(e.left,s,"below")}}positionAt(e,t,n="below"){if(!this.popupEl)return;let o=this.popupEl.getBoundingClientRect(),s=12;if(this.scrollContainer){let r=this.scrollContainer.getBoundingClientRect(),a=this.scrollContainer.scrollTop,i=this.scrollContainer.scrollLeft,c=this.scrollContainer.querySelector(".cm-content"),l=c?c.getBoundingClientRect():r,d=e-r.left+i-o.width/2,p=n==="above"?t-r.top+a-o.height-s:t-r.top+a+s,u=i+8,h=Math.max(u,r.width-o.width+i-8);d=Math.min(Math.max(u,d),h);let w=a+8,v=Math.max(w,r.height-o.height+a-8);p<w&&n==="above"&&(p=t-r.top+a+s),p=Math.min(Math.max(w,p),v),this.popupEl.style.left=d+"px",this.popupEl.style.top=p+"px"}else{let r=window.innerWidth,a=window.innerHeight,i=n==="right"?e+s:e-o.width/2,c=n==="above"?t-o.height-s:t+s;n==="right"&&i+o.width>r-10&&(i=r-o.width-12),n!=="above"&&c+o.height>a-10&&(c=t-o.height-s),i=Math.min(Math.max(10,i),r-o.width-12),c=Math.min(Math.max(10,c),a-o.height-12),this.popupEl.style.left=i+"px",this.popupEl.style.top=c+"px"}this.popupEl.style.right="auto",this.popupEl.style.bottom="auto"}updateStatus(e){if(!this.popupEl)return;let t=this.popupEl.querySelector(".markdown-next-ai-preview-status"),n=this.popupEl.querySelector(".status-text");t&&n&&(n.textContent=e,t.classList.remove("thinking","generating"),e.includes("\u751F\u6210")?t.classList.add("generating"):t.classList.add("thinking"))}showActions(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-preview-status"),t=this.popupEl.querySelector(".markdown-next-ai-preview-actions");e&&(e.style.display="none"),t&&(t.style.display="flex")}close(){this.isOpen&&(this.isOpen=!1,this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null)}};var le=require("obsidian"),ce=class{constructor(e,t,n,o){this.popupEl=null;this.isOpen=!1;this.isDragging=!1;this.markdownComponent=null;this.onInsertCallback=null;this.onReplaceCallback=null;this.onCopyCallback=null;this.onCancelCallback=null;this.app=e,this.view=t,this.modelId=n,this.position=o}open(){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-result-floating-window"),this.popupEl.innerHTML=`
            <div class="result-header">
                <div class="result-header-left">
                    <span class="model-info">\u6A21\u578B: ${this.modelId}</span>
                    <span class="char-count">0 \u5B57</span>
                </div>
                <button class="result-close-btn">\u2715</button>
            </div>
            <div class="result-status thinking">
                <span class="status-dot"></span>
                <span class="status-text">\u6B63\u5728\u601D\u8003\u4E2D</span>
            </div>
            <div class="result-content markdown-preview-view markdown-rendered"></div>
            <div class="result-actions" style="display: none;">
                <button class="btn-insert" title="\u5728\u5149\u6807\u5904\u63D2\u5165">\u63D2\u5165</button>
                <button class="btn-replace" title="\u66FF\u6362\u9009\u4E2D\u6587\u672C">\u66FF\u6362</button>
                <button class="btn-copy" title="\u590D\u5236\u5230\u526A\u8D34\u677F">\u590D\u5236</button>
                <button class="btn-cancel" title="\u53D6\u6D88">\u53D6\u6D88</button>
            </div>
        `,document.body.appendChild(this.popupEl),this.position?(this.popupEl.style.position="fixed",this.popupEl.style.left=this.position.left+"px",this.popupEl.style.top=this.position.top+(this.position.height||20)+10+"px"):(this.popupEl.style.position="fixed",this.popupEl.style.left=window.innerWidth/2-200+"px",this.popupEl.style.top=window.innerHeight/3+"px"),this.enableDragging(),this.markdownComponent=new le.Component;let e=this.popupEl.querySelector(".result-close-btn"),t=this.popupEl.querySelector(".btn-insert"),n=this.popupEl.querySelector(".btn-replace"),o=this.popupEl.querySelector(".btn-copy"),s=this.popupEl.querySelector(".btn-cancel");e==null||e.addEventListener("click",()=>this.close()),t==null||t.addEventListener("click",()=>{this.onInsertCallback&&this.onInsertCallback()}),n==null||n.addEventListener("click",()=>{this.onReplaceCallback&&this.onReplaceCallback()}),o==null||o.addEventListener("click",()=>{this.onCopyCallback&&this.onCopyCallback()}),s==null||s.addEventListener("click",()=>{this.onCancelCallback&&this.onCancelCallback(),this.close()}),(!this.view||!this.view.editor)&&(t&&(t.disabled=!0),n&&(n.disabled=!0))}updateContent(e){if(!this.popupEl)return;let t=this.popupEl.querySelector(".result-content"),n=this.popupEl.querySelector(".char-count");t&&(t.textContent=e),n&&(n.textContent=`${e.length} \u5B57`)}async renderMarkdown(e){var n;if(!this.popupEl)return;let t=this.popupEl.querySelector(".result-content");if(t){if(!e||!e.trim()){t.textContent="";return}this.markdownComponent||(this.markdownComponent=new le.Component),(n=t.empty)==null||n.call(t),t.innerHTML="";try{await le.MarkdownRenderer.render(this.app,e,t,"",this.markdownComponent)}catch(o){console.error("\u6E32\u67D3 Markdown \u5931\u8D25",o),t.textContent=e}}}updateStatus(e){if(!this.popupEl)return;let t=this.popupEl.querySelector(".result-status"),n=this.popupEl.querySelector(".status-text");t&&n&&(n.textContent=e,t.classList.remove("thinking","generating"),e.includes("\u751F\u6210")?t.classList.add("generating"):t.classList.add("thinking"))}showError(e){if(!this.popupEl)return;let t=this.popupEl.querySelector(".result-status"),n=this.popupEl.querySelector(".result-content");if(t){t.classList.add("error");let o=t.querySelector(".status-text");o&&(o.textContent="\u751F\u6210\u5931\u8D25")}n&&(n.textContent=e),this.showActions()}showActions(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".result-status"),t=this.popupEl.querySelector(".result-actions");e&&(e.style.display="none"),t&&(t.style.display="flex")}setOnInsert(e){this.onInsertCallback=e}setOnReplace(e){this.onReplaceCallback=e}setOnCopy(e){this.onCopyCallback=e}setOnCancel(e){this.onCancelCallback=e}close(){if(!this.isOpen||!this.popupEl)return;this.isOpen=!1;let e=this.dragListeners;e&&(e.forEach(({element:t,event:n,handler:o})=>{t.removeEventListener(n,o)}),this.dragListeners=null),this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.markdownComponent&&(this.markdownComponent.unload(),this.markdownComponent=null)}enableDragging(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".result-header");if(!e)return;let t=0,n=0,o=0,s=0,r=p=>{if(p.button!==0||!this.popupEl)return;this.isDragging=!0,t=p.clientX,n=p.clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(o=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},a=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.clientX-t,h=p.clientY-n,w=o+u,v=s+h;this.popupEl.style.transform=`translate(${w}px, ${v}px)`},i=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))},c=p=>{if(!this.popupEl)return;this.isDragging=!0,t=p.touches[0].clientX,n=p.touches[0].clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(o=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},l=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.touches[0].clientX-t,h=p.touches[0].clientY-n,w=o+u,v=s+h;this.popupEl.style.transform=`translate(${w}px, ${v}px)`},d=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))};e.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",i),e.addEventListener("touchstart",c,{passive:!1}),document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",d),this.dragListeners=[{element:e,event:"mousedown",handler:r},{element:document,event:"mousemove",handler:a},{element:document,event:"mouseup",handler:i},{element:e,event:"touchstart",handler:c},{element:document,event:"touchmove",handler:l},{element:document,event:"touchend",handler:d}]}};var we=class extends R.Plugin{constructor(){super(...arguments);this.eventListeners=[];this.atTriggerTimeout=null;this.lastMouseUpPosition=null;this.lastActiveMarkdownView=null}logRoutingTelemetry(t,n){let o={mode:t.mode,confidence:t.confidence,fallback:!!t.appliedFallback,reason:t.reason,hasSelection:!!(n.selectionText&&n.selectionText.trim()),hasReferences:!!((n.additionalContext||"").trim()||(n.contextContent||"").trim()),promptPreview:(n.prompt||"").slice(0,80),cursorProvided:!!n.useCursor,locale:n.locale||""};console.info("[markdown-next-ai][routing]",o)}async decideModeByLLM(t){let n=this.settings.fallbackMode||"chat";if(!this.settings.enableAutoRoutingByLLM)return this.logRoutingTelemetry({mode:n,confidence:0,reason:"auto routing disabled",appliedFallback:!0},t),n;try{let o=await be(t,{aiService:this.aiService,minConfidenceForAuto:this.settings.minConfidenceForAuto,fallbackMode:n});return o.appliedFallback&&new R.Notice(`\u81EA\u52A8\u8DEF\u7531\u4F4E\u7F6E\u4FE1\u5EA6\uFF0C\u5DF2\u56DE\u9000\u4E3A ${o.mode}`),this.logRoutingTelemetry(o,t),o.mode}catch(o){return console.error("\u8DEF\u7531\u5224\u5B9A\u5931\u8D25\uFF0C\u4F7F\u7528\u56DE\u9000\u6A21\u5F0F",o),this.logRoutingTelemetry({mode:n,confidence:0,reason:`routing failed: ${String(o)}`,appliedFallback:!0},t),n}}async onload(){await this.loadSettings(),this.aiService=new ee(this.settings,this.app),this.ruleManager=new ne(this),this.addSettingTab(new fe(this.app,this)),this.addCommands(),this.updateEventListeners(),this.setupLastActiveViewTracker(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u52A0\u8F7D")}onunload(){this.cleanupEventListeners(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u5378\u8F7D")}async loadSettings(){let t=await this.loadData();if(this.settings=Object.assign({},D,t),t&&t.providers){this.settings.providers={...D.providers};for(let n in t.providers)this.settings.providers[n]={...D.providers[n]||{},...t.providers[n]}}if(t&&t.models){this.settings.models={...D.models};for(let n in t.models)typeof t.models[n]!="object"||t.models[n]===null||(this.settings.models[n]={...D.models[n]||{},...t.models[n]})}Array.isArray(this.settings.globalRules)||(this.settings.globalRules=[...D.globalRules]),Array.isArray(this.settings.commonPrompts)||(this.settings.commonPrompts=[...D.commonPrompts]),Array.isArray(this.settings.conversationHistory)||(this.settings.conversationHistory=[]),(!this.settings.conversationHistoryLimit||this.settings.conversationHistoryLimit<=0)&&(this.settings.conversationHistoryLimit=D.conversationHistoryLimit)}async saveSettings(){await this.saveData(this.settings),this.aiService&&this.aiService.updateSettings(this.settings)}getAvailableModels(){return Object.values(this.settings.models).filter(t=>t.enabled).map(t=>({id:t.id,name:t.name,provider:t.provider}))}addCommands(){this.addCommand({id:"open-ai-popup",name:"\u5524\u51FAAI\u5BF9\u8BDD\u6846",hotkeys:[{modifiers:["Alt"],key:"v"}],callback:()=>{try{let t=this.app.workspace.getActiveViewOfType(R.MarkdownView);if(!t||!t.editor)return this.showAtTriggerModalGlobal(""),!0;let n=t.editor.getSelection()||"";return this.showAtTriggerModal(n),!0}catch(t){return console.error("\u5524\u51FAAI\u5BF9\u8BDD\u6846\u547D\u4EE4\u6267\u884C\u9519\u8BEF:",t),new R.Notice("\u547D\u4EE4\u6267\u884C\u5931\u8D25"),!1}}}),this.addCommand({id:"open-ai-popup-global",name:"\u5524\u51FAAI\u5BF9\u8BDD\u6846\uFF08\u5168\u5C40\u6A21\u5F0F\uFF09",hotkeys:[{modifiers:["Ctrl","Shift"],key:"m"}],callback:()=>{var t;try{console.log("[markdown-next-ai] \u6267\u884C\u5168\u5C40\u5BF9\u8BDD\u6846\u547D\u4EE4");let n=((t=window.getSelection())==null?void 0:t.toString().trim())||"";return this.showAtTriggerModalGlobal(n),console.log("[markdown-next-ai] \u5168\u5C40\u5BF9\u8BDD\u6846\u5DF2\u6253\u5F00"),!0}catch(n){return console.error("\u5168\u5C40\u5BF9\u8BDD\u6846\u547D\u4EE4\u6267\u884C\u9519\u8BEF:",n),new R.Notice("\u547D\u4EE4\u6267\u884C\u5931\u8D25: "+String(n)),!1}}})}updateEventListeners(){this.cleanupEventListeners(),this.settings.enableAtTrigger&&this.setupAtTriggerListener(),this.setupPromptTriggerListener(),this.setupRightClickListener();let t=n=>{let o=window.getSelection();if(o&&o.rangeCount>0){let r=o.getRangeAt(0).getBoundingClientRect();(r.width>0||r.height>0)&&(this.lastMouseUpPosition={left:r.right,top:r.top,height:r.height||20})}};document.addEventListener("mouseup",t),this.eventListeners.push({element:document,event:"mouseup",handler:t})}setupLastActiveViewTracker(){this.registerEvent(this.app.workspace.on("active-leaf-change",t=>{(t==null?void 0:t.view)instanceof R.MarkdownView&&(this.lastActiveMarkdownView=t.view)}))}getLastActiveMarkdownView(){return this.getAnyMarkdownView()}getAnyMarkdownView(){let t=this.app.workspace.getActiveViewOfType(R.MarkdownView);if(t)return t;if(this.lastActiveMarkdownView)return this.lastActiveMarkdownView;let n=this.app.workspace.getMostRecentLeaf();if((n==null?void 0:n.view)instanceof R.MarkdownView)return n.view;let o=this.app.workspace.getLeavesOfType("markdown");return o.length>0&&o[0].view instanceof R.MarkdownView?o[0].view:null}setupRightClickListener(){this.registerEvent(this.app.workspace.on("editor-menu",(t,n,o)=>{let s=n.getSelection();s&&s.trim()&&t.addItem(r=>{r.setTitle("Markdown-Next-AI\uFF1A\u4FEE\u6539\u6240\u9009\u5185\u5BB9").setIcon("bot").onClick(()=>{this.showAtTriggerModal(s)})})})),this.settings.enableGlobalDialog&&document.addEventListener("contextmenu",t=>{var o;let n=((o=window.getSelection())==null?void 0:o.toString().trim())||"";n&&!this.isInEditor(t.target)&&this.showGlobalContextMenu(n,t)},!0)}isInEditor(t){return!!(t.closest(".cm-editor")||t.closest(".markdown-source-view")||t.closest(".markdown-preview-view"))}showGlobalContextMenu(t,n){let o=new R.Menu;o.addItem(s=>{s.setTitle("Markdown-Next-AI\uFF1A\u4FEE\u6539\u6240\u9009\u5185\u5BB9").setIcon("bot").onClick(()=>{this.showAtTriggerModalGlobal(t)})}),o.showAtPosition({x:n.clientX,y:n.clientY})}setupPromptTriggerListener(){}showPromptSelectorModal(t){new W(this.app,this,n=>{if(t.contentEditable==="true"){let o=window.getSelection();if(!o||!o.rangeCount)return;let s=o.getRangeAt(0),r=s.startContainer;if(r.nodeType===Node.TEXT_NODE){let a=r.textContent||"",i=s.startOffset,c=a.lastIndexOf("#",i-1);if(c!==-1){let l=a.substring(0,c)+n+a.substring(i);r.textContent=l;let d=c+n.length;try{let p=document.createRange();p.setStart(r,d),p.collapse(!0),o.removeAllRanges(),o.addRange(p)}catch(p){console.error("Failed to set cursor position",p)}}}}else{let o=t,s=o.selectionStart||0,r=o.value,a=r.substring(0,s),i=r.substring(s),c=a.lastIndexOf("#");if(c!==-1){let l=a.substring(0,c)+n;o.value=l+i,o.selectionStart=o.selectionEnd=l.length,o.focus()}}}).open(t)}setupAtTriggerListener(){let t=n=>{if(n.key==="@"||n.shiftKey&&n.key==="2"||n.key==="&"||n.shiftKey&&n.key==="7"){let o=document.activeElement;if(o&&(o.classList.contains("markdown-next-ai-modify-input")||o.classList.contains("markdown-next-ai-continue-input")))return;let s=this.app.workspace.getActiveViewOfType(R.MarkdownView);if(!s||!s.editor)return;this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.atTriggerTimeout=setTimeout(()=>{let r=s.editor.getCursor(),i=s.editor.getLine(r.line).substring(0,r.ch),c=i.charAt(i.length-1);(c==="@"||c==="&")&&!i.endsWith("@@")&&!i.endsWith("&&")&&(this.showAtTriggerModal(),this.atTriggerTimeout=null)},500)}};document.addEventListener("keydown",t),this.eventListeners.push({element:document,event:"keydown",handler:t})}cleanupEventListeners(){this.eventListeners&&(this.eventListeners.forEach(({element:t,event:n,handler:o})=>{t&&o&&(t===this.app.workspace&&typeof t.off=="function"?t.off(n,o):typeof t.removeEventListener=="function"&&t.removeEventListener(n,o))}),this.eventListeners=[])}showAtTriggerModal(t=""){let n=this.app.workspace.getActiveViewOfType(R.MarkdownView),o=this.getCursorPosition(n)||this.lastMouseUpPosition||this.getFallbackPosition(n);if(!o){new R.Notice("\u672A\u627E\u5230\u53EF\u7528\u7684\u5149\u6807\u4F4D\u7F6E\uFF0C\u8BF7\u5148\u70B9\u51FB\u6587\u6863\u533A\u57DF");return}new Q(this.app,(s,r,a,i,c)=>{this.handleContinueWriting(s,r,a,i,c)},o,this,n,t).open()}showAtTriggerModalGlobal(t=""){var s;console.log("[markdown-next-ai] \u8FDB\u5165 showAtTriggerModalGlobal");let n=this.getFallbackPosition(null);console.log("[markdown-next-ai] fallbackPos:",n);let o=t||((s=window.getSelection())==null?void 0:s.toString().trim())||"";console.log("[markdown-next-ai] \u6B63\u5728\u521B\u5EFA AtTriggerPopup (\u5168\u5C40\u6A21\u5F0F\uFF0C\u65E0\u9700\u7F16\u8F91\u5668)"),new Q(this.app,(r,a,i,c,l)=>{let d=l||o;this.settings.useFloatingPreview?this.handleContinueWritingGlobal(r,a,i,c,d):this.handleContinueWriting(r,a,i,c,d)},n,this,null,o).open(),console.log("[markdown-next-ai] AtTriggerPopup \u5DF2\u6253\u5F00")}getCursorPosition(t=null){var s;let n=t!=null?t:this.getAnyMarkdownView(),o=n==null?void 0:n.editor;if(o!=null&&o.somethingSelected()){let r=o.getCursor("from"),a=o.coordsAtPos(r),i=o.getCursor("to"),c=o.coordsAtPos(i);if(a&&c)return{left:a.left,top:c.top,height:c.bottom-c.top}}try{let r=n==null?void 0:n.containerEl.querySelector(".cm-editor"),a=o==null?void 0:o.getCursor(),i=a?o.coordsAtPos(a):null;if(i)return{left:i.left,top:i.top,height:i.bottom-i.top};let c=window.getSelection();if(c&&c.rangeCount>0){let u=c.getRangeAt(0).getBoundingClientRect();if(u.width>0||u.height>0)return{left:u.left,top:u.top,height:u.height||20}}if(this.lastMouseUpPosition)return{...this.lastMouseUpPosition};let l=r==null?void 0:r.getBoundingClientRect();if(l)return{left:l.left+50,top:l.top+50,height:20};let d=(s=n==null?void 0:n.containerEl)==null?void 0:s.getBoundingClientRect();return d?{left:d.left+d.width/2,top:d.top+d.height/3,height:20}:{left:window.innerWidth/2,top:window.innerHeight/3,height:20}}catch(r){return console.error("\u83B7\u53D6\u5149\u6807\u4F4D\u7F6E\u5931\u8D25:",r),null}}getFallbackPosition(t){if(t&&t.containerEl){let n=t.containerEl.getBoundingClientRect();return{left:n.left+n.width/2,top:n.top+n.height/3,height:20}}return{left:window.innerWidth/2,top:window.innerHeight/3,height:20}}async handleContinueWritingGlobal(t="",n=[],o=null,s=null,r=""){var d;let a=this.getAnyMarkdownView();if(!t&&n.length===0&&!s&&!r){new R.Notice("\u8BF7\u8F93\u5165\u7EED\u5199\u8981\u6C42\u6216\u4E0A\u4F20\u56FE\u7247");return}let i="",c=this.getCursorPosition(a)||this.getFallbackPosition(a),l=new ce(this.app,a||null,o||this.settings.currentModel,c);l.open(),l.updateStatus("\u6B63\u5728\u601D\u8003\u4E2D");try{let p=a!=null&&a.editor?a.editor.getValue().substring(0,a.editor.posToOffset(a.editor.getCursor())):"",u=((d=a==null?void 0:a.editor)==null?void 0:d.getCursor())||{line:0,ch:0},h={prompt:t,selectionText:r,cursorBefore:p,cursorAfter:"",useCursor:!0,additionalContext:s||void 0,cursorPosition:u},w=await this.decideModeByLLM(h),v=await this.aiService.sendRequest(w,{selectedText:r,beforeText:p,afterText:"",cursorPosition:u,additionalContext:s||void 0},t,n,[],y=>{y.content!=null&&(i=y.content,l.updateContent(i),l.updateStatus(`\u6B63\u5728\u751F\u6210\u4E2D(${y.content.length}\u5B57)`)),y.isComplete&&(l.showActions(),l.renderMarkdown(i))});!i&&(v!=null&&v.content)&&(i=v.content,l.updateContent(i),l.showActions(),l.renderMarkdown(i)),l.setOnInsert(()=>{this.insertGeneratedContent(a||null,"insert",i,r),l.close()}),l.setOnReplace(()=>{this.insertGeneratedContent(a||null,"replace",i,r),l.close()}),l.setOnCopy(()=>{navigator.clipboard.writeText(i),new R.Notice("\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F")}),await this.recordConversation({prompt:t,response:i,modelId:o||this.settings.currentModel,selectedText:r,contextSnippet:s||void 0})}catch(p){l.showError(`\u751F\u6210\u5931\u8D25: ${p.message}`),console.error("\u5168\u5C40\u5BF9\u8BDD\u751F\u6210\u5931\u8D25",p)}}async insertGeneratedContent(t,n,o,s){if(!t||!t.editor){navigator.clipboard.writeText(o),new R.Notice("\u65E0\u53EF\u7528\u7F16\u8F91\u5668\uFF0C\u5185\u5BB9\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F");return}let r=t.editor,a=s.length>0&&n==="replace";try{if(a)r.replaceSelection(o);else{let i=r.getCursor();r.replaceRange(o,i)}new R.Notice("\u5185\u5BB9\u5DF2\u63D2\u5165"),this.settings.lastInsertAction=n,await this.saveSettings()}catch(i){new R.Notice(`\u63D2\u5165\u5931\u8D25: ${i.message}`),console.error("\u63D2\u5165\u5185\u5BB9\u5931\u8D25",i)}}async handleContinueWriting(t="",n=[],o=null,s=null,r=""){if(this.settings.useFloatingPreview)return this.handleContinueWritingGlobal(t,n,o,s,r);let a=this.app.workspace.getActiveViewOfType(R.MarkdownView);if(!a||!a.editor){new R.Notice("\u8BF7\u5728Markdown\u7F16\u8F91\u5668\u4E2D\u4F7F\u7528\u6B64\u529F\u80FD");return}if(!t&&n.length===0&&!s&&!r){this.showAtTriggerModal();return}let i=a.editor,c=i.getCursor(),l=i.getLine(c.line),d=c.ch>0?l.charAt(c.ch-1):"";if(d==="@"||d==="&"){let A={line:c.line,ch:c.ch-1},T={line:c.line,ch:c.ch};i.replaceRange("",A,T),c.ch=c.ch-1}let p=r.length>0,u=p?i.getCursor("from"):{line:c.line,ch:c.ch},h="markdown-next-ai-preview-"+Date.now(),w="markdown-next-ai-original-"+Date.now(),v=`<span style="background:#90EE90;" data-preview-id="${h}">`,y=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${w}">`,f="</span>";if(p){let A=`${y}${r}${f}${v}${f}`;i.replaceSelection(A)}else i.replaceRange(`${v}${f}`,u);let b;p?b=i.posToOffset(u)+y.length+r.length+f.length+v.length:b=i.posToOffset(u)+v.length;let M=0,I=!1,$="",P=i.coordsAtPos(u),B=P?{left:P.left,top:P.top}:null,H=new ae(this.app,i,a,()=>{let A=i.getValue(),T=`<span style="background:#90EE90;" data-preview-id="${h}">`,L=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${w}">`;if(p){let E=i.getValue(),S=E.indexOf(T);if(S!==-1){let k=S+T.length,C=E.indexOf(f,k);if(C!==-1){let F=C+f.length;i.replaceRange("",i.offsetToPos(C),i.offsetToPos(F)),i.replaceRange("",i.offsetToPos(S),i.offsetToPos(k))}}E=i.getValue();let x=E.indexOf(L);if(x!==-1){let k=x+L.length,C=E.indexOf(f,k);if(C!==-1){let F=C+f.length;i.replaceRange("",i.offsetToPos(x),i.offsetToPos(F)),i.setCursor(i.offsetToPos(x))}}}else{let E=A.indexOf(T);if(E!==-1){let S=E+T.length,x=A.indexOf(f,S);if(x!==-1){let k=x+f.length;i.replaceRange("",i.offsetToPos(x),i.offsetToPos(k)),i.replaceRange("",i.offsetToPos(E),i.offsetToPos(S));let C=x-T.length;i.setCursor(i.offsetToPos(C))}}}new R.Notice("\u5DF2\u66FF\u6362\u539F\u6587")},()=>{let A=i.getValue(),T=`<span style="background:#90EE90;" data-preview-id="${h}">`,L=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${w}">`;if(p){let E=i.getValue(),S=E.indexOf(T);if(S!==-1){let k=S+T.length,C=E.indexOf(f,k);if(C!==-1){let F=C+f.length;i.replaceRange("",i.offsetToPos(S),i.offsetToPos(F))}}E=i.getValue();let x=E.indexOf(L);if(x!==-1){let k=x+L.length,C=E.indexOf(f,k);if(C!==-1){let F=C+f.length;i.replaceRange("",i.offsetToPos(C),i.offsetToPos(F)),i.replaceRange("",i.offsetToPos(x),i.offsetToPos(k)),i.setCursor(i.offsetToPos(x))}}}else{let E=A.indexOf(T);if(E!==-1){let S=E+T.length,x=A.indexOf(f,S);if(x!==-1){let k=x+f.length;i.replaceRange("",i.offsetToPos(E),i.offsetToPos(k)),i.setCursor(i.offsetToPos(E))}}}new R.Notice("\u5DF2\u653E\u5F03\u751F\u6210")},p?()=>{let A=`<span style="background:#90EE90;" data-preview-id="${h}">`,T=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${w}">`,L=i.getValue(),E=L.indexOf(A);if(E!==-1){let x=E+A.length,k=L.indexOf(f,x);if(k!==-1){let C=k+f.length;i.replaceRange("",i.offsetToPos(k),i.offsetToPos(C)),i.replaceRange("",i.offsetToPos(E),i.offsetToPos(x))}}L=i.getValue();let S=L.indexOf(T);if(S!==-1){let x=S+T.length,k=L.indexOf(f,x);if(k!==-1){let C=k+f.length;i.replaceRange("",i.offsetToPos(k),i.offsetToPos(C)),i.replaceRange("",i.offsetToPos(S),i.offsetToPos(x))}}new R.Notice("\u5DF2\u8FFD\u52A0\u5185\u5BB9")}:null);H.open(B);try{let A={prompt:t,selectionText:r,cursorBefore:i.getValue().substring(0,i.posToOffset(u)),cursorAfter:"",useCursor:!0,additionalContext:s||void 0,cursorPosition:c},T=await this.decideModeByLLM(A),L=await this.aiService.sendRequest(T,{selectedText:r,beforeText:i.getValue().substring(0,i.posToOffset(u)),afterText:"",cursorPosition:c,additionalContext:s||void 0},t,n,[],S=>{if(S.content!=null){let x=i.offsetToPos(b),k=i.offsetToPos(b+M);i.replaceRange(S.content,x,k),M=S.content.length,$=S.content;let C=i.offsetToPos(b+M);i.setCursor(C),I=!0,H.updateStatus(`\u6B63\u5728\u751F\u6210\u4E2D(${M}\u5B57)`)}if(S.isComplete){H.showActions();let x=i.offsetToPos(b+M),k=i.coordsAtPos(x);k&&H.positionAt(k.left,k.bottom,"below")}});if(!I&&L&&L.content){let S=i.offsetToPos(b),x=i.offsetToPos(b+M);i.replaceRange(L.content,S,x),M=L.content.length,$=L.content;let k=i.offsetToPos(b+M);i.setCursor(k),H.showActions();let C=i.offsetToPos(b+M),F=i.coordsAtPos(C);F&&H.positionAt(F.left,F.bottom,"below")}let E=$||L&&L.content||"";if(E.trim()){let S=s||"";await this.recordConversation({prompt:t,response:E,modelId:o||this.settings.currentModel,contextSnippet:S,selectedText:r})}}catch(A){let T=`<span style="background:#90EE90;" data-preview-id="${h}">`,L=`<span style="background:#FFCCCB;text-decoration:line-through;" data-original-id="${w}">`;if(p){let E=i.getValue(),S=E.indexOf(T);if(S!==-1){let k=S+T.length,C=E.indexOf(f,k);if(C!==-1){let F=C+f.length;i.replaceRange("",i.offsetToPos(S),i.offsetToPos(F))}}E=i.getValue();let x=E.indexOf(L);if(x!==-1){let k=x+L.length,C=E.indexOf(f,k);if(C!==-1){let F=C+f.length;i.replaceRange("",i.offsetToPos(C),i.offsetToPos(F)),i.replaceRange("",i.offsetToPos(x),i.offsetToPos(k))}}}else{let E=i.getValue(),S=E.indexOf(T);if(S!==-1){let x=S+T.length,k=E.indexOf(f,x);if(k!==-1){let C=k+f.length;i.replaceRange("",i.offsetToPos(S),i.offsetToPos(C))}}}i.setCursor(u),H.close(),new R.Notice("\u7EED\u5199\u5931\u8D25: "+A.message)}}async recordConversation(t){this.settings.conversationHistory||(this.settings.conversationHistory=[]);let n=this.settings.conversationHistoryLimit||D.conversationHistoryLimit||50,o=(t.contextSnippet||"").slice(0,4e3),s={id:`conv-${Date.now()}`,timestamp:Date.now(),...t,contextSnippet:o};this.settings.conversationHistory.push(s),this.settings.conversationHistory.length>n&&(this.settings.conversationHistory=this.settings.conversationHistory.slice(-n)),await this.saveSettings()}};
