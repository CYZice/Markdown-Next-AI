var J=Object.defineProperty;var ot=Object.getOwnPropertyDescriptor;var lt=Object.getOwnPropertyNames;var at=Object.prototype.hasOwnProperty;var rt=(O,e)=>{for(var t in e)J(O,t,{get:e[t],enumerable:!0})},ct=(O,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of lt(e))!at.call(O,i)&&i!==t&&J(O,i,{get:()=>e[i],enumerable:!(n=ot(e,i))||n.enumerable});return O};var dt=O=>ct(J({},"__esModule",{value:!0}),O);var pt={};rt(pt,{default:()=>Y});module.exports=dt(pt);var N=require("obsidian");var A={THINKING:"thinking",VISION:"vision",MULTIMODAL:"multimodal",TEXT:"text",IMAGE:"image"},it={continue:"\u4F60\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u5199\u4F5C\u52A9\u624B\u3002\u8BF7\u6839\u636E\u7528\u6237\u63D0\u4F9B\u7684\u4E0A\u4E0B\u6587\uFF0C\u4ECE\u5149\u6807\u4F4D\u7F6E\u5F00\u59CB\u7EED\u5199\u540E\u7EED\u5185\u5BB9\u3002\u91CD\u8981\uFF1A\u53EA\u751F\u6210\u65B0\u7684\u5185\u5BB9\uFF0C\u4E0D\u8981\u91CD\u590D\u6216\u91CD\u5199\u5DF2\u6709\u7684\u5185\u5BB9\u3002"},Z={IMAGE:["png","jpg","jpeg","gif","bmp","svg","webp"],DOCUMENT:["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"]},Q={MAX_FILE_SIZE:10485760,ALLOWED_TYPES:["image/jpeg","image/png","image/gif","image/webp"]};var B={providers:{openai:{apiKey:"",baseUrl:"https://api.openai.com/v1",enabled:!0}},models:{"gemini-3-pro-preview":{id:"gemini-3-pro-preview",name:"Gemini 3 Pro Preview",provider:"openai",model:"gemini-3-pro-preview",enabled:!0,category:A.MULTIMODAL},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",name:"Gemini 3 Flash Preview",provider:"openai",model:"gemini-3-flash-preview",enabled:!0,category:A.MULTIMODAL},"gpt-5":{id:"gpt-5",name:"GPT-5",provider:"openai",model:"gpt-5",enabled:!0,category:A.MULTIMODAL}},currentModel:"gemini-3-flash-preview",timeout:3e4,enableRightClick:!0,enableAtTrigger:!0,maxTokens:5e3,maxContextLines:20,maxContextChars:3e3,globalRules:[],ruleTemplates:[],enableGlobalRules:!0,commonPrompts:[{id:"expand",name:"\u6269\u5C55\u5185\u5BB9",content:"\u8BF7\u6269\u5C55\u8FD9\u6BB5\u5185\u5BB9\uFF0C\u589E\u52A0\u66F4\u591A\u7EC6\u8282\u548C\u4F8B\u5B50"},{id:"summarize",name:"\u603B\u7ED3\u6982\u62EC",content:"\u8BF7\u603B\u7ED3\u8FD9\u6BB5\u5185\u5BB9\u7684\u8981\u70B9"},{id:"improve",name:"\u6539\u8FDB\u6587\u672C",content:"\u8BF7\u6539\u8FDB\u8FD9\u6BB5\u6587\u672C\u7684\u8868\u8FBE\u548C\u903B\u8F91"},{id:"translate",name:"\u7FFB\u8BD1",content:"\u8BF7\u5C06\u8FD9\u6BB5\u5185\u5BB9\u7FFB\u8BD1\u6210\u82F1\u6587"},{id:"continue",name:"\u7EE7\u7EED\u5199\u4F5C",content:"\u8BF7\u6839\u636E\u4E0A\u4E0B\u6587\u7EE7\u7EED\u5199\u4F5C\uFF0C\u4FDD\u6301\u98CE\u683C\u4E00\u81F4"}]};var $=require("obsidian");var U=class{constructor(e,t){this.requestQueue=[];this.isProcessing=!1;this.settings=e,this.app=t}updateSettings(e){this.settings=e}getCurrentModelConfig(){if(this.settings.apiKey&&this.settings.baseUrl&&this.settings.model)return{apiKey:this.settings.apiKey,baseUrl:this.settings.baseUrl,model:this.settings.model};let e=this.settings.currentModel;if(!e)throw new Error("\u672A\u9009\u62E9\u5F53\u524D\u6A21\u578B");let t=this.settings.models[e];if(!t||!t.enabled)throw new Error(`\u6A21\u578B ${e} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);let n=this.settings.providers[t.provider];if(!n||!n.enabled)throw new Error(`\u4F9B\u5E94\u5546 ${t.provider} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);return{apiKey:n.apiKey,baseUrl:n.baseUrl,model:t.actualModel||t.model||t.id}}isVisionModel(e){let t=this.settings.currentModel,n=this.settings.models[t];if(!n)return!1;let i=n.category;return!i&&n.type&&(i=n.type==="image"?A.IMAGE:A.TEXT),i===A.VISION}isThinkingModel(e=null){let t=this.settings.currentModel,n=this.settings.models[t];if(!n)return!1;let i=n.category;return!i&&n.type&&(i=n.type==="image"?A.IMAGE:A.TEXT),i===A.THINKING}normalizeBaseUrl(e){return e?e.replace(/\/$/,""):""}buildApiUrl(e){let t=this.getCurrentModelConfig(),n=this.normalizeBaseUrl(t.baseUrl),i=n.includes("api.openai.com");return n.endsWith("/v1")?`${n}${e}`:!i&&(n.includes("/chat/completions")||n.includes("/images/generations"))?`${n.split("/chat/completions")[0].split("/images/generations")[0]}${e}`:`${n}/v1${e}`}getMaxTokens(e){return this.settings.maxTokens||B.maxTokens}async sendRequest(e,t,n="",i=[],o=[],a=null){let l=this.getCurrentModelConfig();if(!l.apiKey)throw new Error("\u8BF7\u5148\u914D\u7F6EAPI Key");let s=this.settings.currentModel,c=this.settings.models[s],r=c==null?void 0:c.category;if(!r&&c&&(c.type==="image"?r=A.IMAGE:r=A.TEXT,c.category=r),r===A.IMAGE){if(e==="continue"&&t.selectedText&&t.selectedText.trim())throw new Error("\u4E0D\u652F\u6301\u56FE\u7247\u751F\u6210\u6A21\u578B\uFF0C\u8BF7\u9009\u62E9\u6587\u672C\u751F\u6210\u6A21\u578B\u8FDB\u884C\u6587\u672C\u4FEE\u6539\u3002");return this.handleImageGeneration(n,l,t.cursorPosition)}let d=r===A.THINKING||this.isThinkingModel(l.model),p=a&&typeof a=="function",g=r===A.MULTIMODAL,x=r===A.VISION||this.isVisionModel(l.model);i&&i.length>0&&!(g||x)&&(new $.Notice(`\u5F53\u524D\u6A21\u578B ${l.model} \u4E0D\u652F\u6301\u56FE\u7247\u548C\u9644\u4EF6\uFF0C\u8BF7\u5207\u6362\u5230\u591A\u6A21\u6001\u6A21\u578B\u6216\u89C6\u89C9\u6A21\u578B`),i=[]);let T=it[e]||"";if(this.settings.enableGlobalRules&&this.settings.globalRules&&this.settings.globalRules.length>0){let h=this.settings.globalRules.filter(y=>y.enabled!==!1).sort((y,H)=>(H.priority||0)-(y.priority||0));if(h.length>0){let y=h.map(H=>H.content).join(`
`);T+=`

\u5168\u5C40\u89C4\u5219\uFF08\u8BF7\u4E25\u683C\u9075\u5FAA\u4EE5\u4E0B\u89C4\u5219\uFF09\uFF1A
`+y}}let E="";e==="continue"?t.selectedText&&t.selectedText.trim()?E=`\u9700\u8981\u4FEE\u6539\u7684\u5B8C\u6574\u5185\u5BB9\uFF1A${t.selectedText}

\u4FEE\u6539\u8981\u6C42\uFF1A${n}`:E=`\u4EE5\u4E0B\u662F\u5149\u6807\u524D\u7684\u4E0A\u4E0B\u6587\u5185\u5BB9\uFF1A
${t.beforeText}

\u8BF7\u4ECE\u5149\u6807\u4F4D\u7F6E\u5F00\u59CB\u7EED\u5199\uFF0C\u53EA\u751F\u6210\u65B0\u5185\u5BB9\uFF0C\u4E0D\u8981\u91CD\u590D\u4E0A\u8FF0\u5185\u5BB9\u3002\u7EED\u5199\u8981\u6C42\uFF1A${n}`:(E=`\u4E0A\u4E0B\u6587\uFF1A${t.beforeText}

\u9009\u4E2D\u6587\u672C\uFF1A${t.selectedText}

\u540E\u7EED\u5185\u5BB9\uFF1A${t.afterText}`,n&&(E+=`

\u7279\u6B8A\u8981\u6C42\uFF1A${n}`)),t.additionalContext&&t.additionalContext.trim()&&(E+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u5FC5\u987B\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${t.additionalContext}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`),t.contextContent&&t.contextContent.trim()&&(E+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u5FC5\u987B\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${t.contextContent}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`);let C=this.buildApiUrl("/chat/completions"),m=[{role:"system",content:T}];if(o&&o.length>0&&o.forEach(h=>{(h.role==="user"||h.role==="assistant")&&m.push({role:h.role,content:h.content})}),i&&i.length>0){E+=`

\u9644\u52A0\u56FE\u7247\uFF1A\u5171${i.length}\u5F20\u56FE\u7247`;let h=[{type:"text",text:E}];i.forEach(y=>{h.push({type:"image_url",image_url:{url:y.base64||y.url}})}),m.push({role:"user",content:h})}else m.push({role:"user",content:E});let f={model:l.model,messages:m,temperature:.7,max_tokens:this.getMaxTokens(e)};p&&(f.stream=!0);try{let h={"Content-Type":"application/json",Authorization:`Bearer ${l.apiKey}`};if(p)return await this.handleStreamRequest(C,h,f,a);let y=await(0,$.requestUrl)({url:C,method:"POST",headers:h,body:JSON.stringify(f),throw:!1});if(y.status!==200){let k=y.text;throw y.status===429?k.includes("quota")||k.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${y.status} ${k}`)}let H=y.json;if(!H.choices||H.choices.length===0)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11choices\u6570\u7EC4");let R=H.choices[0];if(!R.message)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11message\u5BF9\u8C61");let I="";if(R.message.content)I=R.message.content.trim();else if(R.text)I=R.text.trim();else if(R.message.text)I=R.message.text.trim();else throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u627E\u4E0D\u5230\u5185\u5BB9\u5B57\u6BB5");let L=H.usage||{};return{content:I,usage:L}}catch(h){throw h}}async handleStreamRequest(e,t,n,i){var o,a;try{let l=await fetch(e,{method:"POST",headers:t,body:JSON.stringify(n)});if(!l.ok){let x=await l.text();throw l.status===429?x.includes("quota")||x.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${l.status} ${x}`)}let s=l.body.getReader(),c=new TextDecoder,r="",d="",p="",g="";try{for(;;){let{done:x,value:T}=await s.read();if(x)break;r+=c.decode(T,{stream:!0});let E=r.split(`
`);r=E.pop()||"";for(let C of E)if(C.startsWith("data: ")){let m=C.slice(6);if(m==="[DONE]")break;try{let h=(a=(o=JSON.parse(m).choices)==null?void 0:o[0])==null?void 0:a.delta;if(h!=null&&h.reasoning_content){let y=h.reasoning_content;d+=y,g+=y,i({content:p,thinking:d,fullContent:g,isComplete:!1})}if(h!=null&&h.content){let y=h.content;p+=y,g+=y,i({content:p,thinking:d,fullContent:g,isComplete:!1})}if(h!=null&&h.text){let y=h.text;p+=y,g+=y,i({content:p,thinking:d,fullContent:g,isComplete:!1})}}catch(f){}}}return i({content:p,thinking:d,fullContent:g,isComplete:!0}),{content:p.trim(),thinking:d.trim(),usage:{}}}finally{s.releaseLock()}}catch(l){throw l}}async handleImageGeneration(e,t,n=null){if(!e||!e.trim())throw new Error("\u8BF7\u8F93\u5165\u56FE\u7247\u63CF\u8FF0");let i=this.buildApiUrl("/images/generations"),o=t.model,a={model:o,prompt:e.trim(),response_format:"b64_json",n:1,size:this.settings.imageGenerationSize||"1024x1024"};o.includes("dall-e")&&o==="dall-e-3"&&(a.quality="standard",a.style="vivid");try{let l=await(0,$.requestUrl)({url:i,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify(a),throw:!1});if(l.status!==200){let d=l.text;throw l.status===429?d.includes("quota")||d.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):l.status===401?new Error("API\u5BC6\u94A5\u65E0\u6548\uFF0C\u8BF7\u68C0\u67E5\u914D\u7F6E\u3002"):new Error(`\u56FE\u7247\u751F\u6210API\u8BF7\u6C42\u5931\u8D25: ${l.status} ${d}`)}let s=l.json;if(!s.data||!Array.isArray(s.data)||s.data.length===0)throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let c=s.data[0],r=null;if(c.b64_json)r=c.b64_json;else throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u4E2D\u7F3A\u5C11\u56FE\u7247\u5185\u5BB9");try{let d=`image_${Date.now()}.png`,p=this.settings.imageSavePath||"Extras/\u9644\u4EF6",g=p+"/"+d;try{this.app.vault.getAbstractFileByPath(p)||await this.app.vault.createFolder(p)}catch(f){try{await this.app.vault.adapter.mkdir(p)}catch(h){throw new Error(`\u65E0\u6CD5\u521B\u5EFA\u76EE\u5F55 ${p}: ${h.message}`)}}let x=atob(r||""),T=new Uint8Array(x.length);for(let f=0;f<x.length;f++)T[f]=x.charCodeAt(f);await this.app.vault.createBinary(g,T.buffer);let E=this.settings.imageSize||300,C=!0;n&&n.ch>0&&(C=!1);let m;return C?m=`![Generated Image|${E}](${g})`:m=`<span class="image-mask-rounded-R" style="width: 200px; height: 200px;"><img src="${g}" alt="" style="width: 100%; height: 100%; object-fit: cover;"></span>`,{content:m,imageData:{filePath:g,format:"png",prompt:e},usage:s.usage||{}}}catch(d){throw new Error("\u56FE\u7247\u4FDD\u5B58\u5931\u8D25: "+d.message)}}catch(l){throw l}}getAvailableImageModels(){let e=[];for(let[t,n]of Object.entries(this.settings.models))n.type==="image"&&n.enabled&&e.push(n.name||t);return e}async testConnection(){try{let e=this.getCurrentModelConfig(),t=this.buildApiUrl("/chat/completions"),n=await(0,$.requestUrl)({url:t,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:"hi"}],max_tokens:5})});return n.status===200?{success:!0}:{success:!1,message:`HTTP ${n.status}: ${n.text}`}}catch(e){return{success:!1,message:e.message}}}};var W=require("obsidian");var G=class{constructor(){this.images=[];this.maxFileSize=Q.MAX_FILE_SIZE;this.allowedTypes=Q.ALLOWED_TYPES}handlePaste(e,t){var i;let n=(i=e.clipboardData)==null?void 0:i.items;if(n)for(let o=0;o<n.length;o++){let a=n[o];if(a.type.indexOf("image")!==-1){e.preventDefault();let l=a.getAsFile();l&&this.processImageFile(l,t);break}}}handleFileSelect(e,t){for(let n of Array.from(e))this.allowedTypes.includes(n.type)?this.processImageFile(n,t):new W.Notice("\u4E0D\u652F\u6301\u7684\u6587\u4EF6\u7C7B\u578B: "+n.type)}processImageFile(e,t){if(e.size>this.maxFileSize){new W.Notice("\u56FE\u7247\u6587\u4EF6\u8FC7\u5927\uFF0C\u8BF7\u9009\u62E9\u5C0F\u4E8E10MB\u7684\u56FE\u7247");return}let n=new FileReader;n.onload=i=>{var l;let o=(l=i.target)==null?void 0:l.result,a={id:String(Date.now()+Math.random()),name:e.name,size:e.size,type:e.type,base64:o,url:o};this.images.push(a),t&&t(a)},n.onerror=()=>{new W.Notice("\u8BFB\u53D6\u56FE\u7247\u5931\u8D25")},n.readAsDataURL(e)}removeImage(e,t){this.images=this.images.filter(n=>n.id!==e),t&&t(e)}getImages(){return this.images}addImage(e){this.images.push(e)}clearImages(){this.images=[]}createImagePreview(e,t){let n=document.createElement("div");n.className="markdown-next-ai-image-preview",n.setAttribute("data-image-id",String(e.id)),n.innerHTML=`
            <div class="markdown-next-ai-image-container">
                <img src="${e.url}" alt="${e.name}" class="markdown-next-ai-preview-img">
                <button class="markdown-next-ai-remove-image" title="\u5220\u9664\u56FE\u7247">\u2715</button>
            </div>
            <div class="markdown-next-ai-image-info">
                <span class="markdown-next-ai-image-name">${e.name}</span>
                <span class="markdown-next-ai-image-size">${this.formatFileSize(e.size)}</span>
            </div>
        `;let i=n.querySelector(".markdown-next-ai-remove-image");return i.onclick=o=>{o.stopPropagation(),this.removeImage(String(e.id),()=>{t&&t()}),n.remove()},n}formatFileSize(e){if(e===0)return"0 Bytes";let t=1024,n=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(2))+" "+n[i]}};var K=class{constructor(e){this.plugin=e}getRules(){return this.plugin.settings.globalRules||[]}getActiveRules(){return this.getRules().filter(e=>e.enabled!==!1)}async addRule(e){let t={id:this.generateRuleId(),name:e.name||"\u65B0\u89C4\u5219",content:e.content||"",description:e.description||"",category:e.category||"custom",priority:e.priority||0,enabled:e.enabled!==!1,createdAt:Date.now(),updatedAt:Date.now()};return this.plugin.settings.globalRules||(this.plugin.settings.globalRules=[]),this.plugin.settings.globalRules.push(t),await this.plugin.saveSettings(),t}async updateRule(e,t){let n=this.getRules(),i=n.findIndex(o=>o.id===e);if(i===-1)throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728");return n[i]={...n[i],...t,updatedAt:Date.now()},await this.plugin.saveSettings(),n}async deleteRule(e){let t=this.getRules(),n=t.findIndex(i=>i.id===e);if(n===-1)throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728");t.splice(n,1),await this.plugin.saveSettings()}async toggleRule(e){let t=this.getRules().find(n=>n.id===e);if(t)return t.enabled=!t.enabled,t.updatedAt=Date.now(),await this.plugin.saveSettings(),t;throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728")}async createFromTemplate(e){let t=(this.plugin.settings.ruleTemplates||[]).find(n=>n.id===e);if(t)return this.addRule({name:t.name,content:t.content,description:t.description,category:t.category});throw new Error("\u6A21\u677F\u4E0D\u5B58\u5728")}getTemplates(){return this.plugin.settings.ruleTemplates||[]}getTemplatesByCategory(e){return this.getTemplates().filter(t=>t.category===e)}generateRuleId(){return"rule_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}exportRules(){return{version:"1.0",exportedAt:Date.now(),rules:this.getRules()}}async importRules(e){if(!e||!e.rules||!Array.isArray(e.rules))throw new Error("\u5BFC\u5165\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let t=0;for(let n of e.rules)try{await this.addRule(n),t++}catch(i){console.error("\u5BFC\u5165\u89C4\u5219\u5931\u8D25",i)}return t}};var u=require("obsidian");var X=class extends u.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"MarkdownNext AI \u8BBE\u7F6E"}),e.createEl("h3",{text:"\u4F9B\u5E94\u5546\u3001API\u8BBE\u7F6E"}),e.createEl("p",{text:"APIKey\uFF1A\u9700\u5728\u4F9B\u5E94\u5546API\u5BC6\u94A5\u4E2D\u8BBE\u7F6EAPIKey",attr:{style:"color: var(--text-muted); margin-bottom: 5px;"}}),e.createEl("p",{text:"Base URL\uFF1A\u9009\u586B\u7B2C\u4E09\u65B9URL\uFF0C\u4F7F\u7528openai\u517C\u5BB9\u683C\u5F0F",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}});let t=e.createEl("table",{cls:"markdown-next-ai-config-table"}),n=t.createEl("thead").createEl("tr");n.createEl("th",{text:"ID"}),n.createEl("th",{text:"Type"}),n.createEl("th",{text:"API Key"}),n.createEl("th",{text:"Get API keys"}),n.createEl("th",{text:"Actions"});let i=t.createEl("tbody");Object.keys(this.plugin.settings.providers).forEach(r=>{let d=this.plugin.settings.providers[r],p=i.createEl("tr");p.createEl("td",{text:r}),p.createEl("td",{text:d.type||"openai"});let g=p.createEl("td",{cls:"markdown-next-ai-api-key-cell"});d.apiKey&&d.apiKey.trim()&&g.createEl("span",{text:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",attr:{style:"color: var(--text-muted); margin-right: 8px;"}});let x=g.createEl("button",{cls:"markdown-next-ai-settings-btn",attr:{title:"\u8BBE\u7F6EAPI Key"}});x.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',x.onclick=()=>this.showApiKeyModal(r);let T=p.createEl("td",{attr:{style:"text-align: left;"}}),C={openai:"https://platform.openai.com/api-keys",anthropic:"https://console.anthropic.com/",gemini:"https://aistudio.google.com/app/apikey",ollama:"https://ollama.com/"}[r]||this.plugin.settings.apiKeyLinks&&this.plugin.settings.apiKeyLinks[r];C?T.createEl("a",{text:"\u83B7\u53D6API Key",attr:{href:C,target:"_blank",style:"color: var(--text-accent); text-decoration: underline; font-size: 0.9em;"}}):T.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});let m=p.createEl("td",{cls:"markdown-next-ai-actions-cell"});if(["openai","anthropic","gemini","deepseek","ollama"].includes(r))m.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});else{let f=m.createEl("button",{text:"\u7F16\u8F91"});f.onclick=()=>this.showEditProviderModal(r);let h=m.createEl("button",{text:"\u5220\u9664"});h.onclick=async()=>{confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4F9B\u5E94\u5546 "${r}" \uFF1F\u8FD9\u5C06\u540C\u65F6\u5220\u9664\u8BE5\u4F9B\u5E94\u5546\u4E0B\u7684\u6240\u6709\u6A21\u578B\u3002`)&&(Object.keys(this.plugin.settings.models).forEach(y=>{this.plugin.settings.models[y].provider===r&&delete this.plugin.settings.models[y]}),delete this.plugin.settings.providers[r],await this.plugin.saveSettings(),this.display())}}}),e.createEl("div",{attr:{style:"margin-top: 15px; margin-bottom: 20px;"}}).createEl("button",{text:"+ \u6DFB\u52A0\u4F9B\u5E94\u5546",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;"}}).onclick=()=>this.showAddProviderModal();let o=e.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px;"}});o.createEl("h3",{text:"\u6A21\u578B\u8BBE\u7F6E",attr:{style:"margin: 0;"}}),o.createEl("button",{text:"+ \u6DFB\u52A0\u6A21\u578B",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;"}}).onclick=()=>this.showAddModelModal();let a=e.createEl("table",{cls:"markdown-next-ai-config-table"}),l=a.createEl("thead").createEl("tr");l.createEl("th",{text:"ID"}),l.createEl("th",{text:"Provider"}),l.createEl("th",{text:"Model"}),l.createEl("th",{text:"Enable"}),l.createEl("th",{text:"Actions"});let s=a.createEl("tbody"),c=Object.values(this.plugin.settings.models);if(c.length>0?c.forEach(r=>{let d=s.createEl("tr");d.createEl("td",{text:r.id}),d.createEl("td",{text:r.provider}),d.createEl("td",{text:r.name});let g=d.createEl("td",{cls:"markdown-next-ai-enable-cell"}).createEl("input",{type:"checkbox"});g.checked=r.enabled,g.onchange=async()=>{if(this.plugin.settings.models[r.id].enabled=g.checked,await this.plugin.saveSettings(),!g.checked&&this.plugin.settings.currentModel===r.id){let C=Object.keys(this.plugin.settings.models).find(m=>this.plugin.settings.models[m].enabled);C&&(this.plugin.settings.currentModel=C,await this.plugin.saveSettings(),this.display())}};let x=d.createEl("td",{cls:"markdown-next-ai-actions-cell"}),T=x.createEl("button",{text:"\u7F16\u8F91"});T.onclick=()=>this.showEditModelModal(r.id);let E=x.createEl("button",{text:"\u5220\u9664"});E.onclick=async()=>{if(confirm(`\u786E\u5B9A\u8981\u5220\u9664\u6A21\u578B "${r.name}" \uFF1F`)){if(this.plugin.settings.currentModel===r.id){let C=Object.keys(this.plugin.settings.models).find(m=>m!==r.id&&this.plugin.settings.models[m].enabled);this.plugin.settings.currentModel=C||""}delete this.plugin.settings.models[r.id],await this.plugin.saveSettings(),this.display()}}}):s.createEl("tr").createEl("td",{text:"\u6682\u65E0\u6A21\u578B\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{colspan:"5",style:"text-align: center; color: var(--text-muted); font-style: italic; padding: 20px;"}}),new u.Setting(e).setName("\u5F53\u524D\u6A21\u578B").setDesc("\u9009\u62E9\u5F53\u524D\u4F7F\u7528\u7684AI\u6A21\u578B").addDropdown(r=>{let d=Object.keys(this.plugin.settings.models).filter(p=>this.plugin.settings.models[p].enabled);d.forEach(p=>{let g=this.plugin.settings.models[p];r.addOption(p,`${g.name} (${g.provider})`)}),!d.includes(this.plugin.settings.currentModel)&&d.length>0&&(this.plugin.settings.currentModel=d[0],this.plugin.saveSettings()),r.setValue(this.plugin.settings.currentModel||"").onChange(async p=>{this.plugin.settings.currentModel=p,await this.plugin.saveSettings()})}),new u.Setting(e).setName("\u6D4B\u8BD5API\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u5F53\u524DAPI\u914D\u7F6E\u662F\u5426\u6B63\u5E38").addButton(r=>r.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{r.setButtonText("\u6D4B\u8BD5\u4E2D...");try{let d=await this.plugin.aiService.testConnection();d.success?new u.Notice("\u2705 API\u8FDE\u63A5\u6210\u529F"):new u.Notice("\u274C API\u8FDE\u63A5\u5931\u8D25: "+d.message)}catch(d){new u.Notice("\u274C \u6D4B\u8BD5\u5931\u8D25: "+d.message)}finally{r.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5")}})),new u.Setting(e).setName("\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4").setDesc("API\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4\uFF08\u6BEB\u79D2\uFF09").addText(r=>r.setPlaceholder("30000").setValue(String(this.plugin.settings.timeout)).onChange(async d=>{let p=parseInt(d)||3e4;this.plugin.settings.timeout=p,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u529F\u80FD\u8BBE\u7F6E"}),new u.Setting(e).setName("\u542F\u7528\u53F3\u952E\u83DC\u5355").setDesc("\u5728\u9009\u4E2D\u6587\u672C\u65F6\u663E\u793AAI\u5904\u7406\u9009\u9879").addToggle(r=>r.setValue(this.plugin.settings.enableRightClick).onChange(async d=>{this.plugin.settings.enableRightClick=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new u.Setting(e).setName("\u542F\u7528@\u6216&\u7B26\u53F7\u89E6\u53D1").setDesc("\u8F93\u5165@\u6216&\u7B26\u53F7\u65F6\u547C\u51FA\u7EED\u5199\u5BF9\u8BDD\u6846").addToggle(r=>r.setValue(this.plugin.settings.enableAtTrigger).onChange(async d=>{this.plugin.settings.enableAtTrigger=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),e.createEl("h3",{text:"\u5168\u5C40\u89C4\u5219\u8BBE\u7F6E"}),e.createEl("p",{text:"\u5168\u5C40\u89C4\u5219\u4F1A\u81EA\u52A8\u5E94\u7528\u5230\u6240\u6709AI\u8BF7\u6C42\u4E2D\uFF0C\u6BCF\u6B21\u5BF9\u8BDD\u90FD\u9700\u8981\u9075\u5FAA\u5168\u5C40\u89C4\u5219",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new u.Setting(e).setName("\u542F\u7528\u5168\u5C40\u89C4\u5219").setDesc("\u5F00\u542F\u540E\uFF0C\u5168\u5C40\u89C4\u5219\u5C06\u81EA\u52A8\u5E94\u7528\u5230\u6240\u6709AI\u8BF7\u6C42\u4E2D").addToggle(r=>r.setValue(this.plugin.settings.enableGlobalRules).onChange(async d=>{this.plugin.settings.enableGlobalRules=d,await this.plugin.saveSettings()})),new u.Setting(e).setName("\u7BA1\u7406\u5168\u5C40\u89C4\u5219").setDesc("\u6DFB\u52A0\u3001\u7F16\u8F91\u548C\u7BA1\u7406\u5168\u5C40\u89C4\u5219").addButton(r=>r.setButtonText("\u6253\u5F00\u89C4\u5219\u7BA1\u7406\u5668").onClick(()=>this.showRuleManager())),new u.Setting(e).setName("\u6700\u5927Token\u6570").setDesc("AI\u751F\u6210\u6587\u672C\u7684\u6700\u5927\u957F\u5EA6\u9650\u5236").addText(r=>r.setPlaceholder("5000").setValue(String(this.plugin.settings.maxTokens)).onChange(async d=>{let p=parseInt(d)||5e3;p>0?(this.plugin.settings.maxTokens=p,await this.plugin.saveSettings()):new u.Notice("Token\u6570\u5FC5\u987B\u4E3A\u6B63\u6574\u6570")})),e.createEl("h3",{text:"\u5E38\u7528\u63D0\u793A\u8BCD\u7BA1\u7406"}),e.createEl("p",{text:"\u7BA1\u7406\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u53EF\u5728\u8F93\u5165\u6846\u4E2D\u4F7F\u7528#\u7B26\u53F7\u5FEB\u901F\u8C03\u7528",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new u.Setting(e).setName("\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u5E38\u7528\u63D0\u793A\u8BCD").addButton(r=>r.setButtonText("\u6DFB\u52A0\u63D0\u793A\u8BCD").onClick(()=>this.showPromptModal())),this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts.length>0){let r=e.createEl("div",{attr:{style:"margin-top: 15px;"}});this.plugin.settings.commonPrompts.forEach((d,p)=>{let g=r.createEl("div",{attr:{style:"display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary);"}}),x=g.createEl("div",{attr:{style:"flex: 1;"}});x.createEl("div",{text:d.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD",attr:{style:"font-weight: bold; margin-bottom: 4px;"}}),x.createEl("div",{text:d.content&&d.content.length>100?d.content.substring(0,100)+"...":d.content||"",attr:{style:"color: var(--text-muted); font-size: 0.7em;"}});let T=g.createEl("div",{attr:{style:"display: flex; gap: 8px;"}});T.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--background-modifier-border); background: var(--background-primary); color: var(--text-normal); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.showPromptModal(p),T.createEl("button",{text:"\u5220\u9664",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--text-error); background: var(--background-primary); color: var(--text-error); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.deletePrompt(p)})}else e.createEl("p",{text:"\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{style:"color: var(--text-muted); font-style: italic; margin-top: 15px;"}})}showPromptModal(e=null){let t=new u.Modal(this.app);t.titleEl.setText(e!==null?"\u7F16\u8F91\u63D0\u793A\u8BCD":"\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD");let{contentEl:n}=t,i=e!==null,o=i&&this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]?this.plugin.settings.commonPrompts[e]:null;n.createEl("label",{text:"\u63D0\u793A\u8BCD\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});i&&o&&(a.value=o.name),n.createEl("label",{text:"\u63D0\u793A\u8BCD\u5185\u5BB9:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let l=n.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9",attr:{style:"width: 100%; height: 120px; padding: 8px; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px; resize: vertical; font-family: var(--font-text);"}});i&&o&&(l.value=o.content);let s=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}});s.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>t.close();let c=s.createEl("button",{text:i?"\u66F4\u65B0":"\u6DFB\u52A0",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),r=async()=>{let p=a.value.trim(),g=l.value.trim();if(!p){new u.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0");return}if(!g){new u.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9");return}if(this.plugin.settings.commonPrompts.findIndex((E,C)=>E.name===p&&C!==e)!==-1){new u.Notice("\u63D0\u793A\u8BCD\u540D\u79F0\u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6\u540D\u79F0");return}this.plugin.settings.commonPrompts||(this.plugin.settings.commonPrompts=[]);let T={id:i&&o?o.id:Date.now().toString(),name:p,content:g};i&&e!==null?(this.plugin.settings.commonPrompts[e]=T,new u.Notice("\u63D0\u793A\u8BCD\u5DF2\u66F4\u65B0")):(this.plugin.settings.commonPrompts.push(T),new u.Notice("\u63D0\u793A\u8BCD\u5DF2\u6DFB\u52A0")),await this.plugin.saveSettings(),t.close(),this.display()};c.onclick=r;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),r())};a.addEventListener("keydown",d),l.addEventListener("keydown",d),t.open(),a.focus()}async deletePrompt(e){if(this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]){let t=this.plugin.settings.commonPrompts[e],n=new u.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:i}=n;i.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u63D0\u793A\u8BCD "${t.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD"}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let o=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});o.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),o.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{this.plugin.settings.commonPrompts.splice(e,1),await this.plugin.saveSettings(),new u.Notice("\u63D0\u793A\u8BCD\u5DF2\u5220\u9664"),n.close(),this.display()},n.open()}}showApiKeyModal(e){let t=new u.Modal(this.app);t.titleEl.setText(`\u8BBE\u7F6E ${e.toUpperCase()} \u914D\u7F6E`);let{contentEl:n}=t,i=this.plugin.settings.providers[e];n.createEl("label",{text:"API Key:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"password",placeholder:"\u8BF7\u8F93\u5165API Key",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});o.value=(i==null?void 0:i.apiKey)||"",n.createEl("label",{text:"Base URL (\u53EF\u9009):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",value:(i==null?void 0:i.baseUrl)||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),l=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),s=l.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}});s.onclick=()=>t.close();let c=l.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),r=async()=>{this.plugin.settings.providers[e]||(this.plugin.settings.providers[e]={apiKey:"",baseUrl:"",enabled:!0}),this.plugin.settings.providers[e].apiKey=o.value.trim(),this.plugin.settings.providers[e].baseUrl=a.value.trim(),o.value.trim()&&(this.plugin.settings.providers[e].enabled=!0),await this.plugin.saveSettings(),new u.Notice(e.toUpperCase()+" \u914D\u7F6E\u5DF2\u4FDD\u5B58"),t.close(),this.display()};c.onclick=r;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),r())};o.addEventListener("keydown",d),a.addEventListener("keydown",d),t.open(),o.focus()}showAddProviderModal(){let e=new u.Modal(this.app);e.titleEl.setText("\u6DFB\u52A0\u4F9B\u5E94\u5546");let{contentEl:t}=e;t.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let n=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: custom-provider",attr:{style:"width: 100%; margin-bottom: 15px;"}});t.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let i=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u81EA\u5B9A\u4E49\u4F9B\u5E94\u5546",attr:{style:"width: 100%; margin-bottom: 15px;"}});t.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=t.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(r=>{o.createEl("option",{value:r,text:r.toUpperCase()})}),t.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",attr:{style:"width: 100%; margin-bottom: 15px;"}}),l=t.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),s=l.createEl("button",{text:"\u53D6\u6D88"});s.onclick=()=>e.close();let c=l.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});c.onclick=async()=>{let r=n.value.trim(),d=i.value.trim(),p=o.value,g=a.value.trim();if(!r||!d){new u.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.providers[r]){new u.Notice("\u4F9B\u5E94\u5546ID\u5DF2\u5B58\u5728");return}this.plugin.settings.providers[r]={name:d,type:p,enabled:!0,apiKey:"",baseUrl:g},await this.plugin.saveSettings(),new u.Notice("\u4F9B\u5E94\u5546\u5DF2\u6DFB\u52A0"),e.close(),this.display()},e.open(),n.focus()}showEditProviderModal(e){let t=new u.Modal(this.app);t.titleEl.setText("\u7F16\u8F91\u4F9B\u5E94\u5546");let{contentEl:n}=t,i=this.plugin.settings.providers[e];n.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:e,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",value:i.name||e,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(d=>{let p=a.createEl("option",{value:d,text:d.toUpperCase()});d===i.type&&(p.selected=!0)}),n.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let l=n.createEl("input",{type:"text",value:i.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px;"}}),s=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),c=s.createEl("button",{text:"\u53D6\u6D88"});c.onclick=()=>t.close();let r=s.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});r.onclick=async()=>{let d=o.value.trim(),p=a.value,g=l.value.trim();if(!d){new u.Notice("\u8BF7\u586B\u5199\u663E\u793A\u540D\u79F0");return}this.plugin.settings.providers[e]={...i,name:d,type:p,baseUrl:g},await this.plugin.saveSettings(),new u.Notice("\u4F9B\u5E94\u5546\u5DF2\u66F4\u65B0"),t.close(),this.display()},t.open(),o.focus()}showAddModelModal(e=A.MULTIMODAL){let t=new u.Modal(this.app);t.titleEl.setText("\u6DFB\u52A0\u65B0\u6A21\u578B");let{contentEl:n}=t;n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let i=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: gpt-4-turbo",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u6211\u7684\u81EA\u5B9A\u4E49\u6A21\u578B",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(d=>{a.createEl("option",{value:d,text:d.toUpperCase()})}),n.createEl("label",{text:"\u6A21\u578B\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let l=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});l.createEl("option",{value:A.MULTIMODAL,text:"\u591A\u6A21\u6001\u6A21\u578B (\u652F\u6301\u56FE\u7247)"}).selected=!0,l.createEl("option",{value:A.TEXT,text:"\u6587\u672C\u6A21\u578B"});let s=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),c=s.createEl("button",{text:"\u53D6\u6D88"});c.onclick=()=>t.close();let r=s.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});r.onclick=async()=>{let d=i.value.trim(),p=o.value.trim(),g=a.value,x=l.value;if(!d||!p){new u.Notice("\u8BF7\u586B\u5199\u6240\u6709\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.models[d]){new u.Notice("\u6A21\u578B ID \u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6 ID");return}this.plugin.settings.models[d]={id:d,name:p,provider:g,model:d,actualModel:d,enabled:!0,category:x},await this.plugin.saveSettings(),new u.Notice("\u6A21\u578B\u5DF2\u6DFB\u52A0"),t.close(),this.display()},t.open(),i.focus()}showEditModelModal(e){let t=new u.Modal(this.app);t.titleEl.setText("\u7F16\u8F91\u6A21\u578B");let{contentEl:n}=t,i=this.plugin.settings.models[e];n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:e,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",value:i.name,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(r=>{let d=a.createEl("option",{value:r,text:r.toUpperCase()});r===i.provider&&(d.selected=!0)});let l=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),s=l.createEl("button",{text:"\u53D6\u6D88"});s.onclick=()=>t.close();let c=l.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});c.onclick=async()=>{let r=o.value.trim(),d=a.value;if(!r){new u.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}this.plugin.settings.models[e]={...i,name:r,provider:d,model:e,actualModel:e},await this.plugin.saveSettings(),new u.Notice("\u6A21\u578B\u5DF2\u66F4\u65B0"),t.close(),this.display()},t.open(),o.focus()}renderRuleList(e,t){e.empty();let n=this.plugin.ruleManager.getRules();if(n.length===0){e.createEl("div",{text:'\u6682\u65E0\u89C4\u5219\uFF0C\u70B9\u51FB"\u65B0\u5EFA\u89C4\u5219"\u6216"\u4ECE\u6A21\u677F\u521B\u5EFA"\u5F00\u59CB\u6DFB\u52A0',attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});return}let i={};n.forEach(a=>{let l=a.category||"custom";i[l]||(i[l]=[]),i[l].push(a)});let o={writing:"\u5199\u4F5C\u98CE\u683C",format:"\u683C\u5F0F\u8981\u6C42",language:"\u8BED\u8A00\u8BBE\u7F6E",custom:"\u81EA\u5B9A\u4E49\u89C4\u5219"};Object.entries(i).forEach(([a,l])=>{e.createEl("h4",{text:o[a]||a,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),l.forEach(s=>{let c=e.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; background: var(--background-secondary);"}}),r=c.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"}}),d=r.createEl("div",{attr:{style:"flex: 1;"}});d.createEl("h5",{text:s.name,attr:{style:"margin: 0 0 5px 0; font-weight: 600;"}}),s.description&&d.createEl("p",{text:s.description,attr:{style:"margin: 0; color: var(--text-muted); font-size: 0.9em;"}});let p=r.createEl("div",{attr:{style:"display: flex; gap: 8px; align-items: center;"}}),g=p.createEl("input",{type:"checkbox",attr:{style:"margin-right: 5px;"}});g.checked=s.enabled!==!1,g.onchange=async()=>{try{await this.plugin.ruleManager.toggleRule(s.id),new u.Notice(g.checked?"\u89C4\u5219\u5DF2\u542F\u7528":"\u89C4\u5219\u5DF2\u7981\u7528")}catch(x){new u.Notice("\u64CD\u4F5C\u5931\u8D25: "+x.message)}},p.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>{this.showRuleEditor(t,s)},p.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>this.deleteRule(s,t),s.content&&(c.createEl("div",{attr:{style:"background: var(--background-primary); padding: 10px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85em; color: var(--text-muted); max-height: 100px; overflow-y: auto;"}}).textContent=s.content.length>200?s.content.substring(0,200)+"...":s.content)})})}showRuleManager(){let e=new u.Modal(this.app);e.titleEl.setText("\u5168\u5C40\u89C4\u5219\u7BA1\u7406\u5668"),e.modalEl.addClass("flowtext-rule-manager-modal");let{contentEl:t}=e;t.empty();let n=t.createEl("div",{attr:{style:"min-height: 500px; display: flex; flex-direction: column;"}}),i=n.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--background-modifier-border);"}}),o=i.createEl("div",{attr:{style:"display: flex; gap: 10px;"}});o.createEl("button",{text:"\u65B0\u5EFA\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showRuleEditor(e),o.createEl("button",{text:"\u4ECE\u63D0\u793A\u8BCD\u521B\u5EFA",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showTemplateSelector(e);let a=i.createEl("div",{attr:{style:"display: flex; gap: 10px;"}});a.createEl("button",{text:"\u5BFC\u5165\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.importRules(e),a.createEl("button",{text:"\u5BFC\u51FA\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.exportRules();let l=n.createEl("div",{attr:{style:"flex: 1; overflow-y: auto;"}});this.renderRuleList(l,e),e.open()}showRuleEditor(e,t=null){let n=new u.Modal(this.app);n.titleEl.setText(t?"\u7F16\u8F91\u89C4\u5219":"\u65B0\u5EFA\u89C4\u5219"),n.modalEl.addClass("flowtext-rule-editor-modal");let{contentEl:i}=n;i.empty();let o=i.createEl("div",{attr:{style:"display: flex; flex-direction: column; gap: 15px; min-width: 500px;"}});o.createEl("label",{text:"\u89C4\u5219\u540D\u79F0",attr:{style:"font-weight: 600;"}});let a=o.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u540D\u79F0",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});t&&(a.value=t.name),o.createEl("label",{text:"\u89C4\u5219\u63CF\u8FF0",attr:{style:"font-weight: 600;"}});let l=o.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u63CF\u8FF0\uFF08\u53EF\u9009\uFF09",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});t&&t.description&&(l.value=t.description),o.createEl("label",{text:"\u89C4\u5219\u5206\u7C7B",attr:{style:"font-weight: 600;"}});let s=o.createEl("select",{attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),c=[{value:"writing",text:"\u5199\u4F5C\u98CE\u683C"},{value:"format",text:"\u683C\u5F0F\u8981\u6C42"},{value:"language",text:"\u8BED\u8A00\u8BBE\u7F6E"},{value:"custom",text:"\u81EA\u5B9A\u4E49\u89C4\u5219"}],r=t?t.category:"custom";c.forEach(C=>{let m=s.createEl("option",{value:C.value,text:C.text});C.value===r&&(m.selected=!0)}),o.createEl("label",{text:"\u4F18\u5148\u7EA7 (\u6570\u5B57\u8D8A\u5927\u4F18\u5148\u7EA7\u8D8A\u9AD8\uFF0C\u6700\u592710)",attr:{style:"font-weight: 600;"}});let d=o.createEl("input",{type:"number",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});d.min="0",d.max="10",d.value=String(t&&t.priority!==void 0?t.priority:0),o.createEl("label",{text:"\u89C4\u5219\u5185\u5BB9",attr:{style:"font-weight: 600;"}});let p=o.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u5185\u5BB9\uFF0C\u8FD9\u4E9B\u5185\u5BB9\u5C06\u4F5C\u4E3A\u7CFB\u7EDF\u63D0\u793A\u8BCD\u7684\u4E00\u90E8\u5206",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; min-height: 150px; font-family: var(--font-monospace); resize: vertical;"}});t&&(p.value=t.content);let g=o.createEl("div",{attr:{style:"display: flex; align-items: center; gap: 8px;"}}),x=g.createEl("input",{type:"checkbox"});x.checked=!t||t.enabled!==!1,g.createEl("label",{text:"\u542F\u7528\u6B64\u89C4\u5219",attr:{style:"font-weight: 600;"}});let T=o.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;"}});T.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 8px 16px;"}}).onclick=()=>n.close();let E=T.createEl("button",{text:t?"\u66F4\u65B0":"\u521B\u5EFA",cls:"mod-cta",attr:{style:"padding: 8px 16px;"}});E.onclick=async()=>{let C=a.value.trim(),m=p.value.trim();if(!C){new u.Notice("\u8BF7\u8F93\u5165\u89C4\u5219\u540D\u79F0"),a.focus();return}if(!m){new u.Notice("\u8BF7\u8F93\u5165\u89C4\u5219\u5185\u5BB9"),p.focus();return}let f=parseInt(d.value)||0;if(f>10){new u.Notice("\u4F18\u5148\u7EA7\u4E0D\u80FD\u8D85\u8FC710"),d.focus();return}try{let h={name:C,description:l.value.trim(),category:s.value,priority:f,content:m,enabled:x.checked};t?(await this.plugin.ruleManager.updateRule(t.id,h),new u.Notice("\u89C4\u5219\u5DF2\u66F4\u65B0")):(await this.plugin.ruleManager.addRule(h),new u.Notice("\u89C4\u5219\u5DF2\u521B\u5EFA")),n.close(),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(h){new u.Notice("\u64CD\u4F5C\u5931\u8D25: "+h.message)}},n.open(),a.focus()}showTemplateSelector(e){let t=new u.Modal(this.app);t.titleEl.setText("\u4ECE\u6A21\u677F\u521B\u5EFA\u89C4\u5219");let{contentEl:n}=t;n.empty();let i=this.plugin.ruleManager.getTemplates();if(i.length===0)n.createEl("p",{text:"\u6682\u65E0\u53EF\u7528\u6A21\u677F",attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});else{let o={};i.forEach(l=>{let s=l.category||"custom";o[s]||(o[s]=[]),o[s].push(l)});let a={writing:"\u5199\u4F5C\u98CE\u683C",format:"\u683C\u5F0F\u8981\u6C42",language:"\u8BED\u8A00\u8BBE\u7F6E",custom:"\u81EA\u5B9A\u4E49\u6A21\u677F"};Object.entries(o).forEach(([l,s])=>{n.createEl("h4",{text:a[l]||l,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),s.forEach(c=>{let r=n.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;"}});r.addEventListener("mouseenter",()=>{r.style.backgroundColor="var(--background-modifier-hover)"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor=""}),r.createEl("h5",{text:c.name,attr:{style:"margin: 0 0 8px 0; font-weight: 600;"}}),c.description&&r.createEl("p",{text:c.description,attr:{style:"margin: 0 0 10px 0; color: var(--text-muted); font-size: 0.9em;"}}),c.content&&(r.createEl("div",{attr:{style:"background: var(--background-primary); padding: 8px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.8em; color: var(--text-muted);"}}).textContent=c.content.length>100?c.content.substring(0,100)+"...":c.content),r.onclick=async()=>{try{await this.plugin.ruleManager.createFromTemplate(c.id),new u.Notice("\u5DF2\u4ECE\u6A21\u677F\u521B\u5EFA\u89C4\u5219: "+c.name),t.close(),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(d){new u.Notice("\u521B\u5EFA\u5931\u8D25: "+d.message)}}})})}t.open()}async deleteRule(e,t){let n=new u.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:i}=n;i.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u89C4\u5219 "${e.name}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let o=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});o.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),o.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{try{await this.plugin.ruleManager.deleteRule(e.id),new u.Notice("\u89C4\u5219\u5DF2\u5220\u9664"),n.close(),this.renderRuleList(t.contentEl.querySelector('[style*="flex: 1"]'),t)}catch(a){new u.Notice("\u5220\u9664\u5931\u8D25: "+a.message)}},n.open()}exportRules(){try{let e=this.plugin.ruleManager.exportRules(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(n),o=document.createElement("a");o.href=i,o.download=`flowtext-rules-${new Date().toISOString().split("T")[0]}.json`,o.click(),URL.revokeObjectURL(i),new u.Notice("\u89C4\u5219\u5DF2\u5BFC\u51FA")}catch(e){new u.Notice("\u5BFC\u51FA\u5931\u8D25: "+e.message)}}importRules(e){let t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async n=>{let i=n.target.files[0];if(i)try{let o=await i.text(),a=JSON.parse(o),l=await this.plugin.ruleManager.importRules(a);new u.Notice(`\u6210\u529F\u5BFC\u5165 ${l} \u6761\u89C4\u5219`),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(o){new u.Notice("\u5BFC\u5165\u5931\u8D25: "+o.message)}},t.click()}};var tt=require("obsidian");var z=class{constructor(e,t,n){this.suggestionEl=null;this.isOpen=!1;this.selectedIndex=0;this.items=[];this.searchQuery="";this.atPosition=0;this.selectedTags=[];this.keydownHandler=null;this.app=e,this.inputEl=t,this.onSelect=n}convertToContentEditable(){if(this.inputEl.tagName==="TEXTAREA"){let e=document.createElement("div");e.className=this.inputEl.className+" markdown-next-ai-editable-input",e.contentEditable="true",e.setAttribute("data-placeholder",this.inputEl.placeholder),e.style.minHeight="80px",e.style.maxHeight="300px",e.style.overflowY="auto",e.textContent=this.inputEl.value,this.inputEl.parentNode.replaceChild(e,this.inputEl),this.inputEl=e,this.updatePlaceholder(),e.addEventListener("input",()=>this.updatePlaceholder())}}updatePlaceholder(){this.inputEl.textContent.trim()===""&&this.inputEl.querySelectorAll(".markdown-next-ai-inline-tag").length===0?this.inputEl.classList.add("empty"):this.inputEl.classList.remove("empty")}getTextContent(){let e="";return this.inputEl.childNodes.forEach(t=>{if(t.nodeType===Node.TEXT_NODE)e+=t.textContent;else if(t.classList&&t.classList.contains("markdown-next-ai-inline-tag")){let n=t.getAttribute("data-type"),i=t.getAttribute("data-path");e+=`@[${n}:${i}]`}}),e}getCursorPosition(){let e=window.getSelection();if(!e||!e.rangeCount)return 0;let t=e.getRangeAt(0),n=0,i=o=>{if(o===t.endContainer)return n+=t.endOffset,!0;if(o.nodeType===Node.TEXT_NODE)n+=o.textContent.length;else if(o.nodeType===Node.ELEMENT_NODE){if(o.classList&&o.classList.contains("markdown-next-ai-inline-tag")){let a=`@[${o.getAttribute("data-type")}:${o.getAttribute("data-path")}]`;n+=a.length}else for(let a of Array.from(o.childNodes))if(i(a))return!0}return!1};for(let o of Array.from(this.inputEl.childNodes))if(i(o))break;return n}setCursorPosition(e){let t=window.getSelection(),n=document.createRange(),i=0,o=!1,a=l=>{if(!o){if(l.nodeType===Node.TEXT_NODE){let s=l.textContent.length;i+s>=e?(n.setStart(l,e-i),n.collapse(!0),o=!0):i+=s}else if(l.nodeType===Node.ELEMENT_NODE){for(let s of Array.from(l.childNodes))if(a(s),o)return}}};a(this.inputEl),!o&&this.inputEl.lastChild&&(n.setStartAfter(this.inputEl.lastChild),n.collapse(!0)),t.removeAllRanges(),t.addRange(n)}show(e,t=""){if(this.atPosition=e,this.searchQuery=t,this.isOpen=!0,this.items=this.getAllItems(t),this.items.length===0){this.close();return}this.suggestionEl||(this.suggestionEl=document.createElement("div"),this.suggestionEl.className="markdown-next-ai-context-suggestions",this.suggestionEl.addEventListener("click",n=>n.stopPropagation()),this.suggestionEl.addEventListener("mousedown",n=>n.stopPropagation()),document.body.appendChild(this.suggestionEl)),this.render(),this.position(),this.bindKeyboardEvents()}getAllItems(e){let t=[],n=e.toLowerCase(),i=Z.IMAGE,o=Z.DOCUMENT;return this.app.vault.getFiles().forEach(l=>{let s=l.extension.toLowerCase(),c="file",r="\u{1F4C4}";if(s==="md")c="file",r="\u{1F4C4}";else if(i.includes(s))c="image",r="\u{1F5BC}\uFE0F";else if(o.includes(s))c="file",r=s==="pdf"?"\u{1F4D5}":["xlsx","xls","csv"].includes(s)?"\u{1F4CA}":["docx","doc","txt"].includes(s)?"\u{1F4DD}":["epub","mobi"].includes(s)?"\u{1F4DA}":s==="json"?"\u{1F4CB}":"\u{1F4C4}";else return;e&&!l.basename.toLowerCase().includes(n)&&!l.path.toLowerCase().includes(n)||t.push({type:c,name:l.basename,path:l.path,icon:r})}),this.app.vault.getAllLoadedFiles().filter(l=>l.children).forEach(l=>{e&&!l.name.toLowerCase().includes(n)&&!l.path.toLowerCase().includes(n)||t.push({type:"folder",name:l.name,path:l.path,icon:"\u{1F4C1}"})}),t.slice(0,50)}render(){if(!this.suggestionEl)return;this.suggestionEl.innerHTML="";let e=document.createElement("div");e.className="markdown-next-ai-suggestions-header",e.textContent=`\u9009\u62E9\u4E0A\u4E0B\u6587 (${this.items.length}\u9879)`,this.suggestionEl.appendChild(e);let t=document.createElement("div");t.className="markdown-next-ai-suggestions-list",this.items.forEach((n,i)=>{let o=document.createElement("div");o.className="markdown-next-ai-suggestion-item",i===this.selectedIndex&&o.classList.add("selected"),o.innerHTML=`
                <span class="markdown-next-ai-suggestion-icon">${n.icon}</span>
                <div class="markdown-next-ai-suggestion-content">
                    <div class="markdown-next-ai-suggestion-name">${n.name}</div>
                    <div class="markdown-next-ai-suggestion-path">${n.path}</div>
                </div>
            `,o.onclick=a=>{a.stopPropagation(),a.preventDefault(),this.selectItem(i)},t.appendChild(o)}),this.suggestionEl.appendChild(t)}position(){if(!this.suggestionEl||!this.inputEl)return;let e=this.inputEl.getBoundingClientRect(),t=window.getSelection();if(t&&t.rangeCount>0){let i=t.getRangeAt(0).getBoundingClientRect();this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=i.left+"px",this.suggestionEl.style.top=i.bottom+5+"px"}else this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=e.left+"px",this.suggestionEl.style.top=e.bottom+5+"px";this.suggestionEl.style.maxHeight="300px",this.suggestionEl.style.overflowY="auto",this.suggestionEl.style.zIndex="10000"}bindKeyboardEvents(){this.keydownHandler&&this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=e=>{if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,this.items.length-1),this.render(),this.scrollToSelected();break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.render(),this.scrollToSelected();break;case"Enter":e.preventDefault(),e.stopPropagation(),this.selectItem(this.selectedIndex);break;case"Escape":e.preventDefault(),e.stopPropagation(),this.close();break}},this.inputEl.addEventListener("keydown",this.keydownHandler)}scrollToSelected(){if(!this.suggestionEl)return;let e=this.suggestionEl.querySelector(".markdown-next-ai-suggestion-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}selectItem(e){if(e<0||e>=this.items.length)return;let t=this.items[e],n=document.createElement("span");n.className="markdown-next-ai-inline-tag",n.contentEditable="false",n.setAttribute("data-type",t.type),n.setAttribute("data-path",t.path),n.innerHTML=`<span class="markdown-next-ai-inline-tag-icon">${t.icon}</span><span class="markdown-next-ai-inline-tag-name">${t.name}</span>`;let i=window.getSelection();if(!i||!i.rangeCount)return;let o=i.getRangeAt(0),a=this.getCursorPosition()-this.atPosition,l=0,s=!1,c=(d,p,g)=>{if(!s){if(d.nodeType===Node.TEXT_NODE){let x=d.textContent.length;if(l+x>p){let T=p-l,E=Math.min(T+g,x),C=d.textContent;d.textContent=C.substring(0,T)+C.substring(E),o.setStart(d,T),o.collapse(!0),s=!0}else l+=x}else if(d.nodeType===Node.ELEMENT_NODE){if(d.classList&&d.classList.contains("markdown-next-ai-inline-tag")){let x=`@[${d.getAttribute("data-type")}:${d.getAttribute("data-path")}]`;l+=x.length}else for(let x of Array.from(d.childNodes))if(c(x,p,g),s)return}}};c(this.inputEl,this.atPosition,a),s||o.deleteContents(),o.insertNode(n);let r=document.createTextNode(" ");o.setStartAfter(n),o.insertNode(r),o.setStartAfter(r),o.collapse(!0),i.removeAllRanges(),i.addRange(o),this.inputEl.focus(),this.updatePlaceholder(),this.selectedTags.push(t),this.onSelect&&this.onSelect(t),this.close()}updateSearch(e){this.searchQuery=e,this.items=this.getAllItems(e),this.selectedIndex=0,this.items.length===0?this.close():this.render()}close(){this.isOpen=!1,this.suggestionEl&&this.suggestionEl.parentNode&&this.suggestionEl.parentNode.removeChild(this.suggestionEl),this.suggestionEl=null,this.keydownHandler&&(this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}};var j=class{constructor(e,t,n){this.selectedFiles=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=e,this.files=t,this.onSelect=n}open(e){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-file-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u6863</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6...">
                    </div>
                    <div class="markdown-next-ai-file-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let t=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),i=this.windowEl.querySelector(".markdown-next-ai-file-list"),o=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),a=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),l=c=>{c&&c.stopPropagation(),this.close()};t.onclick=l,a.onclick=l,o.onclick=c=>{c.stopPropagation(),this.onSelect(this.selectedFiles),this.close()},n.addEventListener("input",c=>{let r=c.target.value.toLowerCase();this.renderFileList(i,r)}),this.renderFileList(i,""),this.outsideClickHandler=c=>{this.windowEl.contains(c.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let s=this.windowEl.querySelector(".markdown-next-ai-window-content");if(e){let c=e.left;c+600>window.innerWidth-20&&(c=window.innerWidth-600-20),c<20&&(c=20);let r=e.bottom+8,d=Math.max(300,Math.min(window.innerHeight-r-20,500));s.style.maxHeight=d+"px",s.style.overflowY="auto",s.style.transform="none",s.style.left=c+"px",s.style.top=r+"px"}else s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),s.addEventListener("click",c=>c.stopPropagation())}renderFileList(e,t){e.innerHTML="",this.files.filter(i=>t===""?!0:(i.name||i.path).toLowerCase().includes(t)).forEach(i=>{let o=document.createElement("div");o.className="markdown-next-ai-file-item";let a=document.createElement("input");a.type="checkbox",a.className="markdown-next-ai-file-checkbox",a.checked=this.selectedFiles.some(r=>r.path===i.path);let l=document.createElement("label");l.className="markdown-next-ai-file-label";let s=document.createElement("span");s.className="markdown-next-ai-file-name",s.textContent=i.name;let c=document.createElement("span");c.className="markdown-next-ai-file-extension",c.textContent=i.extension?"."+i.extension:"",l.appendChild(s),l.appendChild(c),o.appendChild(a),o.appendChild(l),e.appendChild(o),a.addEventListener("change",()=>{a.checked?this.selectedFiles.some(r=>r.path===i.path)||this.selectedFiles.push(i):this.selectedFiles=this.selectedFiles.filter(r=>r.path!==i.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null)}};var q=class{constructor(e,t,n){this.selectedFolders=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=e,this.folders=t,this.onSelect=n}open(e){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-folder-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u4EF6\u5939</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6\u5939...">
                    </div>
                    <div class="markdown-next-ai-folder-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let t=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),i=this.windowEl.querySelector(".markdown-next-ai-folder-list"),o=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),a=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),l=c=>{c&&c.stopPropagation(),this.close()};t.onclick=l,a.onclick=l,o.onclick=c=>{c.stopPropagation(),this.onSelect(this.selectedFolders),this.close()},n.addEventListener("input",c=>{let r=c.target.value.toLowerCase();this.renderFolderList(i,r)}),this.renderFolderList(i,""),this.outsideClickHandler=c=>{this.windowEl.contains(c.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let s=this.windowEl.querySelector(".markdown-next-ai-window-content");if(e){let c=e.left;c+600>window.innerWidth-20&&(c=window.innerWidth-600-20),c<20&&(c=20);let r=e.bottom+8,d=Math.max(300,Math.min(window.innerHeight-r-20,500));s.style.maxHeight=d+"px",s.style.overflowY="auto",s.style.transform="none",s.style.left=c+"px",s.style.top=r+"px"}else s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),s.addEventListener("click",c=>c.stopPropagation())}renderFolderList(e,t){e.innerHTML="",this.folders.filter(i=>t===""?!0:(i.name||i.path).toLowerCase().includes(t)).forEach(i=>{let o=document.createElement("div");o.className="markdown-next-ai-folder-item";let a=document.createElement("input");a.type="checkbox",a.className="markdown-next-ai-folder-checkbox",a.checked=this.selectedFolders.some(s=>s.path===i.path);let l=document.createElement("label");l.className="markdown-next-ai-folder-label",l.textContent=i.name||i.path,o.appendChild(a),o.appendChild(l),e.appendChild(o),a.addEventListener("change",()=>{a.checked?this.selectedFolders.some(s=>s.path===i.path)||this.selectedFolders.push(i):this.selectedFolders=this.selectedFolders.filter(s=>s.path!==i.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null)}};var D=class{constructor(e,t,n){this.isOpen=!1;this.modalEl=null;this.eventListeners=[];this.selectedIndex=0;this.commonPrompts=[];this.app=e,this.plugin=t,this.onSelect=n}open(e){if(!this.isOpen){this.isOpen=!0;try{this.modalEl=document.createElement("div"),this.modalEl.className="markdown-next-ai-context-suggestions";let t=this.plugin.settings.commonPrompts||[];this.commonPrompts=t,this.selectedIndex=0;let n=document.createElement("div");n.className="markdown-next-ai-suggestions-header",n.textContent=`\u5E38\u7528\u63D0\u793A\u8BCD (${this.commonPrompts.length})`,this.modalEl.appendChild(n);let i=document.createElement("div");if(i.className="markdown-next-ai-suggestions-list",this.commonPrompts.length===0)i.innerHTML=`
                    <div class="markdown-next-ai-suggestion-item" style="cursor: default;">
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD</div>
                            <div class="markdown-next-ai-suggestion-path">\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u6DFB\u52A0</div>
                        </div>
                    </div>
                `;else{let l=this.commonPrompts.map((s,c)=>`
                    <div class="markdown-next-ai-suggestion-item ${c===0?"selected":""}" data-index="${c}">
                        <span class="markdown-next-ai-suggestion-icon">\u{1F4A1}</span>
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">${s.name}</div>
                            <div class="markdown-next-ai-suggestion-path">${s.content.substring(0,50)}${s.content.length>50?"...":""}</div>
                        </div>
                    </div>
                `).join("");i.innerHTML=l}this.modalEl.appendChild(i),this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(l=>{if(this.commonPrompts.length===0)return;let s=()=>{let r=parseInt(l.dataset.index||"0");this.selectPrompt(r)};l.addEventListener("click",s),this.eventListeners.push({element:l,event:"click",handler:s});let c=()=>{let r=parseInt(l.dataset.index||"0");this.updateSelection(r)};l.addEventListener("mouseenter",c),this.eventListeners.push({element:l,event:"mouseenter",handler:c})});let o=l=>{l.target.closest(".markdown-next-ai-at-popup")||this.modalEl.contains(l.target)||this.close()};document.addEventListener("click",o),this.eventListeners.push({element:document,event:"click",handler:o});let a=l=>{l.key==="Escape"?(l.preventDefault(),this.close()):l.key==="ArrowDown"?(l.preventDefault(),this.moveSelection(1)):l.key==="ArrowUp"?(l.preventDefault(),this.moveSelection(-1)):l.key==="Enter"&&(l.preventDefault(),this.selectPrompt(this.selectedIndex))};document.addEventListener("keydown",a),this.eventListeners.push({element:document,event:"keydown",handler:a}),document.body.appendChild(this.modalEl),this.positionPopup(e)}catch(t){console.error("Failed to open prompt selector:",t)}}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e&&typeof e.removeEventListener=="function"&&e.removeEventListener(t,n)}),this.eventListeners=[],this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null)}positionPopup(e){if(this.modalEl&&e)try{let t=e.getBoundingClientRect(),n=this.modalEl.getBoundingClientRect(),i=window.innerWidth,o=window.innerHeight,a=t.left,l=t.bottom+5;a+n.width>i&&(a=i-n.width-10),l+n.height>o&&(l=t.top-n.height-5),a=Math.max(10,a),l=Math.max(10,l),this.modalEl.style.position="fixed",this.modalEl.style.left=a+"px",this.modalEl.style.top=l+"px",this.modalEl.style.zIndex="10002"}catch(t){console.error("Failed to position prompt selector:",t)}}moveSelection(e){if(this.commonPrompts.length===0)return;let t=this.selectedIndex+e;t<0&&(t=this.commonPrompts.length-1),t>=this.commonPrompts.length&&(t=0),this.updateSelection(t)}updateSelection(e){if(!this.modalEl||this.commonPrompts.length===0)return;this.selectedIndex=e,this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(n=>n.classList.remove("selected"));let t=this.modalEl.querySelector(`[data-index="${e}"]`);t&&(t.classList.add("selected"),t.scrollIntoView({block:"nearest",behavior:"smooth"}))}selectPrompt(e){if(e<0||e>=this.commonPrompts.length)return;let t=this.commonPrompts[e];t&&this.onSelect&&this.onSelect(t.content),this.close()}};var V=class{constructor(e,t,n,i,o,a=""){this.popupEl=null;this.inputEl=null;this.modelSelectEl=null;this.isOpen=!1;this.eventListeners=[];this.selectedContext={files:[],folders:[]};this.scrollContainer=null;this.contextSelector=null;this.promptSelector=null;this.outsideClickHandler=null;this.app=e,this.onSubmit=t,this.cursorPosition=n,this.plugin=i,this.view=o,this.selectedText=a,this.imageHandler=new G}async submit(){var o,a;let e=((o=this.contextSelector)==null?void 0:o.getTextContent().trim())||"";await this.processInlineImages();let t=this.imageHandler.getImages(),n=((a=this.modelSelectEl)==null?void 0:a.value)||"",i=await this.getContextContent();if(!e&&t.length===0&&!i){new tt.Notice("\u8BF7\u8F93\u5165\u7EED\u5199\u8981\u6C42\u6216\u4E0A\u4F20\u56FE\u7247");return}this.onSubmit(e,t,n,i,this.selectedText),this.close()}getModelOptions(){let e=this.plugin.getAvailableModels(),t=this.plugin.settings.currentModel;return e.map(n=>{let i=n.id===t?"selected":"";return`<option value="${n.id}" ${i}>${n.name}</option>`}).join("")}addImagePreview(e,t){let n=this.imageHandler.createImagePreview(e,()=>{});t.appendChild(n)}open(){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-at-popup");let e=this.selectedText.length>0,t=e?"\u4FEE\u6539\u6240\u9009\u5185\u5BB9":"Markdown-Next-AI",n=e?"\u8BF7\u8F93\u5165\u4FEE\u6539\u8981\u6C42...":"\uFF08@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD\uFF09...",i=this.selectedText;this.popupEl.innerHTML=`
            <div class="markdown-next-ai-popup-header">
                <span class="markdown-next-ai-popup-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                    ${t}
                </span>
                <button class="markdown-next-ai-popup-close">\u2715</button>
            </div>
            <div class="markdown-next-ai-popup-content">
                ${e?`
                <div class="markdown-next-ai-selected-text-section">
                    <div class="markdown-next-ai-selected-text-header">
                        <span class="markdown-next-ai-selected-text-label">\u9009\u4E2D\u6587\u672C\u5185\u5BB9:</span>
                    </div>
                    <div class="markdown-next-ai-selected-text-preview">${i}</div>
                </div>
                `:""}
                <div class="markdown-next-ai-context-section">
                    <div class="markdown-next-ai-selected-context" style="display: none;">
                        <div class="markdown-next-ai-context-header">
                            <span class="markdown-next-ai-context-title">\u5DF2\u9009\u62E9\u4E0A\u4E0B\u6587:</span>
                            <button class="markdown-next-ai-clear-context-btn" title="\u6E05\u9664\u4E0A\u4E0B\u6587">\u2715</button>
                        </div>
                        <div class="markdown-next-ai-context-list"></div>
                    </div>
                </div>
                <textarea class="markdown-next-ai-continue-input" placeholder="${n}" rows="3"></textarea>
                <div class="markdown-next-ai-upload-section">
                    <div class="markdown-next-ai-left-section">
                        <select class="markdown-next-ai-model-select">
                            ${this.getModelOptions()}
                        </select>
                        <input type="file" class="markdown-next-ai-file-input" accept="image/*" multiple style="display: none;">
                        <button class="markdown-next-ai-upload-btn" title="\u4E0A\u4F20\u56FE\u7247"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg></button>
                        <div class="markdown-next-ai-context-buttons">
                            <button class="markdown-next-ai-select-file-btn" title="\u9009\u62E9\u6587\u6863\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></button>
                            <button class="markdown-next-ai-select-folder-btn" title="\u9009\u62E9\u6587\u4EF6\u5939\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg></button>
                        </div>
                    </div>
                    <button class="markdown-next-ai-submit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more-icon lucide-message-square-more" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 11h.01"/></svg>\u63D0\u4EA4</button>
                </div>
                <div class="markdown-next-ai-image-previews"></div>
            </div>
        `,this.inputEl=this.popupEl.querySelector(".markdown-next-ai-continue-input"),this.modelSelectEl=this.popupEl.querySelector(".markdown-next-ai-model-select");let o=this.popupEl.querySelector(".markdown-next-ai-submit-btn"),a=this.popupEl.querySelector(".markdown-next-ai-popup-close"),l=this.popupEl.querySelector(".markdown-next-ai-file-input"),s=this.popupEl.querySelector(".markdown-next-ai-upload-btn"),c=this.popupEl.querySelector(".markdown-next-ai-image-previews"),r=this.popupEl.querySelector(".markdown-next-ai-select-file-btn"),d=this.popupEl.querySelector(".markdown-next-ai-select-folder-btn"),p=this.popupEl.querySelector(".markdown-next-ai-clear-context-btn");this.contextSelector=new z(this.app,this.inputEl,()=>{}),this.contextSelector.convertToContentEditable(),this.inputEl=this.contextSelector.inputEl,this.promptSelector=new D(this.app,this.plugin,f=>{let h=this.contextSelector.getCursorPosition(),H=this.contextSelector.getTextContent().substring(0,h).lastIndexOf("#");if(H!==-1){let R=window.getSelection();if(R&&R.rangeCount>0){let I=R.getRangeAt(0),L=h-H,k=0,P=!1,w=(v,b,S)=>{if(!P){if(v.nodeType===Node.TEXT_NODE){let M=v.textContent.length;if(k+M>b){let F=b-k,st=Math.min(F+S,M),et=v.textContent;v.textContent=et.substring(0,F)+et.substring(st);let nt=document.createTextNode(f);v.parentNode&&(v.parentNode.insertBefore(nt,v.nextSibling),I.setStartAfter(nt),I.collapse(!0)),P=!0}else k+=M}else if(v.nodeType===Node.ELEMENT_NODE){for(let M of Array.from(v.childNodes))if(w(M,b,S),P)return}}};w(this.inputEl,H,L),R.removeAllRanges(),R.addRange(I),this.inputEl.focus()}}}),a.onclick=()=>this.close(),o.onclick=()=>this.submit(),s.onclick=()=>l.click(),r.onclick=()=>this.showFileSelector(),d.onclick=()=>this.showFolderSelector(),p.onclick=()=>this.clearContext();let g=f=>{let h=f.target;this.plugin&&this.plugin.settings&&(this.plugin.settings.currentModel=h.value,this.plugin.saveSettings()),this.updateUIForModelType(h.value),this.adjustModelSelectWidth()};this.modelSelectEl.addEventListener("change",g),this.eventListeners.push({element:this.modelSelectEl,event:"change",handler:g}),this.updateUIForModelType(this.modelSelectEl.value),this.adjustModelSelectWidth();let x=f=>{let h=f.target;h.files&&this.imageHandler.handleFileSelect(h.files,y=>{this.addImagePreview(y,c)}),h.value=""};l.addEventListener("change",x),this.eventListeners.push({element:l,event:"change",handler:x});let T=f=>{this.imageHandler.handlePaste(f,h=>{this.addImagePreview(h,c)})};this.inputEl.addEventListener("paste",T),this.eventListeners.push({element:this.inputEl,event:"paste",handler:T});let E=f=>{f.stopPropagation(),this.adjustPopupWidth();let h=this.contextSelector.getCursorPosition(),y=this.contextSelector.getTextContent().substring(0,h),H=y.lastIndexOf("@");if(H!==-1){let I=y.substring(H+1);if(!I.includes(" ")&&!I.includes(`
`)){this.contextSelector.show(H,I);return}else this.contextSelector.close()}else this.contextSelector.close();let R=y.lastIndexOf("#");if(R!==-1){let I=R>0?y.charAt(R-1):" ";if(I===" "||I===`
`){this.promptSelector.open(this.inputEl);let L=window.getSelection();if(L&&L.rangeCount>0){let P=L.getRangeAt(0).getBoundingClientRect(),w=document.querySelector(".markdown-next-ai-context-suggestions");w&&(w.style.position="fixed",w.style.left=P.left+"px",w.style.top=P.bottom+5+"px")}}else this.promptSelector.close()}else this.promptSelector.close()};this.inputEl.addEventListener("input",E),this.eventListeners.push({element:this.inputEl,event:"input",handler:E});let C=f=>{this.contextSelector&&this.contextSelector.isOpen||(f.key==="Enter"?f.shiftKey||(f.preventDefault(),o.click()):f.key==="Escape"&&(f.preventDefault(),this.close()))};this.inputEl.addEventListener("keydown",C),this.eventListeners.push({element:this.inputEl,event:"keydown",handler:C});let m=f=>{this.popupEl.hasAttribute("data-prompt-selecting")||f.target.closest(".markdown-next-ai-prompt-selector-popup")||f.target.closest(".markdown-next-ai-context-suggestions")||this.contextSelector&&this.contextSelector.isOpen||f.target.closest(".markdown-next-ai-file-selection-window")||f.target.closest(".markdown-next-ai-folder-selection-window")||this.popupEl.contains(f.target)||this.close()};setTimeout(()=>{document.addEventListener("click",m)},100),this.outsideClickHandler=m,this.view&&(this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor"))),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.scrollContainer.appendChild(this.popupEl)):document.body.appendChild(this.popupEl),this.positionPopup(),setTimeout(()=>{this.inputEl&&this.inputEl.focus()},100)}positionPopup(){if(!this.popupEl||!this.cursorPosition)return;let{left:e,top:t,height:n=20}=this.cursorPosition;if(this.scrollContainer){let i=this.scrollContainer.getBoundingClientRect(),o=this.scrollContainer.scrollTop,a=this.scrollContainer.scrollLeft,l=e-i.left+a,s=t+n+5-i.top+o;this.popupEl.style.position="absolute",this.popupEl.style.left=l+"px",this.popupEl.style.top=s+"px",this.popupEl.style.zIndex="10000";let c=this.popupEl.getBoundingClientRect(),r=i.width;c.right>i.right&&(l=r+a-c.width-10,this.popupEl.style.left=l+"px"),l<a&&(this.popupEl.style.left=a+10+"px"),c.bottom>i.bottom&&(s=t-i.top+o-c.height-5,this.popupEl.style.top=s+"px")}else{this.popupEl.style.position="fixed",this.popupEl.style.left=e+"px",this.popupEl.style.top=t+n+5+"px",this.popupEl.style.zIndex="10000";let i=this.popupEl.getBoundingClientRect(),o=window.innerWidth,a=window.innerHeight;i.right>o&&(this.popupEl.style.left=o-i.width-10+"px"),i.left<0&&(this.popupEl.style.left="10px"),i.bottom>a&&(this.popupEl.style.top=t-i.height-5+"px")}}adjustPopupWidth(){if(!this.popupEl||!this.inputEl)return;let e=document.createElement("span");e.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            max-width: 80vw;
        `;let t=this.contextSelector?this.contextSelector.getTextContent():"";e.textContent=t||"",document.body.appendChild(e);let n=e.offsetWidth;document.body.removeChild(e);let i=480,o=window.innerWidth*.5,l=Math.max(i,Math.min(n+100,o));this.popupEl.style.width=l+"px"}adjustModelSelectWidth(){if(!this.modelSelectEl)return;let e=this.modelSelectEl.options[this.modelSelectEl.selectedIndex];if(!e)return;let t=document.createElement("span");t.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: inherit;
            font-size: 12px;
        `,t.textContent=e.text,document.body.appendChild(t);let n=t.offsetWidth;document.body.removeChild(t);let i=n+35;this.modelSelectEl.style.width=i+"px"}close(){this.isOpen&&(this.isOpen=!1,this.contextSelector&&(this.contextSelector.close(),this.contextSelector=null),this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e.removeEventListener(t,n)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.imageHandler.clearImages(),this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.inputEl=null)}updateUIForModelType(e){var n;if(!this.popupEl||!e)return;let t=this.plugin.settings.models[e];if(t){let i=t.category===A.IMAGE,o=this.popupEl.querySelector(".markdown-next-ai-popup-title");o&&(o.innerHTML=i?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-icon lucide-image" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>AI\u56FE\u7247\u751F\u6210':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>Markdown-Next-AI'),this.inputEl&&(this.inputEl.setAttribute("data-placeholder",i?"\u8BF7\u63CF\u8FF0\u60A8\u60F3\u8981\u751F\u6210\u7684\u56FE\u7247...":"(@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD)"),(n=this.contextSelector)==null||n.updatePlaceholder());let a=this.popupEl.querySelector(".markdown-next-ai-submit-btn");a&&(a.innerHTML=i?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-plus-icon lucide-image-plus" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M16 5h6"/><path d="M19 2v6"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>\u751F\u6210\u56FE\u7247':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more-icon lucide-message-square-more" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 11h.01"/></svg>\u63D0\u4EA4');let l=this.popupEl.querySelector(".markdown-next-ai-upload-btn");l&&(l.style.display=i?"none":"inline-flex")}}showFileSelector(){let e=["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"],t=this.plugin.app.vault.getFiles().filter(i=>e.includes(i.extension.toLowerCase())).map(i=>({name:i.basename,path:i.path,extension:i.extension.toLowerCase()})),n=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(n){let i=n.getBoundingClientRect();new j(this.plugin.app,t,o=>{this.addFilesToContext(o)}).open(i)}}showFolderSelector(){let e=this.plugin.app.vault.getAllLoadedFiles().filter(n=>!!n.children).map(n=>({name:n.name,path:n.path})),t=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(t){let n=t.getBoundingClientRect();new q(this.plugin.app,e,i=>{this.addFoldersToContext(i)}).open(n)}}addFilesToContext(e){e.forEach(t=>{this.selectedContext.files.find(n=>n.path===t.path)||this.selectedContext.files.push(t)}),this.updateContextDisplay()}addFoldersToContext(e){e.forEach(t=>{this.selectedContext.folders.find(n=>n.path===t.path)||this.selectedContext.folders.push(t)}),this.updateContextDisplay()}updateContextDisplay(){let e=this.popupEl.querySelector(".markdown-next-ai-selected-context"),t=this.popupEl.querySelector(".markdown-next-ai-context-list");this.selectedContext.files.length===0&&this.selectedContext.folders.length===0?e.style.display="none":(e.style.display="block",t.innerHTML="",this.selectedContext.files.forEach(n=>{let i=document.createElement("div");i.className="markdown-next-ai-context-item",i.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${n.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="file" data-path="${n.path}">\xD7</button>
                `,t.appendChild(i)}),this.selectedContext.folders.forEach(n=>{let i=document.createElement("div");i.className="markdown-next-ai-context-item",i.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${n.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="folder" data-path="${n.path}">\xD7</button>
                `,t.appendChild(i)}),t.querySelectorAll(".markdown-next-ai-remove-context").forEach(n=>{n.onclick=i=>{i.stopPropagation();let o=n.getAttribute("data-type"),a=n.getAttribute("data-path");this.removeFromContext(o,a)}}))}removeFromContext(e,t){e==="file"?this.selectedContext.files=this.selectedContext.files.filter(n=>n.path!==t):e==="folder"&&(this.selectedContext.folders=this.selectedContext.folders.filter(n=>n.path!==t)),this.updateContextDisplay()}clearContext(){this.selectedContext={files:[],folders:[]},this.updateContextDisplay()}async processInlineImages(){var t;if(!this.contextSelector||!this.contextSelector.inputEl)return;let e=this.contextSelector.inputEl.querySelectorAll(".markdown-next-ai-inline-tag");for(let n of Array.from(e)){let i=n.getAttribute("data-type"),o=n.getAttribute("data-path");if(i==="image"&&o)try{let a=this.plugin.app.vault.getAbstractFileByPath(o);if(!a)continue;let l=await this.plugin.app.vault.readBinary(a),s=new Uint8Array(l),c="";for(let E=0;E<s.length;E++)c+=String.fromCharCode(s[E]);let r=btoa(c),p={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",svg:"image/svg+xml"}[((t=a.extension)==null?void 0:t.toLowerCase())||"png"]||"image/png",g=`data:${p};base64,${r}`,x={id:Date.now()+Math.random(),name:a.name,size:l.byteLength,type:p,base64:g,url:g,fromInline:!0};this.imageHandler.getImages().some(E=>E.name===x.name&&E.size===x.size)||this.imageHandler.addImage(x)}catch(a){console.error("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+o,a),new tt.Notice("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+o)}}}async getContextContent(){let e="";for(let n of this.selectedContext.files)try{let i=this.plugin.app.vault.getAbstractFileByPath(n.path);if(i){let o=await this.plugin.app.vault.read(i);e+=`

=== \u6587\u6863: ${n.name} ===
${o}`}}catch(i){console.error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:",i)}let t=(n,i)=>{let o=[];if(n&&n.children){for(let a of n.children)if(a.extension==="md")o.push({file:a,sourcePath:a.path,baseFolderName:i});else if(a.children){let l=t(a,i);o.push(...l)}}return o};for(let n of this.selectedContext.folders)try{let i=this.plugin.app.vault.getAbstractFileByPath(n.path);if(i){let o=t(i,n.name);for(let{file:a,sourcePath:l,baseFolderName:s}of o){let c=await this.plugin.app.vault.read(a);e+=`

=== \u6587\u6863: ${a.basename} (\u6765\u81EA\u6587\u4EF6\u5939: ${s}, \u8DEF\u5F84: ${l}) ===
${c}`}}}catch(i){console.error("\u8BFB\u53D6\u6587\u4EF6\u5939\u5931\u8D25:",i)}return e.trim()}};var _=class{constructor(e,t,n,i,o,a=null){this.isOpen=!1;this.popupEl=null;this.scrollContainer=null;this.app=e,this.editor=t,this.view=n,this.onConfirm=i,this.onReject=o,this.onAppend=a}open(e){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-preview-popup"),this.popupEl.innerHTML=`
            <div class="markdown-next-ai-preview-content">
                <div class="markdown-next-ai-preview-header">
                    <div class="markdown-next-ai-preview-status thinking">
                        <span class="status-dot"></span>
                        <span class="status-text">\u6B63\u5728\u601D\u8003\u4E2D</span>
                    </div>
                </div>
                <div class="markdown-next-ai-preview-actions" style="display: none;">
                    <button class="markdown-next-ai-preview-btn confirm" title="\u66FF\u6362\u539F\u6587">\u66FF\u6362</button>
                    ${this.onAppend?'<button class="markdown-next-ai-preview-btn append" title="\u4FDD\u7559\u539F\u6587\u5E76\u8FFD\u52A0">\u8FFD\u52A0</button>':""}
                    <button class="markdown-next-ai-preview-btn reject" title="\u653E\u5F03\u751F\u6210">\u653E\u5F03</button>
                </div>
            </div>
        `;let t=this.popupEl.querySelector(".markdown-next-ai-preview-btn.confirm"),n=this.popupEl.querySelector(".markdown-next-ai-preview-btn.reject"),i=this.popupEl.querySelector(".markdown-next-ai-preview-btn.append");t.onclick=()=>{this.onConfirm&&this.onConfirm(),this.close()},i&&(i.onclick=()=>{this.onAppend&&this.onAppend(),this.close()}),n.onclick=()=>{this.onReject&&this.onReject(),this.close()},this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor")),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.popupEl.style.position="absolute",this.scrollContainer.appendChild(this.popupEl)):(this.popupEl.style.position="fixed",document.body.appendChild(this.popupEl)),e&&this.positionAt(e.left,e.top,"above")}positionAt(e,t,n="above"){if(!this.popupEl)return;let i=this.popupEl.getBoundingClientRect();if(this.scrollContainer){let o=this.scrollContainer.getBoundingClientRect(),a=this.scrollContainer.scrollTop,l=this.scrollContainer.scrollLeft,s=this.scrollContainer.querySelector(".cm-content"),c=s?s.getBoundingClientRect():o,r,d;n==="above"?(r=c.left-o.left+l-i.width-2,d=t-o.top+a-i.height/2,r<0&&(r=c.right-o.left+l+12)):n==="right"?(r=e-o.left+l+12,d=t-o.top+a-i.height/2,r+i.width>o.width-10&&(r=o.width-i.width-10,d=t-o.top+a+20)):(r=e-o.left+l,d=t-o.top+a+12,r+i.width>o.width-10&&(r=o.width-i.width-10)),d<a&&(d=a+10),this.popupEl.style.left=r+"px",this.popupEl.style.top=d+"px"}else{let o=window.innerWidth,a=window.innerHeight,l,s;n==="above"?(l=e-i.width-50,s=t-i.height/2,l<10&&(l=e+50)):n==="right"?(l=e+8,s=t-i.height/2):(l=e,s=t+8,s+i.height>a-10&&(s=t-i.height-8)),s<10&&(s=10),s+i.height>a-10&&(s=a-i.height-10),l+i.width>o-10&&(l=o-i.width-10),l<10&&(l=10),this.popupEl.style.left=l+"px",this.popupEl.style.top=s+"px"}this.popupEl.style.right="auto",this.popupEl.style.bottom="auto"}updateStatus(e){if(!this.popupEl)return;let t=this.popupEl.querySelector(".markdown-next-ai-preview-status"),n=this.popupEl.querySelector(".status-text");t&&n&&(n.textContent=e,t.classList.remove("thinking","generating"),e.includes("\u751F\u6210")?t.classList.add("generating"):t.classList.add("thinking"))}showActions(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-preview-status"),t=this.popupEl.querySelector(".markdown-next-ai-preview-actions");e&&(e.style.display="none"),t&&(t.style.display="flex")}close(){this.isOpen&&(this.isOpen=!1,this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null)}};var Y=class extends N.Plugin{constructor(){super(...arguments);this.eventListeners=[];this.atTriggerTimeout=null;this.lastMouseUpPosition=null}async onload(){await this.loadSettings(),this.aiService=new U(this.settings,this.app),this.ruleManager=new K(this),this.addSettingTab(new X(this.app,this)),this.addCommands(),this.updateEventListeners(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u52A0\u8F7D")}onunload(){this.cleanupEventListeners(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u5378\u8F7D")}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},B,t),t&&(t.providers&&(this.settings.providers=Object.assign({},B.providers,t.providers)),t.models&&(this.settings.models=Object.assign({},B.models,t.models),Object.keys(this.settings.models).forEach(n=>{let i=this.settings.models[n];(typeof i!="object"||i===null||!i.id||n in B)&&(n in B&&n!=="models"?delete this.settings.models[n]:(typeof i!="object"||i===null||!i.id)&&delete this.settings.models[n])})))}async saveSettings(){await this.saveData(this.settings),this.aiService&&this.aiService.updateSettings(this.settings)}getAvailableModels(){return Object.values(this.settings.models).filter(t=>t.enabled).map(t=>({id:t.id,name:t.name,provider:t.provider}))}addCommands(){this.addCommand({id:"continue-writing",name:"\u667A\u80FD\u7EED\u5199",callback:()=>{this.handleContinueWriting()}}),this.addCommand({id:"open-ai-popup",name:"\u5524\u51FAAI\u5BF9\u8BDD\u6846",hotkeys:[{modifiers:["Ctrl"],key:"m"}],editorCallback:t=>{let n=t.getSelection()||"";this.showAtTriggerModal(n)}})}updateEventListeners(){this.cleanupEventListeners(),this.settings.enableAtTrigger&&this.setupAtTriggerListener(),this.setupPromptTriggerListener(),this.setupRightClickListener();let t=n=>{let i=window.getSelection();if(i&&i.rangeCount>0){let a=i.getRangeAt(0).getBoundingClientRect();(a.width>0||a.height>0)&&(this.lastMouseUpPosition={left:a.right,top:a.top,height:a.height||20})}};document.addEventListener("mouseup",t),this.eventListeners.push({element:document,event:"mouseup",handler:t})}setupRightClickListener(){this.registerEvent(this.app.workspace.on("editor-menu",(t,n,i)=>{let o=n.getSelection();o&&o.trim()&&t.addItem(a=>{a.setTitle("Markdown-Next-AI\uFF1A\u4FEE\u6539\u6240\u9009\u5185\u5BB9").setIcon("bot").onClick(()=>{this.showAtTriggerModal(o)})})}))}setupPromptTriggerListener(){}showPromptSelectorModal(t){new D(this.app,this,n=>{if(t.contentEditable==="true"){let i=window.getSelection();if(!i||!i.rangeCount)return;let o=i.getRangeAt(0),a=o.startContainer;if(a.nodeType===Node.TEXT_NODE){let l=a.textContent||"",s=o.startOffset,c=l.lastIndexOf("#",s-1);if(c!==-1){let r=l.substring(0,c)+n+l.substring(s);a.textContent=r;let d=c+n.length;try{let p=document.createRange();p.setStart(a,d),p.collapse(!0),i.removeAllRanges(),i.addRange(p)}catch(p){console.error("Failed to set cursor position",p)}}}}else{let i=t,o=i.selectionStart||0,a=i.value,l=a.substring(0,o),s=a.substring(o),c=l.lastIndexOf("#");if(c!==-1){let r=l.substring(0,c)+n;i.value=r+s,i.selectionStart=i.selectionEnd=r.length,i.focus()}}}).open(t)}setupAtTriggerListener(){let t=n=>{if(n.key==="@"||n.shiftKey&&n.key==="2"||n.key==="&"||n.shiftKey&&n.key==="7"){let i=document.activeElement;if(i&&(i.classList.contains("markdown-next-ai-modify-input")||i.classList.contains("markdown-next-ai-continue-input")))return;let o=this.app.workspace.getActiveViewOfType(N.MarkdownView);if(!o||!o.editor)return;this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.atTriggerTimeout=setTimeout(()=>{let a=o.editor.getCursor(),s=o.editor.getLine(a.line).substring(0,a.ch),c=s.charAt(s.length-1);(c==="@"||c==="&")&&!s.endsWith("@@")&&!s.endsWith("&&")&&(this.showAtTriggerModal(),this.atTriggerTimeout=null)},500)}};document.addEventListener("keydown",t),this.eventListeners.push({element:document,event:"keydown",handler:t})}cleanupEventListeners(){this.eventListeners&&(this.eventListeners.forEach(({element:t,event:n,handler:i})=>{t&&i&&(t===this.app.workspace&&typeof t.off=="function"?t.off(n,i):typeof t.removeEventListener=="function"&&t.removeEventListener(n,i))}),this.eventListeners=[])}showAtTriggerModal(t=""){let n=this.app.workspace.getActiveViewOfType(N.MarkdownView),i=this.getCursorPosition();i&&new V(this.app,(o,a,l,s,c)=>{this.handleContinueWriting(o,a,l,s,c)},i,this,n,t).open()}getCursorPosition(){let t=this.app.workspace.getActiveViewOfType(N.MarkdownView);if(!t||!t.editor)return null;let n=t.editor;if(n.somethingSelected()){let i=n.getCursor("from"),o=n.coordsAtPos(i),a=n.getCursor("to"),l=n.coordsAtPos(a);if(o&&l)return{left:o.left,top:l.top,height:l.bottom-l.top}}try{let i=this.app.workspace.getActiveViewOfType(N.MarkdownView);if(!i||!i.editor)return null;let o=i.containerEl.querySelector(".cm-editor");if(!o)return null;let a=i.editor.getCursor(),l=i.editor.coordsAtPos(a);if(l)return{left:l.left,top:l.top,height:l.bottom-l.top};let s=window.getSelection();if(s&&s.rangeCount>0){let d=s.getRangeAt(0).getBoundingClientRect();if(d.width>0||d.height>0)return{left:d.left,top:d.top,height:d.height||20}}let c=o.getBoundingClientRect();return{left:c.left+50,top:c.top+50,height:20}}catch(i){return console.error("\u83B7\u53D6\u5149\u6807\u4F4D\u7F6E\u5931\u8D25:",i),null}}async handleContinueWriting(t="",n=[],i=null,o=null,a=""){let l=this.app.workspace.getActiveViewOfType(N.MarkdownView);if(!l||!l.editor){new N.Notice("\u8BF7\u5728Markdown\u7F16\u8F91\u5668\u4E2D\u4F7F\u7528\u6B64\u529F\u80FD");return}if(!t&&n.length===0&&!o&&!a){this.showAtTriggerModal();return}let s=l.editor,c=s.getCursor(),r=s.getLine(c.line),d=c.ch>0?r.charAt(c.ch-1):"";if(d==="@"||d==="&"){let L={line:c.line,ch:c.ch-1},k={line:c.line,ch:c.ch};s.replaceRange("",L,k),c.ch=c.ch-1}let p=a.length>0,g=p?s.getCursor("from"):{line:c.line,ch:c.ch},x="markdown-next-ai-preview-"+Date.now(),T="markdown-next-ai-original-"+Date.now(),E=`<span style="background:#90EE90;" data-preview-id="${x}">`,C=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${T}">`,m="</span>";if(p){let L=`${C}${a}${m}${E}${m}`;s.replaceSelection(L)}else s.replaceRange(`${E}${m}`,g);let f;p?f=s.posToOffset(g)+C.length+a.length+m.length+E.length:f=s.posToOffset(g)+E.length;let h=0,y=!1,H=s.coordsAtPos(g),R=H?{left:H.left,top:H.top}:null,I=new _(this.app,s,l,()=>{let L=s.getValue(),k=`<span style="background:#90EE90;" data-preview-id="${x}">`,P=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${T}">`;if(p){let w=s.getValue(),v=w.indexOf(k);if(v!==-1){let S=v+k.length,M=w.indexOf(m,S);if(M!==-1){let F=M+m.length;s.replaceRange("",s.offsetToPos(M),s.offsetToPos(F)),s.replaceRange("",s.offsetToPos(v),s.offsetToPos(S))}}w=s.getValue();let b=w.indexOf(P);if(b!==-1){let S=b+P.length,M=w.indexOf(m,S);if(M!==-1){let F=M+m.length;s.replaceRange("",s.offsetToPos(b),s.offsetToPos(F)),s.setCursor(s.offsetToPos(b))}}}else{let w=L.indexOf(k);if(w!==-1){let v=w+k.length,b=L.indexOf(m,v);if(b!==-1){let S=b+m.length;s.replaceRange("",s.offsetToPos(b),s.offsetToPos(S)),s.replaceRange("",s.offsetToPos(w),s.offsetToPos(v));let M=b-k.length;s.setCursor(s.offsetToPos(M))}}}new N.Notice("\u5DF2\u66FF\u6362\u539F\u6587")},()=>{let L=s.getValue(),k=`<span style="background:#90EE90;" data-preview-id="${x}">`,P=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${T}">`;if(p){let w=s.getValue(),v=w.indexOf(k);if(v!==-1){let S=v+k.length,M=w.indexOf(m,S);if(M!==-1){let F=M+m.length;s.replaceRange("",s.offsetToPos(v),s.offsetToPos(F))}}w=s.getValue();let b=w.indexOf(P);if(b!==-1){let S=b+P.length,M=w.indexOf(m,S);if(M!==-1){let F=M+m.length;s.replaceRange("",s.offsetToPos(M),s.offsetToPos(F)),s.replaceRange("",s.offsetToPos(b),s.offsetToPos(S)),s.setCursor(s.offsetToPos(b))}}}else{let w=L.indexOf(k);if(w!==-1){let v=w+k.length,b=L.indexOf(m,v);if(b!==-1){let S=b+m.length;s.replaceRange("",s.offsetToPos(w),s.offsetToPos(S)),s.setCursor(s.offsetToPos(w))}}}new N.Notice("\u5DF2\u653E\u5F03\u751F\u6210")},p?()=>{let L=`<span style="background:#90EE90;" data-preview-id="${x}">`,k=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${T}">`,P=s.getValue(),w=P.indexOf(L);if(w!==-1){let b=w+L.length,S=P.indexOf(m,b);if(S!==-1){let M=S+m.length;s.replaceRange("",s.offsetToPos(S),s.offsetToPos(M)),s.replaceRange("",s.offsetToPos(w),s.offsetToPos(b))}}P=s.getValue();let v=P.indexOf(k);if(v!==-1){let b=v+k.length,S=P.indexOf(m,b);if(S!==-1){let M=S+m.length;s.replaceRange("",s.offsetToPos(S),s.offsetToPos(M)),s.replaceRange("",s.offsetToPos(v),s.offsetToPos(b))}}new N.Notice("\u5DF2\u8FFD\u52A0\u5185\u5BB9")}:null);I.open(R);try{let L=await this.aiService.sendRequest("continue",{selectedText:a,beforeText:s.getValue().substring(0,s.posToOffset(g)),afterText:"",cursorPosition:c,additionalContext:o||void 0},t,n,[],k=>{if(k.content!=null){let P=s.offsetToPos(f),w=s.offsetToPos(f+h);s.replaceRange(k.content,P,w),h=k.content.length;let v=s.offsetToPos(f+h);s.setCursor(v),y=!0,I.updateStatus(`\u6B63\u5728\u751F\u6210\u4E2D(${h}\u5B57)`)}if(k.isComplete){I.showActions();let P=s.offsetToPos(f+h),w=s.coordsAtPos(P);w&&I.positionAt(w.left,w.bottom,"below")}});if(!y&&L&&L.content){let k=s.offsetToPos(f),P=s.offsetToPos(f+h);s.replaceRange(L.content,k,P),h=L.content.length;let w=s.offsetToPos(f+h);s.setCursor(w),I.showActions();let v=s.offsetToPos(f+h),b=s.coordsAtPos(v);b&&I.positionAt(b.left,b.bottom,"below")}}catch(L){let k=`<span style="background:#90EE90;" data-preview-id="${x}">`,P=`<span style="background:#FFCCCB;text-decoration:line-through;" data-original-id="${T}">`;if(p){let w=s.getValue(),v=w.indexOf(k);if(v!==-1){let S=v+k.length,M=w.indexOf(m,S);if(M!==-1){let F=M+m.length;s.replaceRange("",s.offsetToPos(v),s.offsetToPos(F))}}w=s.getValue();let b=w.indexOf(P);if(b!==-1){let S=b+P.length,M=w.indexOf(m,S);if(M!==-1){let F=M+m.length;s.replaceRange("",s.offsetToPos(M),s.offsetToPos(F)),s.replaceRange("",s.offsetToPos(b),s.offsetToPos(S))}}}else{let w=s.getValue(),v=w.indexOf(k);if(v!==-1){let b=v+k.length,S=w.indexOf(m,b);if(S!==-1){let M=S+m.length;s.replaceRange("",s.offsetToPos(v),s.offsetToPos(M))}}}s.setCursor(g),I.close(),new N.Notice("\u7EED\u5199\u5931\u8D25: "+L.message)}}};
