var ve=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var Fe=Object.prototype.hasOwnProperty;var U=(P,t)=>()=>(P&&(t=P(P=0)),t);var Te=(P,t)=>{for(var e in t)ve(P,e,{get:t[e],enumerable:!0})},$e=(P,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Re(t))!Fe.call(P,i)&&i!==e&&ve(P,i,{get:()=>t[i],enumerable:!(n=Oe(t,i))||n.enumerable});return P};var Ne=P=>$e(ve({},"__esModule",{value:!0}),P);var ce,Me=U(()=>{ce=class{constructor(){this.name="gemini";this.baseUrl="https://generativelanguage.googleapis.com/v1beta/models";this.model="text-embedding-004"}async getEmbedding(t,e){var n,i,s,r,a;try{let l=((n=e.embedModel)==null?void 0:n.apiKey)||((s=(i=e.providers)==null?void 0:i.gemini)==null?void 0:s.apiKey);if(!l)return console.error("[GeminiAdapter] Gemini API key not configured"),null;let o=((r=e.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,c=((a=e.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[GeminiAdapter] Getting embedding using model: ${c}`);let d=await fetch(`${o}/${c}:embedContent?key=${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:t}]}}),signal:AbortSignal.timeout(3e4)});if(!d.ok){let h=await d.text();return console.error(`[GeminiAdapter] Gemini API error: ${d.status} ${h}`),null}let p=await d.json();if(!p.embedding||!p.embedding.values)return console.error("[GeminiAdapter] Invalid embedding response"),null;let u=p.embedding.values;return console.log(`[GeminiAdapter] Generated embedding, dimension: ${u.length}`),u}catch(l){return console.error("[GeminiAdapter] Failed to generate embedding:",l),null}}async getEmbeddings(t,e){var n,i,s,r,a;try{let l=((n=e.embedModel)==null?void 0:n.apiKey)||((s=(i=e.providers)==null?void 0:i.gemini)==null?void 0:s.apiKey);if(!l)return console.error("[GeminiAdapter] Gemini API key not configured"),null;let o=((r=e.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,c=((a=e.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[GeminiAdapter] Getting embeddings for ${t.length} texts using model: ${c}`);let d=[];for(let p of t)try{let u=await fetch(`${o}/${c}:embedContent?key=${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:{parts:[{text:p}]}}),signal:AbortSignal.timeout(3e4)});if(u.ok){let h=await u.json();h.embedding&&h.embedding.values&&d.push(h.embedding.values)}else console.warn(`[GeminiAdapter] Failed to embed text: ${u.statusText}`),d.push([])}catch(u){console.warn("[GeminiAdapter] Error embedding single text:",u),d.push([])}return console.log(`[GeminiAdapter] Generated ${d.length} embeddings`),d}catch(l){return console.error("[GeminiAdapter] Failed to generate embeddings:",l),null}}getModelInfo(){return{adapter:this.name,baseUrl:this.baseUrl,model:this.model,description:"Google Gemini embedding service",models:["text-embedding-004"]}}}});var de,Se=U(()=>{de=class{constructor(){this.name="ollama";this.baseUrl="http://localhost:11434";this.model="nomic-embed-text"}async isOllamaAvailable(){try{return(await fetch(`${this.baseUrl}/api/tags`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok}catch(t){return console.error("[OllamaAdapter] Ollama service not available:",t),!1}}async getEmbedding(t,e){var n,i;try{let s=((n=e.embedModel)==null?void 0:n.baseUrl)||this.baseUrl,r=((i=e.embedModel)==null?void 0:i.modelKey)||this.model;if(!await this.isOllamaAvailable())return console.error("[OllamaAdapter] Ollama service is not running"),null;console.log(`[OllamaAdapter] Getting embedding for text using model: ${r}`);let a=await fetch(`${s}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,prompt:t}),signal:AbortSignal.timeout(3e4)});if(!a.ok)return console.error(`[OllamaAdapter] Failed to get embedding: ${a.statusText}`),null;let l=await a.json();return!l.embedding||!Array.isArray(l.embedding)?(console.error("[OllamaAdapter] Invalid embedding response"),null):(console.log(`[OllamaAdapter] Generated embedding, dimension: ${l.embedding.length}`),l.embedding)}catch(s){return console.error("[OllamaAdapter] Failed to generate embedding:",s),null}}async getEmbeddings(t,e){var n,i;try{let s=((n=e.embedModel)==null?void 0:n.baseUrl)||this.baseUrl,r=((i=e.embedModel)==null?void 0:i.modelKey)||this.model;if(!await this.isOllamaAvailable())return console.error("[OllamaAdapter] Ollama service is not running"),null;console.log(`[OllamaAdapter] Getting embeddings for ${t.length} texts using model: ${r}`);let a=[];for(let l of t)try{let o=await fetch(`${s}/api/embeddings`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:r,prompt:l}),signal:AbortSignal.timeout(3e4)});if(o.ok){let c=await o.json();c.embedding&&Array.isArray(c.embedding)&&a.push(c.embedding)}else console.warn(`[OllamaAdapter] Failed to embed text: ${o.statusText}`),a.push([])}catch(o){console.warn("[OllamaAdapter] Error embedding single text:",o),a.push([])}return console.log(`[OllamaAdapter] Generated ${a.length} embeddings`),a}catch(s){return console.error("[OllamaAdapter] Failed to generate embeddings:",s),null}}getModelInfo(){return{adapter:this.name,baseUrl:this.baseUrl,model:this.model,description:"Local Ollama service for embeddings"}}}});var pe,Ae=U(()=>{pe=class{constructor(){this.name="openai";this.baseUrl="https://api.openai.com/v1";this.model="text-embedding-3-small"}async getEmbedding(t,e){var n,i,s,r,a;try{let l=((n=e.embedModel)==null?void 0:n.apiKey)||((s=(i=e.providers)==null?void 0:i.openai)==null?void 0:s.apiKey);if(!l)return console.error("[OpenAIAdapter] OpenAI API key not configured"),null;let o=((r=e.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,c=((a=e.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[OpenAIAdapter] Getting embedding using model: ${c}`);let d=await fetch(`${o}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({model:c,input:t,encoding_format:"float"}),signal:AbortSignal.timeout(3e4)});if(!d.ok){let h=await d.text();return console.error(`[OpenAIAdapter] OpenAI API error: ${d.status} ${h}`),null}let p=await d.json();if(!p.data||!p.data[0]||!p.data[0].embedding)return console.error("[OpenAIAdapter] Invalid embedding response"),null;let u=p.data[0].embedding;return console.log(`[OpenAIAdapter] Generated embedding, dimension: ${u.length}`),u}catch(l){return console.error("[OpenAIAdapter] Failed to generate embedding:",l),null}}async getEmbeddings(t,e){var n,i,s,r,a;try{let l=((n=e.embedModel)==null?void 0:n.apiKey)||((s=(i=e.providers)==null?void 0:i.openai)==null?void 0:s.apiKey);if(!l)return console.error("[OpenAIAdapter] OpenAI API key not configured"),null;let o=((r=e.embedModel)==null?void 0:r.baseUrl)||this.baseUrl,c=((a=e.embedModel)==null?void 0:a.modelKey)||this.model;console.log(`[OpenAIAdapter] Getting embeddings for ${t.length} texts using model: ${c}`);let d=await fetch(`${o}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({model:c,input:t,encoding_format:"float"}),signal:AbortSignal.timeout(6e4)});if(!d.ok){let h=await d.text();return console.error(`[OpenAIAdapter] OpenAI API error: ${d.status} ${h}`),null}let p=await d.json();if(!p.data||!Array.isArray(p.data))return console.error("[OpenAIAdapter] Invalid embeddings response"),null;let u=p.data.sort((h,f)=>h.index-f.index).map(h=>h.embedding);return console.log(`[OpenAIAdapter] Generated ${u.length} embeddings`),u}catch(l){return console.error("[OpenAIAdapter] Failed to generate embeddings:",l),null}}getModelInfo(){return{adapter:this.name,baseUrl:this.baseUrl,model:this.model,description:"OpenAI embedding service",models:["text-embedding-3-small","text-embedding-3-large"]}}}});var W,Le=U(()=>{W=class{static async loadTransformers(){let t="transformers";if(this.loadedModules.has(t))return this.loadedModules.get(t);if(this.loadingPromises.has(t))return this.loadingPromises.get(t);let e=this._loadTransformersFromCDN();this.loadingPromises.set(t,e);try{let n=await e;return this.loadedModules.set(t,n),n}finally{this.loadingPromises.delete(t)}}static async _loadTransformersFromCDN(){try{console.log("[ExternalLoader] Loading transformers.js from CDN...");let t=await this._loadViaScript("https://cdn-allow-origin.huggingface.co/transformers.js@3/dist/transformers.min.js");return console.log("[ExternalLoader] Transformers.js loaded successfully"),t}catch(t){return console.error("[ExternalLoader] Failed to load transformers.js from CDN:",t),this._loadTransformersFromUnpkg()}}static async _loadTransformersFromUnpkg(){try{console.log("[ExternalLoader] Trying unpkg CDN as fallback...");let t=await this._loadViaScript("https://unpkg.com/@xenova/transformers@3/dist/transformers.min.js");return console.log("[ExternalLoader] Transformers.js loaded from unpkg"),t}catch(t){throw console.error("[ExternalLoader] Failed to load from unpkg:",t),new Error("Failed to load transformers.js from all CDN sources. Please check your internet connection.")}}static _loadViaScript(t){return new Promise((e,n)=>{let i=window.transformers;if(i){console.log("[ExternalLoader] Transformers already loaded in global scope"),e(i);return}let s=document.createElement("script");s.src=t,s.type="text/javascript",s.async=!0,s.onload=()=>{let r=window.transformers;r?(console.log(`[ExternalLoader] Successfully loaded from ${t}`),e(r)):n(new Error(`Transformers not found in global scope after loading ${t}`))},s.onerror=()=>{n(new Error(`Failed to load script from ${t}`))},s.setAttribute("crossorigin","anonymous"),document.head.appendChild(s)})}static async loadTransformersViaScript(){return this._loadViaScript("https://cdn-allow-origin.huggingface.co/transformers.js@3/dist/transformers.min.js")}static clearModuleCache(t){t?(this.loadedModules.delete(t),console.log(`[ExternalLoader] Module cache cleared for: ${t}`)):(this.loadedModules.clear(),console.log("[ExternalLoader] All module caches cleared"))}static getModuleStatus(t){return this.loadedModules.has(t)?"loaded":this.loadingPromises.has(t)?"loading":"not-loaded"}};W.loadedModules=new Map,W.loadingPromises=new Map});var q,ue,Pe=U(()=>{q=class q{constructor(){this.db=null;this.dbName="MardownNextAI-ModelCache";this.storeName="models";this.dbVersion=1;this.initPromise=null}static getInstance(){return q.instance||(q.instance=new q),q.instance}async init(){if(!this.db)return this.initPromise?this.initPromise:(this.initPromise=new Promise((t,e)=>{try{let n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>{console.error("[ModelCache] Failed to open database"),e(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this.db=n.result,console.log("[ModelCache] Database initialized"),t()},n.onupgradeneeded=i=>{let s=i.target.result;s.objectStoreNames.contains(this.storeName)||(s.createObjectStore(this.storeName,{keyPath:"key"}),console.log("[ModelCache] Object store created"))}}catch(n){console.error("[ModelCache] Error initializing database:",n),e(n)}}),this.initPromise)}async get(t){try{return await this.init(),this.db?new Promise((e,n)=>{let r=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);r.onsuccess=()=>{let a=r.result;a?(console.log(`[ModelCache] Cache hit for key: ${t}`),e(a.data)):(console.log(`[ModelCache] Cache miss for key: ${t}`),e(null))},r.onerror=()=>{console.error("[ModelCache] Error reading from cache"),n(new Error("Failed to read from cache"))}}):null}catch(e){return console.error("[ModelCache] Error getting cache:",e),null}}async set(t,e,n){try{return await this.init(),this.db?new Promise((i,s)=>{let a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),l={key:t,data:e,timestamp:Date.now(),size:n},o=a.put(l);o.onsuccess=()=>{console.log(`[ModelCache] Cache saved for key: ${t}`),i(!0)},o.onerror=()=>{console.error("[ModelCache] Error writing to cache"),s(new Error("Failed to write to cache"))}}):!1}catch(i){return console.error("[ModelCache] Error setting cache:",i),!1}}async remove(t){try{return await this.init(),this.db?new Promise((e,n)=>{let r=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(t);r.onsuccess=()=>{console.log(`[ModelCache] Cache removed for key: ${t}`),e(!0)},r.onerror=()=>{console.error("[ModelCache] Error deleting cache"),n(new Error("Failed to delete cache"))}}):!1}catch(e){return console.error("[ModelCache] Error removing cache:",e),!1}}async clear(){try{return await this.init(),this.db?new Promise((t,e)=>{let s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();s.onsuccess=()=>{console.log("[ModelCache] All caches cleared"),t(!0)},s.onerror=()=>{console.error("[ModelCache] Error clearing cache"),e(new Error("Failed to clear cache"))}}):!1}catch(t){return console.error("[ModelCache] Error clearing cache:",t),!1}}close(){this.db&&(this.db.close(),this.db=null,console.log("[ModelCache] Database closed"))}};q.instance=null;ue=q});var V,he,Ie=U(()=>{Le();Pe();V=class V{constructor(){this.name="transformers";this.embedder=null;this.currentModelKey=null;this.isLoading=!1;this.loadingPromise=null;this.transformersLib=null;this.cacheManager=ue.getInstance()}static getInstance(){return V.instance||(V.instance=new V),V.instance}async loadTransformersLib(){if(this.transformersLib)return this.transformersLib;try{console.log("[TransformersAdapter] Loading transformers.js from CDN..."),this.transformersLib=await W.loadTransformers();let{env:t}=this.transformersLib;return t&&(t.allowLocalModels=!1,t.allowRemoteModels=!0,t.cacheDir="transformers-cache",console.log("[TransformersAdapter] Environment configured with IndexedDB caching")),this.transformersLib}catch(t){throw console.error("[TransformersAdapter] Failed to load transformers library:",t),new Error("Failed to load Transformers.js from CDN. Please check your internet connection.")}}async loadModel(t){if(!(this.embedder&&this.currentModelKey===t)){if(this.isLoading&&this.currentModelKey===t&&this.loadingPromise){await this.loadingPromise;return}this.isLoading=!0,this.currentModelKey=t,this.loadingPromise=(async()=>{try{console.log(`[TransformersAdapter] Loading model: ${t}...`);let e=await this.loadTransformersLib(),{pipeline:n}=e;this.embedder=await n("feature-extraction",t,{quantized:!0,device:"gpu"}),console.log(`[TransformersAdapter] Model loaded successfully: ${t}`)}catch(e){throw console.error(`[TransformersAdapter] Failed to load model ${t}:`,e),this.embedder=null,this.currentModelKey=null,e}finally{this.isLoading=!1,this.loadingPromise=null}})(),await this.loadingPromise}}async getEmbedding(t,e){var n;try{let i=((n=e.embedModel)==null?void 0:n.modelKey)||"TaylorAI/bge-micro-v2";if(await this.loadModel(i),!this.embedder)return console.error("[TransformersAdapter] Embedder not initialized"),null;let s=await this.embedder(t,{pooling:"mean",normalize:!0}),r=Array.from(s.data);return r.length===0?(console.warn("[TransformersAdapter] Empty embedding generated"),null):(console.log(`[TransformersAdapter] Generated embedding, dimension: ${r.length}`),r)}catch(i){return console.error("[TransformersAdapter] Failed to generate embedding:",i),null}}async getEmbeddings(t,e){var n;try{let i=((n=e.embedModel)==null?void 0:n.modelKey)||"TaylorAI/bge-micro-v2";if(await this.loadModel(i),!this.embedder)return console.error("[TransformersAdapter] Embedder not initialized"),null;console.log(`[TransformersAdapter] Generating embeddings for ${t.length} texts...`);let s=[];for(let r of t){let a=await this.embedder(r,{pooling:"mean",normalize:!0});s.push(Array.from(a.data))}return console.log(`[TransformersAdapter] Generated ${s.length} embeddings`),s}catch(i){return console.error("[TransformersAdapter] Failed to generate embeddings:",i),null}}async unload(){this.embedder&&(console.log(`[TransformersAdapter] Unloading model: ${this.currentModelKey}`),this.embedder=null,this.currentModelKey=null),this.transformersLib=null}getModelInfo(){return{adapter:this.name,modelKey:this.currentModelKey,isLoading:this.isLoading,hasEmbedder:!!this.embedder}}};V.instance=null;he=V});var ee={};Te(ee,{GeminiEmbeddingAdapter:()=>ce,OllamaEmbeddingAdapter:()=>de,OpenAIEmbeddingAdapter:()=>pe,TransformersEmbeddingAdapter:()=>he});var te=U(()=>{Me();Se();Ae();Ie()});var De={};Te(De,{default:()=>we});module.exports=Ne(De);var O=require("obsidian");var R={THINKING:"thinking",VISION:"vision",MULTIMODAL:"multimodal",TEXT:"text",IMAGE:"image"},Ce={edit:"\u4F60\u662F\u4E00\u4E2A\u7CBE\u786E\u7684\u6587\u672C\u7F16\u8F91\u52A9\u624B\u3002\u4EC5\u4FEE\u6539\u7528\u6237\u9009\u4E2D\u7684\u6587\u672C\uFF0C\u4FDD\u6301\u539F\u6709\u98CE\u683C\u3001\u8BED\u6C14\u548C\u7ED3\u6784\uFF0C\u4E0D\u8981\u6539\u52A8\u672A\u9009\u5185\u5BB9\uFF1B\u5982\u9700\u4F18\u5316\u903B\u8F91\u4E0E\u8868\u8FBE\uFF0C\u7B80\u6D01\u5B8C\u6210\u3002",chat:"\u4F60\u662F\u4E00\u4E2A\u5BF9\u8BDD\u548C\u95EE\u7B54\u52A9\u624B\u3002\u76F4\u63A5\u56DE\u7B54\u7528\u6237\u95EE\u9898\u6216\u534F\u52A9\u751F\u6210\u5185\u5BB9\uFF1B\u82E5\u63D0\u4F9B\u53C2\u8003\u6587\u6863\uFF0C\u5FC5\u987B\u4EE5\u6587\u6863\u4E3A\u51C6\uFF0C\u907F\u514D\u81C6\u9020\u3002",insert:"\u4F60\u662F\u4E00\u4E2A\u7EED\u5199/\u63D2\u5165\u52A9\u624B\u3002\u6839\u636E\u5149\u6807\u4E0A\u4E0B\u6587\u751F\u6210\u53EF\u76F4\u63A5\u63D2\u5165\u7684\u65B0\u5185\u5BB9\uFF0C\u4FDD\u6301\u8FDE\u8D2F\u4E0E\u98CE\u683C\u4E00\u81F4\uFF0C\u4E0D\u590D\u8FF0\u5DF2\u6709\u4E0A\u4E0B\u6587\u3002",continue:"\u4F60\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u5199\u4F5C\u52A9\u624B\u3002\u8BF7\u6839\u636E\u7528\u6237\u63D0\u4F9B\u7684\u4E0A\u4E0B\u6587\uFF0C\u4ECE\u5149\u6807\u4F4D\u7F6E\u5F00\u59CB\u7EED\u5199\u540E\u7EED\u5185\u5BB9\u3002\u91CD\u8981\uFF1A\u53EA\u751F\u6210\u65B0\u7684\u5185\u5BB9\uFF0C\u4E0D\u8981\u91CD\u590D\u6216\u91CD\u5199\u5DF2\u6709\u7684\u5185\u5BB9\u3002"},ye={IMAGE:["png","jpg","jpeg","gif","bmp","svg","webp"],DOCUMENT:["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"]},xe={MAX_FILE_SIZE:10485760,ALLOWED_TYPES:["image/jpeg","image/png","image/gif","image/webp"]};var B={providers:{openai:{apiKey:"",baseUrl:"https://api.openai.com/v1",enabled:!0}},models:{"gemini-3-pro-preview":{id:"gemini-3-pro-preview",name:"Gemini 3 Pro Preview",provider:"openai",model:"gemini-3-pro-preview",enabled:!0,category:R.MULTIMODAL},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",name:"Gemini 3 Flash Preview",provider:"openai",model:"gemini-3-flash-preview",enabled:!0,category:R.MULTIMODAL},"gpt-5":{id:"gpt-5",name:"GPT-5",provider:"openai",model:"gpt-5",enabled:!0,category:R.MULTIMODAL}},currentModel:"gemini-3-flash-preview",timeout:3e4,enableRightClick:!0,enableAtTrigger:!0,maxTokens:5e3,maxContextLines:20,maxContextChars:3e3,globalRules:[],ruleTemplates:[],enableGlobalRules:!0,commonPrompts:[{id:"expand",name:"\u6269\u5C55\u5185\u5BB9",content:"\u8BF7\u6269\u5C55\u8FD9\u6BB5\u5185\u5BB9\uFF0C\u589E\u52A0\u66F4\u591A\u7EC6\u8282\u548C\u4F8B\u5B50"},{id:"summarize",name:"\u603B\u7ED3\u6982\u62EC",content:"\u8BF7\u603B\u7ED3\u8FD9\u6BB5\u5185\u5BB9\u7684\u8981\u70B9"},{id:"improve",name:"\u6539\u8FDB\u6587\u672C",content:"\u8BF7\u6539\u8FDB\u8FD9\u6BB5\u6587\u672C\u7684\u8868\u8FBE\u548C\u903B\u8F91"},{id:"translate",name:"\u7FFB\u8BD1",content:"\u8BF7\u5C06\u8FD9\u6BB5\u5185\u5BB9\u7FFB\u8BD1\u6210\u82F1\u6587"},{id:"continue",name:"\u7EE7\u7EED\u5199\u4F5C",content:"\u8BF7\u6839\u636E\u4E0A\u4E0B\u6587\u7EE7\u7EED\u5199\u4F5C\uFF0C\u4FDD\u6301\u98CE\u683C\u4E00\u81F4"}],conversationHistory:[],conversationHistoryLimit:50,enableGlobalDialog:!1,useFloatingPreview:!1,lastInsertAction:"insert",enableAutoRoutingByLLM:!0,minConfidenceForAuto:.6,fallbackMode:"chat"};var z=require("obsidian");var J=class{constructor(t,e){this.requestQueue=[];this.isProcessing=!1;this.settings=t,this.app=e}updateSettings(t){this.settings=t}getCurrentModelConfig(){if(this.settings.apiKey&&this.settings.baseUrl&&this.settings.model)return{apiKey:this.settings.apiKey,baseUrl:this.settings.baseUrl,model:this.settings.model};let t=this.settings.currentModel;if(!t)throw new Error("\u672A\u9009\u62E9\u5F53\u524D\u6A21\u578B");let e=this.settings.models[t];if(!e||!e.enabled)throw new Error(`\u6A21\u578B ${t} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);let n=this.settings.providers[e.provider];if(!n||!n.enabled)throw new Error(`\u4F9B\u5E94\u5546 ${e.provider} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);return{apiKey:n.apiKey,baseUrl:n.baseUrl,model:e.actualModel||e.model||e.id}}isVisionModel(t){let e=this.settings.currentModel,n=this.settings.models[e];if(!n)return!1;let i=n.category;return!i&&n.type&&(i=n.type==="image"?R.IMAGE:R.TEXT),i===R.VISION}isThinkingModel(t=null){let e=this.settings.currentModel,n=this.settings.models[e];if(!n)return!1;let i=n.category;return!i&&n.type&&(i=n.type==="image"?R.IMAGE:R.TEXT),i===R.THINKING}normalizeBaseUrl(t){return t?t.replace(/\/$/,""):""}buildApiUrl(t){let e=this.getCurrentModelConfig(),n=this.normalizeBaseUrl(e.baseUrl),i=n.includes("api.openai.com");return n.endsWith("/v1")?`${n}${t}`:!i&&(n.includes("/chat/completions")||n.includes("/images/generations"))?`${n.split("/chat/completions")[0].split("/images/generations")[0]}${t}`:`${n}/v1${t}`}getMaxTokens(t){return this.settings.maxTokens||B.maxTokens}async sendRequest(t,e,n="",i=[],s=[],r=null){let a=this.getCurrentModelConfig();if(!a.apiKey)throw new Error("\u8BF7\u5148\u914D\u7F6EAPI Key");let l=this.settings.currentModel,o=this.settings.models[l],c=o==null?void 0:o.category;if(!c&&o&&(o.type==="image"?c=R.IMAGE:c=R.TEXT,o.category=c),c===R.IMAGE){if(t==="continue"&&e.selectedText&&e.selectedText.trim())throw new Error("\u4E0D\u652F\u6301\u56FE\u7247\u751F\u6210\u6A21\u578B\uFF0C\u8BF7\u9009\u62E9\u6587\u672C\u751F\u6210\u6A21\u578B\u8FDB\u884C\u6587\u672C\u4FEE\u6539\u3002");return this.handleImageGeneration(n,a,e.cursorPosition)}let d=c===R.THINKING||this.isThinkingModel(a.model),p=r&&typeof r=="function",u=c===R.MULTIMODAL,h=c===R.VISION||this.isVisionModel(a.model);i&&i.length>0&&!(u||h)&&(new z.Notice(`\u5F53\u524D\u6A21\u578B ${a.model} \u4E0D\u652F\u6301\u56FE\u7247\u548C\u9644\u4EF6\uFF0C\u8BF7\u5207\u6362\u5230\u591A\u6A21\u6001\u6A21\u578B\u6216\u89C6\u89C9\u6A21\u578B`),i=[]);let f=Ce[t]||"";if(this.settings.enableGlobalRules&&this.settings.globalRules&&this.settings.globalRules.length>0){let I=this.settings.globalRules.filter(H=>H.enabled!==!1).sort((H,M)=>(M.priority||0)-(H.priority||0));if(I.length>0){let H=I.map(M=>M.content).join(`
`);f+=`

\u5168\u5C40\u89C4\u5219\uFF08\u8BF7\u4E25\u683C\u9075\u5FAA\u4EE5\u4E0B\u89C4\u5219\uFF09\uFF1A
`+H}}let y=!!(e.selectedText&&e.selectedText.trim()),T=!!(n&&n.trim()),A=e.beforeText||"",v=e.afterText||"",m=e.selectedText||"",x="";switch(t){case"edit":y?(x=`\u5F85\u4FEE\u6539\u5185\u5BB9\uFF1A${m}

\u4E0A\u4E0B\u6587\uFF08\u524D\uFF09\uFF1A${A}

\u4E0A\u4E0B\u6587\uFF08\u540E\uFF09\uFF1A${v}`,T&&(x+=`

\u4FEE\u6539\u8981\u6C42\uFF1A${n}`)):x=T?`\u7528\u6237\u6307\u4EE4\uFF1A${n}

\u4E0A\u4E0B\u6587\uFF08\u524D\uFF09\uFF1A${A}

\u4E0A\u4E0B\u6587\uFF08\u540E\uFF09\uFF1A${v}`:`\u4E0A\u4E0B\u6587\uFF08\u524D\uFF09\uFF1A${A}

\u4E0A\u4E0B\u6587\uFF08\u540E\uFF09\uFF1A${v}

\u8BF7\u57FA\u4E8E\u4E0A\u4E0B\u6587\u5B8C\u6210\u4FEE\u6539\u6216\u56DE\u7B54\u3002`;break;case"chat":default:x=T?`\u7528\u6237\u95EE\u9898\u6216\u6307\u4EE4\uFF1A${n}`:"\u8BF7\u6839\u636E\u4E0B\u8FF0\u4FE1\u606F\u8FDB\u884C\u56DE\u7B54\u3002",(y||A.trim()||v.trim())&&(x+=`

\u53EF\u53C2\u8003\u7684\u4E0A\u4E0B\u6587\uFF1A`,A.trim()&&(x+=`
- \u5149\u6807\u524D\uFF1A${A}`),y&&(x+=`
- \u9009\u4E2D\u6587\u672C\uFF1A${m}`),v.trim()&&(x+=`
- \u5149\u6807\u540E\uFF1A${v}`));break}e.additionalContext&&e.additionalContext.trim()&&(x+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${e.additionalContext}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`),e.contextContent&&e.contextContent.trim()&&(x+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${e.contextContent}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`);let $=this.buildApiUrl("/chat/completions"),N=[{role:"system",content:f}];if(s&&s.length>0&&s.forEach(I=>{(I.role==="user"||I.role==="assistant")&&N.push({role:I.role,content:I.content})}),i&&i.length>0){x+=`

\u9644\u52A0\u56FE\u7247\uFF1A\u5171${i.length}\u5F20\u56FE\u7247`;let I=[{type:"text",text:x}];i.forEach(H=>{I.push({type:"image_url",image_url:{url:H.base64||H.url}})}),N.push({role:"user",content:I})}else N.push({role:"user",content:x});let F={model:a.model,messages:N,temperature:.7,max_tokens:this.getMaxTokens(t)};p&&(F.stream=!0);try{let I={"Content-Type":"application/json",Authorization:`Bearer ${a.apiKey}`};if(p)return await this.handleStreamRequest($,I,F,r);let H=await(0,z.requestUrl)({url:$,method:"POST",headers:I,body:JSON.stringify(F),throw:!1});if(H.status!==200){let E=H.text;throw H.status===429?E.includes("quota")||E.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${H.status} ${E}`)}let M=H.json;if(!M.choices||M.choices.length===0)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11choices\u6570\u7EC4");let k=M.choices[0];if(!k.message)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11message\u5BF9\u8C61");let C="";if(k.message.content)C=k.message.content.trim();else if(k.text)C=k.text.trim();else if(k.message.text)C=k.message.text.trim();else throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u627E\u4E0D\u5230\u5185\u5BB9\u5B57\u6BB5");let w=M.usage||{};return{content:C,usage:w}}catch(I){throw I}}async handleStreamRequest(t,e,n,i){var s,r;try{let a=await fetch(t,{method:"POST",headers:e,body:JSON.stringify(n)});if(!a.ok){let h=await a.text();throw a.status===429?h.includes("quota")||h.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${a.status} ${h}`)}let l=a.body.getReader(),o=new TextDecoder,c="",d="",p="",u="";try{for(;;){let{done:h,value:f}=await l.read();if(h)break;c+=o.decode(f,{stream:!0});let y=c.split(`
`);c=y.pop()||"";for(let T of y)if(T.startsWith("data: ")){let A=T.slice(6);if(A==="[DONE]")break;try{let m=(r=(s=JSON.parse(A).choices)==null?void 0:s[0])==null?void 0:r.delta;if(m!=null&&m.reasoning_content){let x=m.reasoning_content;d+=x,u+=x,i({content:p,thinking:d,fullContent:u,isComplete:!1})}if(m!=null&&m.content){let x=m.content;p+=x,u+=x,i({content:p,thinking:d,fullContent:u,isComplete:!1})}if(m!=null&&m.text){let x=m.text;p+=x,u+=x,i({content:p,thinking:d,fullContent:u,isComplete:!1})}}catch(v){}}}return i({content:p,thinking:d,fullContent:u,isComplete:!0}),{content:p.trim(),thinking:d.trim(),usage:{}}}finally{l.releaseLock()}}catch(a){throw a}}async handleImageGeneration(t,e,n=null){if(!t||!t.trim())throw new Error("\u8BF7\u8F93\u5165\u56FE\u7247\u63CF\u8FF0");let i=this.buildApiUrl("/images/generations"),s=e.model,r={model:s,prompt:t.trim(),response_format:"b64_json",n:1,size:this.settings.imageGenerationSize||"1024x1024"};s.includes("dall-e")&&s==="dall-e-3"&&(r.quality="standard",r.style="vivid");try{let a=await(0,z.requestUrl)({url:i,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify(r),throw:!1});if(a.status!==200){let d=a.text;throw a.status===429?d.includes("quota")||d.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):a.status===401?new Error("API\u5BC6\u94A5\u65E0\u6548\uFF0C\u8BF7\u68C0\u67E5\u914D\u7F6E\u3002"):new Error(`\u56FE\u7247\u751F\u6210API\u8BF7\u6C42\u5931\u8D25: ${a.status} ${d}`)}let l=a.json;if(!l.data||!Array.isArray(l.data)||l.data.length===0)throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let o=l.data[0],c=null;if(o.b64_json)c=o.b64_json;else throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u4E2D\u7F3A\u5C11\u56FE\u7247\u5185\u5BB9");try{let d=`image_${Date.now()}.png`,p=this.settings.imageSavePath||"Extras/\u9644\u4EF6",u=p+"/"+d;try{this.app.vault.getAbstractFileByPath(p)||await this.app.vault.createFolder(p)}catch(v){try{await this.app.vault.adapter.mkdir(p)}catch(m){throw new Error(`\u65E0\u6CD5\u521B\u5EFA\u76EE\u5F55 ${p}: ${m.message}`)}}let h=atob(c||""),f=new Uint8Array(h.length);for(let v=0;v<h.length;v++)f[v]=h.charCodeAt(v);await this.app.vault.createBinary(u,f.buffer);let y=this.settings.imageSize||300,T=!0;n&&n.ch>0&&(T=!1);let A;return T?A=`![Generated Image|${y}](${u})`:A=`<span class="image-mask-rounded-R" style="width: 200px; height: 200px;"><img src="${u}" alt="" style="width: 100%; height: 100%; object-fit: cover;"></span>`,{content:A,imageData:{filePath:u,format:"png",prompt:t},usage:l.usage||{}}}catch(d){throw new Error("\u56FE\u7247\u4FDD\u5B58\u5931\u8D25: "+d.message)}}catch(a){throw a}}getAvailableImageModels(){let t=[];for(let[e,n]of Object.entries(this.settings.models))n.type==="image"&&n.enabled&&t.push(n.name||e);return t}async testConnection(){try{let t=this.getCurrentModelConfig(),e=this.buildApiUrl("/chat/completions"),n=await(0,z.requestUrl)({url:e,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({model:t.model,messages:[{role:"user",content:"hi"}],max_tokens:5})});return n.status===200?{success:!0}:{success:!1,message:`HTTP ${n.status}: ${n.text}`}}catch(t){return{success:!1,message:t.message}}}};var le=require("obsidian");var Z=class{constructor(){this.images=[];this.maxFileSize=xe.MAX_FILE_SIZE;this.allowedTypes=xe.ALLOWED_TYPES}handlePaste(t,e){var i;let n=(i=t.clipboardData)==null?void 0:i.items;if(n)for(let s=0;s<n.length;s++){let r=n[s];if(r.type.indexOf("image")!==-1){t.preventDefault();let a=r.getAsFile();a&&this.processImageFile(a,e);break}}}handleFileSelect(t,e){for(let n of Array.from(t))this.allowedTypes.includes(n.type)?this.processImageFile(n,e):new le.Notice("\u4E0D\u652F\u6301\u7684\u6587\u4EF6\u7C7B\u578B: "+n.type)}processImageFile(t,e){if(t.size>this.maxFileSize){new le.Notice("\u56FE\u7247\u6587\u4EF6\u8FC7\u5927\uFF0C\u8BF7\u9009\u62E9\u5C0F\u4E8E10MB\u7684\u56FE\u7247");return}let n=new FileReader;n.onload=i=>{var a;let s=(a=i.target)==null?void 0:a.result,r={id:String(Date.now()+Math.random()),name:t.name,size:t.size,type:t.type,base64:s,url:s};this.images.push(r),e&&e(r)},n.onerror=()=>{new le.Notice("\u8BFB\u53D6\u56FE\u7247\u5931\u8D25")},n.readAsDataURL(t)}removeImage(t,e){this.images=this.images.filter(n=>n.id!==t),e&&e(t)}getImages(){return this.images}addImage(t){this.images.push(t)}clearImages(){this.images=[]}createImagePreview(t,e){let n=document.createElement("div");n.className="markdown-next-ai-image-preview",n.setAttribute("data-image-id",String(t.id)),n.innerHTML=`
            <div class="markdown-next-ai-image-container">
                <img src="${t.url}" alt="${t.name}" class="markdown-next-ai-preview-img">
                <button class="markdown-next-ai-remove-image" title="\u5220\u9664\u56FE\u7247">\u2715</button>
            </div>
            <div class="markdown-next-ai-image-info">
                <span class="markdown-next-ai-image-name">${t.name}</span>
                <span class="markdown-next-ai-image-size">${this.formatFileSize(t.size)}</span>
            </div>
        `;let i=n.querySelector(".markdown-next-ai-remove-image");return i.onclick=s=>{s.stopPropagation(),this.removeImage(String(t.id),()=>{e&&e()}),n.remove()},n}formatFileSize(t){if(t===0)return"0 Bytes";let e=1024,n=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,i)).toFixed(2))+" "+n[i]}};var Q=class{constructor(t){this.plugin=t}getRules(){return this.plugin.settings.globalRules||[]}getActiveRules(){return this.getRules().filter(t=>t.enabled!==!1)}async addRule(t){let e={id:this.generateRuleId(),name:t.name||"\u65B0\u89C4\u5219",content:t.content||"",description:t.description||"",category:t.category||"custom",priority:t.priority||0,enabled:t.enabled!==!1,createdAt:Date.now(),updatedAt:Date.now()};return this.plugin.settings.globalRules||(this.plugin.settings.globalRules=[]),this.plugin.settings.globalRules.push(e),await this.plugin.saveSettings(),e}async updateRule(t,e){let n=this.getRules(),i=n.findIndex(s=>s.id===t);if(i===-1)throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728");return n[i]={...n[i],...e,updatedAt:Date.now()},await this.plugin.saveSettings(),n}async deleteRule(t){let e=this.getRules(),n=e.findIndex(i=>i.id===t);if(n===-1)throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728");e.splice(n,1),await this.plugin.saveSettings()}async toggleRule(t){let e=this.getRules().find(n=>n.id===t);if(e)return e.enabled=!e.enabled,e.updatedAt=Date.now(),await this.plugin.saveSettings(),e;throw new Error("\u89C4\u5219\u4E0D\u5B58\u5728")}async createFromTemplate(t){let e=(this.plugin.settings.ruleTemplates||[]).find(n=>n.id===t);if(e)return this.addRule({name:e.name,content:e.content,description:e.description,category:e.category});throw new Error("\u6A21\u677F\u4E0D\u5B58\u5728")}getTemplates(){return this.plugin.settings.ruleTemplates||[]}getTemplatesByCategory(t){return this.getTemplates().filter(e=>e.category===t)}generateRuleId(){return"rule_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}exportRules(){return{version:"1.0",exportedAt:Date.now(),rules:this.getRules()}}async importRules(t){if(!t||!t.rules||!Array.isArray(t.rules))throw new Error("\u5BFC\u5165\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let e=0;for(let n of t.rules)try{await this.addRule(n),e++}catch(i){console.error("\u5BFC\u5165\u89C4\u5219\u5931\u8D25",i)}return e}};var j=class{static async getAdapter(t,e){let n=t;if(this.adapters.has(n))return this.adapters.get(n)||null;let i=null;switch(t){case"transformers":try{i=(await Promise.resolve().then(()=>(te(),ee))).TransformersEmbeddingAdapter.getInstance()}catch(s){return console.error("[EmbeddingFactory] Failed to load transformers adapter:",s),null}break;case"openai":try{let r=(await Promise.resolve().then(()=>(te(),ee))).OpenAIEmbeddingAdapter;i=new r}catch(s){return console.error("[EmbeddingFactory] Failed to load OpenAI adapter:",s),null}break;case"ollama":try{let r=(await Promise.resolve().then(()=>(te(),ee))).OllamaEmbeddingAdapter;i=new r}catch(s){return console.error("[EmbeddingFactory] Failed to load Ollama adapter:",s),null}break;case"gemini":try{let r=(await Promise.resolve().then(()=>(te(),ee))).GeminiEmbeddingAdapter;i=new r}catch(s){return console.error("[EmbeddingFactory] Failed to load Gemini adapter:",s),null}break;default:return console.warn(`[EmbeddingFactory] Unknown adapter type: ${t}`),null}return i&&this.adapters.set(n,i),i}static async unloadAdapter(t){let e=this.adapters.get(t);e&&e.unload&&(await e.unload(),this.adapters.delete(t))}static async unloadAll(){for(let[t,e]of this.adapters)if(e.unload)try{await e.unload()}catch(n){console.error(`[EmbeddingFactory] Error unloading adapter ${t}:`,n)}this.adapters.clear()}};j.adapters=new Map;var G=class G{constructor(){this.currentAdapter=null;this.currentAdapterType=null}static getInstance(){return G.instance||(G.instance=new G),G.instance}async getAdapter(t){var n;let e=((n=t.embedModel)==null?void 0:n.adapter)||"transformers";return this.currentAdapter&&this.currentAdapterType===e?this.currentAdapter:(console.log(`[EmbeddingService] Switching to adapter: ${e}`),this.currentAdapter=await j.getAdapter(e,t),this.currentAdapterType=e,this.currentAdapter||console.error(`[EmbeddingService] Failed to get adapter: ${e}`),this.currentAdapter)}async getEmbedding(t,e){try{let n=await this.getAdapter(e);return n?await n.getEmbedding(t,e):(console.error("[EmbeddingService] No adapter available"),null)}catch(n){return console.error("[EmbeddingService] Error getting embedding:",n),null}}async getEmbeddings(t,e){try{let n=await this.getAdapter(e);return n?await n.getEmbeddings(t,e):(console.error("[EmbeddingService] No adapter available"),null)}catch(n){return console.error("[EmbeddingService] Error getting embeddings:",n),null}}getAdapterInfo(){var t,e;return this.currentAdapter?{type:this.currentAdapterType,info:((e=(t=this.currentAdapter).getModelInfo)==null?void 0:e.call(t))||{}}:null}async unload(){this.currentAdapter&&this.currentAdapterType&&(await j.unloadAdapter(this.currentAdapterType),this.currentAdapter=null,this.currentAdapterType=null)}static async cleanup(){await j.unloadAll(),G.instance&&(G.instance=null)}};G.instance=null;var Ee=G;var g=require("obsidian");var ge=class extends g.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"MarkdownNext AI \u8BBE\u7F6E"}),t.createEl("h3",{text:"\u4F9B\u5E94\u5546\u3001API\u8BBE\u7F6E"}),t.createEl("p",{text:"APIKey\uFF1A\u9700\u5728\u4F9B\u5E94\u5546API\u5BC6\u94A5\u4E2D\u8BBE\u7F6EAPIKey",attr:{style:"color: var(--text-muted); margin-bottom: 5px;"}}),t.createEl("p",{text:"Base URL\uFF1A\u9009\u586B\u7B2C\u4E09\u65B9URL\uFF0C\u4F7F\u7528openai\u517C\u5BB9\u683C\u5F0F",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}});let e=t.createEl("table",{cls:"markdown-next-ai-config-table"}),n=e.createEl("thead").createEl("tr");n.createEl("th",{text:"ID"}),n.createEl("th",{text:"Type"}),n.createEl("th",{text:"API Key"}),n.createEl("th",{text:"Get API keys"}),n.createEl("th",{text:"Actions"});let i=e.createEl("tbody");Object.keys(this.plugin.settings.providers).forEach(c=>{let d=this.plugin.settings.providers[c],p=i.createEl("tr");p.createEl("td",{text:c}),p.createEl("td",{text:d.type||"openai"});let u=p.createEl("td",{cls:"markdown-next-ai-api-key-cell"});d.apiKey&&d.apiKey.trim()&&u.createEl("span",{text:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",attr:{style:"color: var(--text-muted); margin-right: 8px;"}});let h=u.createEl("button",{cls:"markdown-next-ai-settings-btn",attr:{title:"\u8BBE\u7F6EAPI Key"}});h.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',h.onclick=()=>this.showApiKeyModal(c);let f=p.createEl("td",{attr:{style:"text-align: left;"}}),T={openai:"https://platform.openai.com/api-keys",anthropic:"https://console.anthropic.com/",gemini:"https://aistudio.google.com/app/apikey",ollama:"https://ollama.com/"}[c]||this.plugin.settings.apiKeyLinks&&this.plugin.settings.apiKeyLinks[c];T?f.createEl("a",{text:"\u83B7\u53D6API Key",attr:{href:T,target:"_blank",style:"color: var(--text-accent); text-decoration: underline; font-size: 0.9em;"}}):f.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});let A=p.createEl("td",{cls:"markdown-next-ai-actions-cell"});if(["openai","anthropic","gemini","deepseek","ollama"].includes(c))A.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});else{let v=A.createEl("button",{text:"\u7F16\u8F91"});v.onclick=()=>this.showEditProviderModal(c);let m=A.createEl("button",{text:"\u5220\u9664"});m.onclick=async()=>{confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4F9B\u5E94\u5546 "${c}" \uFF1F\u8FD9\u5C06\u540C\u65F6\u5220\u9664\u8BE5\u4F9B\u5E94\u5546\u4E0B\u7684\u6240\u6709\u6A21\u578B\u3002`)&&(Object.keys(this.plugin.settings.models).forEach(x=>{this.plugin.settings.models[x].provider===c&&delete this.plugin.settings.models[x]}),delete this.plugin.settings.providers[c],await this.plugin.saveSettings(),this.display())}}}),t.createEl("div",{attr:{style:"margin-top: 15px; margin-bottom: 20px;"}}).createEl("button",{text:"+ \u6DFB\u52A0\u4F9B\u5E94\u5546",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;"}}).onclick=()=>this.showAddProviderModal();let s=t.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px;"}});s.createEl("h3",{text:"\u6A21\u578B\u8BBE\u7F6E",attr:{style:"margin: 0;"}}),s.createEl("button",{text:"+ \u6DFB\u52A0\u6A21\u578B",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;"}}).onclick=()=>this.showAddModelModal();let r=t.createEl("table",{cls:"markdown-next-ai-config-table"}),a=r.createEl("thead").createEl("tr");a.createEl("th",{text:"ID"}),a.createEl("th",{text:"Provider"}),a.createEl("th",{text:"Model"}),a.createEl("th",{text:"Enable"}),a.createEl("th",{text:"Actions"});let l=r.createEl("tbody"),o=Object.values(this.plugin.settings.models);if(o.length>0?o.forEach(c=>{let d=l.createEl("tr");d.createEl("td",{text:c.id}),d.createEl("td",{text:c.provider}),d.createEl("td",{text:c.name});let u=d.createEl("td",{cls:"markdown-next-ai-enable-cell"}).createEl("input",{type:"checkbox"});u.checked=c.enabled,u.onchange=async()=>{if(this.plugin.settings.models[c.id].enabled=u.checked,await this.plugin.saveSettings(),!u.checked&&this.plugin.settings.currentModel===c.id){let T=Object.keys(this.plugin.settings.models).find(A=>this.plugin.settings.models[A].enabled);T&&(this.plugin.settings.currentModel=T,await this.plugin.saveSettings(),this.display())}};let h=d.createEl("td",{cls:"markdown-next-ai-actions-cell"}),f=h.createEl("button",{text:"\u7F16\u8F91"});f.onclick=()=>this.showEditModelModal(c.id);let y=h.createEl("button",{text:"\u5220\u9664"});y.onclick=async()=>{if(confirm(`\u786E\u5B9A\u8981\u5220\u9664\u6A21\u578B "${c.name}" \uFF1F`)){if(this.plugin.settings.currentModel===c.id){let T=Object.keys(this.plugin.settings.models).find(A=>A!==c.id&&this.plugin.settings.models[A].enabled);this.plugin.settings.currentModel=T||""}delete this.plugin.settings.models[c.id],await this.plugin.saveSettings(),this.display()}}}):l.createEl("tr").createEl("td",{text:"\u6682\u65E0\u6A21\u578B\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{colspan:"5",style:"text-align: center; color: var(--text-muted); font-style: italic; padding: 20px;"}}),new g.Setting(t).setName("\u5F53\u524D\u6A21\u578B").setDesc("\u9009\u62E9\u5F53\u524D\u4F7F\u7528\u7684AI\u6A21\u578B").addDropdown(c=>{let d=Object.keys(this.plugin.settings.models).filter(p=>this.plugin.settings.models[p].enabled);d.forEach(p=>{let u=this.plugin.settings.models[p];c.addOption(p,`${u.name} (${u.provider})`)}),!d.includes(this.plugin.settings.currentModel)&&d.length>0&&(this.plugin.settings.currentModel=d[0],this.plugin.saveSettings()),c.setValue(this.plugin.settings.currentModel||"").onChange(async p=>{this.plugin.settings.currentModel=p,await this.plugin.saveSettings()})}),new g.Setting(t).setName("\u6D4B\u8BD5API\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u5F53\u524DAPI\u914D\u7F6E\u662F\u5426\u6B63\u5E38").addButton(c=>c.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{c.setButtonText("\u6D4B\u8BD5\u4E2D...");try{let d=await this.plugin.aiService.testConnection();d.success?new g.Notice("\u2705 API\u8FDE\u63A5\u6210\u529F"):new g.Notice("\u274C API\u8FDE\u63A5\u5931\u8D25: "+d.message)}catch(d){new g.Notice("\u274C \u6D4B\u8BD5\u5931\u8D25: "+d.message)}finally{c.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5")}})),new g.Setting(t).setName("\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4").setDesc("API\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4\uFF08\u6BEB\u79D2\uFF09").addText(c=>c.setPlaceholder("30000").setValue(String(this.plugin.settings.timeout)).onChange(async d=>{let p=parseInt(d)||3e4;this.plugin.settings.timeout=p,await this.plugin.saveSettings()})),t.createEl("h3",{text:"\u529F\u80FD\u8BBE\u7F6E"}),new g.Setting(t).setName("\u542F\u7528\u53F3\u952E\u83DC\u5355").setDesc("\u5728\u9009\u4E2D\u6587\u672C\u65F6\u663E\u793AAI\u5904\u7406\u9009\u9879").addToggle(c=>c.setValue(this.plugin.settings.enableRightClick).onChange(async d=>{this.plugin.settings.enableRightClick=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new g.Setting(t).setName("\u542F\u7528@\u6216&\u7B26\u53F7\u89E6\u53D1").setDesc("\u8F93\u5165@\u6216&\u7B26\u53F7\u65F6\u547C\u51FA\u7EED\u5199\u5BF9\u8BDD\u6846").addToggle(c=>c.setValue(this.plugin.settings.enableAtTrigger).onChange(async d=>{this.plugin.settings.enableAtTrigger=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),t.createEl("h3",{text:"\u5168\u5C40\u89C4\u5219\u8BBE\u7F6E"}),t.createEl("p",{text:"\u5168\u5C40\u89C4\u5219\u4F1A\u81EA\u52A8\u5E94\u7528\u5230\u6240\u6709AI\u8BF7\u6C42\u4E2D\uFF0C\u6BCF\u6B21\u5BF9\u8BDD\u90FD\u9700\u8981\u9075\u5FAA\u5168\u5C40\u89C4\u5219",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new g.Setting(t).setName("\u542F\u7528\u5168\u5C40\u89C4\u5219").setDesc("\u5F00\u542F\u540E\uFF0C\u5168\u5C40\u89C4\u5219\u5C06\u81EA\u52A8\u5E94\u7528\u5230\u6240\u6709AI\u8BF7\u6C42\u4E2D").addToggle(c=>c.setValue(this.plugin.settings.enableGlobalRules).onChange(async d=>{this.plugin.settings.enableGlobalRules=d,await this.plugin.saveSettings()})),new g.Setting(t).setName("\u7BA1\u7406\u5168\u5C40\u89C4\u5219").setDesc("\u6DFB\u52A0\u3001\u7F16\u8F91\u548C\u7BA1\u7406\u5168\u5C40\u89C4\u5219").addButton(c=>c.setButtonText("\u6253\u5F00\u89C4\u5219\u7BA1\u7406\u5668").onClick(()=>this.showRuleManager())),new g.Setting(t).setName("\u6700\u5927Token\u6570").setDesc("AI\u751F\u6210\u6587\u672C\u7684\u6700\u5927\u957F\u5EA6\u9650\u5236").addText(c=>c.setPlaceholder("5000").setValue(String(this.plugin.settings.maxTokens)).onChange(async d=>{let p=parseInt(d)||5e3;p>0?(this.plugin.settings.maxTokens=p,await this.plugin.saveSettings()):new g.Notice("Token\u6570\u5FC5\u987B\u4E3A\u6B63\u6574\u6570")})),t.createEl("h3",{text:"\u5168\u5C40\u5BF9\u8BDD\u6A21\u5F0F\uFF08Beta\uFF09"}),t.createEl("p",{text:"\u542F\u7528\u5168\u5C40\u5BF9\u8BDD\u6A21\u5F0F\u540E\uFF0C\u53EF\u4EE5\u5728\u975E\u7F16\u8F91\u5668\u4E0A\u4E0B\u6587\u6253\u5F00AI\u5BF9\u8BDD\u6846\uFF0C\u751F\u6210\u7684\u5185\u5BB9\u5148\u663E\u793A\u5728\u6D6E\u7A97\u786E\u8BA4\u540E\u518D\u5199\u5165\u7F16\u8F91\u5668",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new g.Setting(t).setName("\u542F\u7528\u5168\u5C40\u5BF9\u8BDD\u6846\u6A21\u5F0F").setDesc("\u5141\u8BB8\u5728\u975EMarkdown\u7F16\u8F91\u5668\u4E0A\u4E0B\u6587\u6253\u5F00\u5BF9\u8BDD\u6846\uFF08\u5FEB\u6377\u952E: Ctrl+Shift+M\uFF09").addToggle(c=>{var d;return c.setValue((d=this.plugin.settings.enableGlobalDialog)!=null?d:!1).onChange(async p=>{this.plugin.settings.enableGlobalDialog=p,await this.plugin.saveSettings()})}),new g.Setting(t).setName("\u4F7F\u7528\u6D6E\u7A97\u786E\u8BA4\u6A21\u5F0F").setDesc("AI\u751F\u6210\u7ED3\u679C\u5148\u663E\u793A\u5728\u6D6E\u7A97\u4E2D\uFF0C\u7528\u6237\u786E\u8BA4\u540E\u518D\u5199\u5165\u7F16\u8F91\u5668").addToggle(c=>{var d;return c.setValue((d=this.plugin.settings.useFloatingPreview)!=null?d:!1).onChange(async p=>{this.plugin.settings.useFloatingPreview=p,await this.plugin.saveSettings()})}),t.createEl("h3",{text:"\u81EA\u52A8\u8DEF\u7531\uFF08LLM \u5224\u5B9A\u6A21\u5F0F\uFF09"}),new g.Setting(t).setName("\u542F\u7528\u81EA\u52A8\u8DEF\u7531").setDesc("\u7531 LLM \u6839\u636E\u9009\u533A/\u5149\u6807/\u6307\u4EE4\u5224\u5B9A edit/chat/insert \u6A21\u5F0F").addToggle(c=>{var d;return c.setValue((d=this.plugin.settings.enableAutoRoutingByLLM)!=null?d:!0).onChange(async p=>{this.plugin.settings.enableAutoRoutingByLLM=p,await this.plugin.saveSettings()})}),new g.Setting(t).setName("\u81EA\u52A8\u6267\u884C\u7684\u6700\u4F4E\u7F6E\u4FE1\u5EA6").setDesc("\u4F4E\u4E8E\u6B64\u503C\u5C06\u56DE\u9000\u5230\u9ED8\u8BA4\u6A21\u5F0F\u6216\u63D0\u793A\u7528\u6237\uFF080~1\uFF0C\u9ED8\u8BA40.6\uFF09").addText(c=>{var d;return c.setPlaceholder("0.6").setValue(String((d=this.plugin.settings.minConfidenceForAuto)!=null?d:.6)).onChange(async p=>{let u=Number(p);!Number.isNaN(u)&&u>=0&&u<=1?(this.plugin.settings.minConfidenceForAuto=u,await this.plugin.saveSettings()):new g.Notice("\u8BF7\u8F93\u5165 0~1 \u4E4B\u95F4\u7684\u6570\u5B57")})}),new g.Setting(t).setName("\u8DEF\u7531\u5931\u8D25/\u4F4E\u7F6E\u4FE1\u5EA6\u56DE\u9000\u6A21\u5F0F").setDesc("\u8DEF\u7531\u5931\u8D25\u6216\u7F6E\u4FE1\u5EA6\u8FC7\u4F4E\u65F6\u4F7F\u7528\u7684\u6A21\u5F0F").addDropdown(c=>{c.addOption("chat","chat"),c.addOption("edit","edit"),c.addOption("insert","insert"),c.setValue(this.plugin.settings.fallbackMode||"chat"),c.onChange(async d=>{this.plugin.settings.fallbackMode=d,await this.plugin.saveSettings()})}),t.createEl("h3",{text:"\u5E38\u7528\u63D0\u793A\u8BCD\u7BA1\u7406"}),t.createEl("p",{text:"\u7BA1\u7406\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u53EF\u5728\u8F93\u5165\u6846\u4E2D\u4F7F\u7528#\u7B26\u53F7\u5FEB\u901F\u8C03\u7528",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new g.Setting(t).setName("\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u5E38\u7528\u63D0\u793A\u8BCD").addButton(c=>c.setButtonText("\u6DFB\u52A0\u63D0\u793A\u8BCD").onClick(()=>this.showPromptModal())),this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts.length>0){let c=t.createEl("div",{attr:{style:"margin-top: 15px;"}});this.plugin.settings.commonPrompts.forEach((d,p)=>{let u=c.createEl("div",{attr:{style:"display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary);"}}),h=u.createEl("div",{attr:{style:"flex: 1;"}});h.createEl("div",{text:d.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD",attr:{style:"font-weight: bold; margin-bottom: 4px;"}}),h.createEl("div",{text:d.content&&d.content.length>100?d.content.substring(0,100)+"...":d.content||"",attr:{style:"color: var(--text-muted); font-size: 0.7em;"}});let f=u.createEl("div",{attr:{style:"display: flex; gap: 8px;"}});f.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--background-modifier-border); background: var(--background-primary); color: var(--text-normal); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.showPromptModal(p),f.createEl("button",{text:"\u5220\u9664",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--text-error); background: var(--background-primary); color: var(--text-error); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.deletePrompt(p)})}else t.createEl("p",{text:"\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{style:"color: var(--text-muted); font-style: italic; margin-top: 15px;"}})}showPromptModal(t=null){let e=new g.Modal(this.app);e.titleEl.setText(t!==null?"\u7F16\u8F91\u63D0\u793A\u8BCD":"\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD");let{contentEl:n}=e,i=t!==null,s=i&&this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[t]?this.plugin.settings.commonPrompts[t]:null;n.createEl("label",{text:"\u63D0\u793A\u8BCD\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});i&&s&&(r.value=s.name),n.createEl("label",{text:"\u63D0\u793A\u8BCD\u5185\u5BB9:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9",attr:{style:"width: 100%; height: 120px; padding: 8px; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px; resize: vertical; font-family: var(--font-text);"}});i&&s&&(a.value=s.content);let l=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}});l.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>e.close();let o=l.createEl("button",{text:i?"\u66F4\u65B0":"\u6DFB\u52A0",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),c=async()=>{let p=r.value.trim(),u=a.value.trim();if(!p){new g.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0");return}if(!u){new g.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9");return}if(this.plugin.settings.commonPrompts.findIndex((y,T)=>y.name===p&&T!==t)!==-1){new g.Notice("\u63D0\u793A\u8BCD\u540D\u79F0\u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6\u540D\u79F0");return}this.plugin.settings.commonPrompts||(this.plugin.settings.commonPrompts=[]);let f={id:i&&s?s.id:Date.now().toString(),name:p,content:u};i&&t!==null?(this.plugin.settings.commonPrompts[t]=f,new g.Notice("\u63D0\u793A\u8BCD\u5DF2\u66F4\u65B0")):(this.plugin.settings.commonPrompts.push(f),new g.Notice("\u63D0\u793A\u8BCD\u5DF2\u6DFB\u52A0")),await this.plugin.saveSettings(),e.close(),this.display()};o.onclick=c;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),c())};r.addEventListener("keydown",d),a.addEventListener("keydown",d),e.open(),r.focus()}async deletePrompt(t){if(this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[t]){let e=this.plugin.settings.commonPrompts[t],n=new g.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:i}=n;i.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u63D0\u793A\u8BCD "${e.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD"}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let s=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});s.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),s.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{this.plugin.settings.commonPrompts.splice(t,1),await this.plugin.saveSettings(),new g.Notice("\u63D0\u793A\u8BCD\u5DF2\u5220\u9664"),n.close(),this.display()},n.open()}}showApiKeyModal(t){let e=new g.Modal(this.app);e.titleEl.setText(`\u8BBE\u7F6E ${t.toUpperCase()} \u914D\u7F6E`);let{contentEl:n}=e,i=this.plugin.settings.providers[t];n.createEl("label",{text:"API Key:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"password",placeholder:"\u8BF7\u8F93\u5165API Key",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});s.value=(i==null?void 0:i.apiKey)||"",n.createEl("label",{text:"Base URL (\u53EF\u9009):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",value:(i==null?void 0:i.baseUrl)||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),a=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),l=a.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}});l.onclick=()=>e.close();let o=a.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),c=async()=>{this.plugin.settings.providers[t]||(this.plugin.settings.providers[t]={apiKey:"",baseUrl:"",enabled:!0}),this.plugin.settings.providers[t].apiKey=s.value.trim(),this.plugin.settings.providers[t].baseUrl=r.value.trim(),s.value.trim()&&(this.plugin.settings.providers[t].enabled=!0),await this.plugin.saveSettings(),new g.Notice(t.toUpperCase()+" \u914D\u7F6E\u5DF2\u4FDD\u5B58"),e.close(),this.display()};o.onclick=c;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),c())};s.addEventListener("keydown",d),r.addEventListener("keydown",d),e.open(),s.focus()}showAddProviderModal(){let t=new g.Modal(this.app);t.titleEl.setText("\u6DFB\u52A0\u4F9B\u5E94\u5546");let{contentEl:e}=t;e.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let n=e.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: custom-provider",attr:{style:"width: 100%; margin-bottom: 15px;"}});e.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let i=e.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u81EA\u5B9A\u4E49\u4F9B\u5E94\u5546",attr:{style:"width: 100%; margin-bottom: 15px;"}});e.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(c=>{s.createEl("option",{value:c,text:c.toUpperCase()})}),e.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=e.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",attr:{style:"width: 100%; margin-bottom: 15px;"}}),a=e.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),l=a.createEl("button",{text:"\u53D6\u6D88"});l.onclick=()=>t.close();let o=a.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});o.onclick=async()=>{let c=n.value.trim(),d=i.value.trim(),p=s.value,u=r.value.trim();if(!c||!d){new g.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.providers[c]){new g.Notice("\u4F9B\u5E94\u5546ID\u5DF2\u5B58\u5728");return}this.plugin.settings.providers[c]={name:d,type:p,enabled:!0,apiKey:"",baseUrl:u},await this.plugin.saveSettings(),new g.Notice("\u4F9B\u5E94\u5546\u5DF2\u6DFB\u52A0"),t.close(),this.display()},t.open(),n.focus()}showEditProviderModal(t){let e=new g.Modal(this.app);e.titleEl.setText("\u7F16\u8F91\u4F9B\u5E94\u5546");let{contentEl:n}=e,i=this.plugin.settings.providers[t];n.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:t,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",value:i.name||t,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(d=>{let p=r.createEl("option",{value:d,text:d.toUpperCase()});d===i.type&&(p.selected=!0)}),n.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("input",{type:"text",value:i.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px;"}}),l=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),o=l.createEl("button",{text:"\u53D6\u6D88"});o.onclick=()=>e.close();let c=l.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});c.onclick=async()=>{let d=s.value.trim(),p=r.value,u=a.value.trim();if(!d){new g.Notice("\u8BF7\u586B\u5199\u663E\u793A\u540D\u79F0");return}this.plugin.settings.providers[t]={...i,name:d,type:p,baseUrl:u},await this.plugin.saveSettings(),new g.Notice("\u4F9B\u5E94\u5546\u5DF2\u66F4\u65B0"),e.close(),this.display()},e.open(),s.focus()}showAddModelModal(t=R.MULTIMODAL){let e=new g.Modal(this.app);e.titleEl.setText("\u6DFB\u52A0\u65B0\u6A21\u578B");let{contentEl:n}=e;n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let i=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: gpt-4-turbo",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u6211\u7684\u81EA\u5B9A\u4E49\u6A21\u578B",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(d=>{r.createEl("option",{value:d,text:d.toUpperCase()})}),n.createEl("label",{text:"\u6A21\u578B\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});a.createEl("option",{value:R.MULTIMODAL,text:"\u591A\u6A21\u6001\u6A21\u578B (\u652F\u6301\u56FE\u7247)"}).selected=!0,a.createEl("option",{value:R.TEXT,text:"\u6587\u672C\u6A21\u578B"});let l=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),o=l.createEl("button",{text:"\u53D6\u6D88"});o.onclick=()=>e.close();let c=l.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});c.onclick=async()=>{let d=i.value.trim(),p=s.value.trim(),u=r.value,h=a.value;if(!d||!p){new g.Notice("\u8BF7\u586B\u5199\u6240\u6709\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.models[d]){new g.Notice("\u6A21\u578B ID \u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6 ID");return}this.plugin.settings.models[d]={id:d,name:p,provider:u,model:d,actualModel:d,enabled:!0,category:h},await this.plugin.saveSettings(),new g.Notice("\u6A21\u578B\u5DF2\u6DFB\u52A0"),e.close(),this.display()},e.open(),i.focus()}showEditModelModal(t){let e=new g.Modal(this.app);e.titleEl.setText("\u7F16\u8F91\u6A21\u578B");let{contentEl:n}=e,i=this.plugin.settings.models[t];n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:t,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",value:i.name,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(c=>{let d=r.createEl("option",{value:c,text:c.toUpperCase()});c===i.provider&&(d.selected=!0)});let a=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),l=a.createEl("button",{text:"\u53D6\u6D88"});l.onclick=()=>e.close();let o=a.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});o.onclick=async()=>{let c=s.value.trim(),d=r.value;if(!c){new g.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}this.plugin.settings.models[t]={...i,name:c,provider:d,model:t,actualModel:t},await this.plugin.saveSettings(),new g.Notice("\u6A21\u578B\u5DF2\u66F4\u65B0"),e.close(),this.display()},e.open(),s.focus()}renderRuleList(t,e){t.empty();let n=this.plugin.ruleManager.getRules();if(n.length===0){t.createEl("div",{text:'\u6682\u65E0\u89C4\u5219\uFF0C\u70B9\u51FB"\u65B0\u5EFA\u89C4\u5219"\u6216"\u4ECE\u6A21\u677F\u521B\u5EFA"\u5F00\u59CB\u6DFB\u52A0',attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});return}let i={};n.forEach(r=>{let a=r.category||"custom";i[a]||(i[a]=[]),i[a].push(r)});let s={writing:"\u5199\u4F5C\u98CE\u683C",format:"\u683C\u5F0F\u8981\u6C42",language:"\u8BED\u8A00\u8BBE\u7F6E",custom:"\u81EA\u5B9A\u4E49\u89C4\u5219"};Object.entries(i).forEach(([r,a])=>{t.createEl("h4",{text:s[r]||r,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),a.forEach(l=>{let o=t.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; background: var(--background-secondary);"}}),c=o.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"}}),d=c.createEl("div",{attr:{style:"flex: 1;"}});d.createEl("h5",{text:l.name,attr:{style:"margin: 0 0 5px 0; font-weight: 600;"}}),l.description&&d.createEl("p",{text:l.description,attr:{style:"margin: 0; color: var(--text-muted); font-size: 0.9em;"}});let p=c.createEl("div",{attr:{style:"display: flex; gap: 8px; align-items: center;"}}),u=p.createEl("input",{type:"checkbox",attr:{style:"margin-right: 5px;"}});u.checked=l.enabled!==!1,u.onchange=async()=>{try{await this.plugin.ruleManager.toggleRule(l.id),new g.Notice(u.checked?"\u89C4\u5219\u5DF2\u542F\u7528":"\u89C4\u5219\u5DF2\u7981\u7528")}catch(h){new g.Notice("\u64CD\u4F5C\u5931\u8D25: "+h.message)}},p.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>{this.showRuleEditor(e,l)},p.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>this.deleteRule(l,e),l.content&&(o.createEl("div",{attr:{style:"background: var(--background-primary); padding: 10px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85em; color: var(--text-muted); max-height: 100px; overflow-y: auto;"}}).textContent=l.content.length>200?l.content.substring(0,200)+"...":l.content)})})}showRuleManager(){let t=new g.Modal(this.app);t.titleEl.setText("\u5168\u5C40\u89C4\u5219\u7BA1\u7406\u5668"),t.modalEl.addClass("flowtext-rule-manager-modal");let{contentEl:e}=t;e.empty();let n=e.createEl("div",{attr:{style:"min-height: 500px; display: flex; flex-direction: column;"}}),i=n.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--background-modifier-border);"}}),s=i.createEl("div",{attr:{style:"display: flex; gap: 10px;"}});s.createEl("button",{text:"\u65B0\u5EFA\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showRuleEditor(t),s.createEl("button",{text:"\u4ECE\u63D0\u793A\u8BCD\u521B\u5EFA",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showTemplateSelector(t);let r=i.createEl("div",{attr:{style:"display: flex; gap: 10px;"}});r.createEl("button",{text:"\u5BFC\u5165\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.importRules(t),r.createEl("button",{text:"\u5BFC\u51FA\u89C4\u5219",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.exportRules();let a=n.createEl("div",{attr:{style:"flex: 1; overflow-y: auto;"}});this.renderRuleList(a,t),t.open()}showRuleEditor(t,e=null){let n=new g.Modal(this.app);n.titleEl.setText(e?"\u7F16\u8F91\u89C4\u5219":"\u65B0\u5EFA\u89C4\u5219"),n.modalEl.addClass("flowtext-rule-editor-modal");let{contentEl:i}=n;i.empty();let s=i.createEl("div",{attr:{style:"display: flex; flex-direction: column; gap: 15px; min-width: 500px;"}});s.createEl("label",{text:"\u89C4\u5219\u540D\u79F0",attr:{style:"font-weight: 600;"}});let r=s.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u540D\u79F0",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});e&&(r.value=e.name),s.createEl("label",{text:"\u89C4\u5219\u63CF\u8FF0",attr:{style:"font-weight: 600;"}});let a=s.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u63CF\u8FF0\uFF08\u53EF\u9009\uFF09",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});e&&e.description&&(a.value=e.description),s.createEl("label",{text:"\u89C4\u5219\u5206\u7C7B",attr:{style:"font-weight: 600;"}});let l=s.createEl("select",{attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),o=[{value:"writing",text:"\u5199\u4F5C\u98CE\u683C"},{value:"format",text:"\u683C\u5F0F\u8981\u6C42"},{value:"language",text:"\u8BED\u8A00\u8BBE\u7F6E"},{value:"custom",text:"\u81EA\u5B9A\u4E49\u89C4\u5219"}],c=e?e.category:"custom";o.forEach(T=>{let A=l.createEl("option",{value:T.value,text:T.text});T.value===c&&(A.selected=!0)}),s.createEl("label",{text:"\u4F18\u5148\u7EA7 (\u6570\u5B57\u8D8A\u5927\u4F18\u5148\u7EA7\u8D8A\u9AD8\uFF0C\u6700\u592710)",attr:{style:"font-weight: 600;"}});let d=s.createEl("input",{type:"number",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});d.min="0",d.max="10",d.value=String(e&&e.priority!==void 0?e.priority:0),s.createEl("label",{text:"\u89C4\u5219\u5185\u5BB9",attr:{style:"font-weight: 600;"}});let p=s.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u89C4\u5219\u5185\u5BB9\uFF0C\u8FD9\u4E9B\u5185\u5BB9\u5C06\u4F5C\u4E3A\u7CFB\u7EDF\u63D0\u793A\u8BCD\u7684\u4E00\u90E8\u5206",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; min-height: 150px; font-family: var(--font-monospace); resize: vertical;"}});e&&(p.value=e.content);let u=s.createEl("div",{attr:{style:"display: flex; align-items: center; gap: 8px;"}}),h=u.createEl("input",{type:"checkbox"});h.checked=!e||e.enabled!==!1,u.createEl("label",{text:"\u542F\u7528\u6B64\u89C4\u5219",attr:{style:"font-weight: 600;"}});let f=s.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;"}});f.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 8px 16px;"}}).onclick=()=>n.close();let y=f.createEl("button",{text:e?"\u66F4\u65B0":"\u521B\u5EFA",cls:"mod-cta",attr:{style:"padding: 8px 16px;"}});y.onclick=async()=>{let T=r.value.trim(),A=p.value.trim();if(!T){new g.Notice("\u8BF7\u8F93\u5165\u89C4\u5219\u540D\u79F0"),r.focus();return}if(!A){new g.Notice("\u8BF7\u8F93\u5165\u89C4\u5219\u5185\u5BB9"),p.focus();return}let v=parseInt(d.value)||0;if(v>10){new g.Notice("\u4F18\u5148\u7EA7\u4E0D\u80FD\u8D85\u8FC710"),d.focus();return}try{let m={name:T,description:a.value.trim(),category:l.value,priority:v,content:A,enabled:h.checked};e?(await this.plugin.ruleManager.updateRule(e.id,m),new g.Notice("\u89C4\u5219\u5DF2\u66F4\u65B0")):(await this.plugin.ruleManager.addRule(m),new g.Notice("\u89C4\u5219\u5DF2\u521B\u5EFA")),n.close(),this.renderRuleList(t.contentEl.querySelector('[style*="flex: 1"]'),t)}catch(m){new g.Notice("\u64CD\u4F5C\u5931\u8D25: "+m.message)}},n.open(),r.focus()}showTemplateSelector(t){let e=new g.Modal(this.app);e.titleEl.setText("\u4ECE\u6A21\u677F\u521B\u5EFA\u89C4\u5219");let{contentEl:n}=e;n.empty();let i=this.plugin.ruleManager.getTemplates();if(i.length===0)n.createEl("p",{text:"\u6682\u65E0\u53EF\u7528\u6A21\u677F",attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});else{let s={};i.forEach(a=>{let l=a.category||"custom";s[l]||(s[l]=[]),s[l].push(a)});let r={writing:"\u5199\u4F5C\u98CE\u683C",format:"\u683C\u5F0F\u8981\u6C42",language:"\u8BED\u8A00\u8BBE\u7F6E",custom:"\u81EA\u5B9A\u4E49\u6A21\u677F"};Object.entries(s).forEach(([a,l])=>{n.createEl("h4",{text:r[a]||a,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),l.forEach(o=>{let c=n.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;"}});c.addEventListener("mouseenter",()=>{c.style.backgroundColor="var(--background-modifier-hover)"}),c.addEventListener("mouseleave",()=>{c.style.backgroundColor=""}),c.createEl("h5",{text:o.name,attr:{style:"margin: 0 0 8px 0; font-weight: 600;"}}),o.description&&c.createEl("p",{text:o.description,attr:{style:"margin: 0 0 10px 0; color: var(--text-muted); font-size: 0.9em;"}}),o.content&&(c.createEl("div",{attr:{style:"background: var(--background-primary); padding: 8px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.8em; color: var(--text-muted);"}}).textContent=o.content.length>100?o.content.substring(0,100)+"...":o.content),c.onclick=async()=>{try{await this.plugin.ruleManager.createFromTemplate(o.id),new g.Notice("\u5DF2\u4ECE\u6A21\u677F\u521B\u5EFA\u89C4\u5219: "+o.name),e.close(),this.renderRuleList(t.contentEl.querySelector('[style*="flex: 1"]'),t)}catch(d){new g.Notice("\u521B\u5EFA\u5931\u8D25: "+d.message)}}})})}e.open()}async deleteRule(t,e){let n=new g.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:i}=n;i.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u89C4\u5219 "${t.name}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let s=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});s.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),s.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{try{await this.plugin.ruleManager.deleteRule(t.id),new g.Notice("\u89C4\u5219\u5DF2\u5220\u9664"),n.close(),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(r){new g.Notice("\u5220\u9664\u5931\u8D25: "+r.message)}},n.open()}exportRules(){try{let t=this.plugin.ruleManager.exportRules(),e=JSON.stringify(t,null,2),n=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`flowtext-rules-${new Date().toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(i),new g.Notice("\u89C4\u5219\u5DF2\u5BFC\u51FA")}catch(t){new g.Notice("\u5BFC\u51FA\u5931\u8D25: "+t.message)}}importRules(t){let e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async n=>{let i=n.target.files[0];if(i)try{let s=await i.text(),r=JSON.parse(s),a=await this.plugin.ruleManager.importRules(r);new g.Notice(`\u6210\u529F\u5BFC\u5165 ${a} \u6761\u89C4\u5219`),this.renderRuleList(t.contentEl.querySelector('[style*="flex: 1"]'),t)}catch(s){new g.Notice("\u5BFC\u5165\u5931\u8D25: "+s.message)}},e.click()}};var me=require("obsidian");var ne=class{constructor(t,e,n){this.suggestionEl=null;this.isOpen=!1;this.selectedIndex=0;this.items=[];this.searchQuery="";this.atPosition=0;this.selectedTags=[];this.keydownHandler=null;this.app=t,this.inputEl=e,this.onSelect=n}convertToContentEditable(){if(this.inputEl.tagName==="TEXTAREA"){let t=document.createElement("div");t.className=this.inputEl.className+" markdown-next-ai-editable-input",t.contentEditable="true",t.setAttribute("data-placeholder",this.inputEl.placeholder),t.style.minHeight="80px",t.style.maxHeight="300px",t.style.overflowY="auto",t.textContent=this.inputEl.value,this.inputEl.parentNode.replaceChild(t,this.inputEl),this.inputEl=t,this.updatePlaceholder(),t.addEventListener("input",()=>this.updatePlaceholder())}}updatePlaceholder(){this.inputEl.textContent.trim()===""&&this.inputEl.querySelectorAll(".markdown-next-ai-inline-tag").length===0?this.inputEl.classList.add("empty"):this.inputEl.classList.remove("empty")}getTextContent(){let t="";return this.inputEl.childNodes.forEach(e=>{if(e.nodeType===Node.TEXT_NODE)t+=e.textContent;else if(e.classList&&e.classList.contains("markdown-next-ai-inline-tag")){let n=e.getAttribute("data-type"),i=e.getAttribute("data-path");t+=`@[${n}:${i}]`}}),t}getCursorPosition(){let t=window.getSelection();if(!t||!t.rangeCount)return 0;let e=t.getRangeAt(0),n=0,i=s=>{if(s===e.endContainer)return n+=e.endOffset,!0;if(s.nodeType===Node.TEXT_NODE)n+=s.textContent.length;else if(s.nodeType===Node.ELEMENT_NODE){if(s.classList&&s.classList.contains("markdown-next-ai-inline-tag")){let r=`@[${s.getAttribute("data-type")}:${s.getAttribute("data-path")}]`;n+=r.length}else for(let r of Array.from(s.childNodes))if(i(r))return!0}return!1};for(let s of Array.from(this.inputEl.childNodes))if(i(s))break;return n}setCursorPosition(t){let e=window.getSelection(),n=document.createRange(),i=0,s=!1,r=a=>{if(!s){if(a.nodeType===Node.TEXT_NODE){let l=a.textContent.length;i+l>=t?(n.setStart(a,t-i),n.collapse(!0),s=!0):i+=l}else if(a.nodeType===Node.ELEMENT_NODE){for(let l of Array.from(a.childNodes))if(r(l),s)return}}};r(this.inputEl),!s&&this.inputEl.lastChild&&(n.setStartAfter(this.inputEl.lastChild),n.collapse(!0)),e.removeAllRanges(),e.addRange(n)}show(t,e=""){if(this.atPosition=t,this.searchQuery=e,this.isOpen=!0,this.items=this.getAllItems(e),this.items.length===0){this.close();return}this.suggestionEl||(this.suggestionEl=document.createElement("div"),this.suggestionEl.className="markdown-next-ai-context-suggestions",this.suggestionEl.addEventListener("click",n=>n.stopPropagation()),this.suggestionEl.addEventListener("mousedown",n=>n.stopPropagation()),document.body.appendChild(this.suggestionEl)),this.render(),this.position(),this.bindKeyboardEvents()}getAllItems(t){let e=[],n=t.toLowerCase(),i=ye.IMAGE,s=ye.DOCUMENT;return this.app.vault.getFiles().forEach(a=>{let l=a.extension.toLowerCase(),o="file",c="\u{1F4C4}";if(l==="md")o="file",c="\u{1F4C4}";else if(i.includes(l))o="image",c="\u{1F5BC}\uFE0F";else if(s.includes(l))o="file",c=l==="pdf"?"\u{1F4D5}":["xlsx","xls","csv"].includes(l)?"\u{1F4CA}":["docx","doc","txt"].includes(l)?"\u{1F4DD}":["epub","mobi"].includes(l)?"\u{1F4DA}":l==="json"?"\u{1F4CB}":"\u{1F4C4}";else return;t&&!a.basename.toLowerCase().includes(n)&&!a.path.toLowerCase().includes(n)||e.push({type:o,name:a.basename,path:a.path,icon:c})}),this.app.vault.getAllLoadedFiles().filter(a=>a.children).forEach(a=>{t&&!a.name.toLowerCase().includes(n)&&!a.path.toLowerCase().includes(n)||e.push({type:"folder",name:a.name,path:a.path,icon:"\u{1F4C1}"})}),e.slice(0,50)}render(){if(!this.suggestionEl)return;this.suggestionEl.innerHTML="";let t=document.createElement("div");t.className="markdown-next-ai-suggestions-header",t.textContent=`\u9009\u62E9\u4E0A\u4E0B\u6587 (${this.items.length}\u9879)`,this.suggestionEl.appendChild(t);let e=document.createElement("div");e.className="markdown-next-ai-suggestions-list",this.items.forEach((n,i)=>{let s=document.createElement("div");s.className="markdown-next-ai-suggestion-item",i===this.selectedIndex&&s.classList.add("selected"),s.innerHTML=`
                <span class="markdown-next-ai-suggestion-icon">${n.icon}</span>
                <div class="markdown-next-ai-suggestion-content">
                    <div class="markdown-next-ai-suggestion-name">${n.name}</div>
                    <div class="markdown-next-ai-suggestion-path">${n.path}</div>
                </div>
            `,s.onclick=r=>{r.stopPropagation(),r.preventDefault(),this.selectItem(i)},e.appendChild(s)}),this.suggestionEl.appendChild(e)}position(){if(!this.suggestionEl||!this.inputEl)return;let t=this.inputEl.getBoundingClientRect(),e=window.getSelection();if(e&&e.rangeCount>0){let i=e.getRangeAt(0).getBoundingClientRect();this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=i.left+"px",this.suggestionEl.style.top=i.bottom+5+"px"}else this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=t.left+"px",this.suggestionEl.style.top=t.bottom+5+"px";this.suggestionEl.style.maxHeight="300px",this.suggestionEl.style.overflowY="auto",this.suggestionEl.style.zIndex="10000"}bindKeyboardEvents(){this.keydownHandler&&this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=t=>{if(this.isOpen)switch(t.key){case"ArrowDown":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,this.items.length-1),this.render(),this.scrollToSelected();break;case"ArrowUp":t.preventDefault(),t.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.render(),this.scrollToSelected();break;case"Enter":t.preventDefault(),t.stopPropagation(),this.selectItem(this.selectedIndex);break;case"Escape":t.preventDefault(),t.stopPropagation(),this.close();break}},this.inputEl.addEventListener("keydown",this.keydownHandler)}scrollToSelected(){if(!this.suggestionEl)return;let t=this.suggestionEl.querySelector(".markdown-next-ai-suggestion-item.selected");t&&t.scrollIntoView({block:"nearest",behavior:"smooth"})}selectItem(t){if(t<0||t>=this.items.length)return;let e=this.items[t],n=document.createElement("span");n.className="markdown-next-ai-inline-tag",n.contentEditable="false",n.setAttribute("data-type",e.type),n.setAttribute("data-path",e.path),n.innerHTML=`<span class="markdown-next-ai-inline-tag-icon">${e.icon}</span><span class="markdown-next-ai-inline-tag-name">${e.name}</span>`;let i=window.getSelection();if(!i||!i.rangeCount)return;let s=i.getRangeAt(0),r=this.getCursorPosition()-this.atPosition,a=0,l=!1,o=(d,p,u)=>{if(!l){if(d.nodeType===Node.TEXT_NODE){let h=d.textContent.length;if(a+h>p){let f=p-a,y=Math.min(f+u,h),T=d.textContent;d.textContent=T.substring(0,f)+T.substring(y),s.setStart(d,f),s.collapse(!0),l=!0}else a+=h}else if(d.nodeType===Node.ELEMENT_NODE){if(d.classList&&d.classList.contains("markdown-next-ai-inline-tag")){let h=`@[${d.getAttribute("data-type")}:${d.getAttribute("data-path")}]`;a+=h.length}else for(let h of Array.from(d.childNodes))if(o(h,p,u),l)return}}};o(this.inputEl,this.atPosition,r),l||s.deleteContents(),s.insertNode(n);let c=document.createTextNode(" ");s.setStartAfter(n),s.insertNode(c),s.setStartAfter(c),s.collapse(!0),i.removeAllRanges(),i.addRange(s),this.inputEl.focus(),this.updatePlaceholder(),this.selectedTags.push(e),this.onSelect&&this.onSelect(e),this.close()}updateSearch(t){this.searchQuery=t,this.items=this.getAllItems(t),this.selectedIndex=0,this.items.length===0?this.close():this.render()}close(){this.isOpen=!1,this.suggestionEl&&this.suggestionEl.parentNode&&this.suggestionEl.parentNode.removeChild(this.suggestionEl),this.suggestionEl=null,this.keydownHandler&&(this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}};var _=class{constructor(t,e,n,i){this.selectedFiles=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=t,this.files=e,this.onSelect=n,this.onClose=i}open(t){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-file-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u6863</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6...">
                    </div>
                    <div class="markdown-next-ai-file-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let e=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),i=this.windowEl.querySelector(".markdown-next-ai-file-list"),s=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),r=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),a=o=>{o&&o.stopPropagation(),this.close()};e.onclick=a,r.onclick=a,s.onclick=o=>{o.stopPropagation(),this.onSelect(this.selectedFiles),this.close()},n.addEventListener("input",o=>{let c=o.target.value.toLowerCase();this.renderFileList(i,c)}),this.renderFileList(i,""),this.outsideClickHandler=o=>{this.windowEl.contains(o.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let l=this.windowEl.querySelector(".markdown-next-ai-window-content");if(t){let o=t.left;o+600>window.innerWidth-20&&(o=window.innerWidth-600-20),o<20&&(o=20);let c=t.bottom+8,d=Math.max(300,Math.min(window.innerHeight-c-20,500));l.style.maxHeight=d+"px",l.style.overflowY="auto",l.style.transform="none",l.style.left=o+"px",l.style.top=c+"px"}else l.style.left="50%",l.style.top="50%",l.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),l.addEventListener("click",o=>o.stopPropagation())}renderFileList(t,e){t.innerHTML="",this.files.filter(i=>e===""?!0:(i.name||i.path).toLowerCase().includes(e)).forEach(i=>{let s=document.createElement("div");s.className="markdown-next-ai-file-item";let r=document.createElement("input");r.type="checkbox",r.className="markdown-next-ai-file-checkbox",r.checked=this.selectedFiles.some(c=>c.path===i.path);let a=document.createElement("label");a.className="markdown-next-ai-file-label";let l=document.createElement("span");l.className="markdown-next-ai-file-name",l.textContent=i.name;let o=document.createElement("span");o.className="markdown-next-ai-file-extension",o.textContent=i.extension?"."+i.extension:"",a.appendChild(l),a.appendChild(o),s.appendChild(r),s.appendChild(a),t.appendChild(s),r.addEventListener("change",()=>{r.checked?this.selectedFiles.some(c=>c.path===i.path)||this.selectedFiles.push(i):this.selectedFiles=this.selectedFiles.filter(c=>c.path!==i.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null,this.onClose&&this.onClose())}};var X=class{constructor(t,e,n,i){this.selectedFolders=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=t,this.folders=e,this.onSelect=n,this.onClose=i}open(t){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-folder-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u4EF6\u5939</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6\u5939...">
                    </div>
                    <div class="markdown-next-ai-folder-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let e=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),i=this.windowEl.querySelector(".markdown-next-ai-folder-list"),s=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),r=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),a=o=>{o&&o.stopPropagation(),this.close()};e.onclick=a,r.onclick=a,s.onclick=o=>{o.stopPropagation(),this.onSelect(this.selectedFolders),this.close()},n.addEventListener("input",o=>{let c=o.target.value.toLowerCase();this.renderFolderList(i,c)}),this.renderFolderList(i,""),this.outsideClickHandler=o=>{this.windowEl.contains(o.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let l=this.windowEl.querySelector(".markdown-next-ai-window-content");if(t){let o=t.left;o+600>window.innerWidth-20&&(o=window.innerWidth-600-20),o<20&&(o=20);let c=t.bottom+8,d=Math.max(300,Math.min(window.innerHeight-c-20,500));l.style.maxHeight=d+"px",l.style.overflowY="auto",l.style.transform="none",l.style.left=o+"px",l.style.top=c+"px"}else l.style.left="50%",l.style.top="50%",l.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),l.addEventListener("click",o=>o.stopPropagation())}renderFolderList(t,e){t.innerHTML="",this.folders.filter(i=>e===""?!0:(i.name||i.path).toLowerCase().includes(e)).forEach(i=>{let s=document.createElement("div");s.className="markdown-next-ai-folder-item";let r=document.createElement("input");r.type="checkbox",r.className="markdown-next-ai-folder-checkbox",r.checked=this.selectedFolders.some(l=>l.path===i.path);let a=document.createElement("label");a.className="markdown-next-ai-folder-label",a.textContent=i.name||i.path,s.appendChild(r),s.appendChild(a),t.appendChild(s),r.addEventListener("change",()=>{r.checked?this.selectedFolders.some(l=>l.path===i.path)||this.selectedFolders.push(i):this.selectedFolders=this.selectedFolders.filter(l=>l.path!==i.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null,this.onClose&&this.onClose())}};var K=class{constructor(t,e,n){this.isOpen=!1;this.modalEl=null;this.eventListeners=[];this.selectedIndex=0;this.commonPrompts=[];this.app=t,this.plugin=e,this.onSelect=n}open(t){if(!this.isOpen){this.isOpen=!0;try{this.modalEl=document.createElement("div"),this.modalEl.className="markdown-next-ai-context-suggestions";let e=this.plugin.settings.commonPrompts||[];this.commonPrompts=e,this.selectedIndex=0;let n=document.createElement("div");n.className="markdown-next-ai-suggestions-header",n.textContent=`\u5E38\u7528\u63D0\u793A\u8BCD (${this.commonPrompts.length})`,this.modalEl.appendChild(n);let i=document.createElement("div");if(i.className="markdown-next-ai-suggestions-list",this.commonPrompts.length===0)i.innerHTML=`
                    <div class="markdown-next-ai-suggestion-item" style="cursor: default;">
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD</div>
                            <div class="markdown-next-ai-suggestion-path">\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u6DFB\u52A0</div>
                        </div>
                    </div>
                `;else{let a=this.commonPrompts.map((l,o)=>`
                    <div class="markdown-next-ai-suggestion-item ${o===0?"selected":""}" data-index="${o}">
                        <span class="markdown-next-ai-suggestion-icon">\u{1F4A1}</span>
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">${l.name}</div>
                            <div class="markdown-next-ai-suggestion-path">${l.content.substring(0,50)}${l.content.length>50?"...":""}</div>
                        </div>
                    </div>
                `).join("");i.innerHTML=a}this.modalEl.appendChild(i),this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(a=>{if(this.commonPrompts.length===0)return;let l=()=>{let c=parseInt(a.dataset.index||"0");this.selectPrompt(c)};a.addEventListener("click",l),this.eventListeners.push({element:a,event:"click",handler:l});let o=()=>{let c=parseInt(a.dataset.index||"0");this.updateSelection(c)};a.addEventListener("mouseenter",o),this.eventListeners.push({element:a,event:"mouseenter",handler:o})});let s=a=>{a.target.closest(".markdown-next-ai-at-popup")||this.modalEl.contains(a.target)||this.close()};document.addEventListener("click",s),this.eventListeners.push({element:document,event:"click",handler:s});let r=a=>{a.key==="Escape"?(a.preventDefault(),this.close()):a.key==="ArrowDown"?(a.preventDefault(),this.moveSelection(1)):a.key==="ArrowUp"?(a.preventDefault(),this.moveSelection(-1)):a.key==="Enter"&&(a.preventDefault(),this.selectPrompt(this.selectedIndex))};document.addEventListener("keydown",r),this.eventListeners.push({element:document,event:"keydown",handler:r}),document.body.appendChild(this.modalEl),this.positionPopup(t)}catch(e){console.error("Failed to open prompt selector:",e)}}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:t,event:e,handler:n})=>{t&&typeof t.removeEventListener=="function"&&t.removeEventListener(e,n)}),this.eventListeners=[],this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null)}positionPopup(t){if(this.modalEl&&t)try{let e=t.getBoundingClientRect(),n=this.modalEl.getBoundingClientRect(),i=window.innerWidth,s=window.innerHeight,r=e.left,a=e.bottom+5;r+n.width>i&&(r=i-n.width-10),a+n.height>s&&(a=e.top-n.height-5),r=Math.max(10,r),a=Math.max(10,a),this.modalEl.style.position="fixed",this.modalEl.style.left=r+"px",this.modalEl.style.top=a+"px",this.modalEl.style.zIndex="10002"}catch(e){console.error("Failed to position prompt selector:",e)}}moveSelection(t){if(this.commonPrompts.length===0)return;let e=this.selectedIndex+t;e<0&&(e=this.commonPrompts.length-1),e>=this.commonPrompts.length&&(e=0),this.updateSelection(e)}updateSelection(t){if(!this.modalEl||this.commonPrompts.length===0)return;this.selectedIndex=t,this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(n=>n.classList.remove("selected"));let e=this.modalEl.querySelector(`[data-index="${t}"]`);e&&(e.classList.add("selected"),e.scrollIntoView({block:"nearest",behavior:"smooth"}))}selectPrompt(t){if(t<0||t>=this.commonPrompts.length)return;let e=this.commonPrompts[t];e&&this.onSelect&&this.onSelect(e.content),this.close()}};var Y=class{constructor(t,e,n,i,s,r="",a="chat"){this.popupEl=null;this.inputEl=null;this.modelSelectEl=null;this.isOpen=!1;this.eventListeners=[];this.selectedContext={files:[],folders:[]};this.scrollContainer=null;this.contextSelector=null;this.promptSelector=null;this.outsideClickHandler=null;this.historyContainer=null;this.historyVisible=!1;this.isDragging=!1;this.closeGuards=new Set;this.app=t,this.onSubmit=e,this.cursorPosition=n,this.plugin=i,this.view=s,this.selectedText=r,this.mode=a,this.imageHandler=new Z}addCloseGuard(t){t&&(this.closeGuards.add(t),this.popupEl&&this.popupEl.setAttribute("data-close-guard","true"))}removeCloseGuard(t){t&&(this.closeGuards.delete(t),this.popupEl&&this.closeGuards.size===0&&this.popupEl.removeAttribute("data-close-guard"))}hasCloseGuard(){return this.closeGuards.size>0}async submit(){var s,r;let t=((s=this.contextSelector)==null?void 0:s.getTextContent().trim())||"";await this.processInlineImages();let e=this.imageHandler.getImages(),n=((r=this.modelSelectEl)==null?void 0:r.value)||"",i=await this.getContextContent();if(!t&&e.length===0&&!i){new me.Notice("\u8BF7\u8F93\u5165\u7EED\u5199\u8981\u6C42\u6216\u4E0A\u4F20\u56FE\u7247");return}this.onSubmit(t,e,n,i,this.selectedText,this.mode),this.close()}getModelOptions(){let t=this.plugin.getAvailableModels(),e=this.plugin.settings.currentModel;return t.map(n=>{let i=n.id===e?"selected":"";return`<option value="${n.id}" ${i}>${n.name}</option>`}).join("")}getModelNameById(t){var n;return((n=this.plugin.getAvailableModels().find(i=>i.id===t))==null?void 0:n.name)||t||"\u9009\u62E9\u6A21\u578B"}addImagePreview(t,e){let n=this.imageHandler.createImagePreview(t,()=>{});e.appendChild(n)}open(){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-at-popup");let t=this.mode==="edit",e=t?"\u4FEE\u6539\u6240\u9009\u5185\u5BB9":"Markdown-Next-AI",n=t?"\u8BF7\u8F93\u5165\u4FEE\u6539\u8981\u6C42...":"\uFF08@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD\uFF09...",i=this.selectedText,s=this.getModelNameById(this.plugin.settings.currentModel);this.popupEl.innerHTML=`
            <div class="markdown-next-ai-popup-header">
                <span class="markdown-next-ai-popup-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                    ${e}
                </span>
                <div class="markdown-next-ai-popup-actions">
                    <button class="markdown-next-ai-history-btn" title="\u67E5\u770B\u5386\u53F2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></button>
                    <button class="markdown-next-ai-popup-close">\u2715</button>
                </div>
            </div>
            <div class="markdown-next-ai-history-panel" style="display:none;"></div>
            <div class="markdown-next-ai-popup-content">
                ${this.selectedText?`
                <div class="markdown-next-ai-selected-text-section">
                    <div class="markdown-next-ai-selected-text-header">
                        <span class="markdown-next-ai-selected-text-label">${t?"\u5F85\u4FEE\u6539\u5185\u5BB9:":"\u5DF2\u9009\u4E2D\u6587\u672C:"}</span>
                    </div>
                    <div class="markdown-next-ai-selected-text-preview">${i}</div>
                </div>
                `:""}
                <div class="markdown-next-ai-context-section">
                    <div class="markdown-next-ai-selected-context" style="display: none;">
                        <div class="markdown-next-ai-context-header">
                            <span class="markdown-next-ai-context-title">\u5DF2\u9009\u62E9\u4E0A\u4E0B\u6587:</span>
                            <button class="markdown-next-ai-clear-context-btn" title="\u6E05\u9664\u4E0A\u4E0B\u6587">\u2715</button>
                        </div>
                        <div class="markdown-next-ai-context-list"></div>
                    </div>
                </div>
                <textarea class="markdown-next-ai-continue-input" placeholder="${n}" rows="3"></textarea>
                <div class="markdown-next-ai-upload-section">
                    <div class="markdown-next-ai-left-section">
                        <select class="markdown-next-ai-model-select">
                            ${this.getModelOptions()}
                        </select>
                        <input type="file" class="markdown-next-ai-file-input" accept="image/*" multiple style="display: none;">
                        <button class="markdown-next-ai-upload-btn" title="\u4E0A\u4F20\u56FE\u7247"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg></button>
                        <div class="markdown-next-ai-context-buttons">
                            <button class="markdown-next-ai-select-file-btn" title="\u9009\u62E9\u6587\u6863\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></button>
                            <button class="markdown-next-ai-select-folder-btn" title="\u9009\u62E9\u6587\u4EF6\u5939\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg></button>
                        </div>
                    </div>
                    <button class="markdown-next-ai-submit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="m22 2-7 19-4-9-9-4 20-6z"/></svg>\u63D0\u4EA4</button>
                </div>
                <div class="markdown-next-ai-image-previews"></div>
            </div>
        `,this.inputEl=this.popupEl.querySelector(".markdown-next-ai-continue-input"),this.modelSelectEl=this.popupEl.querySelector(".markdown-next-ai-model-select");let r=this.popupEl.querySelector(".markdown-next-ai-submit-btn"),a=this.popupEl.querySelector(".markdown-next-ai-popup-close"),l=this.popupEl.querySelector(".markdown-next-ai-file-input"),o=this.popupEl.querySelector(".markdown-next-ai-upload-btn"),c=this.popupEl.querySelector(".markdown-next-ai-image-previews"),d=this.popupEl.querySelector(".markdown-next-ai-select-file-btn"),p=this.popupEl.querySelector(".markdown-next-ai-select-folder-btn"),u=this.popupEl.querySelector(".markdown-next-ai-clear-context-btn"),h=this.popupEl.querySelector(".markdown-next-ai-history-btn");if(this.historyContainer=this.popupEl.querySelector(".markdown-next-ai-history-panel"),this.contextSelector=new ne(this.app,this.inputEl,()=>{}),this.contextSelector.convertToContentEditable(),this.inputEl=this.contextSelector.inputEl,this.promptSelector=new K(this.app,this.plugin,m=>{let x=this.contextSelector.getCursorPosition(),N=this.contextSelector.getTextContent().substring(0,x).lastIndexOf("#");if(N!==-1){let F=window.getSelection();if(F&&F.rangeCount>0){let I=F.getRangeAt(0),H=x-N,M=0,k=!1,C=(w,E,S)=>{if(!k){if(w.nodeType===Node.TEXT_NODE){let b=w.textContent.length;if(M+b>E){let L=E-M,D=Math.min(L+S,b),be=w.textContent;w.textContent=be.substring(0,L)+be.substring(D);let ke=document.createTextNode(m);w.parentNode&&(w.parentNode.insertBefore(ke,w.nextSibling),I.setStartAfter(ke),I.collapse(!0)),k=!0}else M+=b}else if(w.nodeType===Node.ELEMENT_NODE){for(let b of Array.from(w.childNodes))if(C(b,E,S),k)return}}};C(this.inputEl,N,H),F.removeAllRanges(),F.addRange(I),this.inputEl.focus()}}}),a.onclick=()=>this.close(),r.onclick=()=>this.submit(),o.onclick=()=>l.click(),d.onclick=()=>this.showFileSelector(),p.onclick=()=>this.showFolderSelector(),u.onclick=()=>this.clearContext(),h&&(h.onclick=()=>this.toggleHistoryPanel()),this.modelSelectEl){let m=x=>{let $=x.target;this.plugin&&this.plugin.settings&&(this.plugin.settings.currentModel=$.value,this.plugin.saveSettings()),this.updateUIForModelType($.value)};this.modelSelectEl.addEventListener("change",m),this.eventListeners.push({element:this.modelSelectEl,event:"change",handler:m}),this.updateUIForModelType(this.modelSelectEl.value)}let f=m=>{let x=m.target;x.files&&this.imageHandler.handleFileSelect(x.files,$=>{this.addImagePreview($,c)}),x.value=""};l.addEventListener("change",f),this.eventListeners.push({element:l,event:"change",handler:f});let y=m=>{this.imageHandler.handlePaste(m,x=>{this.addImagePreview(x,c)})};this.inputEl.addEventListener("paste",y),this.eventListeners.push({element:this.inputEl,event:"paste",handler:y});let T=m=>{m.stopPropagation(),this.adjustPopupWidth();let x=this.contextSelector.getCursorPosition(),$=this.contextSelector.getTextContent().substring(0,x),N=$.lastIndexOf("@");if(N!==-1){let I=$.substring(N+1);if(!I.includes(" ")&&!I.includes(`
`)){this.contextSelector.show(N,I);return}else this.contextSelector.close()}else this.contextSelector.close();let F=$.lastIndexOf("#");if(F!==-1){let I=F>0?$.charAt(F-1):" ";if(I===" "||I===`
`){this.promptSelector.open(this.inputEl);let H=window.getSelection();if(H&&H.rangeCount>0){let k=H.getRangeAt(0).getBoundingClientRect(),C=document.querySelector(".markdown-next-ai-context-suggestions");C&&(C.style.position="fixed",C.style.left=k.left+"px",C.style.top=k.bottom+5+"px")}}else this.promptSelector.close()}else this.promptSelector.close()};this.inputEl.addEventListener("input",T),this.eventListeners.push({element:this.inputEl,event:"input",handler:T});let A=m=>{this.contextSelector&&this.contextSelector.isOpen||(m.key==="Enter"?m.shiftKey||(m.preventDefault(),r.click()):m.key==="Escape"&&(m.preventDefault(),this.close()))};this.inputEl.addEventListener("keydown",A),this.eventListeners.push({element:this.inputEl,event:"keydown",handler:A});let v=m=>{this.hasCloseGuard()||this.popupEl.hasAttribute("data-prompt-selecting")||m.target.closest(".markdown-next-ai-prompt-selector-popup")||m.target.closest(".markdown-next-ai-context-suggestions")||this.contextSelector&&this.contextSelector.isOpen||m.target.closest(".markdown-next-ai-file-selection-window")||m.target.closest(".markdown-next-ai-folder-selection-window")||m.target.closest(".markdown-next-ai-model-dropdown")||m.target.closest(".cm-editor")||m.target.closest(".markdown-source-view")||m.target.closest(".markdown-preview-view")||m.target.closest(".markdown-next-ai-result-floating-window")||this.popupEl.contains(m.target)||this.close()};setTimeout(()=>{document.addEventListener("click",v)},100),this.outsideClickHandler=v,this.view&&(this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor"))),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.scrollContainer.appendChild(this.popupEl)):document.body.appendChild(this.popupEl),this.positionPopup(),this.enableDragging(),this.adjustPopupWidth(),setTimeout(()=>{this.inputEl&&this.inputEl.focus()},100)}positionPopup(){if(!this.popupEl||!this.cursorPosition)return;let{left:t,top:e,height:n=20}=this.cursorPosition;if(this.scrollContainer){let i=this.scrollContainer.getBoundingClientRect(),s=this.scrollContainer.scrollTop,r=this.scrollContainer.scrollLeft,a=t-i.left+r,l=e+n+5-i.top+s;this.popupEl.style.position="absolute",this.popupEl.style.left=a+"px",this.popupEl.style.top=l+"px",this.popupEl.style.zIndex="10000";let o=this.popupEl.getBoundingClientRect(),c=i.width;o.right>i.right&&(a=c+r-o.width-10,this.popupEl.style.left=a+"px"),a<r&&(this.popupEl.style.left=r+10+"px"),o.bottom>i.bottom&&(l=e-i.top+s-o.height-5,this.popupEl.style.top=l+"px")}else{this.popupEl.style.position="fixed",this.popupEl.style.left=t+"px",this.popupEl.style.top=e+n+5+"px",this.popupEl.style.zIndex="10000";let i=this.popupEl.getBoundingClientRect(),s=window.innerWidth,r=window.innerHeight;i.right>s&&(this.popupEl.style.left=s-i.width-10+"px"),i.left<0&&(this.popupEl.style.left="10px"),i.bottom>r&&(this.popupEl.style.top=e-i.height-5+"px")}}adjustPopupWidth(){if(!this.popupEl||!this.inputEl)return;let t=document.createElement("span");t.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            max-width: 80vw;
        `;let e=this.contextSelector?this.contextSelector.getTextContent():"";t.textContent=e||"",document.body.appendChild(t);let n=t.offsetWidth;document.body.removeChild(t);let i=this.historyContainer&&this.historyVisible?this.historyContainer.scrollWidth+40:0,s=520,r=Math.min(window.innerWidth*.8,900),l=Math.max(s,Math.min(Math.max(n+120,i),r));this.popupEl.style.width=l+"px"}toggleHistoryPanel(){this.historyContainer&&(this.historyVisible=!this.historyVisible,this.historyContainer.style.display=this.historyVisible?"block":"none",this.historyVisible&&this.renderHistoryPanel(),this.adjustPopupWidth())}renderHistoryPanel(){if(!this.historyContainer)return;let t=(this.plugin.settings.conversationHistory||[]).slice(-10).reverse();if(!t.length){this.historyContainer.innerHTML='<div class="markdown-next-ai-history-empty">\u6682\u65E0\u5386\u53F2\u8BB0\u5F55</div>';return}let e=i=>{let s=new Date(i),r=a=>a.toString().padStart(2,"0");return`${s.getMonth()+1}-${s.getDate()} ${r(s.getHours())}:${r(s.getMinutes())}`},n=t.map((i,s)=>{let r=i.prompt.length>80?`${i.prompt.slice(0,80)}...`:i.prompt,a=i.response.length>120?`${i.response.slice(0,120)}...`:i.response;return`
                <div class="markdown-next-ai-history-item" 
                     data-history-id="${i.id}" 
                     data-history-idx="${s}"
                     title="\u70B9\u51FB\u6062\u590D\u6B64\u5BF9\u8BDD">
                    <div class="markdown-next-ai-history-header">
                        <span class="markdown-next-ai-history-time">${e(i.timestamp)}</span>
                        <span class="markdown-next-ai-history-model">${i.modelId}</span>
                    </div>
                    <div class="markdown-next-ai-history-prompt">${r||"(\u7A7A\u63D0\u793A)"}</div>
                    <div class="markdown-next-ai-history-response">${a||"(\u65E0\u56DE\u590D)"}</div>
                </div>
            `}).join("");this.historyContainer.innerHTML=n,this.historyContainer.querySelectorAll(".markdown-next-ai-history-item").forEach(i=>{i.addEventListener("click",()=>{let s=i.getAttribute("data-history-id");s&&this.restoreHistoryEntry(s)})})}restoreHistoryEntry(t){if(!this.inputEl)return;let e=(this.plugin.settings.conversationHistory||[]).find(n=>n.id===t);e&&this.inputEl instanceof HTMLTextAreaElement&&(this.inputEl.value=e.prompt,this.inputEl.focus(),this.adjustPopupWidth(),this.historyContainer&&(this.historyVisible=!1,this.historyContainer.style.display="none"),new me.Notice(`\u5DF2\u6062\u590D: "${e.prompt.slice(0,50)}${e.prompt.length>50?"...":""}"`))}enableDragging(){if(!this.popupEl)return;let t=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(!t)return;let e=0,n=0,i=0,s=0,r=p=>{if(p.button!==0||!this.popupEl||p.target.closest(".markdown-next-ai-popup-actions"))return;this.isDragging=!0,e=p.clientX,n=p.clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(i=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},a=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.clientX-e,h=p.clientY-n,f=i+u,y=s+h;this.popupEl.style.transform=`translate(${f}px, ${y}px)`},l=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))},o=p=>{if(!this.popupEl)return;this.isDragging=!0,e=p.touches[0].clientX,n=p.touches[0].clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(i=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},c=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.touches[0].clientX-e,h=p.touches[0].clientY-n,f=i+u,y=s+h;this.popupEl.style.transform=`translate(${f}px, ${y}px)`},d=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))};t.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",l),t.addEventListener("touchstart",o,{passive:!1}),document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",d),this.eventListeners.push({element:t,event:"mousedown",handler:r},{element:document,event:"mousemove",handler:a},{element:document,event:"mouseup",handler:l},{element:t,event:"touchstart",handler:o},{element:document,event:"touchmove",handler:c},{element:document,event:"touchend",handler:d})}close(){this.isOpen&&(this.isOpen=!1,this.contextSelector&&(this.contextSelector.close(),this.contextSelector=null),this.eventListeners.forEach(({element:t,event:e,handler:n})=>{t.removeEventListener(e,n)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.imageHandler.clearImages(),this.closeGuards.clear(),this.popupEl&&this.popupEl.removeAttribute("data-close-guard"),this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.inputEl=null)}updateUIForModelType(t){var n;if(!this.popupEl||!t)return;let e=this.plugin.settings.models[t];if(e){let i=e.category===R.IMAGE,s=this.popupEl.querySelector(".markdown-next-ai-popup-title");s&&(s.innerHTML=i?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-icon lucide-image" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>AI\u56FE\u7247\u751F\u6210':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>Markdown-Next-AI'),this.inputEl&&(this.inputEl.setAttribute("data-placeholder",i?"\u8BF7\u63CF\u8FF0\u60A8\u60F3\u8981\u751F\u6210\u7684\u56FE\u7247...":"(@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD)"),(n=this.contextSelector)==null||n.updatePlaceholder());let r=this.popupEl.querySelector(".markdown-next-ai-submit-btn");r&&(r.innerHTML=i?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-plus-icon lucide-image-plus" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M16 5h6"/><path d="M19 2v6"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>\u751F\u6210\u56FE\u7247':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="m22 2-7 19-4-9-9-4 20-6z"/></svg>\u63D0\u4EA4');let a=this.popupEl.querySelector(".markdown-next-ai-upload-btn");a&&(a.style.display=i?"none":"inline-flex")}}showFileSelector(){let t=["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"],e=this.plugin.app.vault.getFiles().filter(i=>t.includes(i.extension.toLowerCase())).map(i=>({name:i.basename,path:i.path,extension:i.extension.toLowerCase()})),n=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(n){let i=n.getBoundingClientRect();this.addCloseGuard("file-window"),new _(this.plugin.app,e,s=>{this.addFilesToContext(s)},()=>this.removeCloseGuard("file-window")).open(i)}}showFolderSelector(){let t=this.plugin.app.vault.getAllLoadedFiles().filter(n=>!!n.children).map(n=>({name:n.name,path:n.path})),e=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(e){let n=e.getBoundingClientRect();this.addCloseGuard("folder-window"),new X(this.plugin.app,t,i=>{this.addFoldersToContext(i)},()=>this.removeCloseGuard("folder-window")).open(n)}}addFilesToContext(t){t.forEach(e=>{this.selectedContext.files.find(n=>n.path===e.path)||this.selectedContext.files.push(e)}),this.updateContextDisplay()}addFoldersToContext(t){t.forEach(e=>{this.selectedContext.folders.find(n=>n.path===e.path)||this.selectedContext.folders.push(e)}),this.updateContextDisplay()}updateContextDisplay(){let t=this.popupEl.querySelector(".markdown-next-ai-selected-context"),e=this.popupEl.querySelector(".markdown-next-ai-context-list");this.selectedContext.files.length>0||this.selectedContext.folders.length>0?(t.style.display="block",e.innerHTML="",this.selectedContext.files.forEach(i=>{let s=document.createElement("div");s.className="markdown-next-ai-context-item",s.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${i.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="file" data-path="${i.path}">\xD7</button>
                `,e.appendChild(s)}),this.selectedContext.folders.forEach(i=>{let s=document.createElement("div");s.className="markdown-next-ai-context-item",s.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${i.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="folder" data-path="${i.path}">\xD7</button>
                `,e.appendChild(s)}),e.querySelectorAll(".markdown-next-ai-remove-context").forEach(i=>{i.onclick=s=>{s.stopPropagation();let r=i.getAttribute("data-type"),a=i.getAttribute("data-path");this.removeFromContext(r,a)}})):t.style.display="none"}removeFromContext(t,e){t==="file"?this.selectedContext.files=this.selectedContext.files.filter(n=>n.path!==e):t==="folder"&&(this.selectedContext.folders=this.selectedContext.folders.filter(n=>n.path!==e)),this.updateContextDisplay()}clearContext(){this.selectedContext={files:[],folders:[]},this.updateContextDisplay()}async processInlineImages(){var e;if(!this.contextSelector||!this.contextSelector.inputEl)return;let t=this.contextSelector.inputEl.querySelectorAll(".markdown-next-ai-inline-tag");for(let n of Array.from(t)){let i=n.getAttribute("data-type"),s=n.getAttribute("data-path");if(i==="image"&&s)try{let r=this.plugin.app.vault.getAbstractFileByPath(s);if(!r)continue;let a=await this.plugin.app.vault.readBinary(r),l=new Uint8Array(a),o="";for(let y=0;y<l.length;y++)o+=String.fromCharCode(l[y]);let c=btoa(o),p={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",svg:"image/svg+xml"}[((e=r.extension)==null?void 0:e.toLowerCase())||"png"]||"image/png",u=`data:${p};base64,${c}`,h={id:Date.now()+Math.random(),name:r.name,size:a.byteLength,type:p,base64:u,url:u,fromInline:!0};this.imageHandler.getImages().some(y=>y.name===h.name&&y.size===h.size)||this.imageHandler.addImage(h)}catch(r){console.error("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+s,r),new me.Notice("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+s)}}}async getContextContent(){let t="";for(let n of this.selectedContext.files)try{let i=this.plugin.app.vault.getAbstractFileByPath(n.path);if(i){let s=await this.plugin.app.vault.read(i);t+=`

=== \u6587\u6863: ${n.name} ===
${s}`}}catch(i){console.error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:",i)}let e=(n,i)=>{let s=[];if(n&&n.children){for(let r of n.children)if(r.extension==="md")s.push({file:r,sourcePath:r.path,baseFolderName:i});else if(r.children){let a=e(r,i);s.push(...a)}}return s};for(let n of this.selectedContext.folders)try{let i=this.plugin.app.vault.getAbstractFileByPath(n.path);if(i){let s=e(i,n.name);for(let{file:r,sourcePath:a,baseFolderName:l}of s){let o=await this.plugin.app.vault.read(r);t+=`

=== \u6587\u6863: ${r.basename} (\u6765\u81EA\u6587\u4EF6\u5939: ${l}, \u8DEF\u5F84: ${a}) ===
${o}`}}}catch(i){console.error("\u8BFB\u53D6\u6587\u4EF6\u5939\u5931\u8D25:",i)}return t.trim()}};var ie=class{constructor(t,e,n,i,s,r=null){this.isOpen=!1;this.popupEl=null;this.scrollContainer=null;this.app=t,this.editor=e,this.view=n,this.onConfirm=i,this.onReject=s,this.onAppend=r}open(t){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-preview-popup"),this.popupEl.style.minWidth="240px",this.popupEl.style.maxWidth="420px",this.popupEl.innerHTML=`
            <div class="markdown-next-ai-preview-content">
                <div class="markdown-next-ai-preview-header">
                    <div class="markdown-next-ai-preview-status thinking">
                        <span class="status-dot"></span>
                        <span class="status-text">\u6B63\u5728\u601D\u8003\u4E2D</span>
                    </div>
                </div>
                <div class="markdown-next-ai-preview-actions" style="display: none;">
                    <button class="markdown-next-ai-preview-btn confirm" title="\u66FF\u6362\u539F\u6587">\u66FF\u6362</button>
                    ${this.onAppend?'<button class="markdown-next-ai-preview-btn append" title="\u4FDD\u7559\u539F\u6587\u5E76\u8FFD\u52A0">\u8FFD\u52A0</button>':""}
                    <button class="markdown-next-ai-preview-btn reject" title="\u653E\u5F03\u751F\u6210">\u653E\u5F03</button>
                </div>
            </div>
        `;let e=this.popupEl.querySelector(".markdown-next-ai-preview-btn.confirm"),n=this.popupEl.querySelector(".markdown-next-ai-preview-btn.reject"),i=this.popupEl.querySelector(".markdown-next-ai-preview-btn.append");if(e.onclick=()=>{this.onConfirm&&this.onConfirm(),this.close()},i&&(i.onclick=()=>{this.onAppend&&this.onAppend(),this.close()}),n.onclick=()=>{this.onReject&&this.onReject(),this.close()},this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor")),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.popupEl.style.position="absolute",this.scrollContainer.appendChild(this.popupEl)):(this.popupEl.style.position="fixed",document.body.appendChild(this.popupEl)),t){let s=t.top+(t.height||0);this.positionAt(t.left,s,"below")}}positionAt(t,e,n="below"){if(!this.popupEl)return;let i=this.popupEl.getBoundingClientRect(),s=12;if(this.scrollContainer){let r=this.scrollContainer.getBoundingClientRect(),a=this.scrollContainer.scrollTop,l=this.scrollContainer.scrollLeft,o=this.scrollContainer.querySelector(".cm-content"),c=o?o.getBoundingClientRect():r,d=t-r.left+l-i.width/2,p=n==="above"?e-r.top+a-i.height-s:e-r.top+a+s,u=l+8,h=Math.max(u,r.width-i.width+l-8);d=Math.min(Math.max(u,d),h);let f=a+8,y=Math.max(f,r.height-i.height+a-8);p<f&&n==="above"&&(p=e-r.top+a+s),p=Math.min(Math.max(f,p),y),this.popupEl.style.left=d+"px",this.popupEl.style.top=p+"px"}else{let r=window.innerWidth,a=window.innerHeight,l=n==="right"?t+s:t-i.width/2,o=n==="above"?e-i.height-s:e+s;n==="right"&&l+i.width>r-10&&(l=r-i.width-12),n!=="above"&&o+i.height>a-10&&(o=e-i.height-s),l=Math.min(Math.max(10,l),r-i.width-12),o=Math.min(Math.max(10,o),a-i.height-12),this.popupEl.style.left=l+"px",this.popupEl.style.top=o+"px"}this.popupEl.style.right="auto",this.popupEl.style.bottom="auto"}updateStatus(t){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-preview-status"),n=this.popupEl.querySelector(".status-text");e&&n&&(n.textContent=t,e.classList.remove("thinking","generating"),t.includes("\u751F\u6210")?e.classList.add("generating"):e.classList.add("thinking"))}showActions(){if(!this.popupEl)return;let t=this.popupEl.querySelector(".markdown-next-ai-preview-status"),e=this.popupEl.querySelector(".markdown-next-ai-preview-actions");t&&(t.style.display="none"),e&&(e.style.display="flex")}close(){this.isOpen&&(this.isOpen=!1,this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null)}};var se=require("obsidian"),oe=class{constructor(t,e,n,i){this.popupEl=null;this.isOpen=!1;this.isDragging=!1;this.markdownComponent=null;this.onInsertCallback=null;this.onReplaceCallback=null;this.onCopyCallback=null;this.onCancelCallback=null;this.app=t,this.view=e,this.modelId=n,this.position=i}open(){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-result-floating-window"),this.popupEl.innerHTML=`
            <div class="result-header">
                <div class="result-header-left">
                    <span class="model-info">\u6A21\u578B: ${this.modelId}</span>
                    <span class="char-count">0 \u5B57</span>
                </div>
                <button class="result-close-btn">\u2715</button>
            </div>
            <div class="result-status thinking">
                <span class="status-dot"></span>
                <span class="status-text">\u6B63\u5728\u601D\u8003\u4E2D</span>
            </div>
            <div class="result-content markdown-preview-view markdown-rendered"></div>
            <div class="result-actions" style="display: none;">
                <button class="btn-insert" title="\u5728\u5149\u6807\u5904\u63D2\u5165">\u63D2\u5165</button>
                <button class="btn-replace" title="\u66FF\u6362\u9009\u4E2D\u6587\u672C">\u66FF\u6362</button>
                <button class="btn-copy" title="\u590D\u5236\u5230\u526A\u8D34\u677F">\u590D\u5236</button>
                <button class="btn-cancel" title="\u53D6\u6D88">\u53D6\u6D88</button>
            </div>
        `,document.body.appendChild(this.popupEl),this.position?(this.popupEl.style.position="fixed",this.popupEl.style.left=this.position.left+"px",this.popupEl.style.top=this.position.top+(this.position.height||20)+10+"px"):(this.popupEl.style.position="fixed",this.popupEl.style.left=window.innerWidth/2-200+"px",this.popupEl.style.top=window.innerHeight/3+"px"),this.enableDragging(),this.markdownComponent=new se.Component;let t=this.popupEl.querySelector(".result-close-btn"),e=this.popupEl.querySelector(".btn-insert"),n=this.popupEl.querySelector(".btn-replace"),i=this.popupEl.querySelector(".btn-copy"),s=this.popupEl.querySelector(".btn-cancel");t==null||t.addEventListener("click",()=>this.close()),e==null||e.addEventListener("click",()=>{this.onInsertCallback&&this.onInsertCallback()}),n==null||n.addEventListener("click",()=>{this.onReplaceCallback&&this.onReplaceCallback()}),i==null||i.addEventListener("click",()=>{this.onCopyCallback&&this.onCopyCallback()}),s==null||s.addEventListener("click",()=>{this.onCancelCallback&&this.onCancelCallback(),this.close()}),(!this.view||!this.view.editor)&&(e&&(e.disabled=!0),n&&(n.disabled=!0))}updateContent(t){if(!this.popupEl)return;let e=this.popupEl.querySelector(".result-content"),n=this.popupEl.querySelector(".char-count");e&&(e.textContent=t),n&&(n.textContent=`${t.length} \u5B57`)}async renderMarkdown(t){var n;if(!this.popupEl)return;let e=this.popupEl.querySelector(".result-content");if(e){if(!t||!t.trim()){e.textContent="";return}this.markdownComponent||(this.markdownComponent=new se.Component),(n=e.empty)==null||n.call(e),e.innerHTML="";try{await se.MarkdownRenderer.render(this.app,t,e,"",this.markdownComponent)}catch(i){console.error("\u6E32\u67D3 Markdown \u5931\u8D25",i),e.textContent=t}}}updateStatus(t){if(!this.popupEl)return;let e=this.popupEl.querySelector(".result-status"),n=this.popupEl.querySelector(".status-text");e&&n&&(n.textContent=t,e.classList.remove("thinking","generating"),t.includes("\u751F\u6210")?e.classList.add("generating"):e.classList.add("thinking"))}showError(t){if(!this.popupEl)return;let e=this.popupEl.querySelector(".result-status"),n=this.popupEl.querySelector(".result-content");if(e){e.classList.add("error");let i=e.querySelector(".status-text");i&&(i.textContent="\u751F\u6210\u5931\u8D25")}n&&(n.textContent=t),this.showActions()}showActions(){if(!this.popupEl)return;let t=this.popupEl.querySelector(".result-status"),e=this.popupEl.querySelector(".result-actions");t&&(t.style.display="none"),e&&(e.style.display="flex")}setOnInsert(t){this.onInsertCallback=t}setOnReplace(t){this.onReplaceCallback=t}setOnCopy(t){this.onCopyCallback=t}setOnCancel(t){this.onCancelCallback=t}close(){if(!this.isOpen||!this.popupEl)return;this.isOpen=!1;let t=this.dragListeners;t&&(t.forEach(({element:e,event:n,handler:i})=>{e.removeEventListener(n,i)}),this.dragListeners=null),this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.markdownComponent&&(this.markdownComponent.unload(),this.markdownComponent=null)}enableDragging(){if(!this.popupEl)return;let t=this.popupEl.querySelector(".result-header");if(!t)return;let e=0,n=0,i=0,s=0,r=p=>{if(p.button!==0||!this.popupEl)return;this.isDragging=!0,e=p.clientX,n=p.clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(i=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},a=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.clientX-e,h=p.clientY-n,f=i+u,y=s+h;this.popupEl.style.transform=`translate(${f}px, ${y}px)`},l=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))},o=p=>{if(!this.popupEl)return;this.isDragging=!0,e=p.touches[0].clientX,n=p.touches[0].clientY;let h=(this.popupEl.style.transform||"translate(0, 0)").match(/translate\(([^,]+),\s*([^)]+)\)/);h&&(i=parseFloat(h[1])||0,s=parseFloat(h[2])||0),document.body.style.userSelect="none"},c=p=>{if(!this.isDragging||!this.popupEl)return;p.preventDefault();let u=p.touches[0].clientX-e,h=p.touches[0].clientY-n,f=i+u,y=s+h;this.popupEl.style.transform=`translate(${f}px, ${y}px)`},d=()=>{this.isDragging&&(this.isDragging=!1,document.body.style.removeProperty("user-select"))};t.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",l),t.addEventListener("touchstart",o,{passive:!1}),document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",d),this.dragListeners=[{element:t,event:"mousedown",handler:r},{element:document,event:"mousemove",handler:a},{element:document,event:"mouseup",handler:l},{element:t,event:"touchstart",handler:o},{element:document,event:"touchmove",handler:c},{element:document,event:"touchend",handler:d}]}};var He=require("obsidian"),re=class{constructor(t,e){this.debounceTimer=null;this.handleSelectionChange=()=>{this.debounceTimer&&window.clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(this.processSelection,300)};this.processSelection=()=>{let t=this.app.workspace.getActiveViewOfType(He.MarkdownView);if(!t){this.onSelection(null);return}let e=window.getSelection();if(!e||e.rangeCount===0||e.isCollapsed){this.onSelection(null);return}let n=e.toString().trim();if(n.length<2){this.onSelection(null);return}if(!t.containerEl.contains(e.anchorNode)){this.onSelection(null);return}let i=e.anchorNode;for(;i;){if(i instanceof HTMLElement&&(i.classList.contains("markdown-next-ai-at-popup")||i.classList.contains("markdown-next-ai-result-floating-window")||i.classList.contains("markdown-next-ai-selection-toolbar")))return;i=i.parentNode}let s=e.getRangeAt(0),r=s.getBoundingClientRect();if(r.width===0||r.height===0){this.onSelection(null);return}this.onSelection({text:n,range:s,rect:r,view:t})};this.app=t,this.onSelection=e,this.init()}init(){document.addEventListener("selectionchange",this.handleSelectionChange)}destroy(){document.removeEventListener("selectionchange",this.handleSelectionChange),this.debounceTimer&&window.clearTimeout(this.debounceTimer)}};var fe=require("obsidian"),ae=class{constructor(t,e){this.currentSelection=null;this.isVisible=!1;this.app=t,this.plugin=e,this.el=document.createElement("div"),this.el.addClass("markdown-next-ai-selection-toolbar"),document.body.appendChild(this.el),this.render()}render(){this.el.innerHTML="";let t=this.createButton("AI Modify","pencil",()=>{this.currentSelection&&(this.plugin.showAtTriggerModal(this.currentSelection.text,"edit"),this.hide())}),e=this.createButton("Add to Chat","message-square",()=>{this.currentSelection&&(this.plugin.showAtTriggerModal(this.currentSelection.text,"chat"),this.hide())}),n=this.createButton("Copy","copy",()=>{this.currentSelection&&(navigator.clipboard.writeText(this.currentSelection.text),this.hide())}),i=this.createButton("More","more-horizontal",s=>{if(this.currentSelection){let r=new fe.Menu;r.addItem(a=>{a.setTitle("Summarize").setIcon("file-text").onClick(()=>{var l;this.plugin.handleContinueWriting("Summarize this text",[],null,null,(l=this.currentSelection)==null?void 0:l.text,"chat"),this.hide()})}),r.addItem(a=>{a.setTitle("Explain").setIcon("help-circle").onClick(()=>{var l;this.plugin.handleContinueWriting("Explain this text",[],null,null,(l=this.currentSelection)==null?void 0:l.text,"chat"),this.hide()})}),r.showAtPosition({x:s.pageX,y:s.pageY})}});this.el.appendChild(t),this.el.appendChild(e),this.el.appendChild(n),this.el.appendChild(i)}createButton(t,e,n){let i=document.createElement("button");return i.addClass("markdown-next-ai-toolbar-btn"),i.setAttribute("aria-label",t),(0,fe.setIcon)(i,e),i.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),n(s)}),i}show(t){this.currentSelection=t,this.isVisible=!0;let e=t.rect;this.el.style.display="flex",setTimeout(()=>{let n=this.el.getBoundingClientRect(),i=n.width||140,s=n.height||36,r=e.top-s-8,a=e.left+e.width/2-i/2;r<0&&(r=e.bottom+8),a<10&&(a=10),a+i>window.innerWidth&&(a=window.innerWidth-i-10),this.el.style.top=`${r}px`,this.el.style.left=`${a}px`},0)}hide(){this.isVisible=!1,this.el.style.display="none",this.currentSelection=null}destroy(){this.el.remove()}};var we=class extends O.Plugin{constructor(){super(...arguments);this.eventListeners=[];this.atTriggerTimeout=null;this.lastMouseUpPosition=null;this.lastActiveMarkdownView=null}async onload(){await this.loadSettings(),this.aiService=new J(this.settings,this.app),this.ruleManager=new Q(this),this.selectionToolbar=new ae(this.app,this),this.selectionManager=new re(this.app,e=>{e?this.selectionToolbar.show(e):this.selectionToolbar.hide()}),this.addSettingTab(new ge(this.app,this)),this.addCommands(),this.updateEventListeners(),this.setupLastActiveViewTracker(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u52A0\u8F7D")}onunload(){var e,n;(e=this.selectionManager)==null||e.destroy(),(n=this.selectionToolbar)==null||n.destroy(),this.cleanupEventListeners(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u5378\u8F7D")}async loadSettings(){let e=await this.loadData();if(this.settings=Object.assign({},B,e),e&&e.providers){this.settings.providers={...B.providers};for(let n in e.providers)this.settings.providers[n]={...B.providers[n]||{},...e.providers[n]}}if(e&&e.models){this.settings.models={...B.models};for(let n in e.models)typeof e.models[n]!="object"||e.models[n]===null||(this.settings.models[n]={...B.models[n]||{},...e.models[n]})}Array.isArray(this.settings.globalRules)||(this.settings.globalRules=[...B.globalRules]),Array.isArray(this.settings.commonPrompts)||(this.settings.commonPrompts=[...B.commonPrompts]),Array.isArray(this.settings.conversationHistory)||(this.settings.conversationHistory=[]),(!this.settings.conversationHistoryLimit||this.settings.conversationHistoryLimit<=0)&&(this.settings.conversationHistoryLimit=B.conversationHistoryLimit)}async saveSettings(){await this.saveData(this.settings),this.aiService&&this.aiService.updateSettings(this.settings)}getAvailableModels(){return Object.values(this.settings.models).filter(e=>e.enabled).map(e=>({id:e.id,name:e.name,provider:e.provider}))}addCommands(){this.addCommand({id:"open-ai-popup",name:"\u5524\u51FAAI\u5BF9\u8BDD\u6846",hotkeys:[{modifiers:["Alt"],key:"v"}],callback:()=>{try{let e=this.app.workspace.getActiveViewOfType(O.MarkdownView);if(!e||!e.editor)return this.showAtTriggerModalGlobal(""),!0;let n=e.editor.getSelection()||"";return this.showAtTriggerModal(n),!0}catch(e){return console.error("\u5524\u51FAAI\u5BF9\u8BDD\u6846\u547D\u4EE4\u6267\u884C\u9519\u8BEF:",e),new O.Notice("\u547D\u4EE4\u6267\u884C\u5931\u8D25"),!1}}}),this.addCommand({id:"open-ai-popup-global",name:"\u5524\u51FAAI\u5BF9\u8BDD\u6846\uFF08\u5168\u5C40\u6A21\u5F0F\uFF09",hotkeys:[{modifiers:["Ctrl","Shift"],key:"m"}],callback:()=>{var e;try{console.log("[markdown-next-ai] \u6267\u884C\u5168\u5C40\u5BF9\u8BDD\u6846\u547D\u4EE4");let n=((e=window.getSelection())==null?void 0:e.toString().trim())||"";return this.showAtTriggerModalGlobal(n),console.log("[markdown-next-ai] \u5168\u5C40\u5BF9\u8BDD\u6846\u5DF2\u6253\u5F00"),!0}catch(n){return console.error("\u5168\u5C40\u5BF9\u8BDD\u6846\u547D\u4EE4\u6267\u884C\u9519\u8BEF:",n),new O.Notice("\u547D\u4EE4\u6267\u884C\u5931\u8D25: "+String(n)),!1}}})}updateEventListeners(){this.cleanupEventListeners(),this.settings.enableAtTrigger&&this.setupAtTriggerListener(),this.setupPromptTriggerListener(),this.setupRightClickListener();let e=n=>{let i=window.getSelection();if(i&&i.rangeCount>0){let r=i.getRangeAt(0).getBoundingClientRect();(r.width>0||r.height>0)&&(this.lastMouseUpPosition={left:r.right,top:r.top,height:r.height||20})}};document.addEventListener("mouseup",e),this.eventListeners.push({element:document,event:"mouseup",handler:e})}setupLastActiveViewTracker(){this.registerEvent(this.app.workspace.on("active-leaf-change",e=>{(e==null?void 0:e.view)instanceof O.MarkdownView&&(this.lastActiveMarkdownView=e.view)}))}getLastActiveMarkdownView(){return this.getAnyMarkdownView()}getAnyMarkdownView(){let e=this.app.workspace.getActiveViewOfType(O.MarkdownView);if(e)return e;if(this.lastActiveMarkdownView)return this.lastActiveMarkdownView;let n=this.app.workspace.getMostRecentLeaf();if((n==null?void 0:n.view)instanceof O.MarkdownView)return n.view;let i=this.app.workspace.getLeavesOfType("markdown");return i.length>0&&i[0].view instanceof O.MarkdownView?i[0].view:null}setupRightClickListener(){this.registerEvent(this.app.workspace.on("editor-menu",(e,n,i)=>{let s=n.getSelection();s&&s.trim()&&e.addItem(r=>{r.setTitle("Markdown-Next-AI\uFF1A\u4FEE\u6539\u6240\u9009\u5185\u5BB9").setIcon("bot").onClick(()=>{this.showAtTriggerModal(s)})})})),this.settings.enableGlobalDialog&&document.addEventListener("contextmenu",e=>{var i;let n=((i=window.getSelection())==null?void 0:i.toString().trim())||"";n&&!this.isInEditor(e.target)&&this.showGlobalContextMenu(n,e)},!0)}isInEditor(e){return!!(e.closest(".cm-editor")||e.closest(".markdown-source-view")||e.closest(".markdown-preview-view"))}showGlobalContextMenu(e,n){let i=new O.Menu;i.addItem(s=>{s.setTitle("Markdown-Next-AI\uFF1A\u4FEE\u6539\u6240\u9009\u5185\u5BB9").setIcon("bot").onClick(()=>{this.showAtTriggerModalGlobal(e)})}),i.showAtPosition({x:n.clientX,y:n.clientY})}setupPromptTriggerListener(){}showPromptSelectorModal(e){new K(this.app,this,n=>{if(e.contentEditable==="true"){let i=window.getSelection();if(!i||!i.rangeCount)return;let s=i.getRangeAt(0),r=s.startContainer;if(r.nodeType===Node.TEXT_NODE){let a=r.textContent||"",l=s.startOffset,o=a.lastIndexOf("#",l-1);if(o!==-1){let c=a.substring(0,o)+n+a.substring(l);r.textContent=c;let d=o+n.length;try{let p=document.createRange();p.setStart(r,d),p.collapse(!0),i.removeAllRanges(),i.addRange(p)}catch(p){console.error("Failed to set cursor position",p)}}}}else{let i=e,s=i.selectionStart||0,r=i.value,a=r.substring(0,s),l=r.substring(s),o=a.lastIndexOf("#");if(o!==-1){let c=a.substring(0,o)+n;i.value=c+l,i.selectionStart=i.selectionEnd=c.length,i.focus()}}}).open(e)}setupAtTriggerListener(){let e=n=>{if(n.key==="@"||n.shiftKey&&n.key==="2"||n.key==="&"||n.shiftKey&&n.key==="7"){let i=document.activeElement;if(i&&(i.classList.contains("markdown-next-ai-modify-input")||i.classList.contains("markdown-next-ai-continue-input")))return;let s=this.app.workspace.getActiveViewOfType(O.MarkdownView);if(!s||!s.editor)return;this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.atTriggerTimeout=setTimeout(()=>{let r=s.editor.getCursor(),l=s.editor.getLine(r.line).substring(0,r.ch),o=l.charAt(l.length-1);(o==="@"||o==="&")&&!l.endsWith("@@")&&!l.endsWith("&&")&&(this.showAtTriggerModal(),this.atTriggerTimeout=null)},500)}};document.addEventListener("keydown",e),this.eventListeners.push({element:document,event:"keydown",handler:e})}cleanupEventListeners(){this.eventListeners&&(this.eventListeners.forEach(({element:e,event:n,handler:i})=>{e&&i&&(e===this.app.workspace&&typeof e.off=="function"?e.off(n,i):typeof e.removeEventListener=="function"&&e.removeEventListener(n,i))}),this.eventListeners=[])}showAtTriggerModal(e="",n="chat"){let i=this.app.workspace.getActiveViewOfType(O.MarkdownView),s=this.getCursorPosition(i)||this.lastMouseUpPosition||this.getFallbackPosition(i);if(!s){new O.Notice("\u672A\u627E\u5230\u53EF\u7528\u7684\u5149\u6807\u4F4D\u7F6E\uFF0C\u8BF7\u5148\u70B9\u51FB\u6587\u6863\u533A\u57DF");return}new Y(this.app,(r,a,l,o,c,d)=>{this.handleContinueWriting(r,a,l,o,c,d)},s,this,i,e,n).open()}showAtTriggerModalGlobal(e="",n="chat"){var r;console.log("[markdown-next-ai] \u8FDB\u5165 showAtTriggerModalGlobal");let i=this.getFallbackPosition(null);console.log("[markdown-next-ai] fallbackPos:",i);let s=e||((r=window.getSelection())==null?void 0:r.toString().trim())||"";console.log("[markdown-next-ai] \u6B63\u5728\u521B\u5EFA AtTriggerPopup (\u5168\u5C40\u6A21\u5F0F\uFF0C\u65E0\u9700\u7F16\u8F91\u5668)"),new Y(this.app,(a,l,o,c,d,p)=>{let u=d||s;this.settings.useFloatingPreview?this.handleContinueWritingGlobal(a,l,o,c,u,p):this.handleContinueWriting(a,l,o,c,u,p)},i,this,null,s,n).open(),console.log("[markdown-next-ai] AtTriggerPopup \u5DF2\u6253\u5F00")}getCursorPosition(e=null){var s;let n=e!=null?e:this.getAnyMarkdownView(),i=n==null?void 0:n.editor;if(i!=null&&i.somethingSelected()){let r=i.getCursor("from"),a=i.coordsAtPos(r),l=i.getCursor("to"),o=i.coordsAtPos(l);if(a&&o)return{left:a.left,top:o.top,height:o.bottom-o.top}}try{let r=n==null?void 0:n.containerEl.querySelector(".cm-editor"),a=i==null?void 0:i.getCursor(),l=a?i.coordsAtPos(a):null;if(l)return{left:l.left,top:l.top,height:l.bottom-l.top};let o=window.getSelection();if(o&&o.rangeCount>0){let u=o.getRangeAt(0).getBoundingClientRect();if(u.width>0||u.height>0)return{left:u.left,top:u.top,height:u.height||20}}if(this.lastMouseUpPosition)return{...this.lastMouseUpPosition};let c=r==null?void 0:r.getBoundingClientRect();if(c)return{left:c.left+50,top:c.top+50,height:20};let d=(s=n==null?void 0:n.containerEl)==null?void 0:s.getBoundingClientRect();return d?{left:d.left+d.width/2,top:d.top+d.height/3,height:20}:{left:window.innerWidth/2,top:window.innerHeight/3,height:20}}catch(r){return console.error("\u83B7\u53D6\u5149\u6807\u4F4D\u7F6E\u5931\u8D25:",r),null}}getFallbackPosition(e){if(e&&e.containerEl){let n=e.containerEl.getBoundingClientRect();return{left:n.left+n.width/2,top:n.top+n.height/3,height:20}}return{left:window.innerWidth/2,top:window.innerHeight/3,height:20}}async handleContinueWritingGlobal(e="",n=[],i=null,s=null,r="",a="chat"){var p;let l=this.getAnyMarkdownView();if(!e&&n.length===0&&!s&&!r){new O.Notice("\u8BF7\u8F93\u5165\u7EED\u5199\u8981\u6C42\u6216\u4E0A\u4F20\u56FE\u7247");return}let o="",c=this.getCursorPosition(l)||this.getFallbackPosition(l),d=new oe(this.app,l||null,i||this.settings.currentModel,c);d.open(),d.updateStatus("\u6B63\u5728\u601D\u8003\u4E2D");try{let u=l!=null&&l.editor?l.editor.getValue().substring(0,l.editor.posToOffset(l.editor.getCursor())):"",h=((p=l==null?void 0:l.editor)==null?void 0:p.getCursor())||{line:0,ch:0},f=await this.aiService.sendRequest(a,{selectedText:r,beforeText:u,afterText:"",cursorPosition:h,additionalContext:s||void 0},e,n,[],y=>{y.content!=null&&(o=y.content,d.updateContent(o),d.updateStatus(`\u6B63\u5728\u751F\u6210\u4E2D(${y.content.length}\u5B57)`)),y.isComplete&&(d.showActions(),d.renderMarkdown(o))});!o&&(f!=null&&f.content)&&(o=f.content,d.updateContent(o),d.showActions(),d.renderMarkdown(o)),d.setOnInsert(()=>{this.insertGeneratedContent(l||null,"insert",o,r),d.close()}),d.setOnReplace(()=>{this.insertGeneratedContent(l||null,"replace",o,r),d.close()}),d.setOnCopy(()=>{navigator.clipboard.writeText(o),new O.Notice("\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F")}),await this.recordConversation({prompt:e,response:o,modelId:i||this.settings.currentModel,selectedText:r,contextSnippet:s||void 0})}catch(u){d.showError(`\u751F\u6210\u5931\u8D25: ${u.message}`),console.error("\u5168\u5C40\u5BF9\u8BDD\u751F\u6210\u5931\u8D25",u)}}async insertGeneratedContent(e,n,i,s){if(!e||!e.editor){navigator.clipboard.writeText(i),new O.Notice("\u65E0\u53EF\u7528\u7F16\u8F91\u5668\uFF0C\u5185\u5BB9\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F");return}let r=e.editor,a=s.length>0&&n==="replace";try{if(a)r.replaceSelection(i);else{let l=r.getCursor();r.replaceRange(i,l)}new O.Notice("\u5185\u5BB9\u5DF2\u63D2\u5165"),this.settings.lastInsertAction=n,await this.saveSettings()}catch(l){new O.Notice(`\u63D2\u5165\u5931\u8D25: ${l.message}`),console.error("\u63D2\u5165\u5185\u5BB9\u5931\u8D25",l)}}async handleContinueWriting(e="",n=[],i=null,s=null,r="",a="chat"){if(this.settings.useFloatingPreview)return this.handleContinueWritingGlobal(e,n,i,s,r,a);let l=this.app.workspace.getActiveViewOfType(O.MarkdownView);if(!l||!l.editor){new O.Notice("\u8BF7\u5728Markdown\u7F16\u8F91\u5668\u4E2D\u4F7F\u7528\u6B64\u529F\u80FD");return}if(!e&&n.length===0&&!s&&!r){this.showAtTriggerModal("",a);return}let o=l.editor,c=o.getCursor(),d=o.getLine(c.line),p=c.ch>0?d.charAt(c.ch-1):"";if(p==="@"||p==="&"){let M={line:c.line,ch:c.ch-1},k={line:c.line,ch:c.ch};o.replaceRange("",M,k),c.ch=c.ch-1}let u=r.length>0,h=u?o.getCursor("from"):{line:c.line,ch:c.ch},f="markdown-next-ai-preview-"+Date.now(),y="markdown-next-ai-original-"+Date.now(),T=`<span style="background:#90EE90;" data-preview-id="${f}">`,A=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${y}">`,v="</span>";if(u){let M=`${A}${r}${v}${T}${v}`;o.replaceSelection(M)}else o.replaceRange(`${T}${v}`,h);let m;u?m=o.posToOffset(h)+A.length+r.length+v.length+T.length:m=o.posToOffset(h)+T.length;let x=0,$=!1,N="",F=o.coordsAtPos(h),I=F?{left:F.left,top:F.top}:null,H=new ie(this.app,o,l,()=>{let M=o.getValue(),k=`<span style="background:#90EE90;" data-preview-id="${f}">`,C=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${y}">`;if(u){let w=o.getValue(),E=w.indexOf(k);if(E!==-1){let b=E+k.length,L=w.indexOf(v,b);if(L!==-1){let D=L+v.length;o.replaceRange("",o.offsetToPos(L),o.offsetToPos(D)),o.replaceRange("",o.offsetToPos(E),o.offsetToPos(b))}}w=o.getValue();let S=w.indexOf(C);if(S!==-1){let b=S+C.length,L=w.indexOf(v,b);if(L!==-1){let D=L+v.length;o.replaceRange("",o.offsetToPos(S),o.offsetToPos(D)),o.setCursor(o.offsetToPos(S))}}}else{let w=M.indexOf(k);if(w!==-1){let E=w+k.length,S=M.indexOf(v,E);if(S!==-1){let b=S+v.length;o.replaceRange("",o.offsetToPos(S),o.offsetToPos(b)),o.replaceRange("",o.offsetToPos(w),o.offsetToPos(E));let L=S-k.length;o.setCursor(o.offsetToPos(L))}}}new O.Notice("\u5DF2\u66FF\u6362\u539F\u6587")},()=>{let M=o.getValue(),k=`<span style="background:#90EE90;" data-preview-id="${f}">`,C=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${y}">`;if(u){let w=o.getValue(),E=w.indexOf(k);if(E!==-1){let b=E+k.length,L=w.indexOf(v,b);if(L!==-1){let D=L+v.length;o.replaceRange("",o.offsetToPos(E),o.offsetToPos(D))}}w=o.getValue();let S=w.indexOf(C);if(S!==-1){let b=S+C.length,L=w.indexOf(v,b);if(L!==-1){let D=L+v.length;o.replaceRange("",o.offsetToPos(L),o.offsetToPos(D)),o.replaceRange("",o.offsetToPos(S),o.offsetToPos(b)),o.setCursor(o.offsetToPos(S))}}}else{let w=M.indexOf(k);if(w!==-1){let E=w+k.length,S=M.indexOf(v,E);if(S!==-1){let b=S+v.length;o.replaceRange("",o.offsetToPos(w),o.offsetToPos(b)),o.setCursor(o.offsetToPos(w))}}}new O.Notice("\u5DF2\u653E\u5F03\u751F\u6210")},u?()=>{let M=`<span style="background:#90EE90;" data-preview-id="${f}">`,k=`<span style="background:#FFF3E0;border-bottom: 2px solid #FFB74D;" data-original-id="${y}">`,C=o.getValue(),w=C.indexOf(M);if(w!==-1){let S=w+M.length,b=C.indexOf(v,S);if(b!==-1){let L=b+v.length;o.replaceRange("",o.offsetToPos(b),o.offsetToPos(L)),o.replaceRange("",o.offsetToPos(w),o.offsetToPos(S))}}C=o.getValue();let E=C.indexOf(k);if(E!==-1){let S=E+k.length,b=C.indexOf(v,S);if(b!==-1){let L=b+v.length;o.replaceRange("",o.offsetToPos(b),o.offsetToPos(L)),o.replaceRange("",o.offsetToPos(E),o.offsetToPos(S))}}new O.Notice("\u5DF2\u8FFD\u52A0\u5185\u5BB9")}:null);H.open(I);try{let M=await this.aiService.sendRequest(a,{selectedText:r,beforeText:o.getValue().substring(0,o.posToOffset(h)),afterText:"",cursorPosition:c,additionalContext:s||void 0},e,n,[],C=>{if(C.content!=null){let w=o.offsetToPos(m),E=o.offsetToPos(m+x);o.replaceRange(C.content,w,E),x=C.content.length,N=C.content;let S=o.offsetToPos(m+x);o.setCursor(S),$=!0,H.updateStatus(`\u6B63\u5728\u751F\u6210\u4E2D(${x}\u5B57)`)}if(C.isComplete){H.showActions();let w=o.offsetToPos(m+x),E=o.coordsAtPos(w);E&&H.positionAt(E.left,E.bottom,"below")}});if(!$&&M&&M.content){let C=o.offsetToPos(m),w=o.offsetToPos(m+x);o.replaceRange(M.content,C,w),x=M.content.length,N=M.content;let E=o.offsetToPos(m+x);o.setCursor(E),H.showActions();let S=o.offsetToPos(m+x),b=o.coordsAtPos(S);b&&H.positionAt(b.left,b.bottom,"below")}let k=N||M&&M.content||"";if(k.trim()){let C=s||"";await this.recordConversation({prompt:e,response:k,modelId:i||this.settings.currentModel,contextSnippet:C,selectedText:r})}}catch(M){let k=`<span style="background:#90EE90;" data-preview-id="${f}">`,C=`<span style="background:#FFCCCB;text-decoration:line-through;" data-original-id="${y}">`;if(u){let w=o.getValue(),E=w.indexOf(k);if(E!==-1){let b=E+k.length,L=w.indexOf(v,b);if(L!==-1){let D=L+v.length;o.replaceRange("",o.offsetToPos(E),o.offsetToPos(D))}}w=o.getValue();let S=w.indexOf(C);if(S!==-1){let b=S+C.length,L=w.indexOf(v,b);if(L!==-1){let D=L+v.length;o.replaceRange("",o.offsetToPos(L),o.offsetToPos(D)),o.replaceRange("",o.offsetToPos(S),o.offsetToPos(b))}}}else{let w=o.getValue(),E=w.indexOf(k);if(E!==-1){let S=E+k.length,b=w.indexOf(v,S);if(b!==-1){let L=b+v.length;o.replaceRange("",o.offsetToPos(E),o.offsetToPos(L))}}}o.setCursor(h),H.close(),new O.Notice("\u7EED\u5199\u5931\u8D25: "+M.message)}}async recordConversation(e){this.settings.conversationHistory||(this.settings.conversationHistory=[]);let n=this.settings.conversationHistoryLimit||B.conversationHistoryLimit||50,i=(e.contextSnippet||"").slice(0,4e3),s={id:`conv-${Date.now()}`,timestamp:Date.now(),...e,contextSnippet:i};this.settings.conversationHistory.push(s),this.settings.conversationHistory.length>n&&(this.settings.conversationHistory=this.settings.conversationHistory.slice(-n)),await this.saveSettings()}};
