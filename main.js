var z=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var et=Object.getOwnPropertyNames;var nt=Object.prototype.hasOwnProperty;var it=(L,e)=>{for(var t in e)z(L,t,{get:e[t],enumerable:!0})},st=(L,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of et(e))!nt.call(L,i)&&i!==t&&z(L,i,{get:()=>e[i],enumerable:!(n=tt(e,i))||n.enumerable});return L};var ot=L=>st(z({},"__esModule",{value:!0}),L);var lt={};it(lt,{default:()=>_});module.exports=ot(lt);var P=require("obsidian");var M={THINKING:"thinking",VISION:"vision",MULTIMODAL:"multimodal",TEXT:"text",IMAGE:"image"},Z={continue:"\u4F60\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u5199\u4F5C\u52A9\u624B\u3002\u8BF7\u6839\u636E\u7528\u6237\u63D0\u4F9B\u7684\u4E0A\u4E0B\u6587\uFF0C\u4ECE\u5149\u6807\u4F4D\u7F6E\u5F00\u59CB\u7EED\u5199\u540E\u7EED\u5185\u5BB9\u3002\u91CD\u8981\uFF1A\u53EA\u751F\u6210\u65B0\u7684\u5185\u5BB9\uFF0C\u4E0D\u8981\u91CD\u590D\u6216\u91CD\u5199\u5DF2\u6709\u7684\u5185\u5BB9\u3002"},V={IMAGE:["png","jpg","jpeg","gif","bmp","svg","webp"],DOCUMENT:["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"]},W={MAX_FILE_SIZE:10485760,ALLOWED_TYPES:["image/jpeg","image/png","image/gif","image/webp"]};var I={providers:{openai:{apiKey:"",baseUrl:"https://api.openai.com/v1",enabled:!0}},models:{"gemini-3-pro-preview":{id:"gemini-3-pro-preview",name:"Gemini 3 Pro Preview",provider:"openai",model:"gemini-3-pro-preview",enabled:!0,category:M.TEXT},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",name:"Gemini 3 Flash Preview",provider:"openai",model:"gemini-3-flash-preview",enabled:!0,category:M.TEXT},"gpt-5":{id:"gpt-5",name:"GPT-5",provider:"openai",model:"gpt-5",enabled:!0,category:M.TEXT}},currentModel:"gemini-3-flash-preview",timeout:3e4,enableRightClick:!0,enableAtTrigger:!0,maxTokens:5e3,maxContextLines:20,maxContextChars:3e3,globalRules:[],enableGlobalRules:!0,commonPrompts:[{id:"expand",name:"\u6269\u5C55\u5185\u5BB9",content:"\u8BF7\u6269\u5C55\u8FD9\u6BB5\u5185\u5BB9\uFF0C\u589E\u52A0\u66F4\u591A\u7EC6\u8282\u548C\u4F8B\u5B50"},{id:"summarize",name:"\u603B\u7ED3\u6982\u62EC",content:"\u8BF7\u603B\u7ED3\u8FD9\u6BB5\u5185\u5BB9\u7684\u8981\u70B9"},{id:"improve",name:"\u6539\u8FDB\u6587\u672C",content:"\u8BF7\u6539\u8FDB\u8FD9\u6BB5\u6587\u672C\u7684\u8868\u8FBE\u548C\u903B\u8F91"},{id:"translate",name:"\u7FFB\u8BD1",content:"\u8BF7\u5C06\u8FD9\u6BB5\u5185\u5BB9\u7FFB\u8BD1\u6210\u82F1\u6587"},{id:"continue",name:"\u7EE7\u7EED\u5199\u4F5C",content:"\u8BF7\u6839\u636E\u4E0A\u4E0B\u6587\u7EE7\u7EED\u5199\u4F5C\uFF0C\u4FDD\u6301\u98CE\u683C\u4E00\u81F4"}]};var N=require("obsidian");var D=class{constructor(e,t){this.requestQueue=[];this.isProcessing=!1;this.settings=e,this.app=t}updateSettings(e){this.settings=e}getCurrentModelConfig(){if(this.settings.apiKey&&this.settings.baseUrl&&this.settings.model)return{apiKey:this.settings.apiKey,baseUrl:this.settings.baseUrl,model:this.settings.model};let e=this.settings.currentModel;if(!e)throw new Error("\u672A\u9009\u62E9\u5F53\u524D\u6A21\u578B");let t=this.settings.models[e];if(!t||!t.enabled)throw new Error(`\u6A21\u578B ${e} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);let n=this.settings.providers[t.provider];if(!n||!n.enabled)throw new Error(`\u4F9B\u5E94\u5546 ${t.provider} \u672A\u542F\u7528\u6216\u4E0D\u5B58\u5728`);return{apiKey:n.apiKey,baseUrl:n.baseUrl,model:t.actualModel||t.model||t.id}}isVisionModel(e){let t=this.settings.currentModel,n=this.settings.models[t];if(!n)return!1;let i=n.category;return!i&&n.type&&(i=n.type==="image"?M.IMAGE:M.TEXT),i===M.VISION}isThinkingModel(e=null){let t=this.settings.currentModel,n=this.settings.models[t];if(!n)return!1;let i=n.category;return!i&&n.type&&(i=n.type==="image"?M.IMAGE:M.TEXT),i===M.THINKING}normalizeBaseUrl(e){return e?e.replace(/\/$/,""):""}buildApiUrl(e){let t=this.getCurrentModelConfig(),n=this.normalizeBaseUrl(t.baseUrl),i=n.includes("api.openai.com");return n.endsWith("/v1")?`${n}${e}`:!i&&(n.includes("/chat/completions")||n.includes("/images/generations"))?`${n.split("/chat/completions")[0].split("/images/generations")[0]}${e}`:`${n}/v1${e}`}getMaxTokens(e){return this.settings.maxTokens||I.maxTokens}async sendRequest(e,t,n="",i=[],o=[],a=null){let s=this.getCurrentModelConfig();if(!s.apiKey)throw new Error("\u8BF7\u5148\u914D\u7F6EAPI Key");let r=this.settings.currentModel,c=this.settings.models[r],l=c==null?void 0:c.category;if(!l&&c&&(c.type==="image"?l=M.IMAGE:l=M.TEXT,c.category=l),l===M.IMAGE){if(e==="continue"&&t.selectedText&&t.selectedText.trim())throw new Error("AI\u539F\u6587\u4FEE\u6539\u6A21\u5F0F\u4E0D\u652F\u6301\u56FE\u7247\u751F\u6210\u6A21\u578B\uFF0C\u8BF7\u9009\u62E9\u6587\u672C\u751F\u6210\u6A21\u578B\u8FDB\u884C\u6587\u672C\u4FEE\u6539\u3002");return this.handleImageGeneration(n,s,t.cursorPosition)}let d=l===M.THINKING||this.isThinkingModel(s.model),p=a&&typeof a=="function",g=l===M.MULTIMODAL,w=l===M.VISION||this.isVisionModel(s.model);i&&i.length>0&&!(g||w)&&(new N.Notice(`\u5F53\u524D\u6A21\u578B ${s.model} \u4E0D\u652F\u6301\u56FE\u7247\u548C\u9644\u4EF6\uFF0C\u8BF7\u5207\u6362\u5230\u591A\u6A21\u6001\u6A21\u578B\u6216\u89C6\u89C9\u6A21\u578B`),i=[]);let h=Z[e]||"";if(this.settings.enableGlobalRules&&this.settings.globalRules&&this.settings.globalRules.length>0){let u=this.settings.globalRules.filter(f=>f.enabled!==!1).sort((f,b)=>(b.priority||0)-(f.priority||0));if(u.length>0){let f=u.map(b=>b.content).join(`
`);h+=`

\u5168\u5C40\u89C4\u5219\uFF08\u8BF7\u4E25\u683C\u9075\u5FAA\u4EE5\u4E0B\u89C4\u5219\uFF09\uFF1A
`+f}}let m="";e==="continue"?t.selectedText&&t.selectedText.trim()?m=`\u9700\u8981\u4FEE\u6539\u7684\u5B8C\u6574\u5185\u5BB9\uFF1A${t.selectedText}

\u4FEE\u6539\u8981\u6C42\uFF1A${n}`:m=`\u4EE5\u4E0B\u662F\u5149\u6807\u524D\u7684\u4E0A\u4E0B\u6587\u5185\u5BB9\uFF1A
${t.beforeText}

\u8BF7\u4ECE\u5149\u6807\u4F4D\u7F6E\u5F00\u59CB\u7EED\u5199\uFF0C\u53EA\u751F\u6210\u65B0\u5185\u5BB9\uFF0C\u4E0D\u8981\u91CD\u590D\u4E0A\u8FF0\u5185\u5BB9\u3002\u7EED\u5199\u8981\u6C42\uFF1A${n}`:(m=`\u4E0A\u4E0B\u6587\uFF1A${t.beforeText}

\u9009\u4E2D\u6587\u672C\uFF1A${t.selectedText}

\u540E\u7EED\u5185\u5BB9\uFF1A${t.afterText}`,n&&(m+=`

\u7279\u6B8A\u8981\u6C42\uFF1A${n}`)),t.additionalContext&&t.additionalContext.trim()&&(m+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u5FC5\u987B\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${t.additionalContext}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`),t.contextContent&&t.contextContent.trim()&&(m+=`

\u3010\u91CD\u8981\u63D0\u793A\uFF1A\u4EE5\u4E0B\u662F\u5FC5\u987B\u53C2\u8003\u7684\u6587\u6863\u5185\u5BB9\uFF0C\u8BF7\u52A1\u5FC5\u57FA\u4E8E\u8FD9\u4E9B\u5185\u5BB9\u8FDB\u884C\u56DE\u590D\uFF0C\u4E0D\u5F97\u5FFD\u7565\u3011

=== \u5FC5\u8BFB\u53C2\u8003\u6587\u6863 ===
${t.contextContent}
=== \u53C2\u8003\u6587\u6863\u7ED3\u675F ===

\u3010\u8BF7\u786E\u4FDD\u4F60\u7684\u56DE\u590D\u5B8C\u5168\u57FA\u4E8E\u4E0A\u8FF0\u6587\u6863\u5185\u5BB9\uFF0C\u5FC5\u987B\u5F15\u7528\u548C\u4F7F\u7528\u6587\u6863\u4E2D\u7684\u4FE1\u606F\u3011`);let v=this.buildApiUrl("/chat/completions"),y=[{role:"system",content:h}];if(o&&o.length>0&&o.forEach(u=>{(u.role==="user"||u.role==="assistant")&&y.push({role:u.role,content:u.content})}),i&&i.length>0){m+=`

\u9644\u52A0\u56FE\u7247\uFF1A\u5171${i.length}\u5F20\u56FE\u7247`;let u=[{type:"text",text:m}];i.forEach(f=>{u.push({type:"image_url",image_url:{url:f.base64||f.url}})}),y.push({role:"user",content:u})}else y.push({role:"user",content:m});let T={model:s.model,messages:y,temperature:.7,max_tokens:this.getMaxTokens(e)};p&&(T.stream=!0);try{let u={"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`};if(p)return await this.handleStreamRequest(v,u,T,a);let f=await(0,N.requestUrl)({url:v,method:"POST",headers:u,body:JSON.stringify(T),throw:!1});if(f.status!==200){let S=f.text;throw f.status===429?S.includes("quota")||S.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${f.status} ${S}`)}let b=f.json;if(!b.choices||b.choices.length===0)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11choices\u6570\u7EC4");let E=b.choices[0];if(!E.message)throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u7F3A\u5C11message\u5BF9\u8C61");let C="";if(E.message.content)C=E.message.content.trim();else if(E.text)C=E.text.trim();else if(E.message.text)C=E.message.text.trim();else throw new Error("API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF1A\u627E\u4E0D\u5230\u5185\u5BB9\u5B57\u6BB5");let k=b.usage||{};return{content:C,usage:k}}catch(u){throw u}}async handleStreamRequest(e,t,n,i){var o,a;try{let s=await fetch(e,{method:"POST",headers:t,body:JSON.stringify(n)});if(!s.ok){let w=await s.text();throw s.status===429?w.includes("quota")||w.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):new Error(`API\u8BF7\u6C42\u5931\u8D25: ${s.status} ${w}`)}let r=s.body.getReader(),c=new TextDecoder,l="",d="",p="",g="";try{for(;;){let{done:w,value:h}=await r.read();if(w)break;l+=c.decode(h,{stream:!0});let m=l.split(`
`);l=m.pop()||"";for(let v of m)if(v.startsWith("data: ")){let y=v.slice(6);if(y==="[DONE]")break;try{let u=(a=(o=JSON.parse(y).choices)==null?void 0:o[0])==null?void 0:a.delta;if(u!=null&&u.reasoning_content){let f=u.reasoning_content;d+=f,g+=f,i({content:p,thinking:d,fullContent:g,isComplete:!1})}if(u!=null&&u.content){let f=u.content;p+=f,g+=f,i({content:p,thinking:d,fullContent:g,isComplete:!1})}if(u!=null&&u.text){let f=u.text;p+=f,g+=f,i({content:p,thinking:d,fullContent:g,isComplete:!1})}}catch(T){}}}return i({content:p,thinking:d,fullContent:g,isComplete:!0}),{content:p.trim(),thinking:d.trim(),usage:{}}}finally{r.releaseLock()}}catch(s){throw s}}async handleImageGeneration(e,t,n=null){if(!e||!e.trim())throw new Error("\u8BF7\u8F93\u5165\u56FE\u7247\u63CF\u8FF0");let i=this.buildApiUrl("/images/generations"),o=t.model,a={model:o,prompt:e.trim(),response_format:"b64_json",n:1,size:this.settings.imageGenerationSize||"1024x1024"};o.includes("dall-e")&&o==="dall-e-3"&&(a.quality="standard",a.style="vivid");try{let s=await(0,N.requestUrl)({url:i,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify(a),throw:!1});if(s.status!==200){let d=s.text;throw s.status===429?d.includes("quota")||d.includes("insufficient_quota")?new Error("API\u914D\u989D\u5DF2\u7528\u5B8C\uFF0C\u8BF7\u68C0\u67E5\u60A8\u7684\u8D26\u6237\u4F59\u989D\u548C\u8BA1\u8D39\u8BE6\u60C5\u3002"):new Error("API\u8BF7\u6C42\u9891\u7387\u8FC7\u9AD8\uFF0C\u8BF7\u7A0D\u540E\u518D\u8BD5\u3002"):s.status===401?new Error("API\u5BC6\u94A5\u65E0\u6548\uFF0C\u8BF7\u68C0\u67E5\u914D\u7F6E\u3002"):new Error(`\u56FE\u7247\u751F\u6210API\u8BF7\u6C42\u5931\u8D25: ${s.status} ${d}`)}let r=s.json;if(!r.data||!Array.isArray(r.data)||r.data.length===0)throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u683C\u5F0F\u9519\u8BEF");let c=r.data[0],l=null;if(c.b64_json)l=c.b64_json;else throw new Error("\u56FE\u7247\u751F\u6210API\u8FD4\u56DE\u6570\u636E\u4E2D\u7F3A\u5C11\u56FE\u7247\u5185\u5BB9");try{let d=`image_${Date.now()}.png`,p=this.settings.imageSavePath||"Extras/\u9644\u4EF6",g=p+"/"+d;try{this.app.vault.getAbstractFileByPath(p)||await this.app.vault.createFolder(p)}catch(T){try{await this.app.vault.adapter.mkdir(p)}catch(u){throw new Error(`\u65E0\u6CD5\u521B\u5EFA\u76EE\u5F55 ${p}: ${u.message}`)}}let w=atob(l||""),h=new Uint8Array(w.length);for(let T=0;T<w.length;T++)h[T]=w.charCodeAt(T);await this.app.vault.createBinary(g,h.buffer);let m=this.settings.imageSize||300,v=!0;n&&n.ch>0&&(v=!1);let y;return v?y=`![Generated Image|${m}](${g})`:y=`<span class="image-mask-rounded-R" style="width: 200px; height: 200px;"><img src="${g}" alt="" style="width: 100%; height: 100%; object-fit: cover;"></span>`,{content:y,imageData:{filePath:g,format:"png",prompt:e},usage:r.usage||{}}}catch(d){throw new Error("\u56FE\u7247\u4FDD\u5B58\u5931\u8D25: "+d.message)}}catch(s){throw s}}getAvailableImageModels(){let e=[];for(let[t,n]of Object.entries(this.settings.models))n.type==="image"&&n.enabled&&e.push(n.name||t);return e}async testConnection(){try{let e=this.getCurrentModelConfig(),t=this.buildApiUrl("/chat/completions"),n=await(0,N.requestUrl)({url:t,method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.model,messages:[{role:"user",content:"hi"}],max_tokens:5})});return n.status===200?{success:!0}:{success:!1,message:`HTTP ${n.status}: ${n.text}`}}catch(e){return{success:!1,message:e.message}}}};var U=require("obsidian");var R=class{constructor(){this.images=[];this.maxFileSize=W.MAX_FILE_SIZE;this.allowedTypes=W.ALLOWED_TYPES}handlePaste(e,t){var i;let n=(i=e.clipboardData)==null?void 0:i.items;if(n)for(let o=0;o<n.length;o++){let a=n[o];if(a.type.indexOf("image")!==-1){e.preventDefault();let s=a.getAsFile();s&&this.processImageFile(s,t);break}}}handleFileSelect(e,t){for(let n of Array.from(e))this.allowedTypes.includes(n.type)?this.processImageFile(n,t):new U.Notice("\u4E0D\u652F\u6301\u7684\u6587\u4EF6\u7C7B\u578B: "+n.type)}processImageFile(e,t){if(e.size>this.maxFileSize){new U.Notice("\u56FE\u7247\u6587\u4EF6\u8FC7\u5927\uFF0C\u8BF7\u9009\u62E9\u5C0F\u4E8E10MB\u7684\u56FE\u7247");return}let n=new FileReader;n.onload=i=>{var s;let o=(s=i.target)==null?void 0:s.result,a={id:String(Date.now()+Math.random()),name:e.name,size:e.size,type:e.type,base64:o,url:o};this.images.push(a),t&&t(a)},n.onerror=()=>{new U.Notice("\u8BFB\u53D6\u56FE\u7247\u5931\u8D25")},n.readAsDataURL(e)}removeImage(e,t){this.images=this.images.filter(n=>n.id!==e),t&&t(e)}getImages(){return this.images}addImage(e){this.images.push(e)}clearImages(){this.images=[]}createImagePreview(e,t){let n=document.createElement("div");n.className="markdown-next-ai-image-preview",n.setAttribute("data-image-id",String(e.id)),n.innerHTML=`
            <div class="markdown-next-ai-image-container">
                <img src="${e.url}" alt="${e.name}" class="markdown-next-ai-preview-img">
                <button class="markdown-next-ai-remove-image" title="\u5220\u9664\u56FE\u7247">\u2715</button>
            </div>
            <div class="markdown-next-ai-image-info">
                <span class="markdown-next-ai-image-name">${e.name}</span>
                <span class="markdown-next-ai-image-size">${this.formatFileSize(e.size)}</span>
            </div>
        `;let i=n.querySelector(".markdown-next-ai-remove-image");return i.onclick=o=>{o.stopPropagation(),this.removeImage(String(e.id),()=>{t&&t()}),n.remove()},n}formatFileSize(e){if(e===0)return"0 Bytes";let t=1024,n=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,i)).toFixed(2))+" "+n[i]}};var x=require("obsidian");var K=class extends x.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"MarkdownNext AI \u8BBE\u7F6E"}),e.createEl("h3",{text:"\u4F9B\u5E94\u5546\u3001API\u8BBE\u7F6E"}),e.createEl("p",{text:"APIKey\uFF1A\u9700\u5728\u4F9B\u5E94\u5546API\u5BC6\u94A5\u4E2D\u8BBE\u7F6EAPIKey",attr:{style:"color: var(--text-muted); margin-bottom: 5px;"}}),e.createEl("p",{text:"Base URL\uFF1A\u9009\u586B\u7B2C\u4E09\u65B9URL\uFF0C\u4F7F\u7528openai\u517C\u5BB9\u683C\u5F0F",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}});let t=e.createEl("table",{cls:"markdown-next-ai-config-table"}),n=t.createEl("thead").createEl("tr");n.createEl("th",{text:"ID"}),n.createEl("th",{text:"Type"}),n.createEl("th",{text:"API Key"}),n.createEl("th",{text:"Get API keys"}),n.createEl("th",{text:"Actions"});let i=t.createEl("tbody");Object.keys(this.plugin.settings.providers).forEach(l=>{let d=this.plugin.settings.providers[l],p=i.createEl("tr");p.createEl("td",{text:l}),p.createEl("td",{text:d.type||"openai"});let g=p.createEl("td",{cls:"markdown-next-ai-api-key-cell"});d.apiKey&&d.apiKey.trim()&&g.createEl("span",{text:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",attr:{style:"color: var(--text-muted); margin-right: 8px;"}});let w=g.createEl("button",{cls:"markdown-next-ai-settings-btn",attr:{title:"\u8BBE\u7F6EAPI Key"}});w.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',w.onclick=()=>this.showApiKeyModal(l);let h=p.createEl("td",{attr:{style:"text-align: left;"}}),v={openai:"https://platform.openai.com/api-keys",anthropic:"https://console.anthropic.com/",gemini:"https://aistudio.google.com/app/apikey",ollama:"https://ollama.com/"}[l]||this.plugin.settings.apiKeyLinks&&this.plugin.settings.apiKeyLinks[l];v?h.createEl("a",{text:"\u83B7\u53D6API Key",attr:{href:v,target:"_blank",style:"color: var(--text-accent); text-decoration: underline; font-size: 0.9em;"}}):h.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});let y=p.createEl("td",{cls:"markdown-next-ai-actions-cell"});if(["openai","anthropic","gemini","deepseek","ollama"].includes(l))y.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}});else{let T=y.createEl("button",{text:"\u7F16\u8F91"});T.onclick=()=>this.showEditProviderModal(l);let u=y.createEl("button",{text:"\u5220\u9664"});u.onclick=async()=>{confirm(`\u786E\u5B9A\u8981\u5220\u9664\u4F9B\u5E94\u5546 "${l}" \uFF1F\u8FD9\u5C06\u540C\u65F6\u5220\u9664\u8BE5\u4F9B\u5E94\u5546\u4E0B\u7684\u6240\u6709\u6A21\u578B\u3002`)&&(Object.keys(this.plugin.settings.models).forEach(f=>{this.plugin.settings.models[f].provider===l&&delete this.plugin.settings.models[f]}),delete this.plugin.settings.providers[l],await this.plugin.saveSettings(),this.display())}}}),e.createEl("div",{attr:{style:"margin-top: 15px; margin-bottom: 20px;"}}).createEl("button",{text:"+ \u6DFB\u52A0\u4F9B\u5E94\u5546",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;"}}).onclick=()=>this.showAddProviderModal();let o=e.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px;"}});o.createEl("h3",{text:"\u6A21\u578B\u8BBE\u7F6E",attr:{style:"margin: 0;"}}),o.createEl("button",{text:"+ \u6DFB\u52A0\u6A21\u578B",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;"}}).onclick=()=>this.showAddModelModal();let a=e.createEl("table",{cls:"markdown-next-ai-config-table"}),s=a.createEl("thead").createEl("tr");s.createEl("th",{text:"ID"}),s.createEl("th",{text:"Provider"}),s.createEl("th",{text:"Model"}),s.createEl("th",{text:"Enable"}),s.createEl("th",{text:"Actions"});let r=a.createEl("tbody"),c=Object.keys(this.plugin.settings.models).map(l=>({id:l,...this.plugin.settings.models[l]}));if(c.length>0?c.forEach(l=>{let d=r.createEl("tr");d.createEl("td",{text:l.id}),d.createEl("td",{text:l.provider}),d.createEl("td",{text:l.name});let g=d.createEl("td",{cls:"markdown-next-ai-enable-cell"}).createEl("input",{type:"checkbox"});g.checked=l.enabled,g.onchange=async()=>{if(this.plugin.settings.models[l.id].enabled=g.checked,await this.plugin.saveSettings(),!g.checked&&this.plugin.settings.currentModel===l.id){let v=Object.keys(this.plugin.settings.models).find(y=>this.plugin.settings.models[y].enabled);v&&(this.plugin.settings.currentModel=v,await this.plugin.saveSettings(),this.display())}};let w=d.createEl("td",{cls:"markdown-next-ai-actions-cell"}),h=w.createEl("button",{text:"\u7F16\u8F91"});h.onclick=()=>this.showEditModelModal(l.id);let m=w.createEl("button",{text:"\u5220\u9664"});m.onclick=async()=>{if(confirm(`\u786E\u5B9A\u8981\u5220\u9664\u6A21\u578B "${l.name}" \uFF1F`)){if(this.plugin.settings.currentModel===l.id){let v=Object.keys(this.plugin.settings.models).find(y=>y!==l.id&&this.plugin.settings.models[y].enabled);this.plugin.settings.currentModel=v||""}delete this.plugin.settings.models[l.id],await this.plugin.saveSettings(),this.display()}}}):r.createEl("tr").createEl("td",{text:"\u6682\u65E0\u6A21\u578B\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{colspan:"5",style:"text-align: center; color: var(--text-muted); font-style: italic; padding: 20px;"}}),new x.Setting(e).setName("\u5F53\u524D\u6A21\u578B").setDesc("\u9009\u62E9\u5F53\u524D\u4F7F\u7528\u7684AI\u6A21\u578B").addDropdown(l=>{let d=Object.keys(this.plugin.settings.models).filter(p=>this.plugin.settings.models[p].enabled);d.forEach(p=>{let g=this.plugin.settings.models[p];l.addOption(p,`${g.name} (${g.provider})`)}),!d.includes(this.plugin.settings.currentModel)&&d.length>0&&(this.plugin.settings.currentModel=d[0],this.plugin.saveSettings()),l.setValue(this.plugin.settings.currentModel||"").onChange(async p=>{this.plugin.settings.currentModel=p,await this.plugin.saveSettings()})}),new x.Setting(e).setName("\u6D4B\u8BD5API\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u5F53\u524DAPI\u914D\u7F6E\u662F\u5426\u6B63\u5E38").addButton(l=>l.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(async()=>{l.setButtonText("\u6D4B\u8BD5\u4E2D...");try{let d=await this.plugin.aiService.testConnection();d.success?new x.Notice("\u2705 API\u8FDE\u63A5\u6210\u529F"):new x.Notice("\u274C API\u8FDE\u63A5\u5931\u8D25: "+d.message)}catch(d){new x.Notice("\u274C \u6D4B\u8BD5\u5931\u8D25: "+d.message)}finally{l.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5")}})),new x.Setting(e).setName("\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4").setDesc("API\u8BF7\u6C42\u8D85\u65F6\u65F6\u95F4\uFF08\u6BEB\u79D2\uFF09").addText(l=>l.setPlaceholder("30000").setValue(String(this.plugin.settings.timeout)).onChange(async d=>{let p=parseInt(d)||3e4;this.plugin.settings.timeout=p,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\u529F\u80FD\u8BBE\u7F6E"}),new x.Setting(e).setName("\u542F\u7528\u53F3\u952E\u83DC\u5355").setDesc("\u5728\u9009\u4E2D\u6587\u672C\u65F6\u663E\u793AAI\u5904\u7406\u9009\u9879").addToggle(l=>l.setValue(this.plugin.settings.enableRightClick).onChange(async d=>{this.plugin.settings.enableRightClick=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new x.Setting(e).setName("\u542F\u7528@\u6216&\u7B26\u53F7\u89E6\u53D1").setDesc("\u8F93\u5165@\u6216&\u7B26\u53F7\u65F6\u547C\u51FA\u7EED\u5199\u5BF9\u8BDD\u6846").addToggle(l=>l.setValue(this.plugin.settings.enableAtTrigger).onChange(async d=>{this.plugin.settings.enableAtTrigger=d,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new x.Setting(e).setName("\u6700\u5927Token\u6570").setDesc("AI\u751F\u6210\u6587\u672C\u7684\u6700\u5927\u957F\u5EA6\u9650\u5236").addText(l=>l.setPlaceholder("5000").setValue(String(this.plugin.settings.maxTokens)).onChange(async d=>{let p=parseInt(d)||5e3;p>0?(this.plugin.settings.maxTokens=p,await this.plugin.saveSettings()):new x.Notice("Token\u6570\u5FC5\u987B\u4E3A\u6B63\u6574\u6570")})),e.createEl("h3",{text:"\u5E38\u7528\u63D0\u793A\u8BCD\u7BA1\u7406"}),e.createEl("p",{text:"\u7BA1\u7406\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u53EF\u5728\u8F93\u5165\u6846\u4E2D\u4F7F\u7528#\u7B26\u53F7\u5FEB\u901F\u8C03\u7528",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new x.Setting(e).setName("\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD").setDesc("\u521B\u5EFA\u4E00\u4E2A\u65B0\u7684\u5E38\u7528\u63D0\u793A\u8BCD").addButton(l=>l.setButtonText("\u6DFB\u52A0\u63D0\u793A\u8BCD").onClick(()=>this.showPromptModal())),this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts.length>0){let l=e.createEl("div",{attr:{style:"margin-top: 15px;"}});this.plugin.settings.commonPrompts.forEach((d,p)=>{let g=l.createEl("div",{attr:{style:"display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary);"}}),w=g.createEl("div",{attr:{style:"flex: 1;"}});w.createEl("div",{text:d.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD",attr:{style:"font-weight: bold; margin-bottom: 4px;"}}),w.createEl("div",{text:d.content&&d.content.length>100?d.content.substring(0,100)+"...":d.content||"",attr:{style:"color: var(--text-muted); font-size: 0.7em;"}});let h=g.createEl("div",{attr:{style:"display: flex; gap: 8px;"}});h.createEl("button",{text:"\u7F16\u8F91",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--background-modifier-border); background: var(--background-primary); color: var(--text-normal); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.showPromptModal(p),h.createEl("button",{text:"\u5220\u9664",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--text-error); background: var(--background-primary); color: var(--text-error); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.deletePrompt(p)})}else e.createEl("p",{text:"\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD\uFF0C\u70B9\u51FB\u4E0A\u65B9\u6309\u94AE\u6DFB\u52A0",attr:{style:"color: var(--text-muted); font-style: italic; margin-top: 15px;"}})}showPromptModal(e=null){let t=new x.Modal(this.app);t.titleEl.setText(e!==null?"\u7F16\u8F91\u63D0\u793A\u8BCD":"\u6DFB\u52A0\u65B0\u63D0\u793A\u8BCD");let{contentEl:n}=t,i=e!==null,o=i&&this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]?this.plugin.settings.commonPrompts[e]:null;n.createEl("label",{text:"\u63D0\u793A\u8BCD\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("input",{type:"text",placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});i&&o&&(a.value=o.name),n.createEl("label",{text:"\u63D0\u793A\u8BCD\u5185\u5BB9:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("textarea",{placeholder:"\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9",attr:{style:"width: 100%; height: 120px; padding: 8px; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px; resize: vertical; font-family: var(--font-text);"}});i&&o&&(s.value=o.content);let r=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}});r.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>t.close();let c=r.createEl("button",{text:i?"\u66F4\u65B0":"\u6DFB\u52A0",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),l=async()=>{let p=a.value.trim(),g=s.value.trim();if(!p){new x.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u540D\u79F0");return}if(!g){new x.Notice("\u8BF7\u8F93\u5165\u63D0\u793A\u8BCD\u5185\u5BB9");return}if(this.plugin.settings.commonPrompts.findIndex((m,v)=>m.name===p&&v!==e)!==-1){new x.Notice("\u63D0\u793A\u8BCD\u540D\u79F0\u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6\u540D\u79F0");return}this.plugin.settings.commonPrompts||(this.plugin.settings.commonPrompts=[]);let h={id:i&&o?o.id:Date.now().toString(),name:p,content:g};i&&e!==null?(this.plugin.settings.commonPrompts[e]=h,new x.Notice("\u63D0\u793A\u8BCD\u5DF2\u66F4\u65B0")):(this.plugin.settings.commonPrompts.push(h),new x.Notice("\u63D0\u793A\u8BCD\u5DF2\u6DFB\u52A0")),await this.plugin.saveSettings(),t.close(),this.display()};c.onclick=l;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),l())};a.addEventListener("keydown",d),s.addEventListener("keydown",d),t.open(),a.focus()}async deletePrompt(e){if(this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]){let t=this.plugin.settings.commonPrompts[e],n=new x.Modal(this.app);n.titleEl.setText("\u786E\u8BA4\u5220\u9664");let{contentEl:i}=n;i.createEl("p",{text:`\u786E\u5B9A\u8981\u5220\u9664\u63D0\u793A\u8BCD "${t.name||"\u672A\u547D\u540D\u63D0\u793A\u8BCD"}" \u5417\uFF1F\u6B64\u64CD\u4F5C\u65E0\u6CD5\u64A4\u9500\u3002`,attr:{style:"margin-bottom: 20px;"}});let o=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}});o.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}}).onclick=()=>n.close(),o.createEl("button",{text:"\u5220\u9664",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=async()=>{this.plugin.settings.commonPrompts.splice(e,1),await this.plugin.saveSettings(),new x.Notice("\u63D0\u793A\u8BCD\u5DF2\u5220\u9664"),n.close(),this.display()},n.open()}}showApiKeyModal(e){let t=new x.Modal(this.app);t.titleEl.setText(`\u8BBE\u7F6E ${e.toUpperCase()} \u914D\u7F6E`);let{contentEl:n}=t,i=this.plugin.settings.providers[e];n.createEl("label",{text:"API Key:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"password",placeholder:"\u8BF7\u8F93\u5165API Key",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});o.value=(i==null?void 0:i.apiKey)||"",n.createEl("label",{text:"Base URL (\u53EF\u9009):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",value:(i==null?void 0:i.baseUrl)||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),s=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),r=s.createEl("button",{text:"\u53D6\u6D88",attr:{style:"padding: 6px 12px;"}});r.onclick=()=>t.close();let c=s.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}}),l=async()=>{this.plugin.settings.providers[e]||(this.plugin.settings.providers[e]={apiKey:"",baseUrl:"",enabled:!0}),this.plugin.settings.providers[e].apiKey=o.value.trim(),this.plugin.settings.providers[e].baseUrl=a.value.trim(),o.value.trim()&&(this.plugin.settings.providers[e].enabled=!0),await this.plugin.saveSettings(),new x.Notice(e.toUpperCase()+" \u914D\u7F6E\u5DF2\u4FDD\u5B58"),t.close(),this.display()};c.onclick=l;let d=p=>{p.key==="Enter"&&(p.ctrlKey||p.metaKey)&&(p.preventDefault(),l())};o.addEventListener("keydown",d),a.addEventListener("keydown",d),t.open(),o.focus()}showAddProviderModal(){let e=new x.Modal(this.app);e.titleEl.setText("\u6DFB\u52A0\u4F9B\u5E94\u5546");let{contentEl:t}=e;t.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let n=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: custom-provider",attr:{style:"width: 100%; margin-bottom: 15px;"}});t.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let i=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u81EA\u5B9A\u4E49\u4F9B\u5E94\u5546",attr:{style:"width: 100%; margin-bottom: 15px;"}});t.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=t.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(l=>{o.createEl("option",{value:l,text:l.toUpperCase()})}),t.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=t.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: https://api.example.com/v1",attr:{style:"width: 100%; margin-bottom: 15px;"}}),s=t.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),r=s.createEl("button",{text:"\u53D6\u6D88"});r.onclick=()=>e.close();let c=s.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});c.onclick=async()=>{let l=n.value.trim(),d=i.value.trim(),p=o.value,g=a.value.trim();if(!l||!d){new x.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.providers[l]){new x.Notice("\u4F9B\u5E94\u5546ID\u5DF2\u5B58\u5728");return}this.plugin.settings.providers[l]={name:d,type:p,enabled:!0,apiKey:"",baseUrl:g},await this.plugin.saveSettings(),new x.Notice("\u4F9B\u5E94\u5546\u5DF2\u6DFB\u52A0"),e.close(),this.display()},e.open(),n.focus()}showEditProviderModal(e){let t=new x.Modal(this.app);t.titleEl.setText("\u7F16\u8F91\u4F9B\u5E94\u5546");let{contentEl:n}=t,i=this.plugin.settings.providers[e];n.createEl("label",{text:"\u4F9B\u5E94\u5546ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:e,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",value:i.name||e,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u7C7B\u578B:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});["openai","anthropic","gemini","ollama"].forEach(d=>{let p=a.createEl("option",{value:d,text:d.toUpperCase()});d===i.type&&(p.selected=!0)}),n.createEl("label",{text:"\u9ED8\u8BA4Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let s=n.createEl("input",{type:"text",value:i.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px;"}}),r=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),c=r.createEl("button",{text:"\u53D6\u6D88"});c.onclick=()=>t.close();let l=r.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});l.onclick=async()=>{let d=o.value.trim(),p=a.value,g=s.value.trim();if(!d){new x.Notice("\u8BF7\u586B\u5199\u663E\u793A\u540D\u79F0");return}this.plugin.settings.providers[e]={...i,name:d,type:p,baseUrl:g},await this.plugin.saveSettings(),new x.Notice("\u4F9B\u5E94\u5546\u5DF2\u66F4\u65B0"),t.close(),this.display()},t.open(),o.focus()}showAddModelModal(e=M.TEXT){let t=new x.Modal(this.app);t.titleEl.setText("\u6DFB\u52A0\u65B0\u6A21\u578B");let{contentEl:n}=t;n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let i=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: gpt-4-turbo",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",placeholder:"\u4F8B\u5982: \u6211\u7684\u81EA\u5B9A\u4E49\u6A21\u578B",attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(l=>{a.createEl("option",{value:l,text:l.toUpperCase()})});let s=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),r=s.createEl("button",{text:"\u53D6\u6D88"});r.onclick=()=>t.close();let c=s.createEl("button",{text:"\u6DFB\u52A0",cls:"mod-cta"});c.onclick=async()=>{let l=i.value.trim(),d=o.value.trim(),p=a.value,g=e;if(!l||!d){new x.Notice("\u8BF7\u586B\u5199\u6240\u6709\u5FC5\u586B\u5B57\u6BB5");return}if(this.plugin.settings.models[l]){new x.Notice("\u6A21\u578B ID \u5DF2\u5B58\u5728\uFF0C\u8BF7\u4F7F\u7528\u5176\u4ED6 ID");return}this.plugin.settings.models[l]={id:l,name:d,provider:p,model:l,actualModel:l,enabled:!0,category:g},await this.plugin.saveSettings(),new x.Notice("\u6A21\u578B\u5DF2\u6DFB\u52A0"),t.close(),this.display()},t.open(),i.focus()}showEditModelModal(e){let t=new x.Modal(this.app);t.titleEl.setText("\u7F16\u8F91\u6A21\u578B");let{contentEl:n}=t,i=this.plugin.settings.models[e];n.createEl("label",{text:"\u6A21\u578B ID (API\u53C2\u6570):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),n.createEl("input",{type:"text",value:e,attr:{style:"width: 100%; margin-bottom: 15px;",disabled:"disabled"}}),n.createEl("label",{text:"\u663E\u793A\u540D\u79F0:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=n.createEl("input",{type:"text",value:i.name,attr:{style:"width: 100%; margin-bottom: 15px;"}});n.createEl("label",{text:"\u4F9B\u5E94\u5546:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let a=n.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px;"}});Object.keys(this.plugin.settings.providers).forEach(l=>{let d=a.createEl("option",{value:l,text:l.toUpperCase()});l===i.provider&&(d.selected=!0)});let s=n.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),r=s.createEl("button",{text:"\u53D6\u6D88"});r.onclick=()=>t.close();let c=s.createEl("button",{text:"\u4FDD\u5B58",cls:"mod-cta"});c.onclick=async()=>{let l=o.value.trim(),d=a.value;if(!l){new x.Notice("\u8BF7\u586B\u5199\u5FC5\u586B\u5B57\u6BB5");return}this.plugin.settings.models[e]={...i,name:l,provider:d,model:e,actualModel:e},await this.plugin.saveSettings(),new x.Notice("\u6A21\u578B\u5DF2\u66F4\u65B0"),t.close(),this.display()},t.open(),o.focus()}};var G=require("obsidian");var $=class{constructor(e,t,n){this.suggestionEl=null;this.isOpen=!1;this.selectedIndex=0;this.items=[];this.searchQuery="";this.atPosition=0;this.selectedTags=[];this.keydownHandler=null;this.app=e,this.inputEl=t,this.onSelect=n}convertToContentEditable(){if(this.inputEl.tagName==="TEXTAREA"){let e=document.createElement("div");e.className=this.inputEl.className+" markdown-next-ai-editable-input",e.contentEditable="true",e.setAttribute("data-placeholder",this.inputEl.placeholder),e.style.minHeight="80px",e.style.maxHeight="300px",e.style.overflowY="auto",e.textContent=this.inputEl.value,this.inputEl.parentNode.replaceChild(e,this.inputEl),this.inputEl=e,this.updatePlaceholder(),e.addEventListener("input",()=>this.updatePlaceholder())}}updatePlaceholder(){this.inputEl.textContent.trim()===""&&this.inputEl.querySelectorAll(".markdown-next-ai-inline-tag").length===0?this.inputEl.classList.add("empty"):this.inputEl.classList.remove("empty")}getTextContent(){let e="";return this.inputEl.childNodes.forEach(t=>{if(t.nodeType===Node.TEXT_NODE)e+=t.textContent;else if(t.classList&&t.classList.contains("markdown-next-ai-inline-tag")){let n=t.getAttribute("data-type"),i=t.getAttribute("data-path");e+=`@[${n}:${i}]`}}),e}getCursorPosition(){let e=window.getSelection();if(!e||!e.rangeCount)return 0;let t=e.getRangeAt(0),n=0,i=o=>{if(o===t.endContainer)return n+=t.endOffset,!0;if(o.nodeType===Node.TEXT_NODE)n+=o.textContent.length;else if(o.nodeType===Node.ELEMENT_NODE){if(o.classList&&o.classList.contains("markdown-next-ai-inline-tag")){let a=`@[${o.getAttribute("data-type")}:${o.getAttribute("data-path")}]`;n+=a.length}else for(let a of Array.from(o.childNodes))if(i(a))return!0}return!1};for(let o of Array.from(this.inputEl.childNodes))if(i(o))break;return n}setCursorPosition(e){let t=window.getSelection(),n=document.createRange(),i=0,o=!1,a=s=>{if(!o){if(s.nodeType===Node.TEXT_NODE){let r=s.textContent.length;i+r>=e?(n.setStart(s,e-i),n.collapse(!0),o=!0):i+=r}else if(s.nodeType===Node.ELEMENT_NODE){for(let r of Array.from(s.childNodes))if(a(r),o)return}}};a(this.inputEl),!o&&this.inputEl.lastChild&&(n.setStartAfter(this.inputEl.lastChild),n.collapse(!0)),t.removeAllRanges(),t.addRange(n)}show(e,t=""){if(this.atPosition=e,this.searchQuery=t,this.isOpen=!0,this.items=this.getAllItems(t),this.items.length===0){this.close();return}this.suggestionEl||(this.suggestionEl=document.createElement("div"),this.suggestionEl.className="markdown-next-ai-context-suggestions",this.suggestionEl.addEventListener("click",n=>n.stopPropagation()),this.suggestionEl.addEventListener("mousedown",n=>n.stopPropagation()),document.body.appendChild(this.suggestionEl)),this.render(),this.position(),this.bindKeyboardEvents()}getAllItems(e){let t=[],n=e.toLowerCase(),i=V.IMAGE,o=V.DOCUMENT;return this.app.vault.getFiles().forEach(s=>{let r=s.extension.toLowerCase(),c="file",l="\u{1F4C4}";if(r==="md")c="file",l="\u{1F4C4}";else if(i.includes(r))c="image",l="\u{1F5BC}\uFE0F";else if(o.includes(r))c="file",l=r==="pdf"?"\u{1F4D5}":["xlsx","xls","csv"].includes(r)?"\u{1F4CA}":["docx","doc","txt"].includes(r)?"\u{1F4DD}":["epub","mobi"].includes(r)?"\u{1F4DA}":r==="json"?"\u{1F4CB}":"\u{1F4C4}";else return;e&&!s.basename.toLowerCase().includes(n)&&!s.path.toLowerCase().includes(n)||t.push({type:c,name:s.basename,path:s.path,icon:l})}),this.app.vault.getAllLoadedFiles().filter(s=>s.children).forEach(s=>{e&&!s.name.toLowerCase().includes(n)&&!s.path.toLowerCase().includes(n)||t.push({type:"folder",name:s.name,path:s.path,icon:"\u{1F4C1}"})}),t.slice(0,50)}render(){if(!this.suggestionEl)return;this.suggestionEl.innerHTML="";let e=document.createElement("div");e.className="markdown-next-ai-suggestions-header",e.textContent=`\u9009\u62E9\u4E0A\u4E0B\u6587 (${this.items.length}\u9879)`,this.suggestionEl.appendChild(e);let t=document.createElement("div");t.className="markdown-next-ai-suggestions-list",this.items.forEach((n,i)=>{let o=document.createElement("div");o.className="markdown-next-ai-suggestion-item",i===this.selectedIndex&&o.classList.add("selected"),o.innerHTML=`
                <span class="markdown-next-ai-suggestion-icon">${n.icon}</span>
                <div class="markdown-next-ai-suggestion-content">
                    <div class="markdown-next-ai-suggestion-name">${n.name}</div>
                    <div class="markdown-next-ai-suggestion-path">${n.path}</div>
                </div>
            `,o.onclick=a=>{a.stopPropagation(),a.preventDefault(),this.selectItem(i)},t.appendChild(o)}),this.suggestionEl.appendChild(t)}position(){if(!this.suggestionEl||!this.inputEl)return;let e=this.inputEl.getBoundingClientRect(),t=window.getSelection();if(t&&t.rangeCount>0){let i=t.getRangeAt(0).getBoundingClientRect();this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=i.left+"px",this.suggestionEl.style.top=i.bottom+5+"px"}else this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=e.left+"px",this.suggestionEl.style.top=e.bottom+5+"px";this.suggestionEl.style.maxHeight="300px",this.suggestionEl.style.overflowY="auto",this.suggestionEl.style.zIndex="10000"}bindKeyboardEvents(){this.keydownHandler&&this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=e=>{if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,this.items.length-1),this.render(),this.scrollToSelected();break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.render(),this.scrollToSelected();break;case"Enter":e.preventDefault(),e.stopPropagation(),this.selectItem(this.selectedIndex);break;case"Escape":e.preventDefault(),e.stopPropagation(),this.close();break}},this.inputEl.addEventListener("keydown",this.keydownHandler)}scrollToSelected(){if(!this.suggestionEl)return;let e=this.suggestionEl.querySelector(".markdown-next-ai-suggestion-item.selected");e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}selectItem(e){if(e<0||e>=this.items.length)return;let t=this.items[e],n=document.createElement("span");n.className="markdown-next-ai-inline-tag",n.contentEditable="false",n.setAttribute("data-type",t.type),n.setAttribute("data-path",t.path),n.innerHTML=`<span class="markdown-next-ai-inline-tag-icon">${t.icon}</span><span class="markdown-next-ai-inline-tag-name">${t.name}</span>`;let i=window.getSelection();if(!i||!i.rangeCount)return;let o=i.getRangeAt(0),a=this.getCursorPosition()-this.atPosition,s=0,r=!1,c=(d,p,g)=>{if(!r){if(d.nodeType===Node.TEXT_NODE){let w=d.textContent.length;if(s+w>p){let h=p-s,m=Math.min(h+g,w),v=d.textContent;d.textContent=v.substring(0,h)+v.substring(m),o.setStart(d,h),o.collapse(!0),r=!0}else s+=w}else if(d.nodeType===Node.ELEMENT_NODE){if(d.classList&&d.classList.contains("markdown-next-ai-inline-tag")){let w=`@[${d.getAttribute("data-type")}:${d.getAttribute("data-path")}]`;s+=w.length}else for(let w of Array.from(d.childNodes))if(c(w,p,g),r)return}}};c(this.inputEl,this.atPosition,a),r||o.deleteContents(),o.insertNode(n);let l=document.createTextNode(" ");o.setStartAfter(n),o.insertNode(l),o.setStartAfter(l),o.collapse(!0),i.removeAllRanges(),i.addRange(o),this.inputEl.focus(),this.updatePlaceholder(),this.selectedTags.push(t),this.onSelect&&this.onSelect(t),this.close()}updateSearch(e){this.searchQuery=e,this.items=this.getAllItems(e),this.selectedIndex=0,this.items.length===0?this.close():this.render()}close(){this.isOpen=!1,this.suggestionEl&&this.suggestionEl.parentNode&&this.suggestionEl.parentNode.removeChild(this.suggestionEl),this.suggestionEl=null,this.keydownHandler&&(this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}};var O=class{constructor(e,t,n){this.selectedFiles=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=e,this.files=t,this.onSelect=n}open(e){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-file-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u6863</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6...">
                    </div>
                    <div class="markdown-next-ai-file-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let t=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),i=this.windowEl.querySelector(".markdown-next-ai-file-list"),o=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),a=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),s=c=>{c&&c.stopPropagation(),this.close()};t.onclick=s,a.onclick=s,o.onclick=c=>{c.stopPropagation(),this.onSelect(this.selectedFiles),this.close()},n.addEventListener("input",c=>{let l=c.target.value.toLowerCase();this.renderFileList(i,l)}),this.renderFileList(i,""),this.outsideClickHandler=c=>{this.windowEl.contains(c.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let r=this.windowEl.querySelector(".markdown-next-ai-window-content");if(e){let c=e.left;c+600>window.innerWidth-20&&(c=window.innerWidth-600-20),c<20&&(c=20);let l=e.bottom+8,d=Math.max(300,Math.min(window.innerHeight-l-20,500));r.style.maxHeight=d+"px",r.style.overflowY="auto",r.style.transform="none",r.style.left=c+"px",r.style.top=l+"px"}else r.style.left="50%",r.style.top="50%",r.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),r.addEventListener("click",c=>c.stopPropagation())}renderFileList(e,t){e.innerHTML="",this.files.filter(i=>t===""?!0:(i.name||i.path).toLowerCase().includes(t)).forEach(i=>{let o=document.createElement("div");o.className="markdown-next-ai-file-item";let a=document.createElement("input");a.type="checkbox",a.className="markdown-next-ai-file-checkbox",a.checked=this.selectedFiles.some(l=>l.path===i.path);let s=document.createElement("label");s.className="markdown-next-ai-file-label";let r=document.createElement("span");r.className="markdown-next-ai-file-name",r.textContent=i.name;let c=document.createElement("span");c.className="markdown-next-ai-file-extension",c.textContent=i.extension?"."+i.extension:"",s.appendChild(r),s.appendChild(c),o.appendChild(a),o.appendChild(s),e.appendChild(o),a.addEventListener("change",()=>{a.checked?this.selectedFiles.some(l=>l.path===i.path)||this.selectedFiles.push(i):this.selectedFiles=this.selectedFiles.filter(l=>l.path!==i.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null)}};var B=class{constructor(e,t,n){this.selectedFolders=[];this.windowEl=null;this.isOpen=!1;this.outsideClickHandler=null;this.app=e,this.folders=t,this.onSelect=n}open(e){if(this.isOpen)return;this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="markdown-next-ai-folder-selection-window",this.windowEl.innerHTML=`
            <div class="markdown-next-ai-window-content">
                <div class="markdown-next-ai-window-header">
                    <h2>\u9009\u62E9\u6587\u4EF6\u5939</h2>
                    <button class="markdown-next-ai-window-close">\u2715</button>
                </div>
                <div class="markdown-next-ai-window-body">
                    <div class="markdown-next-ai-search-container">
                        <input type="text" class="markdown-next-ai-search-input" placeholder="\u641C\u7D22\u6587\u4EF6\u5939...">
                    </div>
                    <div class="markdown-next-ai-folder-list"></div>
                </div>
                <div class="markdown-next-ai-window-buttons">
                    <button class="markdown-next-ai-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></button>
                    <button class="markdown-next-ai-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
                </div>
            </div>
        `;let t=this.windowEl.querySelector(".markdown-next-ai-window-close"),n=this.windowEl.querySelector(".markdown-next-ai-search-input"),i=this.windowEl.querySelector(".markdown-next-ai-folder-list"),o=this.windowEl.querySelector(".markdown-next-ai-confirm-btn"),a=this.windowEl.querySelector(".markdown-next-ai-cancel-btn"),s=c=>{c&&c.stopPropagation(),this.close()};t.onclick=s,a.onclick=s,o.onclick=c=>{c.stopPropagation(),this.onSelect(this.selectedFolders),this.close()},n.addEventListener("input",c=>{let l=c.target.value.toLowerCase();this.renderFolderList(i,l)}),this.renderFolderList(i,""),this.outsideClickHandler=c=>{this.windowEl.contains(c.target)||this.close()},setTimeout(()=>{document.addEventListener("click",this.outsideClickHandler)},100),this.windowEl.style.position="fixed",document.body.appendChild(this.windowEl);let r=this.windowEl.querySelector(".markdown-next-ai-window-content");if(e){let c=e.left;c+600>window.innerWidth-20&&(c=window.innerWidth-600-20),c<20&&(c=20);let l=e.bottom+8,d=Math.max(300,Math.min(window.innerHeight-l-20,500));r.style.maxHeight=d+"px",r.style.overflowY="auto",r.style.transform="none",r.style.left=c+"px",r.style.top=l+"px"}else r.style.left="50%",r.style.top="50%",r.style.transform="translate(-50%, -50%)";this.windowEl.style.zIndex="10001",n.focus(),r.addEventListener("click",c=>c.stopPropagation())}renderFolderList(e,t){e.innerHTML="",this.folders.filter(i=>t===""?!0:(i.name||i.path).toLowerCase().includes(t)).forEach(i=>{let o=document.createElement("div");o.className="markdown-next-ai-folder-item";let a=document.createElement("input");a.type="checkbox",a.className="markdown-next-ai-folder-checkbox",a.checked=this.selectedFolders.some(r=>r.path===i.path);let s=document.createElement("label");s.className="markdown-next-ai-folder-label",s.textContent=i.name||i.path,o.appendChild(a),o.appendChild(s),e.appendChild(o),a.addEventListener("change",()=>{a.checked?this.selectedFolders.some(r=>r.path===i.path)||this.selectedFolders.push(i):this.selectedFolders=this.selectedFolders.filter(r=>r.path!==i.path)})})}close(){this.isOpen&&(this.isOpen=!1,this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null)}};var A=class{constructor(e,t,n){this.isOpen=!1;this.modalEl=null;this.eventListeners=[];this.selectedIndex=0;this.commonPrompts=[];this.app=e,this.plugin=t,this.onSelect=n}open(e){if(!this.isOpen){this.isOpen=!0;try{this.modalEl=document.createElement("div"),this.modalEl.className="markdown-next-ai-context-suggestions";let t=this.plugin.settings.commonPrompts||[];this.commonPrompts=t,this.selectedIndex=0;let n=document.createElement("div");n.className="markdown-next-ai-suggestions-header",n.textContent=`\u5E38\u7528\u63D0\u793A\u8BCD (${this.commonPrompts.length})`,this.modalEl.appendChild(n);let i=document.createElement("div");if(i.className="markdown-next-ai-suggestions-list",this.commonPrompts.length===0)i.innerHTML=`
                    <div class="markdown-next-ai-suggestion-item" style="cursor: default;">
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">\u6682\u65E0\u5E38\u7528\u63D0\u793A\u8BCD</div>
                            <div class="markdown-next-ai-suggestion-path">\u8BF7\u5728\u8BBE\u7F6E\u4E2D\u6DFB\u52A0</div>
                        </div>
                    </div>
                `;else{let s=this.commonPrompts.map((r,c)=>`
                    <div class="markdown-next-ai-suggestion-item ${c===0?"selected":""}" data-index="${c}">
                        <span class="markdown-next-ai-suggestion-icon">\u{1F4A1}</span>
                        <div class="markdown-next-ai-suggestion-content">
                            <div class="markdown-next-ai-suggestion-name">${r.name}</div>
                            <div class="markdown-next-ai-suggestion-path">${r.content.substring(0,50)}${r.content.length>50?"...":""}</div>
                        </div>
                    </div>
                `).join("");i.innerHTML=s}this.modalEl.appendChild(i),this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(s=>{if(this.commonPrompts.length===0)return;let r=()=>{let l=parseInt(s.dataset.index||"0");this.selectPrompt(l)};s.addEventListener("click",r),this.eventListeners.push({element:s,event:"click",handler:r});let c=()=>{let l=parseInt(s.dataset.index||"0");this.updateSelection(l)};s.addEventListener("mouseenter",c),this.eventListeners.push({element:s,event:"mouseenter",handler:c})});let o=s=>{s.target.closest(".markdown-next-ai-at-popup")||this.modalEl.contains(s.target)||this.close()};document.addEventListener("click",o),this.eventListeners.push({element:document,event:"click",handler:o});let a=s=>{s.key==="Escape"?(s.preventDefault(),this.close()):s.key==="ArrowDown"?(s.preventDefault(),this.moveSelection(1)):s.key==="ArrowUp"?(s.preventDefault(),this.moveSelection(-1)):s.key==="Enter"&&(s.preventDefault(),this.selectPrompt(this.selectedIndex))};document.addEventListener("keydown",a),this.eventListeners.push({element:document,event:"keydown",handler:a}),document.body.appendChild(this.modalEl),this.positionPopup(e)}catch(t){console.error("Failed to open prompt selector:",t)}}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e&&typeof e.removeEventListener=="function"&&e.removeEventListener(t,n)}),this.eventListeners=[],this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null)}positionPopup(e){if(this.modalEl&&e)try{let t=e.getBoundingClientRect(),n=this.modalEl.getBoundingClientRect(),i=window.innerWidth,o=window.innerHeight,a=t.left,s=t.bottom+5;a+n.width>i&&(a=i-n.width-10),s+n.height>o&&(s=t.top-n.height-5),a=Math.max(10,a),s=Math.max(10,s),this.modalEl.style.position="fixed",this.modalEl.style.left=a+"px",this.modalEl.style.top=s+"px",this.modalEl.style.zIndex="10002"}catch(t){console.error("Failed to position prompt selector:",t)}}moveSelection(e){if(this.commonPrompts.length===0)return;let t=this.selectedIndex+e;t<0&&(t=this.commonPrompts.length-1),t>=this.commonPrompts.length&&(t=0),this.updateSelection(t)}updateSelection(e){if(!this.modalEl||this.commonPrompts.length===0)return;this.selectedIndex=e,this.modalEl.querySelectorAll(".markdown-next-ai-suggestion-item").forEach(n=>n.classList.remove("selected"));let t=this.modalEl.querySelector(`[data-index="${e}"]`);t&&(t.classList.add("selected"),t.scrollIntoView({block:"nearest",behavior:"smooth"}))}selectPrompt(e){if(e<0||e>=this.commonPrompts.length)return;let t=this.commonPrompts[e];t&&this.onSelect&&this.onSelect(t.content),this.close()}};var j=class{constructor(e,t,n,i,o){this.popupEl=null;this.inputEl=null;this.modelSelectEl=null;this.isOpen=!1;this.eventListeners=[];this.selectedContext={files:[],folders:[]};this.scrollContainer=null;this.contextSelector=null;this.promptSelector=null;this.outsideClickHandler=null;this.app=e,this.onSubmit=t,this.cursorPosition=n,this.plugin=i,this.view=o,this.imageHandler=new R}async submit(){var o,a;let e=((o=this.contextSelector)==null?void 0:o.getTextContent().trim())||"";await this.processInlineImages();let t=this.imageHandler.getImages(),n=((a=this.modelSelectEl)==null?void 0:a.value)||"",i=await this.getContextContent();if(!e&&t.length===0&&!i){new G.Notice("\u8BF7\u8F93\u5165\u7EED\u5199\u8981\u6C42\u6216\u4E0A\u4F20\u56FE\u7247");return}this.onSubmit(e,t,n,i),this.close()}getModelOptions(){let e=this.plugin.getAvailableModels(),t=this.plugin.settings.currentModel;return e.map(n=>{let i=n.id===t?"selected":"";return`<option value="${n.id}" ${i}>${n.name}</option>`}).join("")}addImagePreview(e,t){let n=this.imageHandler.createImagePreview(e,()=>{});t.appendChild(n)}open(){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-at-popup"),this.popupEl.innerHTML=`
            <div class="markdown-next-ai-popup-header">
                <span class="markdown-next-ai-popup-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
                    Markdown-Next-AI
                </span>
                <button class="markdown-next-ai-popup-close">\u2715</button>
            </div>
            <div class="markdown-next-ai-popup-content">
                <div class="markdown-next-ai-context-section">
                    <div class="markdown-next-ai-selected-context" style="display: none;">
                        <div class="markdown-next-ai-context-header">
                            <span class="markdown-next-ai-context-title">\u5DF2\u9009\u62E9\u4E0A\u4E0B\u6587:</span>
                            <button class="markdown-next-ai-clear-context-btn" title="\u6E05\u9664\u4E0A\u4E0B\u6587">\u2715</button>
                        </div>
                        <div class="markdown-next-ai-context-list"></div>
                    </div>
                </div>
                <textarea class="markdown-next-ai-continue-input" placeholder="\uFF08@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD\uFF09..." rows="3"></textarea>
                <div class="markdown-next-ai-upload-section">
                    <div class="markdown-next-ai-left-section">
                        <select class="markdown-next-ai-model-select">
                            ${this.getModelOptions()}
                        </select>
                        <input type="file" class="markdown-next-ai-file-input" accept="image/*" multiple style="display: none;">
                        <button class="markdown-next-ai-upload-btn" title="\u4E0A\u4F20\u56FE\u7247"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg></button>
                        <div class="markdown-next-ai-context-buttons">
                            <button class="markdown-next-ai-select-file-btn" title="\u9009\u62E9\u6587\u6863\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></button>
                            <button class="markdown-next-ai-select-folder-btn" title="\u9009\u62E9\u6587\u4EF6\u5939\u4F5C\u4E3A\u4E0A\u4E0B\u6587"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg></button>
                        </div>
                    </div>
                    <button class="markdown-next-ai-submit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more-icon lucide-message-square-more" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 11h.01"/></svg>\u63D0\u4EA4</button>
                </div>
                <div class="markdown-next-ai-image-previews"></div>
            </div>
        `,this.inputEl=this.popupEl.querySelector(".markdown-next-ai-continue-input"),this.modelSelectEl=this.popupEl.querySelector(".markdown-next-ai-model-select");let e=this.popupEl.querySelector(".markdown-next-ai-submit-btn"),t=this.popupEl.querySelector(".markdown-next-ai-popup-close"),n=this.popupEl.querySelector(".markdown-next-ai-file-input"),i=this.popupEl.querySelector(".markdown-next-ai-upload-btn"),o=this.popupEl.querySelector(".markdown-next-ai-image-previews"),a=this.popupEl.querySelector(".markdown-next-ai-select-file-btn"),s=this.popupEl.querySelector(".markdown-next-ai-select-folder-btn"),r=this.popupEl.querySelector(".markdown-next-ai-clear-context-btn");this.contextSelector=new $(this.app,this.inputEl,()=>{}),this.contextSelector.convertToContentEditable(),this.inputEl=this.contextSelector.inputEl,this.promptSelector=new A(this.app,this.plugin,h=>{let m=this.contextSelector.getCursorPosition(),y=this.contextSelector.getTextContent().substring(0,m).lastIndexOf("#");if(y!==-1){let T=window.getSelection();if(T&&T.rangeCount>0){let u=T.getRangeAt(0),f=m-y,b=0,E=!1,C=(k,S,H)=>{if(!E){if(k.nodeType===Node.TEXT_NODE){let F=k.textContent.length;if(b+F>S){let X=S-b,Q=Math.min(X+H,F),Y=k.textContent;k.textContent=Y.substring(0,X)+Y.substring(Q);let J=document.createTextNode(h);k.parentNode&&(k.parentNode.insertBefore(J,k.nextSibling),u.setStartAfter(J),u.collapse(!0)),E=!0}else b+=F}else if(k.nodeType===Node.ELEMENT_NODE){for(let F of Array.from(k.childNodes))if(C(F,S,H),E)return}}};C(this.inputEl,y,f),T.removeAllRanges(),T.addRange(u),this.inputEl.focus()}}}),t.onclick=()=>this.close(),e.onclick=()=>this.submit(),i.onclick=()=>n.click(),a.onclick=()=>this.showFileSelector(),s.onclick=()=>this.showFolderSelector(),r.onclick=()=>this.clearContext();let c=h=>{let m=h.target;this.plugin&&this.plugin.settings&&(this.plugin.settings.currentModel=m.value,this.plugin.saveSettings()),this.updateUIForModelType(m.value),this.adjustModelSelectWidth()};this.modelSelectEl.addEventListener("change",c),this.eventListeners.push({element:this.modelSelectEl,event:"change",handler:c}),this.updateUIForModelType(this.modelSelectEl.value),this.adjustModelSelectWidth();let l=h=>{let m=h.target;m.files&&this.imageHandler.handleFileSelect(m.files,v=>{this.addImagePreview(v,o)}),m.value=""};n.addEventListener("change",l),this.eventListeners.push({element:n,event:"change",handler:l});let d=h=>{this.imageHandler.handlePaste(h,m=>{this.addImagePreview(m,o)})};this.inputEl.addEventListener("paste",d),this.eventListeners.push({element:this.inputEl,event:"paste",handler:d});let p=h=>{h.stopPropagation(),this.adjustPopupWidth();let m=this.contextSelector.getCursorPosition(),v=this.contextSelector.getTextContent().substring(0,m),y=v.lastIndexOf("@");if(y!==-1){let u=v.substring(y+1);if(!u.includes(" ")&&!u.includes(`
`)){this.contextSelector.show(y,u);return}else this.contextSelector.close()}else this.contextSelector.close();let T=v.lastIndexOf("#");if(T!==-1){let u=T>0?v.charAt(T-1):" ";if(u===" "||u===`
`){this.promptSelector.open(this.inputEl);let f=window.getSelection();if(f&&f.rangeCount>0){let E=f.getRangeAt(0).getBoundingClientRect(),C=document.querySelector(".markdown-next-ai-context-suggestions");C&&(C.style.position="fixed",C.style.left=E.left+"px",C.style.top=E.bottom+5+"px")}}else this.promptSelector.close()}else this.promptSelector.close()};this.inputEl.addEventListener("input",p),this.eventListeners.push({element:this.inputEl,event:"input",handler:p});let g=h=>{this.contextSelector&&this.contextSelector.isOpen||(h.key==="Enter"?h.shiftKey||(h.preventDefault(),e.click()):h.key==="Escape"&&(h.preventDefault(),this.close()))};this.inputEl.addEventListener("keydown",g),this.eventListeners.push({element:this.inputEl,event:"keydown",handler:g});let w=h=>{this.popupEl.hasAttribute("data-prompt-selecting")||h.target.closest(".markdown-next-ai-prompt-selector-popup")||h.target.closest(".markdown-next-ai-context-suggestions")||this.contextSelector&&this.contextSelector.isOpen||h.target.closest(".markdown-next-ai-file-selection-window")||h.target.closest(".markdown-next-ai-folder-selection-window")||this.popupEl.contains(h.target)||this.close()};setTimeout(()=>{document.addEventListener("click",w)},100),this.outsideClickHandler=w,this.view&&(this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor"))),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.scrollContainer.appendChild(this.popupEl)):document.body.appendChild(this.popupEl),this.positionPopup(),setTimeout(()=>{this.inputEl&&this.inputEl.focus()},100)}positionPopup(){if(!this.popupEl||!this.cursorPosition)return;let{left:e,top:t,height:n=20}=this.cursorPosition;if(this.scrollContainer){let i=this.scrollContainer.getBoundingClientRect(),o=this.scrollContainer.scrollTop,a=this.scrollContainer.scrollLeft,s=e-i.left+a,r=t+n+5-i.top+o;this.popupEl.style.position="absolute",this.popupEl.style.left=s+"px",this.popupEl.style.top=r+"px",this.popupEl.style.zIndex="10000";let c=this.popupEl.getBoundingClientRect(),l=i.width;c.right>i.right&&(s=l+a-c.width-10,this.popupEl.style.left=s+"px"),s<a&&(this.popupEl.style.left=a+10+"px"),c.bottom>i.bottom&&(r=t-i.top+o-c.height-5,this.popupEl.style.top=r+"px")}else{this.popupEl.style.position="fixed",this.popupEl.style.left=e+"px",this.popupEl.style.top=t+n+5+"px",this.popupEl.style.zIndex="10000";let i=this.popupEl.getBoundingClientRect(),o=window.innerWidth,a=window.innerHeight;i.right>o&&(this.popupEl.style.left=o-i.width-10+"px"),i.left<0&&(this.popupEl.style.left="10px"),i.bottom>a&&(this.popupEl.style.top=t-i.height-5+"px")}}adjustPopupWidth(){if(!this.popupEl||!this.inputEl)return;let e=document.createElement("span");e.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            max-width: 80vw;
        `;let t=this.contextSelector?this.contextSelector.getTextContent():"";e.textContent=t||"",document.body.appendChild(e);let n=e.offsetWidth;document.body.removeChild(e);let i=480,o=window.innerWidth*.8,s=Math.max(i,Math.min(n+100,o));this.popupEl.style.width=s+"px"}adjustModelSelectWidth(){if(!this.modelSelectEl)return;let e=this.modelSelectEl.options[this.modelSelectEl.selectedIndex];if(!e)return;let t=document.createElement("span");t.style.cssText=`
            position: absolute;
            visibility: hidden;
            white-space: nowrap;
            font-family: inherit;
            font-size: 12px;
        `,t.textContent=e.text,document.body.appendChild(t);let n=t.offsetWidth;document.body.removeChild(t);let i=n+35;this.modelSelectEl.style.width=i+"px"}close(){this.isOpen&&(this.isOpen=!1,this.contextSelector&&(this.contextSelector.close(),this.contextSelector=null),this.eventListeners.forEach(({element:e,event:t,handler:n})=>{e.removeEventListener(t,n)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.imageHandler.clearImages(),this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.inputEl=null)}updateUIForModelType(e){var n;if(!this.popupEl||!e)return;let t=this.plugin.settings.models[e];if(t){let i=t.category===M.IMAGE,o=this.popupEl.querySelector(".markdown-next-ai-popup-title");o&&(o.innerHTML=i?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-icon lucide-image" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>AI\u56FE\u7247\u751F\u6210':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>Markdown-Next-AI'),this.inputEl&&(this.inputEl.setAttribute("data-placeholder",i?"\u8BF7\u63CF\u8FF0\u60A8\u60F3\u8981\u751F\u6210\u7684\u56FE\u7247...":"(@\u9009\u62E9\u6587\u4EF6\uFF0C#\u9009\u62E9\u5E38\u7528\u63D0\u793A\u8BCD)"),(n=this.contextSelector)==null||n.updatePlaceholder());let a=this.popupEl.querySelector(".markdown-next-ai-submit-btn");a&&(a.innerHTML=i?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-plus-icon lucide-image-plus" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M16 5h6"/><path d="M19 2v6"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>\u751F\u6210\u56FE\u7247':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more-icon lucide-message-square-more" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 11h.01"/></svg>\u63D0\u4EA4');let s=this.popupEl.querySelector(".markdown-next-ai-upload-btn");s&&(s.style.display=i?"none":"inline-flex")}}showFileSelector(){let e=["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"],t=this.plugin.app.vault.getFiles().filter(i=>e.includes(i.extension.toLowerCase())).map(i=>({name:i.basename,path:i.path,extension:i.extension.toLowerCase()})),n=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(n){let i=n.getBoundingClientRect();new O(this.plugin.app,t,o=>{this.addFilesToContext(o)}).open(i)}}showFolderSelector(){let e=this.plugin.app.vault.getAllLoadedFiles().filter(n=>!!n.children).map(n=>({name:n.name,path:n.path})),t=this.popupEl.querySelector(".markdown-next-ai-popup-header");if(t){let n=t.getBoundingClientRect();new B(this.plugin.app,e,i=>{this.addFoldersToContext(i)}).open(n)}}addFilesToContext(e){e.forEach(t=>{this.selectedContext.files.find(n=>n.path===t.path)||this.selectedContext.files.push(t)}),this.updateContextDisplay()}addFoldersToContext(e){e.forEach(t=>{this.selectedContext.folders.find(n=>n.path===t.path)||this.selectedContext.folders.push(t)}),this.updateContextDisplay()}updateContextDisplay(){let e=this.popupEl.querySelector(".markdown-next-ai-selected-context"),t=this.popupEl.querySelector(".markdown-next-ai-context-list");this.selectedContext.files.length===0&&this.selectedContext.folders.length===0?e.style.display="none":(e.style.display="block",t.innerHTML="",this.selectedContext.files.forEach(n=>{let i=document.createElement("div");i.className="markdown-next-ai-context-item",i.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${n.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="file" data-path="${n.path}">\xD7</button>
                `,t.appendChild(i)}),this.selectedContext.folders.forEach(n=>{let i=document.createElement("div");i.className="markdown-next-ai-context-item",i.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
                    </svg>
                    <span class="markdown-next-ai-context-name">${n.name}</span>
                    <button class="markdown-next-ai-remove-context" data-type="folder" data-path="${n.path}">\xD7</button>
                `,t.appendChild(i)}),t.querySelectorAll(".markdown-next-ai-remove-context").forEach(n=>{n.onclick=i=>{i.stopPropagation();let o=n.getAttribute("data-type"),a=n.getAttribute("data-path");this.removeFromContext(o,a)}}))}removeFromContext(e,t){e==="file"?this.selectedContext.files=this.selectedContext.files.filter(n=>n.path!==t):e==="folder"&&(this.selectedContext.folders=this.selectedContext.folders.filter(n=>n.path!==t)),this.updateContextDisplay()}clearContext(){this.selectedContext={files:[],folders:[]},this.updateContextDisplay()}async processInlineImages(){var t;if(!this.contextSelector||!this.contextSelector.inputEl)return;let e=this.contextSelector.inputEl.querySelectorAll(".markdown-next-ai-inline-tag");for(let n of Array.from(e)){let i=n.getAttribute("data-type"),o=n.getAttribute("data-path");if(i==="image"&&o)try{let a=this.plugin.app.vault.getAbstractFileByPath(o);if(!a)continue;let s=await this.plugin.app.vault.readBinary(a),r=new Uint8Array(s),c="";for(let m=0;m<r.length;m++)c+=String.fromCharCode(r[m]);let l=btoa(c),p={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",svg:"image/svg+xml"}[((t=a.extension)==null?void 0:t.toLowerCase())||"png"]||"image/png",g=`data:${p};base64,${l}`,w={id:Date.now()+Math.random(),name:a.name,size:s.byteLength,type:p,base64:g,url:g,fromInline:!0};this.imageHandler.getImages().some(m=>m.name===w.name&&m.size===w.size)||this.imageHandler.addImage(w)}catch(a){console.error("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+o,a),new G.Notice("\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247: "+o)}}}async getContextContent(){let e="";for(let n of this.selectedContext.files)try{let i=this.plugin.app.vault.getAbstractFileByPath(n.path);if(i){let o=await this.plugin.app.vault.read(i);e+=`

=== \u6587\u6863: ${n.name} ===
${o}`}}catch(i){console.error("\u8BFB\u53D6\u6587\u4EF6\u5931\u8D25:",i)}let t=(n,i)=>{let o=[];if(n&&n.children){for(let a of n.children)if(a.extension==="md")o.push({file:a,sourcePath:a.path,baseFolderName:i});else if(a.children){let s=t(a,i);o.push(...s)}}return o};for(let n of this.selectedContext.folders)try{let i=this.plugin.app.vault.getAbstractFileByPath(n.path);if(i){let o=t(i,n.name);for(let{file:a,sourcePath:s,baseFolderName:r}of o){let c=await this.plugin.app.vault.read(a);e+=`

=== \u6587\u6863: ${a.basename} (\u6765\u81EA\u6587\u4EF6\u5939: ${r}, \u8DEF\u5F84: ${s}) ===
${c}`}}}catch(i){console.error("\u8BFB\u53D6\u6587\u4EF6\u5939\u5931\u8D25:",i)}return e.trim()}};var q=class{constructor(e,t,n,i,o){this.isOpen=!1;this.popupEl=null;this.scrollContainer=null;this.app=e,this.editor=t,this.view=n,this.onConfirm=i,this.onReject=o}open(e){if(this.isOpen)return;this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("markdown-next-ai-preview-popup"),this.popupEl.innerHTML=`
            <div class="markdown-next-ai-preview-content">
                <div class="markdown-next-ai-preview-header">
                    <span class="markdown-next-ai-preview-status thinking">\u23F3\u6B63\u5728\u601D\u8003\u4E2D</span>
                </div>
                <div class="markdown-next-ai-preview-actions" style="display: none;">
                    <button class="markdown-next-ai-preview-confirm-btn">\u2713 \u63A5\u53D7</button>
                    <button class="markdown-next-ai-preview-reject-btn">\u2717 \u62D2\u7EDD</button>
                </div>
            </div>
        `;let t=this.popupEl.querySelector(".markdown-next-ai-preview-confirm-btn"),n=this.popupEl.querySelector(".markdown-next-ai-preview-reject-btn");t.onclick=()=>{this.onConfirm&&this.onConfirm(),this.close()},n.onclick=()=>{this.onReject&&this.onReject(),this.close()},this.scrollContainer=this.view.containerEl.querySelector(".cm-scroller"),this.scrollContainer||(this.scrollContainer=this.view.containerEl.querySelector(".cm-editor")),this.scrollContainer?(window.getComputedStyle(this.scrollContainer).position==="static"&&(this.scrollContainer.style.position="relative"),this.popupEl.style.position="absolute",this.scrollContainer.appendChild(this.popupEl)):(this.popupEl.style.position="fixed",document.body.appendChild(this.popupEl)),e&&this.positionAt(e.left,e.top,"above")}positionAt(e,t,n="above"){if(!this.popupEl)return;let i=this.popupEl.getBoundingClientRect();if(this.scrollContainer){let o=this.scrollContainer.getBoundingClientRect(),a=this.scrollContainer.scrollTop,s=this.scrollContainer.scrollLeft,r=this.scrollContainer.querySelector(".cm-content"),c=r?r.getBoundingClientRect():o,l,d;n==="above"?(l=c.left-o.left+s-i.width-2,d=t-o.top+a-i.height/2,l<0&&(l=c.right-o.left+s+8)):n==="right"?(l=e-o.left+s+12,d=t-o.top+a-i.height/2,l+i.width>o.width-10&&(l=o.width-i.width-10,d=t-o.top+a+20)):(l=e-o.left+s,d=t-o.top+a+8,l+i.width>o.width-10&&(l=o.width-i.width-10)),d<a&&(d=a+10),this.popupEl.style.left=l+"px",this.popupEl.style.top=d+"px"}else{let o=window.innerWidth,a=window.innerHeight,s,r;n==="above"?(s=e-i.width-50,r=t-i.height/2,s<10&&(s=e+50)):n==="right"?(s=e+8,r=t-i.height/2):(s=e,r=t+8,r+i.height>a-10&&(r=t-i.height-8)),r<10&&(r=10),r+i.height>a-10&&(r=a-i.height-10),s+i.width>o-10&&(s=o-i.width-10),s<10&&(s=10),this.popupEl.style.left=s+"px",this.popupEl.style.top=r+"px"}this.popupEl.style.right="auto",this.popupEl.style.bottom="auto"}updateStatus(e){if(!this.popupEl)return;let t=this.popupEl.querySelector(".markdown-next-ai-preview-status");t&&(t.textContent=e,t.classList.remove("thinking","generating"),e.includes("\u751F\u6210")?t.classList.add("generating"):t.classList.add("thinking"))}showActions(){if(!this.popupEl)return;let e=this.popupEl.querySelector(".markdown-next-ai-preview-status"),t=this.popupEl.querySelector(".markdown-next-ai-preview-actions");e&&(e.style.display="none"),t&&(t.style.display="flex")}close(){this.isOpen&&(this.isOpen=!1,this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null)}};var _=class extends P.Plugin{constructor(){super(...arguments);this.eventListeners=[];this.atTriggerTimeout=null}async onload(){await this.loadSettings(),this.aiService=new D(this.settings,this.app),this.addSettingTab(new K(this.app,this)),this.addCommands(),this.updateEventListeners(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u52A0\u8F7D")}onunload(){this.cleanupEventListeners(),console.log("MarkdownNext AI \u63D2\u4EF6\u5DF2\u5378\u8F7D")}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},I,t),t&&(t.providers&&(this.settings.providers=Object.assign({},I.providers,t.providers)),t.models&&(this.settings.models=Object.assign({},I.models,t.models),Object.keys(this.settings.models).forEach(n=>{let i=this.settings.models[n];(typeof i!="object"||i===null||!i.id||n in I)&&(n in I&&n!=="models"?delete this.settings.models[n]:(typeof i!="object"||i===null||!i.id)&&delete this.settings.models[n])})))}async saveSettings(){await this.saveData(this.settings),this.aiService&&this.aiService.updateSettings(this.settings)}getAvailableModels(){return Object.values(this.settings.models).filter(t=>t.enabled).map(t=>({id:t.id,name:t.name,provider:t.provider}))}addCommands(){this.addCommand({id:"continue-writing",name:"\u667A\u80FD\u7EED\u5199",callback:()=>{this.handleContinueWriting()}})}updateEventListeners(){this.cleanupEventListeners(),this.settings.enableAtTrigger&&this.setupAtTriggerListener(),this.setupPromptTriggerListener()}setupPromptTriggerListener(){}showPromptSelectorModal(t){new A(this.app,this,n=>{if(t.contentEditable==="true"){let i=window.getSelection();if(!i||!i.rangeCount)return;let o=i.getRangeAt(0),a=o.startContainer;if(a.nodeType===Node.TEXT_NODE){let s=a.textContent||"",r=o.startOffset,c=s.lastIndexOf("#",r-1);if(c!==-1){let l=s.substring(0,c)+n+s.substring(r);a.textContent=l;let d=c+n.length;try{let p=document.createRange();p.setStart(a,d),p.collapse(!0),i.removeAllRanges(),i.addRange(p)}catch(p){console.error("Failed to set cursor position",p)}}}}else{let i=t,o=i.selectionStart||0,a=i.value,s=a.substring(0,o),r=a.substring(o),c=s.lastIndexOf("#");if(c!==-1){let l=s.substring(0,c)+n;i.value=l+r,i.selectionStart=i.selectionEnd=l.length,i.focus()}}}).open(t)}setupAtTriggerListener(){let t=n=>{if(n.key==="@"||n.shiftKey&&n.key==="2"||n.key==="&"||n.shiftKey&&n.key==="7"){let i=document.activeElement;if(i&&(i.classList.contains("markdown-next-ai-modify-input")||i.classList.contains("markdown-next-ai-continue-input")))return;let o=this.app.workspace.getActiveViewOfType(P.MarkdownView);if(!o||!o.editor)return;this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.atTriggerTimeout=setTimeout(()=>{let a=o.editor.getCursor(),r=o.editor.getLine(a.line).substring(0,a.ch),c=r.charAt(r.length-1);(c==="@"||c==="&")&&!r.endsWith("@@")&&!r.endsWith("&&")&&(this.showAtTriggerModal(),this.atTriggerTimeout=null)},500)}};document.addEventListener("keydown",t),this.eventListeners.push({element:document,event:"keydown",handler:t})}cleanupEventListeners(){this.eventListeners&&(this.eventListeners.forEach(({element:t,event:n,handler:i})=>{t&&i&&(t===this.app.workspace&&typeof t.off=="function"?t.off(n,i):typeof t.removeEventListener=="function"&&t.removeEventListener(n,i))}),this.eventListeners=[])}showAtTriggerModal(){let t=this.app.workspace.getActiveViewOfType(P.MarkdownView),n=this.getCursorPosition();n&&new j(this.app,(i,o,a,s)=>{this.handleContinueWriting(i,o,a,s)},n,this,t).open()}getCursorPosition(){try{let t=this.app.workspace.getActiveViewOfType(P.MarkdownView);if(!t||!t.editor)return null;let n=t.containerEl.querySelector(".cm-editor");if(!n)return null;let i=t.editor.getCursor(),o=t.editor.coordsAtPos(i);if(o)return{left:o.left,top:o.top,height:o.bottom-o.top};let a=window.getSelection();if(a&&a.rangeCount>0){let c=a.getRangeAt(0).getBoundingClientRect();if(c.width>0||c.height>0)return{left:c.left,top:c.top,height:c.height||20}}let s=n.getBoundingClientRect();return{left:s.left+50,top:s.top+50,height:20}}catch(t){return console.error("\u83B7\u53D6\u5149\u6807\u4F4D\u7F6E\u5931\u8D25:",t),null}}async handleContinueWriting(t="",n=[],i=null,o=null){let a=this.app.workspace.getActiveViewOfType(P.MarkdownView);if(!a||!a.editor){new P.Notice("\u8BF7\u5728Markdown\u7F16\u8F91\u5668\u4E2D\u4F7F\u7528\u6B64\u529F\u80FD");return}if(!t){this.showAtTriggerModal();return}let s=a.editor,r=s.getCursor(),c=s.getLine(r.line),l=r.ch>0?c.charAt(r.ch-1):"";if(l==="@"||l==="&"){let f={line:r.line,ch:r.ch-1},b={line:r.line,ch:r.ch};s.replaceRange("",f,b),r.ch=r.ch-1}let d={line:r.line,ch:r.ch},p="markdown-next-ai-preview-"+Date.now(),g=`<span style="background:#90EE90;" data-preview-id="${p}">`,w="</span>";s.replaceRange(`${g}${w}`,d);let h=s.posToOffset(d)+g.length,m=0,v=!1,y=s.coordsAtPos(d),T=y?{left:y.left,top:y.top}:null,u=new q(this.app,s,a,()=>{let f=s.getValue(),b=`<span style="background:#90EE90;" data-preview-id="${p}">`,E=f.indexOf(b);if(E!==-1){let C=E+b.length,k=f.indexOf(w,C);if(k!==-1){let S=k+w.length;s.replaceRange("",s.offsetToPos(k),s.offsetToPos(S)),s.replaceRange("",s.offsetToPos(E),s.offsetToPos(C));let H=k-b.length;s.setCursor(s.offsetToPos(H))}}new P.Notice("\u5DF2\u63A5\u53D7AI\u751F\u6210\u5185\u5BB9")},()=>{let f=s.getValue(),b=`<span style="background:#90EE90;" data-preview-id="${p}">`,E=f.indexOf(b);if(E!==-1){let C=E+b.length,k=f.indexOf(w,C);if(k!==-1){let S=k+w.length;s.replaceRange("",s.offsetToPos(E),s.offsetToPos(S)),s.setCursor(s.offsetToPos(E))}}new P.Notice("\u5DF2\u62D2\u7EDDAI\u751F\u6210\u5185\u5BB9")});u.open(T);try{let f=await this.aiService.sendRequest("continue",{selectedText:"",beforeText:s.getValue().substring(0,s.posToOffset(d)),afterText:"",cursorPosition:r,additionalContext:o||void 0},t,n,[],b=>{if(b.content!=null){let E=s.offsetToPos(h),C=s.offsetToPos(h+m);s.replaceRange(b.content,E,C),m=b.content.length;let k=s.offsetToPos(h+m);s.setCursor(k),v=!0,u.updateStatus(`\u270D\uFE0F\u6B63\u5728\u751F\u6210\u4E2D(${m}\u5B57)`)}if(b.isComplete){let E=s.coordsAtPos(d);E&&u.positionAt(E.left,E.top,"above"),u.showActions()}});if(!v&&f&&f.content){let b=s.offsetToPos(h),E=s.offsetToPos(h+m);s.replaceRange(f.content,b,E),m=f.content.length;let C=s.offsetToPos(h+m);s.setCursor(C);let k=s.coordsAtPos(d);k&&u.positionAt(k.left,k.top,"above"),u.showActions()}}catch(f){let b=s.getValue(),E=`<span style="background:#90EE90;" data-preview-id="${p}">`,C=b.indexOf(E);if(C!==-1){let k=C+E.length,S=b.indexOf(w,k);if(S!==-1){let H=S+w.length;s.replaceRange("",s.offsetToPos(C),s.offsetToPos(H))}}s.setCursor(d),u.close(),new P.Notice("\u7EED\u5199\u5931\u8D25: "+f.message)}}};
