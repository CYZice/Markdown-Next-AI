# 全局对话模式 - 快速参考

## 快速开始

### 启用功能
1. 打开插件设置
2. 找到 **"全局对话模式（Beta）"** 部分
3. 开启两个开关：
   - ✅ **启用全局对话框模式** (Ctrl+Shift+M)
   - ✅ **使用浮窗确认模式** (可选)

### 使用方法

#### 方式 1: 快捷键
- **编辑器内**: `Ctrl+M` → 编辑器模式（原有）
- **任何地方**: `Ctrl+Shift+M` → 全局模式（新增）
- **Mac**: `Cmd+M` 或 `Cmd+Shift+M`

#### 方式 2: 右键菜单
1. 选中文本
2. 右键菜单 → "Markdown-Next-AI：修改所选内容"
3. 全局模式下也适用（编辑器外的选中文本）

#### 方式 3: 菜单栏
- 命令面板 (`Ctrl+P`) → "打开AI对话框（全局模式）"

## 浮窗操作

```
┌─────────────────────────────────────┐
│ [🤖] Claude 3.5 │ 字数: 245 │ [✕]  │ ← 拖拽此处移动浮窗
├─────────────────────────────────────┤
│ ⏳ 正在生成中(245字) │ 呼吸点动画    │
├─────────────────────────────────────┤
│                                     │
│   生成的内容显示在这里，支持       │
│   滚动，最多显示300px的高度...    │
│                                     │
├─────────────────────────────────────┤
│ [✅插入] [🔄替换] [📋复制] [❌取消] │
└─────────────────────────────────────┘
```

**按钮说明:**
- **✅ 插入**: 在光标位置插入内容
- **🔄 替换**: 替换选中的文本（无选中时禁用）
- **📋 复制**: 复制到剪贴板
- **❌ 取消**: 关闭浮窗，不做任何操作

**拖拽提示:**
- 按住浮窗头部任意位置可拖拽
- 浮窗自动限制在窗口边界内
- 支持鼠标和触摸

## 工作流

### 编辑器模式（原有）
```
快捷键/菜单 → @ 弹窗 → 直接写入编辑器
```

### 全局模式（新增）
```
Ctrl+Shift+M → @ 弹窗 → 浮窗预览 → 用户选择 → 写入编辑器
```

### 浮窗预览（可选）
```
任何生成 → 浮窗预览 → 用户确认 → 写入编辑器
（启用 useFloatingPreview 时）
```

## 常见场景

### 场景 1: 快速改写选中内容
1. **编辑器内** → 选中需要修改的文本
2. **按 `Ctrl+M`** → 编辑器弹窗打开
3. **输入修改要求** → 结果直接替换选中内容
4. **无需确认** → 立即应用

### 场景 2: 谨慎确认重要内容
1. **编辑器内** → 选中文本
2. **启用浮窗模式** → 任何生成都先显示浮窗
3. **查看结果** → 确认无误后点击"插入"
4. **保存内容** → 写入编辑器

### 场景 3: 在其他区域快速生成
1. **在笔记应用/浏览器** → 选中参考文本
2. **按 `Ctrl+Shift+M`** → 全局对话框打开
3. **输入需求** → AI 生成内容
4. **点击复制** → 粘贴到需要的地方

### 场景 4: 聊天历史查看
1. **打开 @ 弹窗**（任何模式）
2. **点击左上角 "🕘" 历史按钮**
3. **查看最近对话记录**
4. **点击历史项快速重复操作**

## 设置详解

### 启用全局对话框模式
```
允许在非 Markdown 编辑器上下文打开对话框
快捷键: Ctrl+Shift+M
```
- **启用**: 可以在任何地方打开 AI 弹窗
- **禁用**: 只能在编辑器内使用（节省资源）

### 使用浮窗确认模式
```
AI 生成结果先显示在浮窗，用户确认后再写入编辑器
```
- **启用**: 
  - ✅ 更多控制力
  - ✅ 可修改后再写入
  - ⚠️ 多一步操作
- **禁用** (默认):
  - ✅ 直接生成结果
  - ✅ 更快速高效
  - ⚠️ 不可验证就覆盖

## 键盘快捷键总结

| 快捷键 | 功能 | 模式 |
|--------|------|------|
| `Ctrl+M` | 打开编辑器弹窗 | 编辑器 |
| `Ctrl+Shift+M` | 打开全局弹窗 | 任何地方 |
| `Cmd+M` | Mac 编辑器模式 | Mac |
| `Cmd+Shift+M` | Mac 全局模式 | Mac |
| `Tab` | 模型选择器 | 弹窗内 |
| `Ctrl+K` | 知识库搜索 | 弹窗内 |
| `Enter` | 提交生成 | 弹窗内 |
| `Esc` | 关闭弹窗 | 弹窗内 |

## 故障排查

### Q: 浮窗不显示？
A: 
1. 检查设置中 `enableGlobalDialog` 是否启用
2. 确保 `useFloatingPreview` 也已启用
3. 查看浏览器控制台的错误信息

### Q: 按钮显示灰色？
A: 
- **插入/替换灰色**: 没有打开的编辑器
- **复制/取消**: 始终可用
- 解决: 打开任何 Markdown 文件

### Q: 右键菜单不出现？
A:
1. 确保选中了文本
2. 在编辑器外右键需启用 `enableGlobalDialog`
3. 刷新或重启 Obsidian

### Q: 内容如何保存？
A:
- 浮窗内的按钮选择会自动记录
- 最后一次操作类型保存为 `lastInsertAction`
- 对话历史在 @ 弹窗的历史列表中

## 开发者注意

### 新增 API 方法
```typescript
// 全局模式打开（非编辑器上下文）
showAtTriggerModalGlobal(selectedText?: string)

// 全局模式生成（流式输出到浮窗）
handleContinueWritingGlobal(...)

// 内容插入操作（支持 insert/replace/copy）
insertGeneratedContent(view, action, content, selectedText)
```

### 新增 UI 组件
```typescript
// 独立浮窗 UI（不依赖编辑器容器）
class AIResultFloatingWindow {
    open()                          // 打开浮窗
    close()                         // 关闭浮窗
    updateContent(text)             // 更新内容
    updateStatus(text)              // 更新状态
    showError(message)              // 显示错误
    showActions()                   // 显示按钮
    setOnInsert(callback)           // 插入回调
    setOnReplace(callback)          // 替换回调
    setOnCopy(callback)             // 复制回调
    setOnCancel(callback)           // 取消回调
}
```

### 关键代码位置
- 全局命令: `src/main.ts` 第 ~112 行
- 浮窗组件: `src/ui/result-floating-window.ts`
- 样式文件: `styles.css` 第 ~3200 行
- 设置 UI: `src/settings.ts` 第 ~360 行

## 性能考虑

### 优化点
✅ 浮窗使用 fixed 定位（不阻塞编辑器渲染）
✅ 流式更新而非整块替换
✅ 内存缓冲防止直接 DOM 写入延迟
✅ 惰性加载 UI 组件

### 建议
- 大文本生成（>10KB）建议使用浮窗模式预览
- 启用全局模式会略增加内存占用（可关闭）
- 频繁短生成使用编辑器模式更快

---

**更新于**: 2026-01-03
**版本**: 1.0.0
**状态**: 生产就绪 ✅

