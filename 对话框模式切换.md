### éœ€æ±‚æ–‡æ¡£ï¼šAI å¯¹è¯æ¡†æ¨¡å¼åˆ‡æ¢å™¨ (AI Dialog Mode Switcher)

#### 1. èƒŒæ™¯ä¸ç›®æ ‡
å½“å‰ `AtTriggerPopup` (Quick Ask) æ‰¿è½½äº†å…¨å±€å¯¹è¯ä¸æ–‡ä»¶ç¼–è¾‘çš„åŒé‡åŠŸèƒ½ã€‚ä¸ºäº†æ›´æ˜ç¡®åœ°åˆ†ç¦»â€œçº¯å¯¹è¯â€ä¸â€œæ–‡ä»¶æ„å»ºâ€åœºæ™¯ï¼Œéœ€åœ¨å¯¹è¯æ¡†å¤´éƒ¨å¼•å…¥ä¸€ä¸ªæ¨¡å¼é€‰æ‹©å™¨ï¼Œä½¿ç”¨æˆ·èƒ½æ˜¾å¼åˆ‡æ¢å½“å‰ AI çš„å·¥ä½œæ¨¡å¼ã€‚
æœ¬æ–¹æ¡ˆå‚è€ƒäº† `obsidian-yolo` æ’ä»¶çš„ `QuickAskPanel` å®ç°ï¼Œé‡‡ç”¨äº†é›†ä¸­å¼æ¨¡å¼å®šä¹‰ä¸æ’ä»¶è®¾ç½®æŒä¹…åŒ–æ–¹æ¡ˆã€‚

#### 2. UI/UX è§„èŒƒ

**2.1 ç»„ä»¶ä½ç½®ä¸å¸ƒå±€**
-   **æŒ‚è½½ç‚¹**: `src/ui/at-trigger-popup.ts` ä¸­çš„ `.markdown-next-ai-popup-header` å®¹å™¨ã€‚
-   **ä½ç½®**: ä½äºæ ‡é¢˜æ  (`.markdown-next-ai-popup-title`) ä¸ æ“ä½œåŒº (`.markdown-next-ai-popup-actions`) ä¹‹é—´ï¼Œæˆ–ä½œä¸ºæ“ä½œåŒºæœ€å·¦ä¾§çš„å…ƒç´ ã€‚
-   **è§†è§‰èåˆ**: èƒŒæ™¯è‰²é€æ˜ï¼Œä»…åœ¨æ‚¬åœ/å±•å¼€æ—¶æ˜¾ç¤ºäº¤äº’æ€ï¼Œä¿æŒæ ‡é¢˜æ æ•´æ´ã€‚

**2.2 ä¸Šæ‹‰é€‰æ‹©å™¨æ ·å¼ (Dropup)**
-   **å°ºå¯¸**:
    -   å®½: `140px` (æ¡Œé¢ç«¯); `100px` (ç§»åŠ¨ç«¯ â‰¤ 768px)ã€‚
    -   é«˜: `32px`ã€‚
    -   åœ†è§’: `4px`ã€‚
    -   å­—ä½“: `14px`, é¢œè‰² `#212121` (äº®è‰²) / `var(--text-normal)` (æš—è‰²)ã€‚
-   **çŠ¶æ€æ€**:
    -   **é»˜è®¤**: æ˜¾ç¤ºå½“å‰æ¨¡å¼å›¾æ ‡ + æ–‡å­— (ç§»åŠ¨ç«¯ä»…æ˜¾ç¤ºæ–‡å­—)ã€‚
    -   **Hover**: èƒŒæ™¯å¾®äº® (`var(--background-modifier-hover)`).
    -   **å±•å¼€**: ä¸Šæ‹‰é¢æ¿å›ºå®šå®šä½ (Fixed + React Portal)ï¼Œä½äºè§¦å‘å™¨ä¸Šæ–¹ï¼Œåœ†è§’ `6px`ï¼Œé˜´å½± `0 4px 12px rgba(0,0,0,0.15)`ã€‚
-   **åŠ¨ç”»**:
    -   å±•å¼€/æ”¶èµ·: `200ms` cubic-bezier ç¼“åŠ¨ã€‚

**2.3 é€‰é¡¹æ ·å¼ (Option Item)**
-   **å¸ƒå±€**: Flex å¸ƒå±€ï¼Œå›¾æ ‡å·¦ç½® (`16px`)ï¼Œæ–‡å­—å³ç½®ã€‚ä»…åŒ…å«å›¾æ ‡ä¸æ ‡é¢˜ï¼Œæ— è¾…åŠ©æè¿°æ–‡æœ¬ã€‚
-   **å†…è¾¹è·**: `6px 8px`ã€‚
-   **äº¤äº’**:
    -   Hover: é«˜äº®èƒŒæ™¯ `#F5F5F5` (äº®è‰²) / `var(--background-modifier-hover)` (æš—è‰²)ã€‚
    -   Selected: ä¿æŒé«˜äº®æˆ–å·¦ä¾§å¢åŠ æŒ‡ç¤ºæ¡ã€‚

**2.4 åé¦ˆäº¤äº’**
-   åˆ‡æ¢æ¨¡å¼åï¼Œå¯¹è¯æ¡†å†…å®¹åŒºåŸŸé¡¶éƒ¨å‡ºç° Toast æç¤ºï¼šâ€œå·²åˆ‡æ¢è‡³ **Ask æ¨¡å¼**â€ï¼Œ3ç§’åæ·¡å‡ºã€‚

#### 3. åŠŸèƒ½éœ€æ±‚

**3.1 æ¨¡å¼å®šä¹‰ (Centralized Definition)**
å€Ÿé‰´ `ModeSelect.tsx` ä¸­çš„ `MODE_OPTIONS` æ¨¡å¼ï¼Œé‡‡ç”¨é›†ä¸­å¼é…ç½®ä»¥æ”¯æŒ i18n å’Œæœªæ¥æ‰©å±•ã€‚

| ç‰¹æ€§ | Ask æ¨¡å¼ (ask) | Edit æ¨¡å¼ (edit) | Edit Direct æ¨¡å¼ (edit-direct) |
| :--- | :--- | :--- | :--- |
| **å€¼** | `ask` | `edit` | `edit-direct` |
| **å›¾æ ‡** | ğŸ’¬ (MessageSquare) | âœï¸ (Pencil) | âš¡ (Zap) |
| **Label Key** | `quickAsk.modeAsk` | `quickAsk.modeEdit` | `quickAsk.modeEditDirect` |
| **Placeholder** | "æœ‰é—®é¢˜å°½ç®¡é—®æˆ‘â€¦" | "æè¿°éœ€æ±‚ï¼Œæˆ‘å°†ç”Ÿæˆ Diffâ€¦" | "ç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼Œæ— éœ€ç¡®è®¤â€¦" |
| **æ ¸å¿ƒè¡Œä¸º** | `submitMessage` (ä»…æ–‡æœ¬å›å¤) | `submitEditMode` (ç”Ÿæˆ Diff) | `submitEditDirect` (ç›´æ¥åº”ç”¨) |

**3.2 çŠ¶æ€ç®¡ç†ä¸æŒä¹…åŒ–**
-   **çŠ¶æ€æº**: æå‡è‡³ `QuickAskPanel` (æˆ–å¯¹åº”å®¹å™¨) ç»´æŠ¤ã€‚
-   **æŒä¹…åŒ–æ–¹æ¡ˆ**:
    -   **Storage**: Plugin Settings (è€Œé localStorage)ã€‚
    -   **KeyPath**: `settings.continuationOptions.quickAskMode` (å‚è€ƒ Yolo)ã€‚
    -   **è¯»å–æ—¶æœº**: ç»„ä»¶åˆå§‹åŒ–æ—¶ä» `plugin.settings` è¯»å–ã€‚
    -   **å†™å…¥æ—¶æœº**: ç”¨æˆ·åˆ‡æ¢é€‰é¡¹æ—¶ï¼Œè°ƒç”¨ `plugin.saveSettings()`ã€‚
-   **é»˜è®¤å€¼**: `edit` (ç”Ÿäº§åŠ›ä¼˜å…ˆ)ã€‚

**3.3 æ— éšœç¢ (Accessibility)**
-   ç»„ä»¶ `role="combobox"`.
-   æ”¯æŒ `ArrowUp` / `ArrowDown` å¯¼èˆªé€‰é¡¹ã€‚
-   æ”¯æŒ `Enter` ç¡®è®¤é€‰æ‹©ã€‚
-   æ”¯æŒ `Esc` å…³é—­ä¸‹æ‹‰èœå•ã€‚

#### 4. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

**4.1 æ•°æ®ç»“æ„å®šä¹‰**
åœ¨ `src/types.ts` æˆ–ç»„ä»¶æ–‡ä»¶ä¸­å®šä¹‰ï¼š
```typescript
export type QuickAskMode = 'ask' | 'edit' | 'edit-direct';

export interface ModeOption {
  value: QuickAskMode;
  labelKey: string;     // i18n key
  labelFallback: string;
  descKey: string;      // i18n key
  descFallback: string;
  icon: React.ReactNode;
}

export const MODE_OPTIONS: ModeOption[] = [
  // ... (è§ 3.1 è¡¨æ ¼å†…å®¹)
];
```

**4.2 ç»„ä»¶è®¾è®¡ (React)**
æ–°å»º `src/components/panels/quick-ask/ModeSelect.tsx` (å‚è€ƒ Yolo):
```tsx
interface ModeSelectProps {
  mode: QuickAskMode;
  onChange: (mode: QuickAskMode) => void;
  // ... å…¶ä»– UI Props (ref, container ç­‰)
}

export const ModeSelect = forwardRef<HTMLButtonElement, ModeSelectProps>(...)
```

**4.3 ä¸šåŠ¡é€»è¾‘é›†æˆ**
åœ¨ `AtTriggerPopup` (æˆ– React å®¹å™¨ç»„ä»¶) ä¸­ï¼š
1.  **Action Branching**:
    ```typescript
    const handleEnter = useCallback((text) => {
      if (mode === 'edit') {
        void submitEditMode(text);
      } else if (mode === 'edit-direct') {
        void submitEditDirect(text);
      } else {
        void submitMessage(text);
      }
    }, [mode]);
    ```
2.  **Settings Sync**:
    ```typescript
    const handleModeChange = (newMode: QuickAskMode) => {
      setMode(newMode);
      // æ›´æ–°æ’ä»¶è®¾ç½®
      plugin.settings.continuationOptions.quickAskMode = newMode;
      plugin.saveSettings();
    };
    ```

**4.4 i18n æ”¯æŒ**
-   åˆ©ç”¨ `labelKey` å’Œ `descKey` å¯¹æ¥æ’ä»¶çš„ `t()` å‡½æ•°ã€‚
-   ç¡®ä¿æ¨¡å¼åç§°å’Œæè¿°æ”¯æŒå¤šè¯­è¨€åˆ‡æ¢ã€‚

#### 5. æµ‹è¯•è®¡åˆ’

**5.1 å•å…ƒæµ‹è¯•**
-   [ ] éªŒè¯ `MODE_OPTIONS` é…ç½®å®Œæ•´æ€§ã€‚
-   [ ] éªŒè¯ `handleModeChange` æ˜¯å¦æ­£ç¡®è°ƒç”¨ `saveSettings`ã€‚
-   [ ] éªŒè¯é”®ç›˜å¯¼èˆªï¼šä¸Šä¸‹é”®æ˜¯å¦å¾ªç¯é€‰æ‹©ï¼Œå›è½¦æ˜¯å¦ç”Ÿæ•ˆã€‚

**5.2 é›†æˆæµ‹è¯•**
-   [ ] **Ask æ¨¡å¼**: è¾“å…¥ "Refactor this code"ï¼ŒéªŒè¯è°ƒç”¨ `submitMessage`ã€‚
-   [ ] **Edit æ¨¡å¼**: è¾“å…¥ç›¸åŒæŒ‡ä»¤ï¼ŒéªŒè¯è°ƒç”¨ `submitEditMode`ã€‚
-   [ ] **æŒä¹…åŒ–æµ‹è¯•**: åˆ‡æ¢æ¨¡å¼åé‡å¯æ’ä»¶/é‡è½½çª—å£ï¼ŒéªŒè¯æ¨¡å¼æ˜¯å¦è®°å¿†ã€‚
